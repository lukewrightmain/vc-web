define(["exports","./e_edison","./e_ui_page_files_router","./c_share_modal_evolution_utils_logging","./c_src_utils_logging","./c_core_browser_detection","./c_core_i18n","./c_components_sharing_spinner","./c_ui-icon_line_link","./c_truncate_index","./c_lodash-es_lodash","./c_clipboard_v3","./c_sharing_ui_util","metaserver/static/js/modules/constants/sharing","./e_core_exception","./c_src_sink_index","./c_core_exception_info"],(function(e,t,s,i,n,r,o,a,c,l,p,d,h,u,_,m,f){"use strict";var E,C,g,L;!function(e){e.PENDING="pending",e.COPY="copy",e.RESULT="result",e.ERROR_CLIENT="error_client",e.ERROR_SERVER="error_server"}(E||(E={})),e.CopyLinkException=void 0,(C=e.CopyLinkException||(e.CopyLinkException={})).SHARED_LINK_ALREADY_EXISTS="shared_link_already_exists",C.ACCESS_DENIED="access_denied",C.PATH="path",C.NOT_FOUND="not_found",C.EMAIL_NOT_VERIFIED="email_not_verified",C.SETTINGS_ERROR="settings_error",C.NOT_AUTHORIZED="not_authorized",C.UNDEFINED_ERROR="undefined_error",C.FAILED_COPY_TO_CLIPBOARD="failed_copy_to_clipboard",function(e){e.PENDING="pending",e.COPY="copy",e.RESULT="result",e.ERROR="error"}(g||(g={})),function(e){e.EXEC_COMMAND="exec_command",e.CLIPBOARD_API="clipboard_api",e.MANUAL="manual"}(L||(L={}));const k=t=>{switch(t){case e.CopyLinkException.ACCESS_DENIED:case e.CopyLinkException.NOT_AUTHORIZED:return o.intl.formatMessage({id:"2wQgFw",defaultMessage:"Couldn't copy the link. You don't have permission to create a link to this content."});case e.CopyLinkException.NOT_FOUND:return o.intl.formatMessage({id:"+HMjSg",defaultMessage:"We can't find this file anymore. Try checking activity or folder history to see what happened."});case e.CopyLinkException.EMAIL_NOT_VERIFIED:return o.intl.formatMessage({id:"cHWnMe",defaultMessage:"You can't share until you verify your email address."});default:return o.intl.formatMessage({id:"pAS2H5",defaultMessage:"Couldn't copy, but it might be a fluke. Try reloading the page or ask us for help."})}},O="copy-link-mini-modal__header";class I extends t.react.exports.Component{constructor(){super(...arguments),this._getContentName=e=>{if(e){const t=e.split("/");return t[t.length-1]}},this._hasFileExtension=e=>{var t;const s=null===(t=this.props.fileInfo)||void 0===t?void 0:t.is_dir;if(!e||s)return!1;return e.lastIndexOf(".")>0}}render(){return t.react.exports.createElement("div",{className:O},t.react.exports.createElement("div",{className:`${O}-content`},this.props.stageType===E.PENDING&&this._renderPendingStage(),this.props.stageType===E.COPY&&this._renderCopyStage(),this.props.stageType===E.RESULT&&this._renderResultStage(),this.props.stageType===E.ERROR_CLIENT&&this._renderClientErrorStage(),this.props.stageType===E.ERROR_SERVER&&this._renderServerErrorStage()),this._renderCloseButton())}_renderPendingStage(){return t.react.exports.createElement(t.react.exports.Fragment,null,t.react.exports.createElement(a.SharingSpinner,{ariaValue:"Loading xsmall",textSize:"standard"}),t.react.exports.createElement(s.Text,{className:`${O}--pending-text`},o.intl.formatMessage({id:"LPF3tp",defaultMessage:"Getting the link..."})))}_renderCopyStage(){return t.react.exports.createElement(s.Text,null,t.react.exports.createElement(s.Link,{href:"#",hasNoUnderline:!0,onClick:this.props.actionHandler,isBold:!0},t.react.exports.createElement(s.UIIcon,{src:c.LinkLine,"aria-label":""}),o.intl.formatMessage({id:"emiHs/",defaultMessage:"Copy Link"})))}_renderResultStage(){var e,i;const n=o.intl.formatMessage({id:"l+Mf7Y",defaultMessage:"Allows editing."}),r=o.intl.formatMessage({id:"FXqYpV",defaultMessage:"Allows viewing."});let a="";void 0!==this.props.linkAccessLevel&&(a="editor"===this.props.linkAccessLevel?n:r);const c=this._getContentName(null===(e=this.props.fileInfo)||void 0===e?void 0:e.fq_path),p=this._hasFileExtension(null===(i=this.props.fileInfo)||void 0===i?void 0:i.fq_path),d=c?t.react.exports.createElement(l.Truncate,{className:`${O}--content-name`,maxWidth:225,observeParent:!0,location:.5},c):void 0,h=this.props.isInCopyLinkRightRailExpt&&d?p?o.intl.formatMessage({id:"0KPHns",defaultMessage:'Link copied to "{contentNameInHeader}".'},{contentNameInHeader:d}):o.intl.formatMessage({id:"Az3hZK",defaultMessage:'Link copied to "{contentNameInHeader}."'},{contentNameInHeader:d}):o.intl.formatMessage({id:"v2yJMn",defaultMessage:"Link copied."});return t.react.exports.createElement(t.react.exports.Fragment,null,t.react.exports.createElement(s.UIIcon,{className:`${O}--result-icon`,src:s.CheckmarkCircleLine,size:"standard","aria-label":""}),t.react.exports.createElement("div",{className:`${O}--result-container`},t.react.exports.createElement(s.Text,{className:`${O}--result-text`,isBold:!0},h," "),t.react.exports.createElement(s.Text,null,a)))}_renderClientErrorStage(){return t.react.exports.createElement(t.react.exports.Fragment,null,t.react.exports.createElement(s.UIIcon,{className:`${O}--client-error-icon`,src:s.FailLine,"aria-label":""}),t.react.exports.createElement(s.Text,{className:`${O}--client-error-text`},t.react.exports.createElement("b",null,o.intl.formatMessage({id:"rp1Lxc",defaultMessage:"Couldn't copy the link."})," "),t.react.exports.createElement(s.Link,{href:"#",hasNoUnderline:!0,onClick:this.props.actionHandler,isBold:!0},o.intl.formatMessage({id:"wXhxJC",defaultMessage:"Try again"}))))}_renderServerErrorStage(){return t.react.exports.createElement(t.react.exports.Fragment,null,t.react.exports.createElement("div",null,t.react.exports.createElement(s.UIIcon,{size:"standard",src:s.FailLine,"aria-label":""})),t.react.exports.createElement(s.Text,{className:`${O}--server-error-text`},this.props.errorMessage))}_renderCloseButton(){return t.react.exports.createElement(s.IconButton,{"aria-label":"close",onClick:this.props.closeButtonHandler,variant:"transparent",isRounded:!0,size:"small"},t.react.exports.createElement(s.UIIcon,{src:s.CloseLine,"aria-label":""}))}}I.displayName="CopyLinkMiniModalHeaderComponent";const R=s.requireCssWithComponent(I,["/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css","/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css"]);class v extends t.react.exports.Component{constructor(){super(...arguments),this.handleCopy=()=>{this.props.onCopyToClipboard(L.MANUAL)}}componentDidMount(){this.props.shouldFocusOnLink&&this.props.focusOnInput()}componentDidUpdate(){this.props.shouldFocusOnLink&&this.props.focusOnInput()}render(){return t.react.exports.createElement("div",{className:"copy-link-mini-modal__link"},t.react.exports.createElement(s.TextInput,{onCopy:this.handleCopy,size:"standard","aria-label":"Link for copy link click",value:this.props.sharedLink.url,readOnly:!0,onClick:this.props.focusOnInput,ref:this.props.inputRef}))}}v.displayName="CopyLinkMiniModalLinkComponent";const y=s.requireCssWithComponent(v,["/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css","/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css"]);class T extends t.React$1.Component{constructor(){super(...arguments),this.onWindowResize=p.throttle((()=>{this.props.anchorRef.current||this.props.closeButtonHandler()}),500),this.handleClick=e=>{e.preventDefault(),e.stopPropagation()}}componentDidMount(){window.addEventListener("resize",this.onWindowResize)}componentWillUnmount(){window.removeEventListener("resize",this.onWindowResize)}render(){var e;const{anchorRef:i,inputRef:n,stage:r,closeButtonHandler:o,linkAccessLevel:a,sharedLink:c,shouldFocusOnLink:l,focusOnInput:p,actionHandler:d,errorMessage:h,onCopyToClipboard:u,zIndexOverride:_,placement:m,fileInfo:f,isInCopyLinkRightRailExpt:E}=this.props,C=t.React$1.createElement(R,{stageType:r,actionHandler:d,closeButtonHandler:o,sharedLink:c,linkAccessLevel:a,errorMessage:h,fileInfo:f,isInCopyLinkRightRailExpt:!!E});let g=t.React$1.createElement(t.React$1.Fragment,null);return c&&p&&n&&(g=t.React$1.createElement(y,{sharedLink:c,focusOnInput:p,inputRef:n,shouldFocusOnLink:l,onCopyToClipboard:u})),t.React$1.createElement(s.LayerContext.Provider,{value:{zIndex:_||20}},t.React$1.createElement(s.ClickOutside,{isActive:!0,onClickOutside:o,shouldPropagateMouseEvents:!1,isBlock:!0,shouldClickOutsideWhenDefaultPrevented:!0},t.React$1.createElement(s.Overlay,{className:"copy-link-mini-modal__overlay",anchorRef:i,placement:m||"bottom",auto:!0,offsetDistance:null!==(e=this.props.yOffsetDistance)&&void 0!==e?e:4,onClick:this.handleClick},C,g)))}}T.displayName="CopyLinkMiniModalOverlayComponent";const x=s.requireCssWithComponent(T,["/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css","/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css"]);class N{constructor(e){this.category="udcl-measures_restricted",this.measure_id=e.id,this.name=e.name,this.platform="web",this.start_time_ms=e.start_time_ms,this.end_time_ms=e.start_time_ms+e.duration_ms,this.duration_ms=e.duration_ms,this.extra=e.extra,Object.seal(this)}}const S=new s.HiveLogger,A="udcl",b="mark",D="measure";function M(e,...t){return[A,...t,e].join(":")}function F(e,...t){const s=M("",...t);return 0===e.indexOf(s)?e.slice(s.length):e}function P(e,...t){return"string"==typeof e?M(e,...t):e}var w;!function(e){e.TTS="tts"}(w||(w={}));const H={[w.TTS]:"success"},U="web",$="time_to_resolution",z=[function(e,t){const s=F(t.name,D);S.log(new N({id:e,name:s,start_time_ms:t.startTime,duration_ms:t.duration,extra:(i=t.detail,p.isPlainObject(i)?p.mapValues(i,(e=>{try{return"string"==typeof e?e:JSON.stringify(e)}catch(e){return _.reportStack("udcl.normalizeJson: value could not be serialized",{severity:f.SEVERITY.NONCRITICAL,exc_extra:{error:e.message}}),"[unserializable value]"}})):{})}));var i},function(e,t){var s,i;if(!function(e){var t,s;const i=F(e.name,D),n=null!==(s=null===(t=e.detail)||void 0===t?void 0:t.jtbd)&&void 0!==s?s:"";return Object.values(w).includes(i)&&(r=n,"string"==typeof r&&r.length>0);var r}(t))return;const n=F(t.name,D),r=null!==(i=String(null===(s=t.detail)||void 0===s?void 0:s.jtbd))&&void 0!==i?i:"",o=t.duration,a=function(e){var t;return null!==(t=H[e])&&void 0!==t?t:"unknown"}(n),c=function(e,t="_"){return e.replace(/[^-0-9a-zA-Z._]/g,t)}(r),l=[U,c,$].join("/");m.getMetricsReporter$1().createStats({ns:A,name:l},{resolution:a}).record(o)}];function B(e,t){(function(e){return e.entryType===D})(t)&&z.forEach((s=>s(e,t)))}function Y(e){return{class:"share",action:"create",object:"shared_link",properties:e}}const W=["max","editor","viewer"];function V(e){return W.find((t=>t===(null==e?void 0:e.toLowerCase())))}class j extends t.React$1.Component{constructor(i){super(i),this.handleCopyLinkToClipboard=()=>{d.copyToClipboard(this.sharedLink.url,(()=>{this.handleClipboardSuccess(L.EXEC_COMMAND)}),this.handleClipboardFailure)},this.handleClipboardSuccess=e=>{e!==L.MANUAL&&this.setState({stage:g.RESULT}),this.logEvent(n.TiburonEventName.CopySharedLink,{created_new_link:this.isLinkNewlyCreated,copy_method:e,access:this.getAccessLevel(),timing:this.getLinkActionTTI(this.startCopyLinkTime)})},this.handleClipboardFailure=()=>{this.copyLinkToClipboardNewAPI()},this.copyLinkToClipboardNewAPI=()=>{if(navigator.clipboard){const e=this.sharedLink.url;navigator.clipboard.writeText(e).then((()=>{this.handleClipboardSuccess(L.CLIPBOARD_API)}),(()=>{this.handleClipboardFailureNewAPI()}))}else this.handleClipboardFailureNewAPI()},this.handleClipboardFailureNewAPI=()=>{this.exceptionType=e.CopyLinkException.FAILED_COPY_TO_CLIPBOARD,this.failToFetchCopyLinkHelper()},this.getLinkActionTTI=e=>Date.now()-e,this.onClose=()=>{this.props.setIsCreatingSharedLink(!1,this.fileIdOrPath),this.props.userActionSource===s.ActionSourceValue.BUTTON&&this.props.onHoverLocked&&this.props.onHoverLocked({isOpen:!1}),this.props.onActionFlowComplete&&this.props.onActionFlowComplete(),this.setState({isOpen:!1})},this.focusOnInput=()=>{this.inputRef.current&&this.inputRef.current.select()},this.inputRef=t.React$1.createRef(),this.state={isOpen:!0,stage:g.PENDING},this.fileIdOrPath=this.getFileIdOrPath()}componentDidMount(){var e;!function(e,t=performance.now()){const s=M(e,b);performance.mark(s,{startTime:t})}(`create-shared-link-${this.fileIdOrPath}`),s.logEvent(Y({eventState:"start",sharedLinkRequestedAccessLevel:V(this.getAccessLevel()),isDir:null===(e=this.props.file)||void 0===e?void 0:e.is_dir})),this.createSharedLink()}createSharedLink(){this.props.setIsCreatingSharedLink(!0,this.fileIdOrPath),this.props.userActionSource===s.ActionSourceValue.BUTTON&&this.props.onHoverLocked&&this.props.onHoverLocked({isOpen:!0}),this.startCreateLinkTime=Date.now();const t=(i=this.props.user,new s.FileShareApiClient({userId:i.id}));var i;let n=this.props.isInUserLevelSharingSettings?"default":"max";n="ON"===u.SHARING_EXPERIMENTS.USER_LEVEL_SHARING_SETTINGS?"default":n,t.createSharedLinkNonAlpha({fileIdOrPath:this.fileIdOrPath,settings:{access:n}}).then((e=>{this.startCopyLinkTime=Date.now(),this.succeedToFetchLinkHelper(e,!0),this.shareFolderIfNeeded(e)})).catch((t=>{this.startCopyLinkTime=Date.now(),t.error[".tag"]===e.CopyLinkException.SHARED_LINK_ALREADY_EXISTS?this.succeedToFetchLinkHelper(t.error.shared_link_already_exists.metadata,!1,t):t.error[".tag"]===e.CopyLinkException.ACCESS_DENIED?(this.exceptionType=e.CopyLinkException.ACCESS_DENIED,this.failToFetchCopyLinkHelper(t)):t.error[".tag"]===e.CopyLinkException.SETTINGS_ERROR&&t.error.settings_error[".tag"]===e.CopyLinkException.NOT_AUTHORIZED?(this.exceptionType=e.CopyLinkException.NOT_AUTHORIZED,this.failToFetchCopyLinkHelper(t)):t.error[".tag"]===e.CopyLinkException.PATH&&t.error.path[".tag"]===e.CopyLinkException.NOT_FOUND?(this.exceptionType=e.CopyLinkException.NOT_FOUND,this.failToFetchCopyLinkHelper(t)):t.error[".tag"]===e.CopyLinkException.EMAIL_NOT_VERIFIED?(this.exceptionType=e.CopyLinkException.EMAIL_NOT_VERIFIED,this.failToFetchCopyLinkHelper(t)):(this.exceptionType=t.error[".tag"]?t.error[".tag"]:e.CopyLinkException.UNDEFINED_ERROR,this.failToFetchCopyLinkHelper(t))}))}succeedToFetchLinkHelper(e,t,i){var r;this.sharedLink=e,this.isLinkNewlyCreated=t;const o=t?200:i&&i.raw&&i.raw.status;this.logEvent(n.TiburonEventName.SucceedCreateSharedLinkWithSettings,{created_new_link:t,http_status_code:o,response_status:"success",is_alpha:!1,access:this.getAccessLevel(),timing:this.getLinkActionTTI(this.startCreateLinkTime)}),t&&this.props.file&&s.getStoreForSharedWith().dispatch(s.sharedLinkDataOutOfDate(this.props.file.fq_path)),(()=>{const e=document.createElement("input");return e.value="sharing is caring",document.body.appendChild(e),e.select(),document.queryCommandEnabled("copy")})()?this.handleCopyLinkToClipboard():this.setState({stage:g.COPY});const a=function(e,t,i,n){const r=s.UUID.v4(),o=M(e,D),a=P(t,b),c=P(i,b);try{return B(r,performance.measure(o,{start:a,end:c,detail:n})),r}catch(e){_.reportException({err:e,severity:f.SEVERITY.NONCRITICAL})}}("tts",`create-shared-link-${this.fileIdOrPath}`,performance.now(),{jtbd:"create_shared_link"});s.logEvent(Y({eventState:"success",sharedLinkRequestedAccessLevel:V(this.getAccessLevel()),isDir:null===(r=this.props.file)||void 0===r?void 0:r.is_dir,udclMeasureId:a}))}failToFetchCopyLinkHelper(e){e&&this.logEvent(n.TiburonEventName.FailCreateSharedLinkWithSettings,{error_message:this.exceptionType,http_status_code:e.raw&&e.raw.status,is_alpha:!1,timing:this.getLinkActionTTI(this.startCreateLinkTime)}),this.setState({stage:g.ERROR}),this.logEvent(n.TiburonEventName.CopySharedLinkFailure,{error:this.exceptionType,timing:this.getLinkActionTTI(this.startCopyLinkTime)})}shareFolderIfNeeded(e){var t;if(!((null===(t=this.props.file)||void 0===t?void 0:t.is_dir)&&!this.props.file.target_ns))return;if(!(e.isRighteousLink()&&"editor"==e.accessLevel()))return;const i=(r=this.props.user.id,new s.FolderShareApiClient({userId:r}));var r;const o={fqPath:this.props.file.fq_path,folderPolicy:null};i.share(o).catch((e=>{this.logEvent(n.TiburonEventName.FailCreateNamespaceAfterLinkCreated,{http_status_code:e.raw&&e.raw.status,error_tag:e.error&&e.error[".tag"]||"undefined_error",error_summary:e&&e.summary,access:"editor"})}))}getFileIdOrPath(){var e,t;return(null===(e=this.props.file)||void 0===e?void 0:e.file_id)||(null===(t=this.props.file)||void 0===t?void 0:t.fq_path)||this.props.filePath}getAccessLevel(){const e=this.sharedLink?this.sharedLink.link_permissions.link_access_level:void 0;let t="viewer";return e&&(t=e.hasOwnProperty(".tag")?e[".tag"]:e),t}logEvent(e,t){var o,a;let c=s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ROW_BUTTON;this.props.userActionSurfaceLogValue===s.ActionSurfaceLogValue.RIGHT_SIDEBAR?(c=s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ACTIONS,t=this.props.rightRailCollapsed?Object.assign(Object.assign({},t),{source:"right_rail_collapsed"}):Object.assign(Object.assign({},t),{source:"right_rail_open"})):this.props.userActionSource===s.ActionSourceValue.OVERFLOW_MENU?c=s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ROW_OVERFLOW_MENU:this.props.userActionSource===s.ActionSourceValue.COPY_LINK_FROM_UPLOAD_MODAL&&(c=s.SHARE_ACTION_ORIGIN_TYPE.COPY_LINK_FROM_UPLOAD_MODAL);const l=r.get_browser_info();s.ShareTibEventLogger.log(this.props.user.id,e,c,Object.assign(Object.assign(Object.assign({},i.buildExtraFromLinkMetadata(this.sharedLink)),{file_id:null===(o=this.props.file)||void 0===o?void 0:o.file_id,fq_path:(null===(a=this.props.file)||void 0===a?void 0:a.fq_path)||this.props.filePath,browser:l.browser,browser_version:l.version}),t)),e===n.TiburonEventName.CopySharedLink&&h.trackUserLeapEvent(h.SharingUserLeapEvent.SHARE_LINK_COPY_SUCCESS,c)}static show(e,i){s.Modal$1.showInstance(t.React$1.createElement(G,Object.assign({},e)),!0,i)}render(){if(!this.state.isOpen)return null;switch(this.state.stage){case g.PENDING:return t.React$1.createElement(x,{stage:E.PENDING,closeButtonHandler:this.onClose,anchorRef:this.props.anchorRef,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement});case g.COPY:return t.React$1.createElement(x,{stage:E.COPY,actionHandler:this.handleCopyLinkToClipboard,closeButtonHandler:this.onClose,sharedLink:this.sharedLink,focusOnInput:this.focusOnInput,anchorRef:this.props.anchorRef,inputRef:this.inputRef,shouldFocusOnLink:!1,onCopyToClipboard:this.handleClipboardSuccess,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement});case g.ERROR:return this.exceptionType!==e.CopyLinkException.FAILED_COPY_TO_CLIPBOARD?t.React$1.createElement(x,{stage:E.ERROR_SERVER,closeButtonHandler:this.onClose,anchorRef:this.props.anchorRef,errorMessage:k(this.exceptionType),zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement}):t.React$1.createElement(x,{stage:E.ERROR_CLIENT,actionHandler:this.handleCopyLinkToClipboard,closeButtonHandler:this.onClose,sharedLink:this.sharedLink,focusOnInput:this.focusOnInput,inputRef:this.inputRef,anchorRef:this.props.anchorRef,shouldFocusOnLink:!0,onCopyToClipboard:this.handleClipboardSuccess,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement});case g.RESULT:return t.React$1.createElement(x,{stage:E.RESULT,linkAccessLevel:this.getAccessLevel(),actionHandler:this.handleCopyLinkToClipboard,closeButtonHandler:this.onClose,sharedLink:this.sharedLink,focusOnInput:this.focusOnInput,inputRef:this.inputRef,anchorRef:this.props.anchorRef,shouldFocusOnLink:!0,onCopyToClipboard:this.handleClipboardSuccess,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement,fileInfo:this.props.file,isInCopyLinkRightRailExpt:this.props.isInCopyLinkRightRailExpt})}}}j.displayName="CopyLinkMiniModalComponent";const G=s.requireCssWithComponent(j,["/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css","/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css"]);e.CopyLinkMiniModal=G}));
//# sourceMappingURL=c_views_copy_link_mini_modal.js-vfl4fE8BC.map
