define(["exports","./c_tslib","./e_ui_page_files_router","./e_edison","./c_ui-icon_line_download","./c_spectrum_tooltip","./c_file_store_utils","./c_extensions_data_selectors","./c_ui-icon_line_dropbox-replay","./c_ui-icon_line_dropbox","./c_ui-icon_line_finder","./c_ui-icon_line_folder-show","./c_ui-icon_line_globe","./c_ui-icon_line_show","./c_extensions_extensions_utils","./c_core_browser_detection","./c_core_i18n","./c_lodash-es_lodash"],(function(e,t,n,i,o,s,r,a,c,l,p,u,d,h,m,g,y,f){"use strict";class A extends i.React$1.Component{constructor(e){super(e),this.handleMouseOver=()=>{clearTimeout(this.timer),this.timer=setTimeout((()=>{this.props.bylines&&(this.setState({show:!0}),this.props.onDidShow())}),this.props.delay)},this.handleMouseOut=()=>{this.setState({show:!1}),clearTimeout(this.timer)},this.triggerRef=i.React$1.createRef(),this.state={show:!1}}componentWillUnmount(){clearTimeout(this.timer)}render(){const{children:e,bylines:t,isInActionBar:o}=this.props,s=i.React$1.Children.only(e);return t?i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(n.Tooltip.Control,{triggerRef:this.triggerRef,open:this.state.show,placement:o?"right":"left"},(e=>{if(e)return e.length>1?i.React$1.createElement("ul",{className:"extensions-byline-list"},e.map((e=>i.React$1.createElement("li",{key:e,className:"extensions-byline-list-item"},e)))):i.React$1.createElement("div",{className:"extensions-byline"},e[0])})(t)),i.React$1.cloneElement(s,{onMouseOver:this.handleMouseOver,onMouseOut:this.handleMouseOut,ref:this.triggerRef})):s}}A.defaultProps={delay:500},A.displayName="ExtensionsBylineTooltip";class _ extends i.React$1.Component{render(){const{unityOptions:e,legacyCloudEditorOptions:t,cloudEditorAppActions:o,bylines:s,currentSession:r,previewOption:y,openInReplayOption:f,openInDesktopOption:_,isInActionBar:E,goToFolderOption:w,wrapValuesForActionBar:I,openInNewTabOption:O}=this.props,C=e=>I?m.toActionBarValue(e):e,R=t.map((e=>{const{type:t}=e,o=t===a.OpenButtonAction.OPEN_WITH_CLOUD_DOC?"cloud_doc":"wopi";return i.React$1.createElement(n.Menu.ActionItem,{key:e.text,value:C(e),withLeftAccessory:e.spriteName?i.React$1.createElement(n.Sprite,{group:"web",name:e.spriteName,alt:""}):i.React$1.createElement("img",{alt:"",src:e.iconUrl,width:24,height:24})},i.React$1.createElement(A,{isInActionBar:E,bylines:s[o],onDidShow:a.handleShowByline(o,r),key:e.text},i.React$1.createElement("span",null,e.text)))})),b=e.map((e=>i.React$1.createElement(n.Menu.ActionItem,{key:e.text,value:C(e),withLeftAccessory:function(e){return"ow_desktop"===e.spriteName&&e.type===a.OpenButtonAction.UNITY_FILE?-1!==e.text.indexOf("Dropbox")?i.React$1.createElement(n.UIIcon,{src:l.DropboxLine}):i.React$1.createElement(n.UIIcon,{src:n.OpenLine}):i.React$1.createElement(n.Sprite,{group:"web",name:e.spriteName||"",alt:""})}(e)},e.text)));let x=!1;const v=o.map((e=>{x||(x=a.isWopiAction(e.appAction));const t=e.appAction.handler.editor_name;return i.React$1.createElement(n.Menu.ActionItem,{key:e.appAction.description,value:C(e),withLeftAccessory:i.React$1.createElement("img",{alt:"",src:e.appAction.icon.url,width:24,height:24})},i.React$1.createElement(A,{isInActionBar:E,bylines:s[t],onDidShow:a.handleShowByline(t,r),key:e.appAction.description},i.React$1.createElement("span",null,e.appAction.description)))})),$=y&&i.React$1.createElement(n.Menu.ActionItem,{key:y.text,value:C(y),withLeftAccessory:i.React$1.createElement(n.UIIcon,{src:h.ShowLine})},y.text),T=f&&i.React$1.createElement(n.Menu.ActionItem,{key:f.text,value:C(f),withLeftAccessory:i.React$1.createElement(n.UIIcon,{src:c.DropboxReplayLine})},f.text),S=_&&i.React$1.createElement(n.Menu.ActionItem,{key:_.text,value:C(_),withLeftAccessory:i.React$1.createElement(n.UIIcon,{src:g.mac?p.FinderLine:p.FileExplorerLine})},_.text),B=O&&i.React$1.createElement(n.Menu.ActionItem,{key:O.text,value:C(O),withLeftAccessory:i.React$1.createElement(n.UIIcon,{src:d.GlobeLine})},O.text),k=w&&i.React$1.createElement(n.Menu.ActionItem,{key:w.text,value:C(w),withLeftAccessory:i.React$1.createElement(n.UIIcon,{src:u.FolderShowLine})},w.text),M=b.length>0||R.length>0||v.length>0||!!B||!!$||!!T||!!S||!!k;return x?M&&i.React$1.createElement(n.Menu.Segment,{key:"open-options"},B,k,v,b,R,$,T,S):M&&i.React$1.createElement(n.Menu.Segment,{key:"open-options"},B,k,b,R,v,$,T,S)}}_.displayName="UnityAndCloudEditorsComponent";const E=n.requireCssWithComponent(_,["/static/metaserver/static/css/app_actions/index-vflXUc6ye.css","/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css"]);class w extends i.React$1.Component{constructor(e){super(e),this.createActionClickHandler=e=>()=>{if("cloud_editor"===e.handler[".tag"]){const t=a.isWopiAction(e)?a.OpenButtonAction.OPEN_WITH:a.OpenButtonAction.OPEN_WITH_CLOUD_DOC;a.logEvent(this.props.currentSession,"select_legacy_action",{type:t});const i=n.UserActionSourceType.WEB_PREVIEW,o=a.cloudEditorNameToParams(e.handler.editor_name);n.openWithCloudEditor(n.fileToOpenWithParams(this.props.file),this.props.user.id,o,!1,i)}}}render(){if(0===this.props.openOptions.length&&0===this.props.cloudEditorAppActions.length)return null;const e=this.props.cloudEditorAppActions.map((e=>({appAction:e,handler:this.createActionClickHandler(e),userAction:n.UserAction.OpenWithAppAction,actionName:e.description})));return i.React$1.createElement(E,{unityOptions:[],legacyCloudEditorOptions:this.props.openOptions,cloudEditorAppActions:e,bylines:{},wrapValuesForActionBar:!!this.props.isInActionBar})}}w.displayName="SharedFilePopoverContentComponent";const I=n.requireCssWithComponent(w,["/static/metaserver/static/css/app_actions/index-vflXUc6ye.css"]);class O extends i.React$1.Component{isFileConversionAction(e){return[a.OpenButtonAction.DECOMPRESS_FILE].includes(e.type)}render(){const{openOptions:e,wrapValuesForActionBar:t}=this.props,o=e.filter(this.isFileConversionAction);if(!o.length)return null;const s=o.map((e=>{const o=t?m.toActionBarValue(e):e;return i.React$1.createElement(n.Menu.ActionItem,{key:e.text,value:o,withLeftAccessory:e.iconElement},i.React$1.createElement("span",null,e.text))}));return i.React$1.createElement(n.Menu.Segment,{key:"file-conversions"},s)}}O.displayName="FileConversionOptionsComponent";const C=n.requireCssWithComponent(O,["/static/metaserver/static/css/app_actions/index-vflXUc6ye.css"]);class R extends i.React$1.Component{constructor(e){super(e),this.createAppActionClickHandler=e=>()=>{var t,n;const{file:i,user:o,featureFlags:s,telemetryContext:r,updateLinkState:c}=this.props;if(m.redirectToActionOrShowAuth(o,[i],e,s,r,c),"redirect"===e.handler[".tag"]){const t=a.getAppActionExtras(e);a.logEvent(this.props.currentSession,"select_action",Object.assign({menu_version:2},t))}else if("cloud_editor"===e.handler[".tag"]){const t=a.isWopiAction(e)?a.OpenButtonAction.OPEN_WITH:a.OpenButtonAction.OPEN_WITH_CLOUD_DOC;a.logEvent(this.props.currentSession,"select_legacy_action",{type:t})}null===(n=(t=this.props).onExtensionClick)||void 0===n||n.call(t)},this.wrapperForAction=e=>({appAction:e,handler:this.createAppActionClickHandler(e),userAction:n.UserAction.OpenWithAppAction,actionName:e.description}),this.renderActionRow=e=>{const t=e.icon;let o;o=t.is_static?i.static_url("/static/metaserver/static/images/generic_app_icon-vflIPYT1H.png"):t.url;const s=e.description,r=this.props.isInActionBar?m.toActionBarValue(this.wrapperForAction(e)):this.wrapperForAction(e);return i.React$1.createElement(n.Menu.ActionItem,{key:e.id,value:r,withLeftAccessory:i.React$1.createElement("img",{alt:"",src:o,width:24,height:24})},s)},this.renderUnpromotedActions=(e,t)=>{const{user:o,file:s,categoryIdToInfos:r,featureFlags:c,currentSession:l,telemetryContext:p,updateLinkState:u,isInActionBar:d}=this.props,h=e.length>0,g={handler:()=>{const n=[...e,...t];m.showExtensionsMiniDirectoryModal(y.intl.formatMessage({id:"KVD2SP",defaultMessage:"Open or edit with these apps"}),o,s,n,r,c,u,p,l),a.logEvent(l,h?"select_show_more":"select_add_app",{surface:p&&p.surface})}},f=d?m.toActionBarValue(g):g;return i.React$1.createElement(n.Menu.ActionItem,{key:y.intl.formatMessage({id:"R/67N/",defaultMessage:"Show more"}),value:f,withLeftAccessory:h&&!d?null:i.React$1.createElement(n.UIIcon,{src:n.AddCircleLine})},h?y.intl.formatMessage({id:"Gevpqz",defaultMessage:"Connect more apps"}):y.intl.formatMessage({id:"XFA09U",defaultMessage:"Connect apps"}))}}render(){const{appActions:e,openOptions:t,bylines:o,currentSession:s,isInActionBar:r}=this.props,c=a.getOpenOptionsWithLogging(t,s),{unityOptions:l,cloudEditorOptions:p,previewOption:u,openInReplayOption:d,openInDesktopOption:h,goToFolderOption:m,openInNewTabOption:g}=a.partitionOptions(c),{cloudEditors:y,installedActions:f,unpromotedActions:A}=a.partitionActions(e),_=f.length>0,w=A.length>0;return i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(C,{openOptions:c,currentSession:s,wrapValuesForActionBar:!!r}),i.React$1.createElement(E,{isInActionBar:r,unityOptions:l,legacyCloudEditorOptions:p,cloudEditorAppActions:y.map((e=>this.wrapperForAction(e))),bylines:o,currentSession:s,previewOption:u,openInReplayOption:d,openInNewTabOption:g,openInDesktopOption:h,goToFolderOption:m,wrapValuesForActionBar:!!r}),r&&(_||w)&&i.React$1.createElement(n.Menu.Segment,null,f.map((e=>this.renderActionRow(e))),this.renderUnpromotedActions(f,A)),!r&&_&&i.React$1.createElement(n.Menu.Segment,{key:"installed-actions"},f.map((e=>this.renderActionRow(e)))),!r&&w&&i.React$1.createElement(n.Menu.Segment,null,this.renderUnpromotedActions(f,A)))}}R.displayName="ExtensionsPopoverV2Component";const b=n.requireCssWithComponent(R,["/static/metaserver/static/css/app_actions/index-vflXUc6ye.css"]);class x extends i.React$1.Component{constructor(){super(...arguments),this.mounted=!1,this.state={unityInfo:null}}componentDidMount(){this.mounted=!0,m.UnityHelpers.isUnityEnabled()&&this.setupUnity()}componentWillUnmount(){this.mounted=!1,window.clearTimeout(this.disableCheck)}setupUnity(){this.props.isUnityDisabled?this.disableUnity():(m.UnityHelpers.getUnityFileInfo(this.props.file.ns_id,this.props.file.ns_path,this.props.user.id,(e=>{this.mounted&&this.setState({unityInfo:e})}),(()=>{this.mounted&&this.disableUnity()})),this.disableCheck=window.setTimeout((()=>{this.state.unityInfo||this.disableUnity()}),1e4))}disableUnity(){this.setState({unityInfo:{local_path:null,resolved_local_path:null,can_open_directly:!1,is_locally_available:!1,is_infinite_placeholder:!1,open_application_identifier:null,open_application_name:null,path_is_dir:!1,error_message:null}})}render(){return this.props.render(this.state.unityInfo)}}x.displayName="WithUnity";class v extends i.React$1.Component{constructor(e){super(e),this.handleButtonClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleMenuClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleHover=()=>{this.currentSession&&this.currentSession.event("trigger_hover")},this.setBigTooltip=e=>t.__awaiter(this,void 0,void 0,(function*(){const{file:t,appActions:i,featureFlags:o}=this.props,s=a.getFileExt(t)||"",r=i.length>0;if(r){const t=yield n.getTooltipHistory(e,["open_with_edu"]),i=n.allowedTooltips(r,s,o).find((e=>void 0!==t[e]&&!t[e]));this.setState({bigTooltipName:i})}})),this.markBigTooltipViewed=()=>{let e=!1;const t=[];this.state.bigTooltipName&&(t.push(n.markTooltipViewed(this.props.user.id,this.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then((()=>{this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)})),this.setState({bigTooltipName:void 0}))},this.handleSelectAction=(e,t)=>{t.preventDefault(),e.handler(),this.props.onExtensionClick&&this.props.onExtensionClick(e.actionName||e.userAction),this.logToPreviews(e,!1),t.stopPropagation()},this.logToPreviews=(e,t)=>{this.props.telemetryContext&&"previews"===this.props.telemetryContext.surface&&e.userAction&&(!e.actionName||e.actionName,r.isBrowseFile(this.props.file)&&this.props.file.read_only)},this.renderTrigger=e=>{const{triggerType:t}=this.props,o=Object.assign({onMouseDown:this.markBigTooltipViewed,onMouseEnter:this.handleHover},e),r="app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",a=y.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"}),c=f.uniqueId("app-action-open-with-menu-");return t===n.TriggerType.OpacityButton?i.React$1.createElement(n.Button,Object.assign({id:c,variant:"opacity",withDropdownIcon:!0},o,{"aria-labelledby":n.classnames(c,this.props.arialabelledby)}),a):t===n.TriggerType.CollapsedButton?i.React$1.createElement(s.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:y.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},i.React$1.createElement(n.IconButton,Object.assign({id:c,variant:"transparent",className:r,"aria-label":a,"aria-labelledby":n.classnames(c,this.props.arialabelledby)},o),i.React$1.createElement(n.UIIcon,{src:n.OpenLine}))):i.React$1.createElement(n.Button,Object.assign({id:c,className:r,variant:t&&t!==n.TriggerType.SecondaryButton?"primary":"opacity","aria-label":a,"aria-labelledby":n.classnames(c,this.props.arialabelledby)},o),i.React$1.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},i.React$1.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},`${a} ▾`)))},this.renderMenu=()=>i.React$1.createElement(n.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:this.handleSelectAction,onToggle:this.onPopoverToggle,isPortaled:!0},(({getContentProps:e,getTriggerProps:t})=>i.React$1.createElement(i.React$1.Fragment,null,this.renderTrigger(t({onClick:this.handleButtonClick})),i.React$1.createElement(n.Menu.Content,Object.assign({},e({}),{onClick:this.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),i.React$1.createElement(M,{user:this.props.user,file:this.props.file,arialabelledby:this.props.arialabelledby,unityInfo:this.props.unityInfo,extraOptions:this.props.extraOptions,currentSession:this.currentSession,telemetryContext:this.props.telemetryContext}))))),this.onPopoverToggle=({isOpen:e})=>{e&&this.props.onDropdownOpen?this.props.onDropdownOpen():!e&&this.props.onDropdownClose&&this.props.onDropdownClose(),this.currentSession&&this.currentSession.event(e?"open_popover":"close_popover")},this.onDownloadClick=e=>t=>{t.preventDefault(),t.stopPropagation(),e.handler(),this.logToPreviews(e,!0)},this.state={},this.telemetryClient=m.createTelemetryClient({component:"menu_v2"})}componentDidMount(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}render(){const{file:e,appActions:t,featureFlags:s,telemetryContext:c,triggerType:l,showAsButtonIfDownloadOnly:p,unityInfo:u,extraOptions:d,user:h,cloudDocsInfo:g}=this.props;if(!e.file_id)return null;c?this.currentSession=this.telemetryClient.session({surface:c.surface,ext:m.getPiiSafeExtension(a.getFileExt(e)||""),feature_flags:s}):delete this.currentSession;const A=m.getOpenOptionsForFile({file:e,unityInfo:u,extraOptions:d,user:h,isCloudEditorDisabled:!0,cloudDocsInfo:g,surface:null==c?void 0:c.surface}),_=l===n.TriggerType.CollapsedButton;let E=A.length>0,w=!1;if(E&&1===A.length&&(w=A[0].type===a.OpenButtonAction.DOWNLOAD,E=!w),!E&&(0===t.length||r.isSharedFile(e)&&0===a.partitionActions(t).cloudEditors.length)){if(p&&w){const e={className:n.classnames("app-actions-download-button",{"app-actions-download-button--collapsed":_}),onClick:this.onDownloadClick(A[0])},t=f.uniqueId("app-actions-download-button-");return _?i.React$1.createElement(n.IconButton,Object.assign({id:t,variant:"transparent","aria-labelledby":n.classnames(t,this.props.arialabelledby)},e),i.React$1.createElement(n.UIIcon,{name:"download-file",src:o.DownloadLine,"aria-label":y.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})})):i.React$1.createElement(n.Button,Object.assign({id:t,variant:"opacity","aria-labelledby":n.classnames(t,this.props.arialabelledby)},e),y.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()}}v.displayName="ExtensionsMenuV2Component";const $={updateLinkState:(e,t)=>n.updateLinkState({actionId:e,linkState:t})},T=n.connect(((e,t)=>({appActions:a.getOpenActionsForFile(e,t.file),bylines:a.getBylines(e),categoryInfos:a.getCategoryInfos(e),featureFlags:a.getFeatureFlags(e),cloudDocsInfo:a.getCloudDocInfo(e)})),$),S=T((e=>r.isBrowseFile(e.file)?i.React$1.createElement(x,{file:e.file,user:e.user,render:t=>i.React$1.createElement(v,Object.assign({},e,{unityInfo:t}))}):i.React$1.createElement(v,Object.assign({},e)))),B=n.requireCssWithComponent(S,["/static/metaserver/static/css/app_actions/index-vflXUc6ye.css","/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css"]),k=e=>{const{file:t,user:n,telemetryContext:o,appActions:s,bylines:c,categoryInfos:l,featureFlags:p,updateLinkState:u,unityInfo:d,extraOptions:h,cloudDocsInfo:g,isInActionBar:y,previewActionHandler:f,openDesktopActionHandler:A,goToFolderActionHandler:_,replayActionHandler:E,openInNewTabActionHandler:w,onExtensionClick:O}=e,C=m.getCategoryIdToInfos(l),R=m.getOpenOptionsForFile({file:t,unityInfo:d,extraOptions:h,user:n,isCloudEditorDisabled:!0,cloudDocsInfo:g,surface:null==o?void 0:o.surface,isInActionBar:y,previewActionHandler:f,openDesktopActionHandler:A,goToFolderActionHandler:_,replayActionHandler:E,openInNewTabActionHandler:w}),x=o&&(e.currentSession||m.createTelemetryClient({component:"menu_v2"}).session({surface:o.surface,ext:m.getPiiSafeExtension(a.getFileExt(t)||""),feature_flags:p}));if(r.isBrowseFile(t)&&(s.length>0||R.length>0))return i.React$1.createElement(b,{file:t,user:n,openOptions:R,appActions:s,bylines:c,categoryIdToInfos:C,featureFlags:p,updateLinkState:u,telemetryContext:o,currentSession:x,isInActionBar:y,onExtensionClick:O});if(r.isSharedFile(t)){const{cloudEditors:e}=a.partitionActions(s);return i.React$1.createElement(I,{openOptions:R,cloudEditorAppActions:e,file:t,user:n,currentSession:x,isInActionBar:y})}return null};k.displayName="ExtensionsPopoverContentController";const M=T(k);e.ExtensionsMenuV2=B,e.ExtensionsPopoverContent=M,e.WithUnity=x}));
//# sourceMappingURL=c_extensions_extensions_menu_component_v2.js-vfld5vZsA.map
