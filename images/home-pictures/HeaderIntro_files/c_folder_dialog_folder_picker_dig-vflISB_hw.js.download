define(["require","exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_table_columns_file_name_column","./c_controls_index","./c_spectrum_icon_arrow_index","./c_keymaster","./c_browse_interface","./c_core_i18n","./e_core_exception","./c_breadcrumb_index","./c_core_exception_info"],(function(e,t,s,a,r,o,i,l,c,n,d,u,h,p){"use strict";const _=a.react.exports.memo((e=>{var{path:t,size:o,user:i,useFullPath:l,isForCurrentPath:c,setUrl:n}=e,d=s.__rest(e,["path","size","user","useFullPath","isForCurrentPath","setUrl"]);const u=r.normalize(t),p=r.Viewer.get_root_name(i),_=r.parent_dirs(u).reverse();return _.unshift(""),l&&""!==u&&_.push(u),a.react.exports.createElement(h.Breadcrumb,Object.assign({size:o,isRootOverflow:!0},d),_.map(((e,t)=>{const s=c&&t===_.length-1,o=s?void 0:r.browse_uri_for_fq_path(i,e).toString(),l=s?void 0:function(e,t){return s=>{0===s.button&&(s.altKey||s.ctrlKey||s.metaKey||s.shiftKey)||(s.preventDefault(),t(e))}}(e,n);return a.react.exports.createElement(h.Breadcrumb.Link,{key:r.filename(e,p),href:o,isCurrentPath:s,onClick:l,className:"file-breadcrumb-link"},r.getDisplayedFilename(r.filename(e,p)))})))}));_.displayName="FileBreadcrumb";const S=r.Loadable({loader:()=>s.__awaiter(void 0,void 0,void 0,(function*(){const{BoxEmptySpot:t}=yield new Promise((function(t,s){e(["./c_dig-illustrations_spot_box-empty"],t,s)}));return t}))}),m=r.Loadable({loader:()=>s.__awaiter(void 0,void 0,void 0,(function*(){const{TargetMissSpot:t}=yield new Promise((function(t,s){e(["./c_dig-illustrations_spot_target-miss"],t,s)}));return t}))}),E=r.requireCssWithComponent(S,["/static/metaserver/static/css/dig-illustrations/index.web-vflzrHQEU.css"]),g=r.requireCssWithComponent(m,["/static/metaserver/static/css/dig-illustrations/index.web-vflzrHQEU.css"]);class f{constructor(){this.getAccessLevel=e=>e.icon.endsWith(r.ACCESS_LEVEL$1.NO_ACCESS)||r.BACKUP_ICONS.includes(e.icon)?r.ACCESS_LEVEL$1.NO_ACCESS:e.icon.endsWith(r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT)?r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT:e.icon.endsWith(r.ACCESS_LEVEL$1.LIMITED_ACCESS)||e.read_only?r.ACCESS_LEVEL$1.LIMITED_ACCESS:r.ACCESS_LEVEL$1.ACCESS,this.convertJsonFolderToFolder=e=>{const{path:t,icon:s,has_subdirs:a,contained_ns:o}=e,i=this.getAccessLevel(e);return{path:t,isReadOnly:e.read_only,icon:s,hasSubfolders:a,isSelectable:i===r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT||i===r.ACCESS_LEVEL$1.ACCESS||i===r.ACCESS_LEVEL$1.LIMITED_ACCESS&&this.canSelectReadonly,isClickable:i===r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT||i===r.ACCESS_LEVEL$1.ACCESS||i===r.ACCESS_LEVEL$1.LIMITED_ACCESS&&(this.canSelectReadonly||a),nsId:o,isLockedVaultFolder:i===r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT&&e.read_only}},this.cachedFolders=new Map}setProps(e,t,s,a){this.apiClient=e,this.user=t,this.canSelectReadonly=s,this.onDataLoaded=a}fetchFolderData(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this.apiClient.getFolderContents(this.user.id,e);if(this.onDataLoaded&&this.onDataLoaded(e),!t)return[];const s=t.map(this.convertJsonFolderToFolder),a=this.user.cdm_tmf_path&&r.paths_are_equal(e,"/")?[...s.filter((e=>r.paths_are_equal(e.path,this.user.cdm_tmf_path))),...s.filter((e=>!r.paths_are_equal(e.path,this.user.cdm_tmf_path)))]:s;return this.cachedFolders.set(r.normalize(e).toLowerCase(),a),a}))}fetchInstantFolderContents(e){const t=r.normalize(e);return this.cachedFolders.get(t.toLowerCase())}fetchFolderContents(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=r.normalize(e);return this.fetchInstantFolderContents(e)||this.fetchFolderData(t)}))}}const C=o.createManagedTable(o.useFlexLayout,o.useKeyboarding);const F=({size:e})=>{const t=d.intl.formatMessage({id:"BAyazl",defaultMessage:"This is the only folder there is."});return a.React$1.createElement(d.Provider,{value:d.intl},a.React$1.createElement("div",{className:r.classnames("folder-picker__empty-message","u-font-center",{"u-pad-top-xl":"small"!==e})},a.React$1.createElement(E,null),"small"===e?a.React$1.createElement("span",null,t):a.React$1.createElement("h2",{className:"u-pad-top-l"},t)))};F.displayName="EmptyMessage";const v=()=>a.React$1.createElement("div",{className:"folder-picker__error"},a.React$1.createElement(g,null),a.React$1.createElement("span",null,d.intl.formatMessage({id:"UIh+KT",defaultMessage:"Something went wrong on our end.  Please reload and try again."}))),y=()=>{const e=d.intl.formatMessage({id:"G09nql",defaultMessage:"Loading your foldersâ€¦"});return a.React$1.createElement(d.Provider,{value:d.intl},a.React$1.createElement("div",{className:"folder-picker-dig-loading "},a.React$1.createElement(r.Spinner,{"aria-valuetext":e,size:"xsmall"}),a.React$1.createElement("span",{className:"folder-picker-dig-loading-label"},e)))};class b{constructor(){this.appendReactableData=e=>{const t=[];return e.forEach(((e,s)=>{t.push(Object.assign(Object.assign({},e),{title:r.Emstring.em_snippet(r.filename(e.path),r.MAX_FOLDER_NAME_LENGTH),uniqueKey:""+e.nsId,isFolder:!0,isShared:!1,extension:"",path:e.path,index:s,isSelected:!1}))})),t},this.getDisplayableFolderList=e=>s.__awaiter(this,void 0,void 0,(function*(){const t=yield $.fetchFolderContents(e);return this.appendReactableData(t)})),this.getInstantDisplayableFolderList=e=>{const t=$.fetchInstantFolderContents(e);if(t)return this.appendReactableData(t)},this.getSingleCachedFolder=e=>{const t=this.getInstantDisplayableFolderList(r.parent_dir(e));let s=null;return null==t||t.some((t=>!!r.paths_are_equal(t.path,e)&&(s=t,!0))),s},this.getSingleFolder=e=>s.__awaiter(this,void 0,void 0,(function*(){let t=this.getInstantDisplayableFolderList(r.parent_dir(e));t||(t=yield this.getDisplayableFolderList(r.parent_dir(e)));let s=null;return null==t||t.some((t=>!!r.paths_are_equal(t.path,e)&&(s=t,!0))),s}))}}class L{constructor(){this.selectedIndex=0,this.prevKeyScope="",this.claimFocusAfterNavigate=!1,this.keysActive=!1,this.updateFolderData=e=>{this.folderData=e},this.handleChoice=()=>{if(!this.folderData[this.selectedIndex].isClickable)return;this.claimFocusAfterNavigate=!0;const e=this.folderData[this.selectedIndex];this.handleFolderChoice(e)},this.setupKeyboardShortcuts=()=>{this.changedFocusedFolder(),this.keysActive||(this.keysActive=!0,this.prevKeyScope=c.key.getScope(),this.prevKeyScope!==r.KEY_SCOPE&&c.key.setScope(r.KEY_SCOPE),c.key("up",r.KEY_SCOPE,(()=>{this.selectedIndex=this.selectedIndex-1,this.changedFocusedFolder()})),c.key("down",r.KEY_SCOPE,(()=>{this.selectedIndex=this.selectedIndex+1,this.changedFocusedFolder()})),c.key("left",r.KEY_SCOPE,(()=>{this.claimFocusAfterNavigate=!0,this.changedFocusedFolder(),this.goToParent()})),c.key("right",r.KEY_SCOPE,this.handleChoice),c.key("space",r.KEY_SCOPE,this.handleChoice),c.key("enter",r.KEY_SCOPE,(()=>{this.changedFocusedFolder(),this.handleChoice(),void 0!==this.onSuccess&&this.onSuccess()})))},this.cleanupKeyboardShortcuts=()=>{this.keysActive=!1,c.key.clearScope(r.KEY_SCOPE),this.prevKeyScope&&c.key.setScope(this.prevKeyScope),c.key.resetFilter()},this.setFocus=()=>{if(!this.claimFocusAfterNavigate)return;const e=document.querySelector(".folder-picker-container table tr");e&&(e.setAttribute("tabindex","-1"),e.focus()),this.claimFocusAfterNavigate=!1}}}const k=(e,t,s)=>{let a,r,o,i=!1;const{onFolderSelected:l,user:c,canSelectReadonly:n}=t;let d;e&&"/"!==e.path?(d=e.path,a=e.isLockedVaultFolder,r=e.nsId,i=e.isSelectable,o=e.isReadOnly):(d="",o="view"===c.user_root_permissions,i=!c.is_cdm_member||!o||n,r=c.root_ns_id),i||t.forceFolderSelectedCallback?l(d,r,s,a,o):l(void 0,void 0)},R=()=>{const e=d.intl.formatMessage({id:"oDXE4c",defaultMessage:"Based on previous activity and file type"});return a.React$1.createElement(r.Tooltip,{title:e},a.React$1.createElement(r.IconButton,{variant:"transparent"},a.React$1.createElement(r.UIIcon,{src:r.HelpLine,className:"icon-help","aria-label":e})))};R.displayName="SuggestionHeaderTooltip";const x=()=>{const e=d.intl.formatMessage({id:"qdhuuB",defaultMessage:"Suggested location"});return a.React$1.createElement("span",null,e,a.React$1.createElement(R,null))};x.displayName="SuggestionHeaderText";const A=e=>{const t=r.parent_dir(e.path),s=r.paths_are_equal(t,"/")?e.rootName:t.slice(1),o=d.intl.formatMessage({id:"R7F8Tb",defaultMessage:"in {location}"},{location:s});return a.React$1.createElement("a",{href:"#",className:"suggestion_parent",onClick:t=>{t.stopPropagation(),e.handleClick()}},o)};A.displayName="FolderSuggestionLocation";class I{constructor(e,t,a){this.fetch=()=>s.__awaiter(this,void 0,void 0,(function*(){try{const e=yield this.fetchFolderSuggestion(this.user.id);this.onFetch(e)}catch(e){const t=e.raw?e.raw.responseBody:"Received error response from folder suggestion API";u.reportException({err:new Error(t),tags:["folder_suggestion"],severity:p.SEVERITY.NONCRITICAL})}})),this.fetchFolderSuggestion=e,this.user=t,this.onFetch=a}}const w=e=>{const[t,s]=a.react.exports.useState(""),i={uniqueKey:e.path,title:r.filename(e.path),isFolder:!0,icon:t};let l="",n=!1;a.react.exports.useEffect((()=>{N.getSingleFolder(e.path).then((e=>{null!==e&&s(e.icon)}))}),[e.path]);const d=a.React$1.createElement(A,{path:r.parent_dir(e.path),handleClick:e.handleLocationClick,rootName:e.rootName});let u="folder-suggestion-location";return e.selected&&(u+=" folder-suggestion-location-selected"),a.React$1.createElement("div",{className:"folder-suggestion-dig",onFocus:()=>{n||(n=!0,l=c.key.getScope(),l!==r.SUGGESTED_LOCATION_KEY_SCOPE&&c.key.setScope(r.SUGGESTED_LOCATION_KEY_SCOPE),e.handleLocationClick())},onBlur:()=>{c.key.clearScope(r.SUGGESTED_LOCATION_KEY_SCOPE),l&&c.key.setScope(l),c.key.resetFilter()}},a.React$1.createElement(x,null),a.React$1.createElement("span",{role:"button",className:u,onClick:e.handleClick},a.React$1.createElement(o.FileNameCell,{file:i,subTitle:d})))};let $,N,P,D;w.displayName="FolderSuggestionDisplay";const T=e=>{var t;const[i,c]=a.react.exports.useState(null!==(t=e.initialPath)&&void 0!==t?t:"/"),u=a.react.exports.useRef(""),[h,p]=a.react.exports.useState([]),S=a.react.exports.useRef(!1),m=e.size||"standard",{showEmptyFolders:E,onError:g,onFolderSelected:R,onRowClicked:x}=e,[A,T]=a.react.exports.useState(void 0),[M,K]=a.react.exports.useState(!1),O=a.react.exports.useMemo((()=>{return t=e.currentUserPath,[{id:"filename",Cell:({row:{original:e}})=>a.React$1.createElement(o.FileNameCell,{file:e}),accessor:e=>e.title,width:300},{id:"current_folder_token",Cell:({row:{original:{path:e}}})=>e===t?a.React$1.createElement(r.AccessoryBadge,null,d.intl.formatMessage({id:"dNc7Si",defaultMessage:"Current folder"})):null,width:void 0},{id:"drilldown_arrow",accessor:e=>e.hasSubfolders?a.React$1.createElement(l.IconArrow,{name:"right"}):"",width:void 0}];var t}),[e.currentUserPath]),V=a.react.exports.useCallback((t=>{const s={user:e.user,canSelectReadonly:e.canSelectReadonly,onFolderSelected:R,forceFolderSelectedCallback:e.forceFolderSelectedCallback};null==x||x(t.path,t.index,!1),t.hasSubfolders||E||(u.current=t.path),c(t.path),k(t,s)}),[e.user,e.canSelectReadonly,e.forceFolderSelectedCallback,R,x,E]),q=a.react.exports.useCallback(((t,a)=>s.__awaiter(void 0,void 0,void 0,(function*(){c(t),K(null!=a);const s={user:e.user,canSelectReadonly:e.canSelectReadonly,onFolderSelected:e.onFolderSelected,forceFolderSelectedCallback:e.forceFolderSelectedCallback};N.getSingleFolder(t).then((e=>{k(e,s,a)}))}))),[e.user,e.canSelectReadonly,e.onFolderSelected,e.forceFolderSelectedCallback]);a.react.exports.useMemo((()=>{$=new f,N=new b,P=new L,P.goToParent=()=>{},P.onSuccess=e.onSuccess,P.changedFocusedFolder=()=>{K(!1)}}),[e.onSuccess]),a.react.exports.useMemo((()=>{$.setProps(e.apiClient,e.user,e.canSelectReadonly,e.onDataLoaded)}),[e.apiClient,e.user,e.canSelectReadonly,e.onDataLoaded]),a.react.exports.useEffect((()=>{(()=>{const e=new Image;e.src=a.static_url("/static/metaserver/static/images/illustration_catalog/dropbox_somethings_not_working-vfl2QXPxi.png"),e.srcset=a.static_url("/static/metaserver/static/images/illustration_catalog/dropbox_somethings_not_working@2x-vflkcbmXv.png")+" 2x"})()}),[]),a.react.exports.useEffect((()=>{e.apiClient.fetchFolderSuggestion&&(D=new I(e.apiClient.fetchFolderSuggestion,e.user,(t=>{var s,a;const{path:r,prediction_id:o,suggest_id:i}=t;if(r){const t={path:r,predictionId:o};null===(a=e.onFetchFolderSuggestionSuccess)||void 0===a||a.call(e,[t],i),T(t)}else null===(s=e.onFetchFolderSuggestionSuccess)||void 0===s||s.call(e,[],i)})),D.fetch())}),[e.apiClient.fetchFolderSuggestion,e.user,e.onFetchFolderSuggestionSuccess]),a.react.exports.useEffect((()=>{P.goToParent=()=>{q(r.parent_dir(u.current))}}),[q]),a.react.exports.useEffect((()=>{P.handleFolderChoice=V}),[V]),a.react.exports.useEffect((()=>{P.onSuccess=e.onSuccess}),[e.onSuccess]),a.react.exports.useEffect((()=>{P.updateFolderData(h),P.selectedIndex=0,P.setFocus()}),[h]),a.react.exports.useEffect((()=>{const e=()=>s.__awaiter(void 0,void 0,void 0,(function*(){let e=yield N.getDisplayableFolderList(i);0!=e.length||r.paths_are_equal(i,"/")||E||(e=yield N.getDisplayableFolderList(r.parent_dir(i))),u.current=i,p(e),q(i)}));(()=>{const t=N.getInstantDisplayableFolderList(i),s=N.getSingleCachedFolder(i);if(u.current&&void 0!==t&&t.length<1&&!r.paths_are_equal(i,"/"))u.current=i;else if(!u.current||!1!==(null==s?void 0:s.hasSubfolders)||E||r.paths_are_equal(i,"/")){if(t)return u.current=i,void p(t);try{R(void 0,void 0,void 0,void 0,!0),e()}catch(e){a=e,null==g||g(a),R(),S.current=!0}var a}else u.current=i})()}),[i,g,R,E]);const U=a.react.exports.useRef(!1);e.initialPath&&!U.current&&(U.current=!0,q(e.initialPath));const B=()=>i!==u.current;let z,Y=null;if(S.current)z=a.React$1.createElement(v,null);else if(B())z=a.React$1.createElement(y,null);else if(B()||h.length>0){const t=n.get_browse_root_name(e.user);void 0!==A&&(Y=a.React$1.createElement(w,{path:A.path,handleClick:()=>{var t;null===(t=e.onFolderSuggestionClick)||void 0===t||t.call(e,A),q(A.path,A.predictionId)},handleLocationClick:()=>{var t;null===(t=e.onFolderSuggestionLocationClick)||void 0===t||t.call(e,A),q(r.parent_dir(A.path),A.predictionId)},rootName:t,selected:M})),z=a.React$1.createElement("div",{className:"folder-picker-container folder-picker-dig-container",onFocus:P.setupKeyboardShortcuts,onBlur:P.cleanupKeyboardShortcuts},a.React$1.createElement(C,{isSelectable:!0,columns:O,data:h,showHeader:!1,getPropsForRow:e=>({disabled:!e.isClickable,onClick:()=>{V(e)},filename:e.title,className:e.isClickable?"":"not-clickable"})}))}else z=a.React$1.createElement(F,{size:m});return a.React$1.createElement(d.Provider,{value:d.intl},Y,a.React$1.createElement("div",{className:"folder-picker-dig__breadcrumbs"},a.React$1.createElement("h1",{className:"ax-visually-hidden"},r.filename(u.current)),a.React$1.createElement(_,{useFullPath:!0,isForCurrentPath:!0,user:e.user,setUrl:t=>{var s;null===(s=e.onBreadcrumbClicked)||void 0===s||s.call(e,t),q(t)},path:u.current,size:"small"})),z)};T.displayName="FolderPickerTableNoCss";const M=r.requireCssWithComponent(T,["/static/metaserver/static/css/browse/browse-vflAysPUB.css","/static/metaserver/static/css/react/folder_picker-vflhBHl9O.css","/static/metaserver/static/css/scooter/scooter-scoped-vfl0EaHDR.css","/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css","/static/typescript/component_libraries/dig-experimental/src/index.web-vfl_m6TBk.css"]);t.FileBreadcrumb=_,t.FolderPicker=M}));
//# sourceMappingURL=c_folder_dialog_folder_picker_dig.js-vflxwD28U.map
