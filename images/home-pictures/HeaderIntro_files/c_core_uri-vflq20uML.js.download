define(["exports"],(function(e){"use strict";const t={DEBUG:!1,IDLE_TIMEOUT:200,NETWORK_TIMEOUT:6e4};class i{static format(...e){return["[ttvc]",...e,"::",performance.now()]}static debug(...e){t.DEBUG&&console.debug(...this.format(...e))}static info(...e){t.DEBUG&&console.info(...this.format(...e))}static warn(...e){t.DEBUG&&console.warn(...this.format(...e))}}class s{constructor(){this.pendingRequests=0,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{i.debug("AjaxIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{if(0===t.NETWORK_TIMEOUT)return;this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{i.warn("AjaxIdleObservable","::","Timed out waiting for requests to resolve.","Make sure that incrementAjaxCount() is always matched with decrementAjaxCount().","::","pendingRequests =",this.pendingRequests),this.didNetworkTimeOut=!0,this.pendingRequests=0,this.next("IDLE")}),t.NETWORK_TIMEOUT)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.increment=()=>{this.startCleanupTimeout(),0===this.pendingRequests&&this.next("BUSY"),this.pendingRequests+=1},this.decrement=()=>{this.abortCleanupTimeout(),1===this.pendingRequests?this.next("IDLE"):this.startCleanupTimeout(),this.pendingRequests=Math.max(this.pendingRequests-1,0),this.pendingRequests<10&&i.debug("AjaxIdleObservable.decrement()","::","pendingRequests =",this.pendingRequests)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}}}}class n{constructor(){this.pendingResources=new Set,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{i.debug("ResourceLoadingIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{if(0===t.NETWORK_TIMEOUT)return;this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{i.warn("ResourceLoadingIdleObservable","::","Timed out waiting for resources to resolve.","Consider filing a bug report if this continues to occur.","::","pendingResources =",this.pendingResources),this.didNetworkTimeOut=!0,this.pendingResources=new Set,this.next("IDLE")}),t.NETWORK_TIMEOUT)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.add=e=>{e instanceof HTMLImageElement&&!e.src||e instanceof HTMLImageElement&&e.complete||e instanceof HTMLLinkElement&&!e.href||e instanceof HTMLScriptElement&&!e.src||e instanceof HTMLIFrameElement&&!e.src||(this.startCleanupTimeout(),0===this.pendingResources.size&&this.next("BUSY"),this.pendingResources.add(e))},this.remove=e=>{this.abortCleanupTimeout(),this.pendingResources.delete(e),0===this.pendingResources.size?this.next("IDLE"):this.startCleanupTimeout(),this.pendingResources.size<10&&i.debug("ResourceLoadingIdleObservable.remove()","::","pendingResources =",this.pendingResources)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},(null===window||void 0===window?void 0:window.MutationObserver)&&window.addEventListener("load",(()=>{new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e instanceof HTMLScriptElement||e instanceof HTMLLinkElement||e instanceof HTMLImageElement||e instanceof HTMLIFrameElement?this.add(e):e.hasChildNodes()&&e instanceof HTMLElement&&e.querySelectorAll("img").forEach(this.add)}))}))})).observe(window.document.documentElement,{childList:!0,subtree:!0}),["load","error"].forEach((e=>{window.document.addEventListener(e,(e=>{(e.target instanceof HTMLScriptElement||e.target instanceof HTMLLinkElement||e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&this.remove(e.target)}),{capture:!0})}))}))}}class r{constructor(){this.ajaxIdleObservable=new s,this.resourceLoadingIdleObservable=new n,this.subscribers=new Set,this.ajaxIdle=!0,this.scriptLoadingIdle=!0,this.handleUpdate=e=>t=>{const i=this.ajaxIdle&&this.scriptLoadingIdle;"AJAX"===e&&(this.ajaxIdle="IDLE"===t),"RESOURCE_LOADING"===e&&(this.scriptLoadingIdle="IDLE"===t);const s=this.ajaxIdle&&this.scriptLoadingIdle;i!==s&&this.next(s?"IDLE":"BUSY")},this.next=e=>{i.debug("NetworkIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.incrementAjaxCount=()=>this.ajaxIdleObservable.increment(),this.decrementAjaxCount=()=>this.ajaxIdleObservable.decrement(),this.isIdle=()=>this.ajaxIdle&&this.scriptLoadingIdle,this.didNetworkTimeOut=()=>this.ajaxIdleObservable.didNetworkTimeOut||this.resourceLoadingIdleObservable.didNetworkTimeOut,this.resetDidNetworkTimeOut=()=>{this.ajaxIdleObservable.didNetworkTimeOut=!1,this.resourceLoadingIdleObservable.didNetworkTimeOut=!1},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},this.ajaxIdleObservable.subscribe(this.handleUpdate("AJAX")),this.resourceLoadingIdleObservable.subscribe(this.handleUpdate("RESOURCE_LOADING"))}}let a;const o=()=>(a||(a=new r),a);class d{constructor(e){this.mutationObserverConfig={attributeFilter:["hidden","style","src"],attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0},this.mutations=new Map,this.mutationObserverCallback=e=>{i.debug("InViewportMutationObserver.mutationObserverCallback()","::","mutations =",e),e.forEach((e=>{e.timestamp=performance.now();let t=null;if(e.target instanceof Element&&(t=e.target),e.target instanceof Text&&(t=e.target.parentElement),t)if("childList"===e.type)e.addedNodes.forEach((t=>{t instanceof HTMLElement&&(this.intersectionObserver.observe(t),this.mutations.set(t,e)),t instanceof Text&&null!=t.parentElement&&(this.intersectionObserver.observe(t.parentElement),this.mutations.set(t.parentElement,e))}));else this.intersectionObserver.observe(t),this.mutations.set(t,e)}))},this.intersectionObserverCallback=e=>{i.debug("InViewportMutationObserver.intersectionObserverCallback()","::","entries =",e),e.forEach((e=>{const t=this.mutations.get(e.target);e.isIntersecting&&null!=t&&(i.info("InViewportMutationObserver.callback()","::","mutation =",t),this.callback(t)),this.mutations.delete(e.target),this.intersectionObserver.unobserve(e.target)}))},this.callback=e,this.mutationObserver=new MutationObserver(this.mutationObserverCallback),this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(e){i.info("InViewportMutationObserver.observe()","::","target =",e),this.mutationObserver.observe(e,this.mutationObserverConfig)}disconnect(){i.info("InViewportMutationObserver.disconnect()"),this.mutationObserver.disconnect(),this.intersectionObserver.disconnect()}}function c(e){const s=o();let n,r=s.isIdle();const a=e=>{r="IDLE"===e,r?(e=>{var t;(null!==(t=window.requestIdleCallback)&&void 0!==t?t:window.setTimeout)((()=>{window.requestAnimationFrame((()=>window.requestAnimationFrame(e)))}))})(d):(window.clearTimeout(n),n=void 0)},d=()=>{i.debug("requestAllIdleCallback.handleCpuIdle()"),r&&!n&&c()},c=()=>{n=window.setTimeout((()=>{const t=s.didNetworkTimeOut();s.resetDidNetworkTimeOut(),i.info("requestAllIdleCallback: ALL IDLE"),e(t),u()}),t.IDLE_TIMEOUT)},u=s.subscribe(a);r&&a("IDLE")}class u{constructor(e){this.imageLoadTimes=new Map,this.lastImageLoadTimestamp=0,this.intersectionObserverCallback=e=>{e.forEach((e=>{const t=e.target,s=this.imageLoadTimes.get(t);e.isIntersecting&&null!=s&&(i.info("InViewportImageObserver.callback()","::","timestamp =",s),this.callback(s,t)),this.intersectionObserver.unobserve(t),this.imageLoadTimes.delete(t)}))},this.handleLoadOrErrorEvent=e=>{(e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&(i.debug("InViewportImageObserver.handleLoadOrErrorEvent()","::","event =",e),this.imageLoadTimes.set(e.target,e.timeStamp),this.intersectionObserver.observe(e.target))},this.callback=e,this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(){i.info("InViewportImageObserver.observe()"),document.addEventListener("load",this.handleLoadOrErrorEvent,{capture:!0}),document.addEventListener("error",this.handleLoadOrErrorEvent,{capture:!0})}disconnect(){i.info("InViewportImageObserver.disconnect()"),this.lastImageLoadTimestamp=0,this.imageLoadTimes.clear(),this.intersectionObserver.disconnect(),document.removeEventListener("load",this.handleLoadOrErrorEvent),document.removeEventListener("error",this.handleLoadOrErrorEvent)}}class h{constructor(){if(this.debug=!1,this.idleTimeout=200,this.lastImageLoadTimestamp=-1,this.subscribers=new Set,this.navigationCount=0,this.onTTVC=e=>(this.subscribers.add(e),()=>this.subscribers.delete(e)),!h.isSupportedEnvironment())throw new Error("VisuallyCompleteCalculator: This browser/runtime is not supported.");this.inViewportMutationObserver=new d((e=>{var t,i,s;(null!==(t=e.timestamp)&&void 0!==t?t:0)>=(null!==(s=null===(i=this.lastMutation)||void 0===i?void 0:i.timestamp)&&void 0!==s?s:0)&&(this.lastMutation=e)})),this.inViewportImageObserver=new u(((e,t)=>{e>=this.lastImageLoadTimestamp&&(this.lastImageLoadTimestamp=e,this.lastImageLoadTarget=t)}))}static isSupportedEnvironment(){var e;return void 0!==window&&"MutationObserver"in window&&"IntersectionObserver"in window&&"function"==typeof document.querySelectorAll&&(null===(e=window.performance)||void 0===e?void 0:e.timing)}cancel(){i.info("VisuallyCompleteCalculator.cancel()","::","index =",this.activeMeasurementIndex),this.activeMeasurementIndex=void 0}async start(e=0,t=!1){var s,n,r,a;const o=this.navigationCount+=1;this.activeMeasurementIndex=o,i.info("VisuallyCompleteCalculator.start()","::","index =",o);const d=()=>{this.activeMeasurementIndex===o&&(this.activeMeasurementIndex=void 0)};this.inViewportImageObserver.observe(),this.inViewportMutationObserver.observe(document.documentElement),window.addEventListener("pagehide",d),window.addEventListener("visibilitychange",d),window.setTimeout((()=>{window.addEventListener("click",d),window.addEventListener("keydown",d)}),0),await("complete"===document.readyState?Promise.resolve():new Promise((e=>{const t=()=>{e(),window.removeEventListener("load",t)};window.addEventListener("load",t)})));const u=await new Promise(c);if(o===this.activeMeasurementIndex){const i=Math.max(e,this.lastImageLoadTimestamp,null!==(n=null===(s=this.lastMutation)||void 0===s?void 0:s.timestamp)&&void 0!==n?n:0),o=performance.getEntriesByType("navigation"),d=t?"back_forward":0!==e?"script":o[o.length-1].type;this.next({start:e,end:i,duration:i-e,detail:{navigationType:d,didNetworkTimeOut:u,lastVisibleChange:this.lastImageLoadTimestamp>(null!==(a=null===(r=this.lastMutation)||void 0===r?void 0:r.timestamp)&&void 0!==a?a:0)?this.lastImageLoadTarget:this.lastMutation}})}else i.debug("VisuallyCompleteCalculator: Measurement discarded","::","index =",o);window.removeEventListener("pagehide",d),window.removeEventListener("visibilitychange",d),window.removeEventListener("click",d),window.removeEventListener("keydown",d),o===this.navigationCount&&(this.inViewportImageObserver.disconnect(),this.inViewportMutationObserver.disconnect())}next(e){var t,s;e.end>Number.MAX_SAFE_INTEGER?i.warn("VisuallyCompleteCalculator.next()","::","This browser reported a time larger than MAX_SAFE_INTEGER. We are ignoring it.","::",e):(i.debug("VisuallyCompleteCalculator.next()","::","lastImageLoadTimestamp =",this.lastImageLoadTimestamp,"lastMutationTimestamp =",null!==(s=null===(t=this.lastMutation)||void 0===t?void 0:t.timestamp)&&void 0!==s?s:0,"::","index =",this.activeMeasurementIndex),i.info("TTVC:",e,"::","index =",this.activeMeasurementIndex),this.subscribers.forEach((t=>t(e))))}}let l;let m;const b=o().incrementAjaxCount,v=o().decrementAjaxCount;function g(e,t,i={}){if(e)return;const s=new Error(`Assertion Error: ${t}`),{tags:n=[],exc_extra:r=null}=i;throw s.assertOptions={tags:n.concat("module:exception","assert"),exc_extra:r},s.isAssertion=!0,s}const p=/^(?:([^:\/\\?#]+):)?(?:[\/\\]{2}([^\/\\?#]*))?([^?#]*)(?:\?([^#]*))?(?:[#](.*))?$/,w=/^[a-zA-Z][a-zA-Z0-9+.\-]*$/;class T{constructor(e={}){this.dict={},this.add(e)}static parseString(e){if(!e)return{};const t={};return e.split("&").forEach((e=>{if(""!==e){const i=e.split("="),s=T.decode(i[0]),n=T.decode(i.slice(1).join("="));if(t.hasOwnProperty(s)){const e=t[s];let i;i="string"==typeof e?[e]:void 0===e?[]:e,i.push(n),t[s]=i}else t[s]=n}})),t}add(e,t){if("string"==typeof e)t&&(Array.isArray(t)?this.dict[e]=t.map(String):this.dict[e]=String(t));else for(const t in e)if(e.hasOwnProperty(t)){const i=e[t];null!=i&&(Array.isArray(i)?this.dict[t]=i.map(String):this.dict[t]=String(i))}return this}remove(e){return delete this.dict[e],this}replace(e){return this.dict=e,this}toString(){const e=[],t=Object.keys(this.dict).sort();for(const i of t)if(this.dict.hasOwnProperty(i)){const t=this.dict[i];Array.isArray(t)?t.forEach((t=>{e.push(T.encode(i)+"="+T.encode(t))})):e.push(T.encode(i)+"="+T.encode(t))}return e.length?e.join("&"):""}static decode(e){return null==e?"":E.decode(e.replace(/\+/g,"%20"))}static encode(e){return null==e?"":E.encode(e).replace(/%20/g,"+")}}class E{constructor(e={}){this.query=new T,this.initFromObject(e)}initFromObject(e){this.setScheme(e.scheme),this.authority=e.authority||"",this.path=e.path||"",this.setQuery(e.query),this.fragment=e.fragment||""}getScheme(){return this.scheme}getAuthority(){return this.authority}getPath(){return this.path}getQuery(){return this.query.dict}getFragment(){return this.fragment}setScheme(e=""){return g(!e||Boolean(e.match(w)),"Invalid scheme",{exc_extra:{scheme_param:e}}),this.scheme=e,this}setAuthority(e=""){return this.authority=e,this}setPath(e=""){return this.path=e,this}setQuery(e={}){return this.query=new T(e),this}setFragment(e=""){return this.fragment=e,this}updateQuery(e,t){return this.query.add(e,t),this}removeQuery(e){return this.query.remove(e),this}clone(){return new E(this.toObject())}toObject(){return{scheme:this.getScheme(),authority:this.getAuthority(),path:this.getPath(),query:this.getQuery(),fragment:this.getFragment()}}toString(){let e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+E.encode(this.authority,":@[]")),e+this.toRelativeUri()}toRelativeUri(){let e="";this.path&&(g(!this.authority||!this.path.length||"/"===this.path[0],'Path must start with a "/" if URI is not relative'),e+=E.encode(this.path,"/"));const t=this.query.toString();return t&&(e+="?"+t),this.fragment&&(e+="#"+E.encode(this.fragment,":@[]/&=+?#!")),e}static parse(e){const t=String(e).match(p)||[],[,i,s,n,r,a]=t,o=new E;return o.setScheme(i),o.setAuthority(E.decode(s)),o.setPath(E.decode(n)),o.setQuery(T.parseString(r)),o.setFragment(E.decode(a)),o}static decode(e){return e?decodeURIComponent(e):""}static encode(e,t=""){if(!e)return"";e=encodeURIComponent(e),t+="~";for(const i of t){const t=encodeURIComponent(i);e=e.replace(new RegExp(t,"g"),i)}return e}static encode_parts(e,t="/"){return e.split(t).map((e=>E.encode(e))).join(t)}}E.Query=T,e.QueryComponent=T,e.URI=E,e.assert=g,e.cancel=()=>null==m?void 0:m.cancel(),e.decrementAjaxCount=v,e.incrementAjaxCount=b,e.init=e=>{(e=>{(null==e?void 0:e.debug)&&(t.DEBUG=e.debug),(null==e?void 0:e.idleTimeout)&&(t.IDLE_TIMEOUT=e.idleTimeout),(null==e?void 0:e.networkTimeout)&&(t.NETWORK_TIMEOUT=e.networkTimeout)})(e),i.info("init()"),l||(l=new h),m=l,m.start(),window.addEventListener("locationchange",(e=>{m.start(e.timeStamp)})),window.addEventListener("pageshow",(e=>{e.persisted&&m.start(e.timeStamp,!0)}))},e.onTTVC=e=>null==m?void 0:m.onTTVC(e),e.start=()=>null==m?void 0:m.start(performance.now())}));
//# sourceMappingURL=c_core_uri.js-vflr7OLXT.map
