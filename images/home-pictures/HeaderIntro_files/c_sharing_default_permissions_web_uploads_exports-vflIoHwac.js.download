define(["require","exports","./c_src_sink_index","./c_tslib","./e_ui_page_files_router","./c_file_uploader_utils","./c_core_uri","./c_core_i18n","./c_api_v2_noauth_client"],(function(e,t,s,a,E,i,r,o,l){"use strict";var d,n;t.PermissionsAtUploadAmpMetrics=void 0,(d=t.PermissionsAtUploadAmpMetrics||(t.PermissionsAtUploadAmpMetrics={})).PAU_FILE_UPLOAD_PROCESSED="pau_file_upload_processed",d.PAU_SHARED_FOLDER_CREATE="pau_shared_folder_create",d.PAU_MODAL_DISPLAY="pau_modal_display",d.PAU_FOLDER_ENQUEUED_ON_UPLOAD_INIT="pau_folder_enqueued_on_upload_init",t.PermissionsAtUploadModalTypes=void 0,(n=t.PermissionsAtUploadModalTypes||(t.PermissionsAtUploadModalTypes={})).SINGLE="single",n.MULTI="multi";const _=new class{constructor(){this.log=(e,t={})=>{const s=this.createCounter(e,t);s.increment(),s.record()},this.metricsReporter=s.getMetricsReporter$1()}createCounter(e,t={}){return this.metricsReporter.createCounter({ns:"permissions_at_upload",name:e},t)}};var A,M,c,R,f,m;!function(e){e.MEMBERS="MEMBERS",e.FILES="FILES",e.ACTIVE_TEAM_FOLDERS="ACTIVE_TEAM_FOLDERS",e.ARCHIVED_TEAM_FOLDERS="ARCHIVED_TEAM_FOLDERS",e.LOCKED_FILES="LOCKED_FILES",e.MEMBER_ACCESS="MEMBER_ACCESS"}(A||(A={})),function(e){e.d="d",e.select="select",e.stormcrow_override="stormcrow_override",e.uoa_member_selection="selected_member_email",e.uoa_source="uoa_source"}(M||(M={})),o.intl.formatMessage({id:"su9q9n",defaultMessage:"Synced"}),o.intl.formatMessage({id:"8JpgPh",defaultMessage:"Unsynced"}),o.intl.formatMessage({id:"8JpgPh",defaultMessage:"Unsynced"}),o.intl.formatMessage({id:"QqM+VH",defaultMessage:"Some synced"}),function(e){e.ARCHIVE="ARCHIVE",e.CHANGE_SYNC_DEFAULT="CHANGE_SYNC_DEFAULT",e.COPY="COPY",e.DELETE="DELETE",e.DOWNLOAD="DOWNLOAD",e.HIDE_DELETED="HIDE_DELETED",e.MOVE="MOVE",e.NEW_FOLDER="NEW_FOLDER",e.PERMANENTLY_DELETE="PERMANENTLY_DELETE",e.PERMANENTLY_DELETE_TEAM_FOLDER="PERMANENTLY_DELETE_TEAM_FOLDER",e.RENAME="RENAME",e.RENAME_TEAM_FOLDER="RENAME_TEAM_FOLDER",e.SHOW_DELETED="SHOW_DELETED",e.VERSION_HISTORY="VERSION_HISTORY",e.VIEW_ACTIVITY="VIEW_ACTIVITY"}(c||(c={})),function(e){e.ARCHIVE_IN_PROGRESS="ARCHIVE_IN_PROGRESS",e.CREATE_TEAM_FOLDER="CREATE_TEAM_FOLDER_PRIMARY",e.DELETE="DELETE_PRIMARY",e.DOWNLOAD="DOWNLOAD_PRIMARY",e.MANAGE="MANAGE_PRIMARY",e.MANAGE_TEAM_FOLDER="MANAGE_TEAM_FOLDER_PRIMARY",e.NEW_FOLDER="NEW_FOLDER_PRIMARY",e.RESTORE="RESTORE_PRIMARY",e.UNARCHIVE="UNARCHIVE_PRIMARY",e.UPLOAD="UPLOAD_PRIMARY"}(R||(R={})),function(e){e.ARCHIVE="ARCHIVE",e.ARCHIVE_IN_PROGRESS="ARCHIVE_IN_PROGRESS",e.CHANGE_SYNC_DEFAULT="CHANGE_SYNC_DEFAULT",e.COPY="COPY",e.CREATE_TEAM_FOLDER="CREATE_TEAM_FOLDER",e.DELETE="DELETE",e.DOWNLOAD="DOWNLOAD",e.HIDE_DELETED="HIDE_DELETED",e.MOVE="MOVE",e.NEW_FOLDER="NEW_FOLDER",e.PERMANENTLY_DELETE="PERMANENTLY_DELETE",e.PERMANENTLY_DELETE_TEAM_FOLDER="PERMANENTLY_DELETE_TEAM_FOLDER",e.RENAME="RENAME",e.RENAME_TEAM_FOLDER="RENAME_TEAM_FOLDER",e.SHOW_DELETED="SHOW_DELETED",e.VERSION_HISTORY="VERSION_HISTORY",e.VIEW_ACTIVITY="VIEW_ACTIVITY",e.MANAGE="MANAGE",e.MANAGE_TEAM_FOLDER="MANAGE_TEAM_FOLDER",e.RESTORE="RESTORE",e.UNARCHIVE="UNARCHIVE",e.UPLOAD="UPLOAD"}(f||(f={})),o.intl.formatMessage({id:"ds25UH",defaultMessage:"Move"}),o.intl.formatMessage({id:"r3T3xT",defaultMessage:"Copy"}),o.intl.formatMessage({id:"BGzgS/",defaultMessage:"Moving files…"}),o.intl.formatMessage({id:"3IxcSr",defaultMessage:"Copying files…"}),o.intl.formatMessage({id:"4KxEa4",defaultMessage:"Move completed."}),o.intl.formatMessage({id:"en3ri/",defaultMessage:"Copy completed."}),o.intl.formatMessage({id:"sVanPX",defaultMessage:"Moving a folder into itself isn’t allowed"}),o.intl.formatMessage({id:"kDkfmv",defaultMessage:"Copying a folder into itself isn’t allowed."}),o.intl.formatMessage({id:"xDSE4z",defaultMessage:"Can’t move 10,000+ files. Try moving subfolders individually."}),o.intl.formatMessage({id:"c2J6cp",defaultMessage:"Can’t copy 10,000+ files. Try copying subfolders individually."}),o.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}),o.intl.formatMessage({id:"aR2in8",defaultMessage:"Archive team folder?"}),o.intl.formatMessage({id:"SuGuM2",defaultMessage:"Add groups?"}),o.intl.formatMessage({id:"7nlCJP",defaultMessage:"Permanently delete team folder?"}),o.intl.formatMessage({id:"IA7/9q",defaultMessage:"Dropbox Migration Assistant"}),o.intl.formatMessage({id:"Vv9iwA",defaultMessage:"Create"}),o.intl.formatMessage({id:"Vv9iwA",defaultMessage:"Create"}),o.intl.formatMessage({id:"d9BujG",defaultMessage:"Rename"}),o.intl.formatMessage({id:"ty8OUw",defaultMessage:"Archive"}),o.intl.formatMessage({id:"SfW7kw",defaultMessage:"Add groups"}),o.intl.formatMessage({id:"SOpAJh",defaultMessage:"Permanently delete"}),o.intl.formatMessage({id:"DHwX9/",defaultMessage:"Cancel"}),o.intl.formatMessage({id:"DXEa3N",defaultMessage:"Not now"}),o.intl.formatMessage({id:"70fmfY",defaultMessage:"Team folder name"}),o.intl.formatMessage({id:"cAAO8x",defaultMessage:"Folder name"}),o.intl.formatMessage({id:"8fj+Bq",defaultMessage:"Starts as unsynced"}),o.intl.formatMessage({id:"s10RHv",defaultMessage:"Close"}),o.intl.formatMessage({id:"jVeAq0",defaultMessage:"Unsynced folders don’t start out on members’ computers"}),o.intl.formatMessage({id:"gH+r8I",defaultMessage:"Archiving usually takes a few minutes, but it could take up to a few hours if it’s shared with many people. Archiving can’t be canceled once started."}),o.intl.formatMessage({id:"Pd9zcR",defaultMessage:"Learn more with our deployment guide."}),function(e){e.ARCHIVE_TEAM_FOLDER="archiveTeamFolder",e.BROWSE="browse",e.COPY="copy",e.CREATE_TEAM_FOLDER="createTeamFolder",e.CREATE_FOLDER="createFolder",e.DELETE="delete",e.DOWNLOAD="download",e.LIST_TEAM_NAMESPACES="listTeamNamespaces",e.MOVE="move",e.PERMANENT_DELETE="permanentDeleteFile",e.PERMANENT_DELETE_TEAM_FOLDER="permanentDeleteTeamFolder",e.RENAME="rename",e.RENAME_TEAM_FOLDER="renameTeamFolder",e.RESTORE="restore",e.SEARCH="search",e.SHARE_FOLDER="shareFolder",e.SHARING="sharing",e.UNARCHIVE_TEAM_FOLDER="unarchiveTeamFolder",e.UPDATE_SYNC_SETTING="updateSyncSetting",e.UPLOAD="upload",e.VIEW_ACTIVITY="viewActivity",e.VIEW_VERSION_HISTORY="viewVersionHistory"}(m||(m={}));const T=(e,t)=>E.normalize(e.dest)===E.normalize(t)?E.FileTypes.FILE:E.FileTypes.FOLDER,u=(e,t)=>T(e,t)===E.FileTypes.FOLDER?i.getRootDest(e,t):D(e),D=e=>(({fqPath:e,fileName:t})=>[e,t].join("/"===e?"":"/"))({fqPath:e.dest,fileName:e.name});t.PermissionsAtUploadStats=_,t.asyncShowDefaultPermissionAtUploadIfNeeded=function(t){return a.__awaiter(this,void 0,void 0,(function*(){(yield new Promise((function(t,s){e(["./c_sharing_default_permissions_web_uploads_default_permission_at_upload_modal"],t,s)}))).displayDefaultPermissionAtUploadIfNeeded(t)}))},t.createSharedFolder=({user:e,uploadPath:t,file:s,teamAccessLevel:r,createdFolders:o,foldersWithError:d,autoTeamGroupId:n,onAttempt:_})=>a.__awaiter(void 0,void 0,void 0,(function*(){if(!r||r===i.TeamAccessLevel.INHERIT)return;if(d.some((e=>{return t=e,a=s.dest,E.paths_are_equal(t,a)||E.inSubDirectory(t,a);var t,a})))throw new Error("This file is in a folder with an upload error");const A=u(s,t),M=new E.FolderShareApiClient({userId:e.id}),c=T(s,t),R=o.includes(A),f=![i.TeamAccessLevel.WRITER,i.TeamAccessLevel.INHERIT].includes(r);if(!R&&c===E.FileTypes.FOLDER){let e;_&&_();try{const{shared_folder_id:t}=yield M.share({fqPath:A,folderPolicy:null,confidential:f});e=t}catch(t){const{error:s}=t;if(!(s&&s.bad_path&&"already_shared"===s.bad_path[".tag"]))throw t;e=s.bad_path.shared_folder_id,[i.TeamAccessLevel.READER,i.TeamAccessLevel.NO_ACCESS].includes(r)&&(yield M.setConfidentiality({contentId:e,confidential:!0})),r===i.TeamAccessLevel.NO_ACCESS&&(yield((e,t,s)=>a.__awaiter(void 0,void 0,void 0,(function*(){try{return yield e.removeMember({contentId:t,memberId:s}),!0}catch(e){if(!e||"no_permission"!==e[".tag"]&&"folder_owner"!==e[".tag"]&&"group_access"!==e[".tag"]&&"team_folder"!==e[".tag"]&&"other"!==e[".tag"])return!0;throw e}})))(M,e,n))}[i.TeamAccessLevel.READER,i.TeamAccessLevel.WRITER].includes(r)&&(yield((e,t,s,r)=>a.__awaiter(void 0,void 0,void 0,(function*(){const a=t===i.TeamAccessLevel.READER?E.ACCESS_LEVEL.READER:E.ACCESS_LEVEL.WRITER;try{yield e.updateMember({contentId:s,memberId:r,accessLevel:a})}catch(t){const{error:E}=t;if(!E||!E.member_error||"no_explicit_access"!==E.member_error[".tag"])throw t;yield e.addMembers({contentId:s,members:[new l.UnionScalar("dropbox_id",r)],accessLevel:a})}if(t===i.TeamAccessLevel.WRITER)try{yield e.relinquishMembership({contentId:s}),yield e.setConfidentiality({contentId:s,confidential:!1})}catch(e){}})))(M,r,e,n))}})),t.getFilePath=D,t.getFileUploadsInPath=(e,t)=>e.filter((e=>{const s=D(e);return E.paths_are_equal(t,s)||E.inSubDirectory(t,s)})),t.getModalFileList=(e,t,s,a,E,r)=>{var o;const l=i.getFileUploadsWithStatus(e,[i.FileStatusType.SET_PERMISSIONS]);return E&&E(l,null===(o=l[0])||void 0===o?void 0:o.batchId),l.reduce(((e,E)=>{const i=T(E,t),o=u(E,t);if(e.some((({file:e})=>e.fq_path===o))||r&&i!==r)return e;const l=s.getTeamAccessLevel(o),d=((e,t)=>{const s=e+t;let a=0;for(let e=0;e<s.length;e++)a=(a<<5)-a+s.charCodeAt(e)|0;return Math.abs(a).toString(36)})(o,a),n={batchId:E.batchId,itemId:d,teamAccessLevel:l,file:{type:i,fq_path:o,icon:""}};return[...e,n]}),[])},t.getRootPath=u}));
//# sourceMappingURL=c_sharing_default_permissions_web_uploads_exports.js-vflvbbEoa.map
