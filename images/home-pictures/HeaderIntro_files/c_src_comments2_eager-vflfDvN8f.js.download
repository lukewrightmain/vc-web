define(["require","exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_comments_data_store","./c_components_approval-forms_approval_request_modal","./c_components_approval-forms_approval_checkbox_in_share","./c_src_file_viewer_components","./c_core_types_preview_type","./c_core_logging_constants","./c_src_video_controls_audio_video_markers","./c_core_logging_video","./c_lodash-es_lodash","./c_file_viewer_sdk_file_viewer_file_viewer","./c_api_v2_redux_files","./c_ui-icon_line_comment"],(function(e,t,a,i,n,r,o,s,d,l,c,m,h,p,u,g,_){"use strict";const f=n.defineMessage({id:"IKrBL8",defaultMessage:"Highlight a section to comment on"}),v=n.defineMessage({id:"Dm5bk9",defaultMessage:"Highlight an area to comment on"}),y=n.defineMessage({id:"VYvI4T",defaultMessage:"Using the arrow keys, select an area to comment on, then hit enter."}),I=n.defineMessage({id:"gO661I",defaultMessage:"Enable continuous commenting?"}),R=n.defineMessage({id:"pCmwyu",defaultMessage:"Now, add your comment in the comments pane"}),C=n.defineMessage({id:"8UKHBA",defaultMessage:"Using the arrow keys, select a timestamp to comment on, then hit enter"}),A=n.defineMessage({id:"DeTJfa",defaultMessage:"Add your comment in the comments pane"}),b=n.defineMessage({id:"55kTfU",defaultMessage:"Cancel"}),w=n.defineMessage({id:"+Guzmf",defaultMessage:"Enable"}),T=i.react.exports.memo((({fileViewerId:e,previewType:t})=>{const a=n.useSelector((e=>e.annotationSettings.state)),o=n.useDispatch(),s=n.useIntl(),[c,m]=r.useContinuousAnnotation(),h=n.useSelector(r.isSingularlyAnnotating),p=c||"annotating"!==a?()=>{o(r.cancelAnnotating(e))}:()=>{o(r.updateAnnotationMode(r.SectionAnnotationMode.continuous)),m()};let u,g,_=s.formatMessage(b);if(t===l.PreviewType.Audio||t===l.PreviewType.Video)if("commenting"===a)u=s.formatMessage(A);else{if("annotating-ax"!==a)return null;u=s.formatMessage(C)}else if(!c&&h&&"annotating"===a)u=s.formatMessage(I),_=s.formatMessage(w),g=s.formatMessage({id:"LwqLT7",defaultMessage:"Close"});else if("annotating"===a)u=t===l.PreviewType.Image?s.formatMessage(v):s.formatMessage(f);else if("annotating-ax"===a)u=s.formatMessage(y);else{if("commenting"!==a)return null;u=s.formatMessage(R)}return i.react.exports.createElement("div",{className:d.floatingHeader},i.react.exports.createElement(n.Banner,{type:"attention",withLeftIcon:!1,onRequestClose:()=>{m()},withCloseButton:g},i.react.exports.createElement(n.Banner.Message,null,u),i.react.exports.createElement(n.Banner.Actions,null,i.react.exports.createElement(n.Button,{variant:"transparent",onClick:p},_))))}));T.displayName="AnnotationBanner",T.displayName="AnnotationBanner";function M({event:e,stream:t,thread_id:a,comment_id:i,is_third_party:n,error:o}){return r.logEventAction({arg:{event:o?{".tag":"comment_error"}:e,stream:t,thread_id:a,comment_id:i,is_third_party:n,oref:"dfv",product_surface:{".tag":"file_preview"},product_surface_context:{".tag":"file_preview"},error_message:o?o.message:void 0}})}const x=({dispatch:e})=>t=>a=>{const i=t(a);if(a.type===r.Action.AddCommentResult)e(M({event:a.payload.arg.thread_id?{".tag":"reply_to_comment"}:{".tag":"new_comment"},stream:a.payload.arg.stream,thread_id:a.payload.arg.thread_id,error:a.error}));else if(a.type===r.Action.MarkThreadReadResult)e(M({event:{".tag":"mark_thread_as_read"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.MarkThreadUnreadResult)e(M({event:{".tag":"mark_thread_as_unread"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.ResolveThreadResult)e(M({event:{".tag":"resolve_thread"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.UnresolveThreadResult)e(M({event:{".tag":"unresolve_thread"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.DeleteCommentResult)e(M({event:{".tag":"delete_comment"},stream:a.payload.arg.stream,thread_id:a.meta?a.meta.threadId:void 0,comment_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.EditCommentResult)e(M({event:{".tag":"edit_comment"},stream:a.payload.arg.stream,thread_id:a.meta?a.meta.threadId:void 0,comment_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action$1.ActivateThread){const{fileId:t,isThirdParty:i,threadId:n}=a.payload,o=r.createStreamFromFileId(t);e(M({event:{".tag":"activate_thread"},stream:o,thread_id:n,is_third_party:i}))}return i},E=({file:e,duration:t,fileViewerId:a,audioVideoMetadata:o,logVideoAction:s,showInverse:l})=>{const c=r.createCommentFileIdentifier(e.file_id,e.url),u=n.useDispatch(),g=n.useSelector((e=>e.threads[c]||{})),_=d.useStabilizedCallback((t=>{u(r.activateThread({fileId:e.file_id,fileViewerId:a,isThirdParty:t.isThirdParty,threadId:t.id}))})),f="video"===(null==o?void 0:o[".tag"])?null==o?void 0:o.thumb_scrubber_vtt_url:void 0,v=i.react.exports.useCallback(p.once((e=>{s(e?h.VideoPreviewEvent.ScrubberThumbnailsLoaded:h.VideoPreviewEvent.ScrubberThumbnailsFailed)})),[s]);return i.React$1.createElement(m.AudioVideoMarkersComponent,{threads:g,vttUrl:f,onScrubberThumbnailsLoaded:v,duration:t,openThreadInRightRail:_,showInverse:l})};E.displayName="CommentMarkersComponent";const $=e=>{var{container:t}=e,n=a.__rest(e,["container"]);return i.reactDom.exports.createPortal(i.React$1.createElement(E,Object.assign({},n)),t)};$.displayName="CommentMarkers",$.displayName="CommentMarkers";n.injectInternalStyle("typescript/libraries/file-viewer/src/comments2/comments2.module.out.css",(e=>"._comments-pane_r21d9_1>.sc-comment-stream{width:100%}._contentBoxReset_r21d9_5 *,._contentBoxReset_r21d9_5 :after,._contentBoxReset_r21d9_5 :before{box-sizing:content-box}._comments-pane-blade_r21d9_11{height:100%}._disabled-annotations-show-more_r21d9_15{color:var(--color__attention__text);cursor:pointer}._annotation-tooltip-container_r21d9_20{height:25px;position:absolute;width:30px}._iconContainer_r21d9_26{position:relative}._unreadBadge_r21d9_30{color:var(--dig-color__primary__on-base);position:absolute;right:-5px;top:-14px}"));const P=({fileId:e,sharedLinkURL:t})=>{const a=r.useUnreadCount(r.createCommentFileIdentifier(e,t));return i.React$1.createElement("span",{className:"_iconContainer_r21d9_26"},i.React$1.createElement(n.UIIcon,{src:_.CommentLine}),a>0&&i.React$1.createElement(n.NotificationBadge,{status:"attention",className:"_unreadBadge_r21d9_30"},a))};P.displayName="CommentIconWithUnreadCount";const k={showApproval:!0},S=i.React$1.lazy((()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{CommentsPluginPane:t}=yield new Promise((function(t,a){e(["./c_src_comments2_pane"],t,a)}));return{default:t}}))));S.displayName="LazyCommentsPluginPane";const L=i.React$1.lazy((()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{AnnotationLayer:t}=yield new Promise((function(t,a){e(["./c_comments2_annotations_annotation_layer"],t,a)}));return{default:t}}))));L.displayName="LazyAnnotationLayer";const O=()=>i.React$1.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"}},i.React$1.createElement(n.Spinner,{className:"comments-blade-loading-spinner",size:"standard"}));O.displayName="LoadingIndicator";const N=e=>i.React$1.createElement(i.React$1.Suspense,{fallback:i.React$1.createElement(O,null)},i.React$1.createElement(S,Object.assign({},e)));N.displayName="AsyncCommentsPluginPane";const B=e=>i.React$1.createElement(i.React$1.Suspense,{fallback:i.React$1.createElement(i.React$1.Fragment,null,e.children)},i.React$1.createElement(L,Object.assign({},e)));B.displayName="AsyncAnnotationLayer";class U{constructor(e,t,s={},l,m){this.didRequestfocus=!1,this.didRequestActivateThread=!1,this.loadMediaFeatures=()=>a.__awaiter(this,void 0,void 0,(function*(){const e=void 0;try{const t=yield this.platform.apiv2ClientBase.ns("media_addon").rpc("get_features",e,{});this.store.dispatch(r.getFeaturesResultAction({result:t,arg:e}));const a=t.frame_precise_comments;null!=a&&this.context.getPluginData().navigation.toggleVideoFrameSteppers(a)}catch(t){this.store.dispatch(r.getFeaturesResultAction({arg:e},null,t))}})),this.handleCancelAnnotating=()=>{this.store.getState().annotationSettings.state&&this.store.dispatch(r.cancelAnnotating(this.context.fileViewerId))},this.renderCommentsContent=e=>{const{expandedBlade:t}=i.React$1.useContext(g.RightRailContext);return d.useRecordPreviewsTimerOnMount(this.context.fileViewerId,c.PreviewsTimer.SidebarContentsMount,{bladeId:d.COMMENTS_PLUGIN_ID},t===d.COMMENTS_PLUGIN_ID),u.isSupportedPreviewType$1(e.file)?i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(d.KeyboardBindingConnector,{name:"comment_plugin",keyboardBindings:this.keybinding}),i.React$1.createElement(N,Object.assign({user:this.user,intl:this.platform.intl,context:this.context,config:this.config,approvalIOClient:this.approvalIOClient},e))):null},this.layerUI={LayerWithEventBubbling:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(B,Object.assign({platform:this.platform,context:this.context,config:this.config},e)))},this.rightRailUI={Control:e=>{var t;return e.file&&u.isSupportedPreviewType$1(e.file)?i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(r.CollapsedCommentsBladeButton,{id:d.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:null===(t=e.file)||void 0===t?void 0:t.fileId,sharedLinkURL:e.file.url})):null},Sidebar:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(r.CommentsBlade,{id:d.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:e.file.fileId,sharedLinkURL:e.file.url,approvalIOClient:this.approvalIOClient},this.renderCommentsContent(e)))},this.commentUI={Header:()=>{const e=this.context.getPluginData().previewType;return i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(T,{fileViewerId:this.context.fileViewerId,previewType:e}))},VideoSeekBarLayer:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement($,Object.assign({},e))),mediaScrubber:{onClickOutsideMarkers:()=>{this.store.dispatch(r.deactivateAllThreads({fileViewerId:this.context.fileViewerId}))}}},this.sidebarUI={Icon:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(P,{fileId:e.file.fileId,sharedLinkURL:e.file.url})),Title:()=>i.React$1.createElement(i.React$1.Fragment,null,this.platform.intl.formatMessage({id:"extqcT",defaultMessage:"Comments"})),TitleAccessory:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(r.CommentsMeatball,{fileId:e.file.fileId,sharedLinkURL:e.file.url,size:"standard",approvalIOClient:this.approvalIOClient})),Content:e=>i.React$1.createElement(n.Provider,{store:this.store},this.renderCommentsContent(e))},this.fetchInitialComments=(e,t)=>{const a=e.url||(null==t?void 0:t.url)||void 0;if(a){const e={include_permissions:!0,stream:{identifier:{".tag":"shared_link_details",url:a},type:{".tag":"file"}}};this.user?this.store.dispatch(r.listCommentsAction({arg:e})):this.store.dispatch(r.loggedOutListCommentsAction({arg:e}))}else this.store.dispatch(r.listCommentsAction({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:e.fileId},type:{".tag":"file"}}}}))},this.lifecycle={previewDidInitialize:({threadId:e,shouldFocusApproval:t,shouldFocusComment:a,commentId:i})=>{var n,s;const d=this.context.getPluginData(),{file:l,sharedLinkInfo:m}=d;if(null!=l){if(this.fetchInitialComments(l,m),"string"!=typeof e||this.didRequestActivateThread){if("string"==typeof i&&!this.didRequestActivateThread){d.navigation.openRightRail(c.UserActionContext.RightRail);const e=l.url||l.fileId,t=Object.values(null!==(n=this.store.getState().threads[e])&&void 0!==n?n:{}).filter((e=>!!e)),a=r.findCommentThread(t,i);a&&this.store.dispatch(r.activateThread({fileId:l.fileId,sharedLinkURL:l.url,fileViewerId:this.context.fileViewerId,threadId:a.thread.id,isThirdParty:a.thread.isThirdParty})),this.didRequestActivateThread=!0}}else d.navigation.openRightRail(c.UserActionContext.RightRail),this.store.dispatch(r.activateInitialThread({fileViewerId:this.context.fileViewerId,threadId:e,fileId:l.fileId})),this.didRequestActivateThread=!0;if(t&&this.store.dispatch(o.setApprovalForm({[l.fileId]:{activeForm:"request",threadId:void 0}})),"string"==typeof i){const e=l.url||l.fileId,t=Object.values(null!==(s=this.store.getState().threads[e])&&void 0!==s?s:{}).filter((e=>!!e)),a=r.findCommentThread(t,i);if(a){const t=r.findActionableApprovalCommentId(a.thread),i=a.thread.comments.find((({id:e})=>e===t));i&&r.canRespondToApproval(i)&&this.store.dispatch(o.setApprovalForm({[e]:{activeForm:"respond",threadId:a.thread.id}}))}}a&&!this.didRequestfocus&&(d.navigation.openRightRail(c.UserActionContext.RightRail),this.store.dispatch(r.focusEditor(this.context.fileViewerId)),this.didRequestfocus=!0)}},previewWillTeardown:()=>{null!=this.store.getState().annotationSettings.state&&this.store.dispatch(r.cancelAnnotating(this.context.fileViewerId))}};const h=(e=>({getState:t,dispatch:a})=>i=>n=>{var o;switch(i(n),n.type){case r.Action$1.ResolveNavigationToActiveThreadAnnotation:return;case r.Action$1.ActivateInitialThread:case r.Action$1.ActivateThread:case r.Action.ListCommentsResult:{const i=t();for(const t of Object.getOwnPropertyNames(i.pendingNavigationToActiveThreadAnnotation)){if(t===e.fileViewerId){const{file:n,navigation:s}=e.getPluginData();if(null!=n){const e=r.createCommentFileIdentifier(n.fileId,n.url),d=i.activeThreadID[t],l=null===(o=i.threads[e])||void 0===o?void 0:o[d];if(l&&l.annotation){const e=l.annotation;"document"===e.type&&"navigateToPage"in s&&s.navigateToPage((e.regions[0].page||1)-1,c.UserActionContext.RightRail),"audio"!==e.type&&"video"!==e.type||!("seek"in s)||s.seek(e.time),a(r.resolveNavigationToActiveThreadAnnotation(t))}}}return}}}})(t);this.store=r.makeStore({apiv2ClientBase:e.apiv2ClientBase,boltIOClient:l.boltIOClient,mentionsIOClient:l.mentionsIOClient,logger:e=>{t.logUserAction(e.event,"right_sidebar",e.extra)}},[h,x]),this.platform=e,this.context=t,this.config=Object.assign(Object.assign({},k),s),this.approvalIOClient=l.approvalIOClient,this.keybinding=[d.getKeyboardBinding({key:n.Key_enum.Key.Escape,callback:this.handleCancelAnnotating})],this.user=m,this.loadMediaFeatures(),this.store.dispatch(r.getStickersAction({arg:void 0}))}}var V=Object.freeze({__proto__:null,makeLoader:function(e,t,i={}){return{pluginId:d.COMMENTS_PLUGIN_ID,load:(n,r)=>a.__awaiter(this,void 0,void 0,(function*(){return new U(n,r,i,e,t)}))}}});t.commentsPaneBlade="_comments-pane-blade_r21d9_11",t.contentBoxReset="_contentBoxReset_r21d9_5",t.disabledAnnotationsShowMore="_disabled-annotations-show-more_r21d9_15",t.eager_esnext=V}));
//# sourceMappingURL=c_src_comments2_eager.js-vflNTo8eF.map
