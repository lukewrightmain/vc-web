define(["exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_typeahead_index","./c_ui-icon_line_import-contacts","./c_contacts_contact_token_state"],(function(e,t,a,n,c,r,o){"use strict";const s=({contact:e,size:t})=>{const c=e.name||e.email||"";let r=e.photo_url;e.type===n.ContactTypes.FB&&(r=`https://graph.facebook.com/${e.fb_id}/picture`);let o=n.getInitials(c);return r?a.React$1.createElement(n.Avatar,{size:t,src:r}):a.React$1.createElement(n.Avatar,{size:t,backgroundColor:n.avatarColorForUserIdentifier(o)},o)};s.displayName="ContactAvatar";const i={type:"expand",getKey:()=>"expand-importer"},l=({contact:e,contactValidator:t,onDelete:c})=>{var r;const s=null==t?void 0:t(e),i={size:"small",onDelete:c,withIconLeft:e.photo_url?a.React$1.createElement(n.Avatar,{hasNoOutline:!0,size:"small",src:e.photo_url}):void 0,children:null!==(r=e.name)&&void 0!==r?r:e.email},l=(null==s?void 0:s.state)===o.ContactTokenState.warn?a.React$1.createElement(n.InputChip,Object.assign({},i,{isWarning:!0})):(null==s?void 0:s.state)===o.ContactTokenState.invalid?a.React$1.createElement(n.InputChip,Object.assign({},i,{isAlert:!0})):a.React$1.createElement(n.InputChip,Object.assign({},i));return(null==s?void 0:s.msg)?a.React$1.createElement(n.Tooltip,{title:s.msg},l):l};l.displayName="ContactChip";const u=([e,t])=>e+t,m=({string:e,match:t})=>{if(!t||0===t.highlighted.length)return a.React$1.createElement(n.Text,null,e);const c=t.highlighted;return a.React$1.createElement(a.React$1.Fragment,null,c.map(((t,r)=>{const o=0===r?[0,0]:c[r-1];return a.React$1.createElement(a.React$1.Fragment,{key:r},a.React$1.createElement(n.Text,null,e.slice(u(o),t[0])),a.React$1.createElement(n.Text,{isBold:!0},e.slice(t[0],u(t))))})),e.slice(u(c[c.length-1])))};m.displayName="MatchedString";const d=({contact:e})=>{const t=n.useIntl(),o={key:e.getKey(),value:e};return"expand"===e.type?a.React$1.createElement(c.Typeahead.Row,Object.assign({},o,{withTitle:t.formatMessage({id:"otWq6d",defaultMessage:"Import contacts"}),withLeftAccessory:a.React$1.createElement(n.UIIcon,{src:r.ImportContactsLine})})):"third-party"===e.type?a.React$1.createElement(c.Typeahead.Row,Object.assign({},o,{withTitle:n.ProfileServicesConstants.to_name(e.provider),withSubtitle:e.connected?t.formatMessage({id:"abwbjF",defaultMessage:"Connected"}):void 0,withLeftAccessory:a.React$1.createElement(n.UIIcon,{src:r.GoogleExternalLogo})})):a.React$1.createElement(c.Typeahead.Row,Object.assign({},o,{withTitle:a.React$1.createElement(m,{string:e.name,match:e.nameMatch}),withSubtitle:e.email&&a.React$1.createElement(m,{string:e.email,match:e.emailMatch}),withLeftAccessory:a.React$1.createElement(s,{contact:e})}))};d.displayName="ContactSuggestion";const p=e=>e.email||e.getKey(),g=e=>a.React$1.createElement(d,{contact:e}),h=(e,t)=>{let a=!1;const c=e.map((e=>{var c;if(!e.pending||!e.query)return e;const r=n.ContactsDataSourceV2.normalizeQuery(e.query),o=null===(c=t[r])||void 0===c?void 0:c.find((t=>t.email===e.email));return a=a||!!o,null!=o?o:e}));return a?c:e},R=new n.ProfileServicesLinkingHandler,f=e=>{var{user:r,contactFilter:o,initialContacts:s,onContentsChange:u,contactValidator:m,onQueryChange:d,focusOnMount:f,showContactImport:$,maxContacts:y,contactsDataSourceFactory:v,resetTokenData:C}=e,_=t.__rest(e,["user","contactFilter","initialContacts","onContentsChange","contactValidator","onQueryChange","focusOnMount","showContactImport","maxContacts","contactsDataSourceFactory","resetTokenData"]);const E=a.React$1.useRef(null),k=a.React$1.useRef(null),[b,T]=a.React$1.useState([]),[I,S]=a.React$1.useState(null!=s?s:[]),[w,x]=a.React$1.useState(!1),[M,O]=a.React$1.useState(""),F=a.React$1.useRef(M),L=n.useIntl(),A=a.React$1.useMemo((()=>v?v(r,o):new n.ContactsDataSourceV2(r,o)),[r,o]),D=a.React$1.useMemo((()=>$&&r?n.LinkedProfileServices.get_linked_profile_services_for_user(r.id):void 0),[$,r]);a.React$1.useEffect((()=>null==u?void 0:u(I)),[I]),a.React$1.useEffect((()=>{null==d||d(M),F.current=M}),[M]),a.React$1.useEffect((()=>{var e;f&&(null===(e=k.current)||void 0===e||e.focus())}),[]),a.React$1.useEffect((()=>{C&&I.length>0&&P([])}),[C]);const P=a.React$1.useCallback(((e,t="")=>{S(e),O(t)}),[]),j=a.React$1.useCallback(((e,t)=>P(I.concat(e.split(/[, ]/).map((e=>e.trim())).filter((e=>!!e)).map(n.Contact.buildFromRawEmail)),t)),[I]);a.React$1.useEffect((()=>{const e=(e=>{const t=new Set(e.map(p));return e=>e.filter((e=>!t.has(p(e))))})(I);A.search(M,(t=>T(e(t))),(t=>{F.current===M&&T((a=>a.concat(e(t))))}))}),[A,I,M]),a.React$1.useEffect((()=>{const e=I.reduce(((e,t)=>t.pending&&t.query?[...e,t.query]:e),[]);0!==e.length&&A.searchBatch(e,(e=>S(h(I,e))),(e=>S((t=>h(t,e)))))}),[I,A]);const z=a.React$1.useCallback((e=>{var t;"expand"===e.type?(x(!0),null===(t=k.current)||void 0===t||t.focus()):"third-party"===e.type?(((e,t,a)=>{if(t){if(!a.connected)return R.auth_service_with_user(a.provider,t.id,n.ProfileServicesLinkingHandler.show_import_notifications);{const t=e.formatMessage({id:"6kb+zR",defaultMessage:"You're already connected to {service_name}"},{service_name:n.ProfileServicesConstants.to_name(a.provider)});n.Snackbar.fail(t)}}})(L,r,e),x(!1)):P(I.concat(e))}),[I,r]),K=a.React$1.useCallback((e=>P(I.filter((t=>t.name!==e.name&&t.email!==e.email)))),[I]),V=a.React$1.useCallback((e=>{const t=e.currentTarget.value,a=Math.max(t.lastIndexOf(","),t.lastIndexOf(" "));if(a>0){const e=a+1,n=t.slice(0,e),c=e<t.length?t.slice(e):"";j(n,c)}else O(t)}),[I]),N=a.React$1.useCallback((e=>{e.key===n.Key_enum.Key.Backspace&&""===M&&I.length>0?(P(I.slice(0,-1)),e.stopPropagation()):e.key!==n.Key_enum.Key.Enter&&" "!==e.key||""===M||(j(M),e.stopPropagation())}),[M,I]),q=w&&D?(e=>n.ProfileServicesConstants.importable_contact_services().map((t=>((e,t)=>({type:"third-party",provider:e,connected:t,getKey:()=>`third-party-import-${e}`}))(t,null==e?void 0:e.service_is_connected(t)))))(D):(null==D?void 0:D.has_unconnected_services(!0))?[...b,i]:b;return a.React$1.createElement(c.Typeahead.Wrapper,{onSelection:z,closeOnSelection:!1},(({getTriggerProps:e,getContentProps:t})=>a.React$1.createElement(a.React$1.Fragment,null,a.React$1.createElement(n.TextInput.Container,{ref:E},a.React$1.createElement(n.TextInput.Accessory,null,a.React$1.createElement(n.UIIcon,{src:n.SearchLine,role:"presentation"})),a.React$1.createElement(n.TextInput.ChipsContainer,null,!!I.length&&I.map(((e,t)=>a.React$1.createElement(l,{key:t,contact:e,onDelete:()=>K(e),contactValidator:m}))),(void 0===y||I.length<y)&&a.React$1.createElement(n.TextInput.Input,Object.assign({"aria-label":L.formatMessage({id:"sZaLAU",defaultMessage:"Contact input"})},_,{ref:k,value:M},e({onChange:V,onKeyDown:N}))))),a.React$1.createElement(c.Typeahead.Container,Object.assign({},t(),{triggerRef:E}),a.React$1.createElement(c.Typeahead.Results,{results:q,renderRow:g})))))};f.displayName="ContactsTokenizerV2",e.ContactsTokenizerV2=f}));
//# sourceMappingURL=c_contacts_tokenizer_v2.js-vflvsEFql.map
