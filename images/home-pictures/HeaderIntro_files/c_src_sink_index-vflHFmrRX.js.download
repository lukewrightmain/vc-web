define(["require","exports","./c_tslib","./c_apex-metrics_src_types","./e_core_exception","./c_core_browser_detection"],(function(e,t,n,s,i,r){"use strict";class o extends s.Message{constructor(e){super(),this.seconds=s.protoInt64.zero,this.nanos=0,s.proto3.util.initPartial(e,this)}fromJson(e,t){if("string"!=typeof e)throw new Error(`cannot decode google.protobuf.Timestamp from JSON: ${s.proto3.json.debug(e)}`);const n=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const i=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(i))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=s.protoInt64.parse(i/1e3),this.nanos=0,n[7]&&(this.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),this}toJson(e){const t=1e3*Number(this.seconds);if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let n="Z";if(this.nanos>0){const e=(this.nanos+1e9).toString().substring(1);n="000000"===e.substring(3)?"."+e.substring(0,3)+"Z":"000"===e.substring(6)?"."+e.substring(0,6)+"Z":"."+e+"Z"}return new Date(t).toISOString().replace(".000Z",n)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return o.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new o({seconds:s.protoInt64.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return(new o).fromBinary(e,t)}static fromJson(e,t){return(new o).fromJson(e,t)}static fromJsonString(e,t){return(new o).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(o,e,t)}}o.runtime=s.proto3,o.typeName="google.protobuf.Timestamp",o.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]));class a{now(){return{value:performance.now(),unit:s.TimeUnit.MILLISECONDS}}}class c{static toMilliseconds(e){switch(e.unit){case s.TimeUnit.NANOSECONDS:return e.value/1e6;case s.TimeUnit.MILLISECONDS:return e.value;case s.TimeUnit.SECONDS:return 1e3*e.value;case s.TimeUnit.MINUTES:return 6e4*e.value;case s.TimeUnit.HOURS:return 36e5*e.value;case s.TimeUnit.DAYS:return 24*e.value*36e5}}}class l{constructor(e){this.jitterStrategy=e}executeEvery(e,t){const n=c.toMilliseconds(e),s=c.toMilliseconds(this.jitterStrategy());setTimeout((()=>{t()&&this.executeEvery(e,t)}),n+s)}}const u=256,d=new RegExp("^[^0-9a-zA-Z]+"),p=new RegExp("[^0-9a-zA-Z._-]","g"),m=p,h=new RegExp("[^0-9a-zA-Z/._-]","g"),f=p;function g(e){return{ns:(n=e.ns,_(n,"namespace",u,d,m)),name:(t=e.name,_(t,"metric name",u,d,h))};var t,n}function v(e){const t={};for(const n in e)if(e.hasOwnProperty(n)){t[_(n,"tag name",u,d,f)]=_(e[n],"tag value",u)}return t}function _(e,t,n,s,i){const r=[];if("string"!=typeof e&&r.push("identifier is not a string"),s&&s.test(e)&&r.push("invalid prefix"),i&&i.test(e)&&r.push("invalid characters"),e.length>n&&r.push(`exceeds ${n} characters`),0===e.length&&r.push("is empty"),0!==r.length)throw new Error(`${t} identifier '${e}' is invalid: ${r}`);return e}const w=3432918353,S=461845907;function b(e){if(4!=e.length)throw new Error("strToUint32 expected length 4 byte array");return e[0]+(e[1]<<8)+(e[2]<<16)+(e[3]<<24)}const y=2**32,k=[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,.0009765625,.00048828125,.000244140625,.0001220703125,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19,9.5367431640625e-7,4.76837158203125e-7,2.384185791015625e-7,1.1920928955078125e-7,5.960464477539063e-8,2.9802322387695312e-8,1.4901161193847656e-8,7.450580596923828e-9,3.725290298461914e-9,1.862645149230957e-9,9.313225746154785e-10,4.656612873077393e-10,2.3283064365386963e-10],E=512;function x(e){return function(e,t){let n=t;const s=Math.floor(e.length/4);for(let t=0;t<s;t++){let s=b(e.slice(4*t,4*t+4));s=Math.imul(s,w),s=(s<<15>>>0|s>>>17)>>>0,s=Math.imul(s,S),n^=s,n>>>=0,n=(n<<13>>>0|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0}let i=e.slice(4*s),r=0;const o=3&i.length;return 3==o&&(r^=i[2]<<16>>>0,r>>>=0),o>=2&&(r^=i[1]<<8>>>0,r>>>=0),o>=1&&(r^=i[0],r=Math.imul(r,w),r=(r<<15>>>0|r>>>17)>>>0,r=Math.imul(r,S),n^=r,n>>>=0),n^=e.length,n>>>=0,n^=n>>>16,n>>>=0,n=Math.imul(n,2246822507),n^=n>>>13,n>>>=0,n=Math.imul(n,3266489909),n^=n>>>16,n>>>=0,n}(function(e){const t=[];let n=0;for(let s=0;s<e.length;s++){const i=e.charCodeAt(s);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t}(e),538513424)}class N{constructor(e=[]){this.registers=new Array(E).fill(0),e.forEach((e=>this.add(e)))}add(e){if(e>=y)throw new Error("add only accepts 32-bit unsigned integers");const t=function(e,t){let n=1;for(;(2147483648&e)>>>0==0&&n<=t;)n++,e=e<<1>>>0;return n}(e<<9>>>0,23),n=e>>>23;t>this.registers[n]&&(this.registers[n]=t)}count(){let e=this.registers.reduce(((e,t)=>e+k[t]),0),t=this.registers.reduce(((e,t)=>e+(0==t?1:0)),0);if(t==E)return 0;let n=188686.82445861166/e;return n<=1280?t>0&&(n=E*Math.log(E/t)):n>1/30*y&&(n=-y*Math.log(1-n/y)),n}merge(e){for(let t=0;t<E;t++){const n=e.registers[t];n>this.registers[t]&&(this.registers[t]=n)}}compressed(){const e=[];for(let t=0;t<64;t++){const n=O(this.registers.slice(8*t,8*(t+1)));for(const t of n)e.push(t)}return String.fromCharCode(...e)}}function O(e){if(8!=e.length)throw new Error("Number of registers in stripCompress routine is not 8");const t=[];let n=0;for(let t=0;t<8;t++){if(n*=32,e[t]>=32)throw new Error("Register in HLL greater than max allowed value");n+=e[t]}for(let e=0;e<5;e++)t.unshift(Number(n%256)),n=Math.floor(n/256);return t}class C{constructor(e,t,n,s={}){this.sink=e,this.clock=t,this.originId=n,this.tags=s}static root(e,t,n=""){return new C(e,t,n)}child(e){return new C(this.sink,this.clock,this.originId,Object.assign(Object.assign({},this.tags),v(e)))}createStats(e,t={}){return new T(g(e),Object.assign(Object.assign({},this.tags),v(t)),this.sink)}createCounter(e,t={}){return new D(g(e),Object.assign(Object.assign({},this.tags),v(t)),this.sink)}createTimer(e,t={}){return new M(g(e),Object.assign(Object.assign({},this.tags),v(t)),this.sink,this.clock)}createSet(e,t={}){return new I(g(e),Object.assign(Object.assign({},this.tags),v(t)),this.sink,this.originId)}}class T{constructor(e,t,n){this.metric=e,this.tags=t,this.sink=n}record(e){R(e,this.metric,this.tags,this.sink)}recordDuration(e,t){R(c.toMilliseconds({value:e,unit:t}),this.metric,this.tags,this.sink)}}class D{constructor(e,t,n,s=0){this.metric=e,this.tags=t,this.sink=n,this.value=s}decrement(e=1){this.value-=e}increment(e=1){this.value+=e}reset(e=0){this.value=e}record(){R(this.value,this.metric,this.tags,this.sink),this.reset()}}class M{constructor(e,t,n,s,i=0){this.metric=e,this.tags=t,this.sink=n,this.clock=s,this.value=i,this.value=c.toMilliseconds(this.clock.now())}record(){R(c.toMilliseconds(this.clock.now())-this.value,this.metric,this.tags,this.sink),this.reset()}reset(){this.value=c.toMilliseconds(this.clock.now())}}class I{constructor(e,t,n,s){this.metric=e,this.tags=t,this.sink=n,this.originId=s}observe(e){if("string"!=typeof e)throw new Error("value must be a string");const t=x(e);this.sink.recordSetSpan({namespace:this.metric.ns,metricName:this.metric.name,tags:this.tags,samples:[t],type:"set"})}observeOriginId(){this.observe(this.originId)}}function R(e,t,n,s){if("number"!=typeof e)throw new Error("value must be a number");s.recordSpan({namespace:t.ns,metricName:t.name,tags:n,samples:[e],type:"histogram"})}function B(e){const t=[];for(const n in e)if(e.hasOwnProperty(n)){const s=e[n];t.push({name:{value:{".tag":"string_value",string_value:n}},value:{value:{".tag":"string_value",string_value:s}}})}return t}function P(e,t){if(e.length!==t.length)throw new Error("Cannot zip values of different dimensions!");return e.map(((e,n)=>({name:{value:{".tag":"string_value",string_value:e}},value:{value:{".tag":"string_value",string_value:t[n]}}})))}const q="amp_client";var L;function F(e,t,n,s){n("samples_sink/submitted_spans",e.submittedSpans),n("samples_sink/submitted_samples",e.submittedSamples);for(const[t,s]of Object.entries(e.submittedSamplesByNs))n("samples_sink/submitted_samples_by_ns",s,{namespace:t});n("samples_sink/retained_spans",e.retainedSpans),n("samples_sink/retained_samples",e.retainedSamples);for(const[t,s]of Object.entries(e.retainedSamplesByNs))n("samples_sink/retained_samples_by_ns",s,{namespace:t});n("samples_sink/request/dropped_samples",e.requestDroppedSamples),n("samples_sink/request/dropped_spans",e.requestDroppedSpans),n("samples_sink/request/attempts",e.requestAttempts),n("samples_sink/request/latency",t),n("samples_sink/submitted_set_observations",e.setObservations);for(const[t,s]of Object.entries(e.setObservationsByNs))n("samples_sink/submitted_set_observations_by_ns",s,{namespace:t});n("samples_sink/request/dropped_set_observations",e.requestDroppedSetObservations),s("samples_sink/reporting_hosts")}!function(e){function t(e,t){var n;const s=Object.assign({},e);for(const[e,i]of Object.entries(t))s[e]=(null!==(n=s[e])&&void 0!==n?n:0)+i;return s}e.empty=function(){return{submittedSpans:0,submittedSamples:0,submittedSamplesByNs:{},retainedSpans:0,retainedSamples:0,retainedSamplesByNs:{},requestDroppedSamples:0,requestDroppedSpans:0,requestAttempts:0,setObservations:0,setObservationsByNs:{},requestDroppedSetObservations:0}},e.incrementSubmittedSamples=function(e,t,n){e.submittedSamples+=n;const s=e.submittedSamplesByNs[t];e.submittedSamplesByNs[t]=(null!=s?s:0)+n},e.incrementSetObservations=function(e,t,n){e.setObservations+=n;const s=e.setObservationsByNs[t];e.setObservationsByNs[t]=(null!=s?s:0)+n},e.incrementRetainedSamples=function(e,t,n){e.retainedSamples+=n;const s=e.retainedSamplesByNs[t];e.retainedSamplesByNs[t]=(null!=s?s:0)+n},e.report=function(t,n,s,i,r){if(0===t.retainedSamples)return t.requestAttempts=0,t;const o=n.child({client_version:i.toString(),origin_kind:r});return F(t,s,((e,t,n)=>{o.createStats({ns:q,name:e},n).record(t)}),(e=>{o.createSet({ns:q,name:e}).observeOriginId()})),e.empty()},e.toScope=function(e,t,n,s){const i=[];return F(e,n,((e,t,n)=>{i.push({tags:n?B(n):[],metrics:[{name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"numerical_data",samples:[t]}}]})}),(e=>{i.push({metrics:[{name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",samples:[x(t)]}}]})})),{metric_namespace:q,timestamp_sec:Math.floor(Date.now()/1e3),tags:B(s),descendants:i}},e.merge=function(e,n){var s,i,r,o,a,c,l,u,d,p,m,h;return{submittedSpans:e.submittedSpans+(null!==(s=n.submittedSpans)&&void 0!==s?s:0),submittedSamples:e.submittedSamples+(null!==(i=n.submittedSamples)&&void 0!==i?i:0),submittedSamplesByNs:t(e.submittedSamplesByNs,null!==(r=n.submittedSamplesByNs)&&void 0!==r?r:{}),retainedSpans:e.retainedSpans+(null!==(o=n.retainedSpans)&&void 0!==o?o:0),retainedSamples:e.retainedSamples+(null!==(a=n.retainedSamples)&&void 0!==a?a:0),retainedSamplesByNs:t(e.retainedSamplesByNs,null!==(c=n.retainedSamplesByNs)&&void 0!==c?c:{}),requestDroppedSamples:e.requestDroppedSamples+(null!==(l=n.requestDroppedSamples)&&void 0!==l?l:0),requestDroppedSpans:e.requestDroppedSpans+(null!==(u=n.requestDroppedSpans)&&void 0!==u?u:0),requestAttempts:e.requestAttempts+(null!==(d=n.requestAttempts)&&void 0!==d?d:0),setObservations:e.setObservations+(null!==(p=n.setObservations)&&void 0!==p?p:0),setObservationsByNs:t(e.setObservationsByNs,null!==(m=n.setObservationsByNs)&&void 0!==m?m:{}),requestDroppedSetObservations:e.requestDroppedSetObservations+(null!==(h=n.requestDroppedSetObservations)&&void 0!==h?h:0)}}}(L||(L={}));const j="apexMetrics",J="spans",U="set_spans",A="namespace",z="controlValues",K="lastPublishTime",V="selfInstrumentation",Z="instrumentation";function H(e,t){return new Promise(((n,s)=>{const i=e.index(A).getKey(IDBKeyRange.lowerBound(t,!0));i.addEventListener("success",(()=>{if(i.result){const e=i.result[0];n(IDBKeyRange.bound([t],[e],!1,!0))}else n(IDBKeyRange.lowerBound([t]))})),i.addEventListener("error",(e=>{s(e)}))}))}function G(e,t,n){const s=e.result,i=e=>{s.removeEventListener("error",i),n(e)};s.addEventListener("error",i),e.transaction.addEventListener("complete",(()=>{s.removeEventListener("error",i)})),e.transaction.addEventListener("error",(e=>{s.removeEventListener("error",i),n(e)}));const r=(e,t)=>e.oldVersion<t&&(null===e.newVersion||e.newVersion&&e.newVersion>=t);if(r(t,1))try{s.createObjectStore(J,{keyPath:["namespace","tagNames","tagValues"]}).createIndex(A,"namespace",{unique:!1}),s.createObjectStore(z,{keyPath:"name"})}catch(e){return void i(e)}if(r(t,2)){const t=e.transaction.objectStore(J).openCursor();t.addEventListener("success",(()=>{const e=t.result;if(!e)return;let n=!1;for(const t in e.value.spans)e.value.spans.hasOwnProperty(t)&&(n=!0,e.value.spans[t]={spanCount:0,samples:e.value.spans[t]});n&&e.update(e.value),e.continue()}))}if(r(t,3))try{s.createObjectStore(V,{keyPath:"name"})}catch(e){return void i(e)}if(r(t,4))try{e.transaction.objectStore(J).clear();e.transaction.objectStore(V).clear()}catch(e){return void i(e)}if(r(t,5))try{s.createObjectStore(U,{keyPath:["namespace","tagNames","tagValues"]}).createIndex(A,"namespace",{unique:!1})}catch(e){return void i(e)}if(r(t,6))try{e.transaction.objectStore(J).clear();e.transaction.objectStore(U).clear();e.transaction.objectStore(V).clear()}catch(e){return void i(e)}}function $(e=6){return n.__awaiter(this,void 0,void 0,(function*(){let t=null;if("undefined"==typeof indexedDB)return t;try{t=yield new Promise(((t,n)=>{indexedDB.open("unused",1);const s=indexedDB.open(j,e);s.addEventListener("success",(()=>{t(s.result)})),s.addEventListener("error",(e=>{n(e)})),s.addEventListener("upgradeneeded",(e=>{try{G(s,e,n)}catch(e){n(e)}}))}))}catch(n){n.target&&n.target.error&&n.target.error.name&&"VersionError"===n.target.error.name&&(yield new Promise(((e,t)=>{const n=indexedDB.deleteDatabase(j);n.addEventListener("success",(()=>e())),n.addEventListener("error",(e=>t(e)))})),t=yield new Promise(((t,n)=>{const s=indexedDB.open(j,e);s.addEventListener("success",(()=>t(s.result))),s.addEventListener("error",(e=>n(e))),s.addEventListener("upgradeneeded",(e=>{try{G(s,e,n)}catch(e){n(e)}}))})))}return t}))}function Y(e,t){return W(e,t,J,(e=>(e.sort(),e)))}function X(e,t){return W(e,t,U,(e=>{const t={};return e.filter((e=>!t[e]&&(t[e]=!0,!0)))}))}function W(e,t,n,s){return Promise.all(t.map((t=>new Promise(((i,r)=>{let o;try{o=e.transaction(n,"readwrite")}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void i();throw e}const a=o.objectStore(n);o.addEventListener("complete",(e=>i())),o.addEventListener("error",(e=>r(e)));const c=[],l=[];for(const e in t.tags)t.tags.hasOwnProperty(e)&&(c.push(e),l.push(t.tags[e]));const u=a.get([t.namespace,c,l]);u.addEventListener("success",(()=>{const e=u.result?u.result:{namespace:t.namespace,tagNames:c,tagValues:l,spans:{}};e.spans[t.metricName]||(e.spans[t.metricName]={spanCount:0,samples:[]}),e.spans[t.metricName].spanCount++,e.spans[t.metricName].samples=s(e.spans[t.metricName].samples.concat(t.samples)),a.put(e)}))})))))}function Q(e,t){return new Promise(((s,i)=>n.__awaiter(this,void 0,void 0,(function*(){var n,r;const o=te(e,V,"readwrite");if(null===o)return void s();const a=o.objectStore(V);o.addEventListener("complete",(()=>{s()})),o.addEventListener("error",i);const c=null!==(r=null===(n=yield ne(a,Z))||void 0===n?void 0:n.value)&&void 0!==r?r:L.empty(),l=L.merge(t,c);yield function(e,t){return new Promise(((n,s)=>{const i=e.put(t);i.addEventListener("success",(()=>{n()})),i.addEventListener("error",(e=>{s(e)}))}))}(a,{name:Z,value:l})}))))}function ee(e,t){return new Promise(((s,i)=>n.__awaiter(this,void 0,void 0,(function*(){var n,r;const o=te(e,V,"readwrite");if(null===o)return void s(t);o.addEventListener("error",i);const a=o.objectStore(V),c=null!==(r=null===(n=yield ne(a,Z))||void 0===n?void 0:n.value)&&void 0!==r?r:L.empty();o.addEventListener("complete",(()=>{s(L.merge(t,c))})),function(e,t){new Promise(((n,s)=>{const i=e.delete(t);i.addEventListener("success",(()=>{n()})),i.addEventListener("error",(e=>{s(e)}))}))}(a,Z)}))))}function te(e,t,n){try{return e.transaction(t,n)}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return null;throw e}}function ne(e,t){return new Promise(((n,s)=>{const i=e.get(t);i.addEventListener("success",(()=>{n(i.result)})),i.addEventListener("error",(e=>{s(e)}))}))}class se extends s.Message{constructor(e){super(),s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new se).fromBinary(e,t)}static fromJson(e,t){return(new se).fromJson(e,t)}static fromJsonString(e,t){return(new se).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(se,e,t)}}se.runtime=s.proto3,se.typeName="apex_metrics_web.RecordNamespace",se.fields=s.proto3.util.newFieldList((()=>[]));class ie extends s.Message{constructor(e){super(),this.metricNamespace="",this.maxTimeUntilRefreshSeconds=0,this.stopPublicationForSeconds=0,this.dropFractionOfHostsPerMetric=0,this.aggregationIntervalSeconds=0,s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new ie).fromBinary(e,t)}static fromJson(e,t){return(new ie).fromJson(e,t)}static fromJsonString(e,t){return(new ie).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(ie,e,t)}}ie.runtime=s.proto3,ie.typeName="apex_metrics_web.RecordNamespace.MetricReportingConfigV2",ie.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"metric_namespace",kind:"scalar",T:9},{no:2,name:"max_time_until_refresh_seconds",kind:"scalar",T:13},{no:3,name:"stop_publication_for_seconds",kind:"scalar",T:13},{no:4,name:"drop_samples",kind:"message",T:re},{no:5,name:"drop_periods",kind:"message",T:re},{no:6,name:"drop_fraction_of_hosts_per_metric",kind:"scalar",T:1},{no:7,name:"aggregation_interval_seconds",kind:"scalar",T:13}]));class re extends s.Message{constructor(e){super(),this.fraction=0,s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new re).fromBinary(e,t)}static fromJson(e,t){return(new re).fromJson(e,t)}static fromJsonString(e,t){return(new re).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(re,e,t)}}re.runtime=s.proto3,re.typeName="apex_metrics_web.RecordNamespace.StickyBiasedCoinV2",re.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"fraction",kind:"scalar",T:1},{no:2,name:"stickiness",kind:"message",T:oe}]));class oe extends s.Message{constructor(e){super(),this.limit={case:void 0},s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new oe).fromBinary(e,t)}static fromJson(e,t){return(new oe).fromJson(e,t)}static fromJsonString(e,t){return(new oe).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(oe,e,t)}}oe.runtime=s.proto3,oe.typeName="apex_metrics_web.RecordNamespace.StickinessV2",oe.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"independent",kind:"message",T:s.Empty,oneof:"limit"},{no:2,name:"permanent",kind:"message",T:s.Empty,oneof:"limit"},{no:3,name:"n_results",kind:"scalar",T:13,oneof:"limit"},{no:4,name:"n_seconds",kind:"scalar",T:2,oneof:"limit"}]));class ae extends s.Message{constructor(e){super(),this.reportingConfigs=[],this.publicationIntervalSeconds=0,this.maxScopesPerRequest=0,this.stopPublicationForSeconds=0,this.debugInfos=[],s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new ae).fromBinary(e,t)}static fromJson(e,t){return(new ae).fromJson(e,t)}static fromJsonString(e,t){return(new ae).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(ae,e,t)}}ae.runtime=s.proto3,ae.typeName="apex_metrics_web.RecordNamespace.RecordResponse",ae.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"reporting_configs",kind:"message",T:ie,repeated:!0},{no:3,name:"publication_interval_seconds",kind:"scalar",T:13},{no:4,name:"max_scopes_per_request",kind:"scalar",T:13},{no:5,name:"stop_publication_for_seconds",kind:"scalar",T:13},{no:6,name:"debug_infos",kind:"scalar",T:9,repeated:!0}]));class ce extends s.Message{constructor(e){super(),s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new ce).fromBinary(e,t)}static fromJson(e,t){return(new ce).fromJson(e,t)}static fromJsonString(e,t){return(new ce).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(ce,e,t)}}ce.runtime=s.proto3,ce.typeName="apex_metrics_web.ApexMetricsCacheData",ce.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"config",kind:"message",T:ae},{no:2,name:"timeStored",kind:"message",T:o},{no:3,name:"state",kind:"message",T:de}]));class le extends s.Message{constructor(e){super(),this.lastResult=!1,this.numTimesChecked=0,s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new le).fromBinary(e,t)}static fromJson(e,t){return(new le).fromJson(e,t)}static fromJsonString(e,t){return(new le).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(le,e,t)}}le.runtime=s.proto3,le.typeName="apex_metrics_web.ApexMetricsCacheData.CoinState",le.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"lastFlipTime",kind:"message",T:o},{no:2,name:"lastResult",kind:"scalar",T:8},{no:3,name:"numTimesChecked",kind:"scalar",T:13}]));class ue extends s.Message{constructor(e){super(),s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new ue).fromBinary(e,t)}static fromJson(e,t){return(new ue).fromJson(e,t)}static fromJsonString(e,t){return(new ue).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(ue,e,t)}}ue.runtime=s.proto3,ue.typeName="apex_metrics_web.ApexMetricsCacheData.NamespaceCoinState",ue.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"dropPeriodCoin",kind:"message",T:le},{no:2,name:"dropSamplesCoin",kind:"message",T:le}]));class de extends s.Message{constructor(e){super(),this.filterID=0,this.namespaceCoinState={},s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new de).fromBinary(e,t)}static fromJson(e,t){return(new de).fromJson(e,t)}static fromJsonString(e,t){return(new de).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(de,e,t)}}function pe(){return new le({lastFlipTime:void 0,lastResult:!1,numTimesChecked:0})}function me(e){let t;if(e.stickiness&&e.stickiness.limit)switch(e.stickiness.limit.case){case"independent":t={".tag":"independent"};break;case"permanent":t={".tag":"permanent"};break;case"nResults":t={".tag":"n_results",n_results:e.stickiness.limit.value};break;case"nSeconds":t={".tag":"n_seconds",n_seconds:e.stickiness.limit.value}}return{fraction:null!==e.fraction?e.fraction:void 0,stickiness:t?{limit:t}:void 0}}de.runtime=s.proto3,de.typeName="apex_metrics_web.ApexMetricsCacheData.FilterState",de.fields=s.proto3.util.newFieldList((()=>[{no:1,name:"filterID",kind:"scalar",T:13},{no:2,name:"namespaceCoinState",kind:"map",K:9,V:{kind:"message",T:ue}}]));function he(e){let t;if(e.stickiness&&e.stickiness.limit)switch(e.stickiness.limit[".tag"]){case"independent":t={limit:{case:"independent",value:new s.Empty}};break;case"permanent":t={limit:{case:"permanent",value:new s.Empty}};break;case"n_results":t={limit:{case:"nResults",value:e.stickiness.limit.n_results}};break;case"n_seconds":t={limit:{case:"nSeconds",value:e.stickiness.limit.n_seconds}}}return new re({fraction:e.fraction,stickiness:t?new oe(t):void 0})}function fe(e,t,n){if(!t.stickiness||!t.stickiness.limit)return{nextState:n,result:!1};const i=Date.now()/1e3,{lastFlipTime:r=o.fromDate(new Date(0)),lastResult:a,numTimesChecked:l=0}=n;let u=!1;switch(t.stickiness.limit[".tag"]){case"n_results":u=null===l||l%t.stickiness.limit.n_results==0;break;case"n_seconds":if(!r){u=!0;break}u=c.toMilliseconds({value:i-(d=r.seconds,Number(d.toString())),unit:s.TimeUnit.SECONDS})>c.toMilliseconds({value:t.stickiness.limit.n_seconds,unit:s.TimeUnit.SECONDS});break;case"permanent":u=0===l;break;case"independent":u=!0;break;default:return{nextState:n,result:!1}}var d;if(u){const n=e()<(t.fraction||0);return{nextState:new le({lastFlipTime:o.fromDate(new Date(1e3*i)),lastResult:n,numTimesChecked:l?l+1:1}),result:n}}return{nextState:new le(Object.assign(Object.assign({},n),{numTimesChecked:l?l+1:1})),result:!!a}}function ge(e,t){return n.__awaiter(this,void 0,void 0,(function*(){let n=null;if(crypto.subtle&&window.TextEncoder){const e=new TextEncoder,s=yield crypto.subtle.digest("SHA-256",e.encode(t));n=new Uint32Array(s).reduce(((e,t)=>e^t))}return null===n?0:((n^e)>>>0)/4294967296}))}class ve{constructor(e,t,n,s,i,r){this.filterID=e,this.randomEngine=t,this.clock=n,this.maxScopes=s,this.namespaceMap=i,this.configuredNamespaces=r}extend(e,t,n){return new ve(this.filterID,this.randomEngine,this.clock,e||this.maxScopes,Object.assign(Object.assign({},this.namespaceMap),t),n)}getState(){const e={filterID:this.filterID,namespaceCoinState:{}};for(const t in this.namespaceMap)this.namespaceMap.hasOwnProperty(t)&&(e.namespaceCoinState[t]=new ue({dropPeriodCoin:this.namespaceMap[t].dropPeriodCoin?new le(Object.assign({},this.namespaceMap[t].dropPeriodCoin.state)):void 0,dropSamplesCoin:this.namespaceMap[t].dropSamplesCoin?new le(Object.assign({},this.namespaceMap[t].dropSamplesCoin.state)):void 0}));return new de(e)}getConfiguredNamespaces(){return this.configuredNamespaces}partitionAndSerializeSpans(e,t,s,i){return n.__awaiter(this,void 0,void 0,(function*(){return new Promise(((r,o)=>{const a=[];let c=0;const l=new Map;let u,d=0;const p=new Set;try{u=e.transaction([J,U],"readwrite")}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void r({scopes:[],storedNamespaces:p,spansRetained:0,samplesRetainedByNs:new Map,observationsRetained:0});throw e}const m=new Map,h=new Set;u.addEventListener("complete",(()=>r({scopes:a,storedNamespaces:p,spansRetained:c,samplesRetainedByNs:l,observationsRetained:d}))),u.addEventListener("error",(e=>o(e)));const f=[{storeName:J,serializeSamplesFunc:(e,t,n,s,r)=>{var o;i.includes(s)||(c+=r,l.set(s,(null!==(o=l.get(s))&&void 0!==o?o:0)+n.length)),function(e,t,n){t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"numerical_data",samples:n}})}(e,t,n)}},{storeName:U,serializeSamplesFunc:(e,t,n,s,r)=>{i.includes(s)||(d+=n.length),function(e,t,n){n.length>80?t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",hyperloglog:{registers:new N(n).compressed()}}}):t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",samples:n}})}(e,t,n)}}];for(const{storeName:e,serializeSamplesFunc:i}of f){const r=u.objectStore(e);let c;try{c=r.index(A)}catch(e){return void o(e)}const l=c.count();l.addEventListener("success",(()=>{if(0===l.result)return;const e=c.openKeyCursor(null,"nextunique");e.addEventListener("success",(()=>n.__awaiter(this,void 0,void 0,(function*(){var c;const l=e.result;if(!l)return;const u=l.key;if(0!==this.maxScopes&&a.length===this.maxScopes&&!h.has(u))return;if(p.add(u),!this.configuredNamespaces.has(u))return void l.continue();const{dropPeriodCoin:d,dropSamplesCoin:f,dropFractionOfHostsPerMetric:g}=this.namespaceMap[u]||{};let v;try{v=yield H(r,u)}catch(e){return void o(e)}if(d){const{result:e,nextState:t}=fe(this.randomEngine,d.config,d.state);if(d.state=t,e)return r.delete(v),void l.continue()}const _=null!==(c=m.get(u))&&void 0!==c?c:{metric_namespace:u,timestamp_sec:s,tags:B(t),descendants:[]};m.set(u,_);const w=r.openCursor(v);w.addEventListener("success",(()=>n.__awaiter(this,void 0,void 0,(function*(){const e=w.result;if(!e)return _.descendants.length>0&&!h.has(u)&&(a.push(_),h.add(u)),void l.continue();const t={tags:P(e.value.tagNames,e.value.tagValues),metrics:[]},n=e.value.spans;for(const e in n){if(!n.hasOwnProperty(e))continue;if(g){if((yield ge(this.filterID,e))<g)continue}let s=n[e].samples;if(f&&(s=s.filter((e=>{const{result:t,nextState:n}=fe(this.randomEngine,f.config,f.state);return f.state=n,!t}))),0===s.length)continue;const r=n[e].spanCount;i(e,t,s,u,r)}t.metrics.length>0&&_.descendants.push(t),e.delete(),e.continue()}))))}))))}))}}))}))}}var _e;!function(e){e.ALLOWED="allowed",e.DENIED="denied"}(_e||(_e={}));const we={".tag":"trigger_heartbeat"},Se={".tag":"trigger_publish"},be="UNCONFIGURED";function ye(e,t,n,s,i){const r=[];return t.forEach((e=>r.push(e))),{scopes:e,known_namespaces:r,environment:"prod",artifact_name:"dropbox-web",artifact_version:"0000000000000000000000000000000000000000",client_metadata:{client_version:25,implementation:{".tag":"typescript"}},trigger:n,os:s,origin_identifier:i}}function ke(e,t,i){return(r,o)=>n.__awaiter(this,void 0,void 0,(function*(){let n=[];if(r){const e=function(e,t){const n=e.getItem(Ee);if(null===n)return null;const i=Date.now()/1e3;let r,o=[];try{r=function(e,t){const n=s.protoBase64.dec(e);return t.fromBinary(n)}(n,ce)}catch(e){return t.reportException({err:e,tags:["js:web:amp-sink","js:web:amp-sink/local-storage"],severity:"non-critical"}),null}if(!r.config||!r.state||!r.timeStored)return t.reportStack("Sink cache was missing data",{tags:["js:web:amp-sink","js:web:amp-sink/local-storage"]}),null;const a=i-(c=r.timeStored.seconds,Number(c.toString()));var c;if(a<0)return t.reportStack("Sink cache was stored in the future instead of the past",{tags:["js:web:amp-sink","js:web:amp-sink/local-storage"],exc_extra:{cacheDataAge:a}}),null;const l={};r.config&&(o=r.config.reportingConfigs.map((e=>e.metricNamespace)),l.reporting_configs=r.config.reportingConfigs?r.config.reportingConfigs.filter((e=>a<e.maxTimeUntilRefreshSeconds)).map((e=>({metric_namespace:e.metricNamespace,max_time_until_refresh_seconds:e.maxTimeUntilRefreshSeconds,stop_publication_for_seconds:e.stopPublicationForSeconds,drop_samples:e.dropSamples?me(e.dropSamples):void 0,drop_periods:e.dropPeriods?me(e.dropPeriods):void 0,drop_fraction_of_hosts_per_metric:e.dropFractionOfHostsPerMetric,aggregation_interval_seconds:e.aggregationIntervalSeconds}))):[],l.publication_interval_seconds=r.config.publicationIntervalSeconds,l.max_scopes_per_request=r.config.maxScopesPerRequest,l.stop_publication_for_seconds=r.config.stopPublicationForSeconds,l.debug_infos=r.config.debugInfos);return{config:l,state:r.state,knownNamespaces:o}}(r,i);if(e){n=e.knownNamespaces;const t=new Set;e.config.reporting_configs.forEach((e=>t.add(e.metric_namespace)));if(!n.some((e=>!t.has(e))))return e}}const a=new Set;n.forEach((e=>a.add(e)));const c=t.detectOS(),l=yield e(),u=(yield l.clientMetricsRecord(ye([],a,we,c,o))).result,d=Math.floor(4294967296*Math.random())>>>0;return{knownNamespaces:n,config:u,state:new de({filterID:d,namespaceCoinState:{}})}}))}const Ee="amp-sink-cache";function xe(){return()=>{try{return window.localStorage||null}catch(e){return null}}}const Ne="amp-sink-origin-id";function Oe(e,t,n){try{const r=Math.floor(Date.now()/1e3),a=new ce({config:new ae({reportingConfigs:t.reporting_configs?t.reporting_configs.map((e=>new ie({metricNamespace:e.metric_namespace,maxTimeUntilRefreshSeconds:e.max_time_until_refresh_seconds,stopPublicationForSeconds:e.stop_publication_for_seconds,dropSamples:e.drop_samples?he(e.drop_samples):void 0,dropPeriods:e.drop_periods?he(e.drop_periods):void 0,dropFractionOfHostsPerMetric:e.drop_fraction_of_hosts_per_metric,aggregationIntervalSeconds:e.aggregation_interval_seconds}))):[],publicationIntervalSeconds:t.publication_interval_seconds,maxScopesPerRequest:t.max_scopes_per_request,stopPublicationForSeconds:t.stop_publication_for_seconds,debugInfos:t.debug_infos||[]}),timeStored:o.fromDate(new Date(1e3*r)),state:n});e.setItem(Ee,(i=a,s.protoBase64.enc(i.toBinary())))}catch(e){}var i}function Ce(e){return{clientMetricsRecord:t=>e.ns("client_metrics").rpc("record",t,{}).then((e=>({result:e})))}}function Te(e){return{clientMetricsRecord:t=>e("/api/2/client_metrics/record",{method:"POST",body:JSON.stringify(t)}).then((e=>{if(e.ok)return e.json().then((e=>e));throw new Error(e.statusText)}))}}function De(e){return{clientMetricsRecord:t=>e.clientMetricsRecord(t).then((e=>e)).then((e=>{if(e.ok)return e.json().then((e=>e));throw new Error(e.statusText)}))}}class Me{emit(e,...t){return!0}}class Ie{constructor(e,t,n,s,i,r,o,a,c,l,u,d=new Me){this.clientFactory=e,this.clock=t,this.initializer=n,this.cacheFactory=s,this.executor=i,this.randomEngine=r,this.databaseFactory=o,this.platformDetector=a,this.excReporter=c,this.originKind=l,this.eventEmitter=d,this.nextRequest=null,this.spanGroupFilter=null,this.knownNamespaces=new Set,this.bufferedSpans=[],this.bufferedSetSpans=[],this.instrumentation=L.empty(),this.blackoutCallback=null,this.publishTimer=null,this.database=null,this.cache=this.cacheFactory(),this.originIdentifier=function(e,t){if(e){let n=e.getItem(Ne);return null===n&&(n=t(),e.setItem(Ne,n)),n}return""}(this.cache,u),this.currentRequest=this.initializer(this.cache,this.originIdentifier).then((e=>(e&&this.updateConfiguration(e.config,e.state),this.eventEmitter.emit("initialized"),e.config||null)))}getOriginId(){return this.originIdentifier}updateConfiguration(e,t){const{reporting_configs:n=[],stop_publication_for_seconds:i,publication_interval_seconds:r}=e,o=new Set;n.forEach((e=>{this.knownNamespaces.add(e.metric_namespace),o.add(e.metric_namespace)})),this.updateBlackoutCallback({value:i,unit:s.TimeUnit.SECONDS}),this.updatePublishTimer({value:r,unit:s.TimeUnit.SECONDS}),this.updateSpanGroupFilter(e,t,o),this.cache&&Oe(this.cache,e,t)}updateSpanGroupFilter(e,t,n){const{reporting_configs:s=[],max_scopes_per_request:i}=e,r=new Set,o=n.values();for(let e=o.next();!e.done;e=o.next())r.add(e.value);const a=function(e,t){const n={};for(const s of e){const e=s.metric_namespace;n[e]={dropFractionOfHostsPerMetric:s.drop_fraction_of_hosts_per_metric||null,dropPeriodCoin:s.drop_periods?{config:s.drop_periods,state:t.namespaceCoinState&&t.namespaceCoinState[e]&&t.namespaceCoinState[e].dropPeriodCoin||pe()}:null,dropSamplesCoin:s.drop_samples?{config:s.drop_samples,state:t.namespaceCoinState&&t.namespaceCoinState[e]&&t.namespaceCoinState[e].dropSamplesCoin||pe()}:null}}return n}(s,t);this.spanGroupFilter=this.spanGroupFilter?this.spanGroupFilter.extend(i,a,r):new ve(t.filterID,this.randomEngine,this.clock,i,a,r)}updateBlackoutCallback(e){0!==e.value?(this.blackoutCallback=()=>(this.blackoutCallback=null,this.eventEmitter.emit("publicationResumed"),!1),this.eventEmitter.emit("publicationPaused"),this.executor.executeEvery(e,this.blackoutCallback)):this.blackoutCallback=null}updatePublishTimer(e){const t=e.unit===s.TimeUnit.SECONDS?e.value:c.toMilliseconds(e)/1e3;if(0===e.value)return void(this.publishTimer=null);if(this.publishTimer&&c.toMilliseconds(this.publishTimer.period)===c.toMilliseconds(e))return;const i={period:e,callback:()=>this.publishTimer===i&&(this.nextRequest=this.currentRequest.then((()=>n.__awaiter(this,void 0,void 0,(function*(){this.nextRequest=null;const e=Math.floor(Date.now()/1e3),s=yield this.getDB();if(s)try{const i=yield function(e,t,s){return new Promise(((i,r)=>n.__awaiter(this,void 0,void 0,(function*(){let n;try{n=e.transaction(z,"readwrite").objectStore(z)}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void i(!1);throw e}const o=n.get(K);o.addEventListener("success",(()=>{const e=o.result;if(e&&t-+e.value<s)return void i(!1);const a=n.put({name:K,value:t});a.addEventListener("success",(()=>{i(!0)})),a.addEventListener("error",(e=>{r(e)}))})),o.addEventListener("error",(e=>{r(e)}))}))))}(s,e,t);i&&(this.currentRequest=this.send())}catch(e){this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"})}})))),!0)};this.publishTimer=i,this.executor.executeEvery(this.publishTimer.period,this.publishTimer.callback)}send(){return n.__awaiter(this,void 0,void 0,(function*(){if(this.blackoutCallback)return this.eventEmitter.emit("publish",_e.DENIED),null;const e=Math.floor(Date.now()/1e3),t={browser:this.platformDetector.detectBrowser()},n=yield this.getDB();if(!n)return null;let s,i,r,o,a;try{({scopes:s,storedNamespaces:i,spansRetained:r,samplesRetainedByNs:o,observationsRetained:a}=yield this.spanGroupFilter.partitionAndSerializeSpans(n,t,e,[q]))}catch(e){return this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"}),null}let c=L.empty();c.retainedSpans+=r;let l=0;o.forEach(((e,t)=>{L.incrementRetainedSamples(c,t,e),l+=e}));let u=s.length>0;if(this.knownNamespaces.forEach((e=>i.add(e))),!u){const e=this.spanGroupFilter.getConfiguredNamespaces(),t=i.values();for(let n=t.next();!n.done;n=t.next())if(!e.has(n.value)){u=!0;break}}let d=null;if(u){c=yield ee(n,c);const e=this.platformDetector.detectOS(),o=ye(s,i,Se,e,this.originIdentifier),u=this.clock.now();c.requestAttempts++;try{const n=yield this.clientFactory();d=(yield n.clientMetricsRecord(o)).result,c=yield this.reportInstrumentation(e,c,u,t)}catch(e){c.requestDroppedSpans+=r,c.requestDroppedSamples+=l,c.requestDroppedSetObservations+=a}d&&this.updateConfiguration(d,this.spanGroupFilter.getState())}return yield Q(n,c),this.eventEmitter.emit("publish",_e.ALLOWED),d}))}reportInstrumentation(e,t,s,i){return n.__awaiter(this,void 0,void 0,(function*(){const n=c.toMilliseconds(this.clock.now())-c.toMilliseconds(s);if(function(e){return!!e.name&&("android"===e.name[".tag"]||"ios"===e.name[".tag"])}(e))try{const s=Object.assign({client_version:25..toString(),origin_kind:this.originKind},i),r=L.toScope(t,this.originIdentifier,n,s),o=ye([r],new Set([q]),Se,e,this.originIdentifier),a=yield this.clientFactory();return yield a.clientMetricsRecord(o),L.empty()}catch(e){return t}return L.report(t,C.root(this,this.clock,this.originIdentifier),n,25,this.originKind)}))}getDB(){return n.__awaiter(this,void 0,void 0,(function*(){return this.database||(this.database=yield this.databaseFactory()),this.database}))}recordSpan(e){if(e.namespace!==q){let t=be;this.spanGroupFilter&&this.spanGroupFilter.getConfiguredNamespaces().has(e.namespace)&&(t=e.namespace),this.instrumentation.submittedSpans++,L.incrementSubmittedSamples(this.instrumentation,t,e.samples.length)}this.knownNamespaces.add(e.namespace),this.bufferedSpans.push(e),this.maybeScheduleNextRequest()}recordSetSpan(e){if(e.namespace!==q){let t=be;this.spanGroupFilter&&this.spanGroupFilter.getConfiguredNamespaces().has(e.namespace)&&(t=e.namespace),L.incrementSetObservations(this.instrumentation,t,e.samples.length)}this.knownNamespaces.add(e.namespace),this.bufferedSetSpans.push(e),this.maybeScheduleNextRequest()}maybeScheduleNextRequest(){this.nextRequest||(this.nextRequest=this.currentRequest.then((()=>n.__awaiter(this,void 0,void 0,(function*(){const e=yield this.getDB();if(!e)return;const t=this.bufferedSpans,n=this.bufferedSetSpans;this.bufferedSpans=[],this.bufferedSetSpans=[];const s=this.instrumentation;this.instrumentation=L.empty();try{yield Promise.all([Y(e,t),X(e,n),Q(e,s)])}catch(e){this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"})}this.publishTimer||(this.currentRequest=this.send()),this.nextRequest=null})))))}}function Re(){return new a}const Be=xe();function Pe(e){var t;let n;n="clientFactory"in e?e.clientFactory:"client"in e?()=>Promise.resolve(Ce(e.client)):"sdk"in e?()=>Promise.resolve(De(e.sdk)):()=>Promise.resolve(Te(e.fetch));let{platformDetector:i,exceptionReporter:r,identifierFactory:o,originKind:a}=e,c=null===(t=window.sinkSingleton)||void 0===t?void 0:t.clientFactory;if(void 0!==c&&(n=c),void 0===i&&(i={detectBrowser:()=>"other",detectOS:()=>({name:{".tag":"unknown_os"},version:"unknown"})}),void 0===r&&(r={reportException:e=>{},reportStack:(e,t)=>{}}),void 0===o&&(o=()=>""),void 0===a&&(a="unknown"),window.sinkSingleton)return window.sinkSingleton.clientFactory=n,window.sinkSingleton;const u=new Ie(n,Re(),ke(n,i,r),Be,new l((()=>({value:5*Math.random(),unit:s.TimeUnit.SECONDS}))),Math.random,$,i,r,a,o);return window.sinkSingleton=u,u}var qe={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function s(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function r(e,t,s,r,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var a=new i(s,r||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,s,i=[];if(0===this._eventsCount)return i;for(s in e=this._events)t.call(e,s)&&i.push(n?s.slice(1):s);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=n?n+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var i=0,r=s.length,o=new Array(r);i<r;i++)o[i]=s[i].fn;return o},a.prototype.listenerCount=function(e){var t=n?n+e:e,s=this._events[t];return s?s.fn?1:s.length:0},a.prototype.emit=function(e,t,s,i,r,o){var a=n?n+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,s),!0;case 4:return u.fn.call(u.context,t,s,i),!0;case 5:return u.fn.call(u.context,t,s,i,r),!0;case 6:return u.fn.call(u.context,t,s,i,r,o),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var p,m=u.length;for(l=0;l<m;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,s);break;case 4:u[l].fn.call(u[l].context,t,s,i);break;default:if(!c)for(p=1,c=new Array(d-1);p<d;p++)c[p-1]=arguments[p];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(e,t,n){return r(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return r(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,s,i){var r=n?n+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||i&&!a.once||s&&a.context!==s||o(this,r);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==t||i&&!a[c].once||s&&a[c].context!==s)&&l.push(a[c]);l.length?this._events[r]=1===l.length?l[0]:l:o(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a}(qe);var Le=qe.exports;class Fe{constructor(e,t){this.cacheFactory=e,this.innerSink=t,this.eventEmitter=new Le,this.onUnloadChange=()=>{this.isUnload()||this.flushToInner()},this.persistor=new Je(this.cacheFactory()),this.listener=new je(this.onUnloadChange),this.onUnloadChange()}flushToInner(){this.persistor.getAllAndClear().forEach((e=>{this.recordSpanToInner(e)}))}isUnload(){return Boolean(this.listener.isUnload)}recordSpan(e){if(this.isUnload())return this.persistor.persistSpans([e]),void this.eventEmitter.emit("spansPersistedInUnload");this.recordSpanToInner(e)}recordSetSpan(e){}recordSpanToInner(e){const t=Object.assign(Object.assign({},e),{fromUnloadSink:!0});this.innerSink.recordSpan(t)}}class je{constructor(e){this.onUnloadChange=e,this._isUnload=!1,this.listenForNavigationChanges()}get isUnload(){return this._isUnload}set isUnload(e){this._isUnload!==e&&(this._isUnload=e,this.onUnloadChange())}listenForNavigationChanges(){if("undefined"!=typeof window&&"function"==typeof window.addEventListener&&"function"==typeof document.addEventListener){const e=()=>{"hidden"===document.visibilityState?this.isUnload=!0:"visible"===document.visibilityState&&(this.isUnload=!1)},t=()=>{this.isUnload=!0,window.removeEventListener("pagehide",t),document.removeEventListener("visibilitychange",e)};window.addEventListener("pagehide",t),document.addEventListener("visibilitychange",e)}}}class Je{constructor(e){this.cache=e,this.CACHE_KEY="amp-persisted-spans-v2",this.OLD_CACHE_KEY="amp-persisted-spans"}getAllAndClear(){if(!this.cache)return[];const e=this.retrieveSpans();try{this.cache.setItem(this.CACHE_KEY,JSON.stringify([])),this.cache.removeItem(this.OLD_CACHE_KEY)}catch(e){}return e}persistSpans(e){if(!this.cache||!e)return;const t=this.retrieveSpans();t.push(...e);try{this.cache.setItem(this.CACHE_KEY,JSON.stringify(t))}catch(e){}}retrieveSpans(){let e=[];try{e=JSON.parse(this.cache.getItem(this.CACHE_KEY))}catch(e){}return e||[]}}const Ue=(()=>{let e,t;const n=[];for(t=0,e=t;t<=255;t++,e=t)n.push((e+256).toString(16).substr(1));return n})();class Ae{static bytesToHex(e){return e.map((e=>Ue[e])).join("")}static toByte(e){return 255&e}static bytesToUUIDString(e){return[e.slice(0,4),e.slice(4,6),e.slice(6,8),e.slice(8,10),e.slice(10,16)].map((e=>this.bytesToHex(e))).join("-")}static getRandomBytes(){const e=new Array(16);return this.getInsecureRandomValues(e),e.map((e=>this.toByte(e)))}static getInsecureRandomValues(e){const t=Math.pow(2,8);for(let n=0;n<e.length;n++)e[n]=Math.floor(Math.random()*t);return e}static v4(){const e=this.getRandomBytes();return e[6]=15&e[6]|64,e[8]=63&e[8]|128,this.bytesToUUIDString(e)}}function ze(){return new a}function Ke(){return n.__awaiter(this,void 0,void 0,(function*(){const{NoAuthApiV2Client:t}=yield new Promise((function(t,n){e(["./c_api_v2_noauth_client"],t,n)})).then((function(e){return e.noauth_client_esnext}));return Ce(new t)}))}function Ve(){return()=>Ae.v4()}function Ze(){return{detectBrowser:He,detectOS:Ge}}function He(){const e=[[!!r.chrome,"chrome"],[!!r.edge,"edge"],[!!r.mozilla,"firefox"],[!!r.msie,"msie"],[!!r.safari,"safari"]];for(const t of e)if(t[0])return t[1];return"other"}function Ge(){return r.mac?{name:{".tag":"mac"},version:"unknown"}:r.windows?{name:{".tag":"windows"},version:(e=r.windowsInfo,e.windowsXP||e.windowsXPx64?"XP":e.windowsVista?"Vista":e.windows7?"7":e.windows8?"8":e.windows8_1?"8.1":e.windows10?"10 Unknown":"unknown")}:r.is_android()?{name:{".tag":"android"},version:"unknown"}:r.iOS?{name:{".tag":"ios"},version:"unknown"}:{name:{".tag":"unknown_os"},version:"unknown"};var e}const $e=xe(),Ye="metaserver";const Xe=new class{constructor(){this.spans=[],this.bridgeInitialized=!1}recordSpan(e){this.spans.push(e),this.bridgeInitialized||this.initializeBridgeSink()}recordSetSpan(e){}initializeBridgeSink(){return n.__awaiter(this,void 0,void 0,(function*(){this.bridgeInitialized=!0;const t=yield new Promise((function(t,n){e(["./c_server_side_client_view_bridge"],t,n)}));(yield t.IsBridgeFunctionSupported("reportMetricsV2"))?(setInterval((()=>{this.spans.length>0&&(t.ReportMetrics(this.spans),this.spans=[])}),5e3),window.addEventListener("beforeunload",(()=>{this.spans.length>0&&(console.log(`Attempting to send ${this.spans.length} pending AMP spans`),t.ReportMetrics(this.spans),this.spans=[])}))):setInterval((function(){this.spans=[]}),6e4)}))}};function We(){const e=Pe({clientFactory:Ke,platformDetector:Ze(),exceptionReporter:i.JSException,identifierFactory:Ve(),originKind:Ye});return void 0!==window._clientBridge?C.root(Xe,ze(),e.getOriginId()):C.root(e,ze(),e.getOriginId())}function Qe(){const e=Pe({clientFactory:Ke,platformDetector:Ze(),exceptionReporter:i.JSException,identifierFactory:Ve(),originKind:Ye}),t=function(e){void 0===e&&(e=Ke);const t=Pe({clientFactory:e,originKind:Ye});if(window.unloadSinkSingleton)return window.unloadSinkSingleton;const n=new Fe($e,t);return window.unloadSinkSingleton=n,n}();return C.root(t,ze(),e.getOriginId())}var et=Object.freeze({__proto__:null,getMetricsReporter:We,getUnloadMetricsReporter:Qe});t.EventEmitter=Le,t.InsecureUUID=Ae,t.clientBaseAdaptor=Ce,t.clientFetchAdaptor=Te,t.clientSDKAdaptor=De,t.getMetricsReporter=function(e){const t=Pe(e);return C.root(t,Re(),t.getOriginId())},t.getMetricsReporter$1=We,t.getUnloadMetricsReporter=Qe,t.index_esnext=et}));
//# sourceMappingURL=c_src_sink_index.js-vflPNyl5h.map
