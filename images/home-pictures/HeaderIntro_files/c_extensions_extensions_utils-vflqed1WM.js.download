define(["exports","./e_ui_page_files_router","./c_tslib","./e_edison","./c_core_i18n","./c_spectrum_modal_utility_modal","./c_ux_analytics_modal_tracking","./c_extensions_data_selectors","./c_browser_cookies","./c_core_notify","./c_core_uri","./c_api_v2_noauth_client","metaserver/static/js/modules/constants/payments","./c_account_email","./c_account_email_verify_reasons","./c_apex-metrics_src_types","./c_lodash-es_lodash","./c_ui-icon_fill_fail","./c_file_store_utils","./c_file_viewer_sdk_file_viewer_experiments","./c_unity_check_file_cache","./c_unity_features","./c_core_browser_detection","./c_downloads"],(function(e,t,i,n,s,a,o,r,c,l,d,p,u,m,_,f,g,h,y,x,v,E,b,w){"use strict";function I(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var M=I(u);class A{constructor(e){this.category="web-app_actions_telemetry",this.user_id=null,this.session_id=null,this.request_id=null,this.url=null,this.telemetry_session_id=e.telemetry_session_id,this.event_name=e.event_name,this.event_start_ts=e.event_start_ts,this.event_extras=e.event_extras,Object.seal(this)}}class T{constructor(e,t){this.logger=e,this.context=t,this.sessionId=T.generateRandomId()}static generateRandomId(){return Math.random().toString(36).substring(2)}static getCurrentTimestamp(){return(new Date).getTime()}event(e,t){const i=T.getCurrentTimestamp(),n=Object.assign(Object.assign({},this.context),t),s=new A({telemetry_session_id:this.sessionId,event_name:e,event_start_ts:i,event_extras:JSON.stringify(n)});this.logger.log(s)}}class N{constructor(e,t){this.logger=e,this.context=t||{}}session(e){const t=Object.assign(Object.assign({},this.context),e);return new T(this.logger,t)}}const O=new t.HiveLogger;function C(e){return new N(O,e)}const D=function(e){const t={};for(const i of e)t[i]=!0;return t}(["",".doc",".docx",".pdf",".dwg",".png",".jpg",".jpeg",".tiff",".m4v",".wmv",".mpg",".pptx",".xlsx",".pages",".numbers",".key"]);function S(e){return D[e]?e:"__REDACTED__"}class R extends f.Message{constructor(e){super(),this.pageType=$.DEFAULT,this.actionId="",this.appName="",this.iconUrl="",this.userId=f.protoInt64.zero,this.fileId="",this.fileName="",f.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new R).fromBinary(e,t)}static fromJson(e,t){return(new R).fromJson(e,t)}static fromJsonString(e,t){return(new R).fromJsonString(e,t)}static equals(e,t){return f.proto3.util.equals(R,e,t)}}var $,k;R.runtime=f.proto3,R.typeName="extensions.AuthPageProps",R.fields=f.proto3.util.newFieldList((()=>[{no:1,name:"pageType",kind:"enum",T:f.proto3.getEnumType($)},{no:2,name:"actionId",kind:"scalar",T:9},{no:3,name:"appName",kind:"scalar",T:9},{no:4,name:"iconUrl",kind:"scalar",T:9},{no:5,name:"userId",kind:"scalar",T:3},{no:6,name:"fileId",kind:"scalar",T:9},{no:7,name:"fileName",kind:"scalar",T:9},{no:8,name:"webTimingLoggerServerContext",kind:"message",T:t.WebTimingLoggerServerContext}])),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.LINK_ONLY=1]="LINK_ONLY"}($||($={})),f.proto3.util.setEnumType($,"extensions.AuthPageProps.PageType",[{no:0,name:"DEFAULT"},{no:1,name:"LINK_ONLY"}]);class U extends f.Message{constructor(e){super(),this.pageType=k.DEFAULT,this.role="",this.fileName="",this.maxFileSize=f.protoInt64.zero,this.isTeam=!1,f.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new U).fromBinary(e,t)}static fromJson(e,t){return(new U).fromJson(e,t)}static fromJsonString(e,t){return(new U).fromJsonString(e,t)}static equals(e,t){return f.proto3.util.equals(U,e,t)}}U.runtime=f.proto3,U.typeName="extensions.StatusPageProps",U.fields=f.proto3.util.newFieldList((()=>[{no:1,name:"pageType",kind:"enum",T:f.proto3.getEnumType(k)},{no:2,name:"role",kind:"scalar",T:9},{no:3,name:"fileName",kind:"scalar",T:9},{no:4,name:"maxFileSize",kind:"scalar",T:3},{no:5,name:"isTeam",kind:"scalar",T:8}])),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.QUOTA=1]="QUOTA",e[e.DOCUSIGN=2]="DOCUSIGN",e[e.ACCESS=3]="ACCESS",e[e.UNVERIFIED_EMAIL=4]="UNVERIFIED_EMAIL",e[e.FILE_TOO_LARGE=5]="FILE_TOO_LARGE",e[e.DOCUSIGN_INVALID_FILE=6]="DOCUSIGN_INVALID_FILE"}(k||(k={})),f.proto3.util.setEnumType(k,"extensions.StatusPageProps.PageType",[{no:0,name:"DEFAULT"},{no:1,name:"QUOTA"},{no:2,name:"DOCUSIGN"},{no:3,name:"ACCESS"},{no:4,name:"UNVERIFIED_EMAIL"},{no:5,name:"FILE_TOO_LARGE"},{no:6,name:"DOCUSIGN_INVALID_FILE"}]);const F=e=>{const i=n.static_url(`/static/metaserver/static/images/illustration_catalog/${e.illustrationName}.png`),s=n.static_url(`/static/metaserver/static/images/illustration_catalog/${e.illustrationName}@2x.png`);return n.React$1.createElement("div",{className:"app-actions-status-page"},n.React$1.createElement(t.Image,{className:"app-actions-status-image",src:i,srcHiRes:s}),n.React$1.createElement("div",{className:"app-actions-status-content"},e.children))},L=e=>n.React$1.createElement(F,{illustrationName:e.illustrationName},n.React$1.createElement("div",{className:"app-actions-status-text"},n.React$1.createElement("div",{className:"app-actions-status-text__header"},e.headerText)),n.React$1.createElement("div",{className:"app-actions-status-detail"},e.detailText),n.React$1.createElement(t.Button$1,{className:"app-actions-status-button",onClick:e.buttonOnClick,href:e.buttonHref,variant:"primary"},e.buttonTitle));function P(){window.close()}const B=t.requireCssWithComponent((e=>n.React$1.createElement("div",{className:"app-actions-status-page"},n.React$1.createElement(t.Image,{className:"app-actions-status-image",src:n.static_url("/static/metaserver/static/images/dbx_cloud_doc_loading-vfl9ZK2NS.gif")}),n.React$1.createElement("div",{className:"app-actions-status-detail"},e.fileName))),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/components/loading_indicator-vflIkyDZA.css"]);t.requireCssWithComponent((e=>n.React$1.createElement(L,{illustrationName:"sickbox-illo_m1",headerText:s.intl.formatMessage({id:"G79Iwz",defaultMessage:"Oops... something went wrong"}),detailText:s.intl.formatMessage({id:"ZvMuf8",defaultMessage:"Oh no, it looks like we failed to load your file. Please return to Dropbox and try once more."}),buttonOnClick:P,buttonTitle:s.intl.formatMessage({id:"u/p3Pl",defaultMessage:"Close"})})),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css"]),t.requireCssWithComponent((e=>{let t=M.OUT_OF_SPACE_URL+"?oqa=wb_oq_aa",i=s.intl.formatMessage({id:"iIucBq",defaultMessage:"Get more space"});return e.isTeam&&(t="/help/business/space-limit-full",i=s.intl.formatMessage({id:"K2PjtT",defaultMessage:"Learn more about Dropbox space"})),n.React$1.createElement(L,{illustrationName:"illo-catbox",headerText:s.intl.formatMessage({id:"0eDgXK",defaultMessage:"Your Dropbox is full"}),detailText:s.intl.formatMessage({id:"nyrsTE",defaultMessage:"Uh oh, in order to perform this action, you need to add more storage to your Dropbox."}),buttonTitle:i,buttonHref:t})}),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css"]),t.requireCssWithComponent((e=>n.React$1.createElement(L,{illustrationName:"account_requires_access",headerText:s.intl.formatMessage({id:"lZ3sPD",defaultMessage:"Your DocuSign account has restricted access"}),detailText:s.intl.formatMessage({id:"lF/7ht",defaultMessage:"It looks like your DocuSign account does not have permission to send envelopes. Please contact your DocuSign admin."}),buttonTitle:s.intl.formatMessage({id:"u/p3Pl",defaultMessage:"Close"}),buttonOnClick:P})),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css"]),t.requireCssWithComponent((e=>n.React$1.createElement(L,{illustrationName:"403_error-illo",headerText:s.intl.formatMessage({id:"G79Iwz",defaultMessage:"Oops... something went wrong"}),detailText:s.intl.formatMessage({id:"NiMCaD",defaultMessage:"You do not have access to update files in this folder."}),buttonTitle:s.intl.formatMessage({id:"u/p3Pl",defaultMessage:"Close"}),buttonOnClick:P})),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css"]),t.requireCssWithComponent((e=>n.React$1.createElement(L,{illustrationName:"illo-catbox",headerText:s.intl.formatMessage({id:"Bf160P",defaultMessage:"Verify Your Email"}),detailText:s.intl.formatMessage({id:"Vg1D7j",defaultMessage:"In order to perform this action, Dropbox needs to verify your email address to share links."}),buttonTitle:s.intl.formatMessage({id:"DUVaTi",defaultMessage:"Verify Email"}),buttonOnClick:()=>{return t=e.role,void m.EmailVerification.getForRole(t).show_verify_modal(void 0,_.EmailVerificationReasons.GENERIC);var t}})),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css","/static/metaserver/static/css/account/emails-vflCpG_Hm.css","/static/metaserver/static/css/maestro_layout-vflBbM3bK.css","/static/metaserver/static/css/upsell/prompt_pagelet-vflF_HvCV.css","/static/metaserver/static/css/notify-vfl4oJv2S.css"]),t.requireCssWithComponent((({maxFileSize:e})=>{const t=Number(e),i=(a=t,isFinite(a)&&a>0?s.intl.formatMessage({id:"fQlkHi",defaultMessage:"The file you selected is larger than the supported {supported_value}MB. Please try again with a smaller file."},{supported_value:t.toString(10)}):s.intl.formatMessage({id:"WMJEtg",defaultMessage:"The file you selected is larger than supported. Please try again with a smaller file."}));var a;return n.React$1.createElement(L,{illustrationName:"illo-catbox",headerText:s.intl.formatMessage({id:"4pvYSI",defaultMessage:"Can’t open file"}),detailText:i,buttonTitle:s.intl.formatMessage({id:"QeGZf9",defaultMessage:"Return to Dropbox"}),buttonOnClick:P})}),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css"]),t.requireCssWithComponent((e=>n.React$1.createElement(L,{illustrationName:"illo-catbox",headerText:s.intl.formatMessage({id:"4pvYSI",defaultMessage:"Can’t open file"}),detailText:s.intl.formatMessage({id:"+3VSGf",defaultMessage:"The file you selected cannot be validated in DocuSign. Please try again with a valid file."}),buttonTitle:s.intl.formatMessage({id:"u/p3Pl",defaultMessage:"Close"}),buttonOnClick:P})),["/static/metaserver/static/css/app_actions/status_page-vflxeNuOK.css","/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css"]);class W extends n.React$1.Component{constructor(e){super(e),this.clickAuthorize=()=>{this.currentSession.event("auth_accept",{action_id:this.props.actionId}),this.props.doAuth()},this.learnMoreOnClick=()=>{this.currentSession.event("learn_more",{action_id:this.props.actionId}),this.props.onLearnMore&&this.props.onLearnMore()},this.telemetryClient=C({component:"auth_v2"})}componentDidMount(){this.currentSession.event("auth_start",{action_id:this.props.actionId})}renderText(){const e=0!==this.props.fileId.length?t.defineMessage({id:"VDSuu6",defaultMessage:"<b>{app_name}</b> needs access to this file"}):t.defineMessage({id:"mZo8K4",defaultMessage:"<b>{app_name}</b> needs access to files you select"}),i=0!==this.props.fileId.length?t.defineMessage({id:"hE6l1Q",defaultMessage:"Changes to this file using {app_name} will save back to Dropbox. This app will have access to the username, email address, and country for your account."}):t.defineMessage({id:"HsAedA",defaultMessage:"Changes to selected files using {app_name} will save back to Dropbox. This app will have access to the username, email address, and country for your account."});return n.React$1.createElement("div",null,n.React$1.createElement("div",{className:"auth-text-header-v2"},s.intl.formatMessage(e,{app_name:this.props.appName,b:e=>n.React$1.createElement("b",null,e)})),n.React$1.createElement("div",{className:"auth-text-v2"},s.intl.formatMessage(i,{app_name:this.props.appName}),n.React$1.createElement("a",{className:"learn-more-link",href:"/help/security/third-party-apps",target:"_blank",rel:"noopener noreferrer",onClick:this.learnMoreOnClick},s.intl.formatMessage({id:"gk12sS",defaultMessage:"Learn more"}))))}renderButtons(){return n.React$1.createElement("div",null,n.React$1.createElement(t.Button$1,{variant:"primary",className:"auth-button-v2",onClick:this.clickAuthorize},s.intl.formatMessage({id:"LGeX5c",defaultMessage:"Allow"})))}renderAuthorization(){const{appName:e,iconUrl:t}=this.props;return n.React$1.createElement("div",{id:"auth",className:"auth-connect-frame-v2"},n.React$1.createElement("div",null,n.React$1.createElement("img",{className:"app-icon-v2",src:t,alt:e})),n.React$1.createElement("div",null,this.renderText()),n.React$1.createElement("div",{id:"buttons"},this.renderButtons()))}render(){const{fileName:e}=this.props;return this.currentSession=this.telemetryClient.session({ext:S("."+t.file_extension(e))}),this.props.showLoadingUI?n.React$1.createElement(B,{fileName:e}):this.renderAuthorization()}}W.displayName="AuthBodyV2Component";const H=t.requireCssWithComponent(W,["/static/metaserver/static/css/spectrum/index.web-vflJy4G-t.css","/static/metaserver/static/css/foundation-vflZkvt4R.css","/static/metaserver/static/css/app_actions/index-vflXUc6ye.css"]),j=e=>n.React$1.createElement(t.Modal$1,{className:"extensions-auth-modal-v2",ariaLabel:"Access Modal",displayCloseButton:!0,clickOutToClose:!1,style:"clean",onDismiss:e.doCancel},n.React$1.createElement(o.UXAnalyticsModalTracking,{id:"EXTENSIONS_AUTH_MODAL_V2"}),n.React$1.createElement(H,Object.assign({},e)));function V(e,t,n){return i.__awaiter(this,void 0,void 0,(function*(){const i=new p.FetchAsyncTransport,s=new d.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),a={};a["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),a["X-Dropbox-Uid"]=e.id.toString();const o=c.Cookies.read("__Host-js_csrf");if(!o)throw new Error("No CSRF cookie");return a["X-CSRF-Token"]=o,i.executeRpc(s,a,JSON.stringify(n),"application/json")}))}function q(e,t,n){return i.__awaiter(this,void 0,void 0,(function*(){const i=yield V(e,t,n),s={request_id:i.headers["x-dropbox-request-id"],redirect_url:i.result.redirect_url};return"link_state"in i.result&&(s.link_state=i.result.link_state),s}))}function G(e,t){if(1!==e.length)throw new Error(`Expected single file: ${t}`);return e[0]}function z(e,s,a,o,c,l,d){return i.__awaiter(this,void 0,void 0,(function*(){if("redirect"===a.handler[".tag"]){const o=a.handler.window_params;let r;if("popup"===o[".tag"]){const{width:e,height:t}=o;r=`width=${e},height=${t}`}if("sfa_unlinked"===a.link_state[".tag"]&&!a.id.startsWith("fp_action_id:")){const o=G(s,"first party actions do not support multiple files yet."),c=t.filename(o.ns_path);!function(e,i,s,a,o,r){t.Modal$1.showInstance(n.React$1.createElement(j,{actionId:e,appName:i,iconUrl:s,fileId:a,fileName:o,doAuth:r,doCancel:t.Modal$1.close}))}(a.id,a.description,a.icon.url,o.file_id,c,(()=>{t.Modal$1.close(),function(e,t,n,s,a,o){i.__awaiter(this,void 0,void 0,(function*(){const r=yield function(e,t,n,s,a){return i.__awaiter(this,void 0,void 0,(function*(){const i=()=>q(e,"authorize",{action_id:t,file_id:s});return yield K(e,t,n,s,i,a)}))}(e,t,n,s,a);o&&r&&r.link_state&&o(t,r.link_state)}))}(e,a.id,a.description,o.file_id,r,l)}))}else{const t=s.map((e=>e.file_id));!function(e,t,n,s,a){i.__awaiter(this,void 0,void 0,(function*(){yield K(e,t,n,s[0],(()=>q(e,"redirect",{action_id:t,file_ids:s})),a)}))}(e,a.id,a.description,t,r)}}else if("cloud_editor"===a.handler[".tag"]){const i=G(s,"cloud docs actions do not support multiple files yet."),n=c?t.getActionSourceFromSurface(c.surface):void 0,o=r.cloudEditorNameToParams(a.handler.editor_name);t.openWithCloudEditor(t.fileToOpenWithParams(i),e.id,o,!1,n)}else{if("profile_service"!==a.handler[".tag"])throw new Error(`Unexpected handler "${a.handler[".tag"]}"`);if(d){const t=G(s,"profile service actions do not support multiple files yet.");d(e,t,a)}}}))}function K(e,n,a,o,r,c){return i.__awaiter(this,void 0,void 0,(function*(){const d=`action_redirect_${Math.random().toString(16).substring(2)}`,p=window.open("",d,c);p&&(p.document.open("text/html","replace"),p.document.write(`<html><head><title>${g.escape(a)}</title></head></html>`),p.document.close());let u=!1;const m=new Promise((i=>{t.SilentBackgroundRequest$1({url:"/aa/loading",subject_user:e.id,data:{file_id:o,action_id:n},success:e=>{!u&&p?(p.document.open("text/html","replace"),p.document.write(e),p.document.close(),p.document.title=a,i()):i()},error:()=>{i()}})}));const[,_]=yield Promise.all([m,function(){return i.__awaiter(this,void 0,void 0,(function*(){try{return yield r()}catch(e){return void(u=!0)}}))}()]),f=_&&_.redirect_url||"/aa/error";if(p)p.location.replace(f);else{if(!window.open(f,"_blank",c)){const e=a;l.Notify.error(s.intl.formatMessage({id:"TFhSer",defaultMessage:"Failed to open {app_name}"},{app_name:e}))}}return _}))}var J;!function(e){e[e.UNVERIFIED=0]="UNVERIFIED",e[e.IN_DEVELOPMENT=1]="IN_DEVELOPMENT",e[e.ENABLED=2]="ENABLED",e[e.DISABLED=3]="DISABLED"}(J||(J={}));t.injectInternalStyle("metaserver/static/js/extensions/extensions_mini_directory_modal.module.out.css",(e=>"._extensions-mini-directory-modal_tgmgc_1{display:flex;flex-direction:column;left:auto;margin:100px auto;max-height:604px;position:static;top:auto;transform:none;width:500px}._extensions-mini-directory-modal-overlay_tgmgc_15{z-index:501}._extensions-mini-directory-modal_tgmgc_1>.mc-modal-body{height:100%}._body-wrapper_tgmgc_24{display:flex;flex-direction:column;height:100%;overflow:hidden}._header-border_tgmgc_31{border-bottom:1px solid var(--color__standard__border)}._title_tgmgc_35{padding-left:24px;padding-right:24px;padding-top:24px}._search-bar_tgmgc_41{margin:16px 24px 8px}._empty-search-app-center_tgmgc_45{align-items:center;display:flex;flex-direction:column;margin-top:172px}._directory-entry-point_tgmgc_52{border-top:1px solid var(--color__standard__border);box-sizing:border-box;flex-grow:0;flex-shrink:0;height:80px;padding-bottom:30px;padding-left:20px;padding-top:28px}._directory-entry-point-text-border_tgmgc_63{border-bottom:1px solid var(--color__standard__border)}._extensions-container_tgmgc_67{display:flex;flex-direction:column;flex-grow:1;overflow-y:auto}._extension-section_tgmgc_74{border:none;box-sizing:border-box;display:flex;flex-direction:row;flex-shrink:0;height:96px;margin:0 24px}._extension-section_tgmgc_74:not(:last-of-type){border-bottom:1px solid var(--color__standard__border)}._extensions-icon_tgmgc_88{flex-shrink:0;height:48px;margin-bottom:24px;margin-right:16px;margin-top:20px;object-fit:contain;width:48px}._extensions-description-link_tgmgc_98{display:block}._extensions-description_tgmgc_98{display:flex;flex-direction:column;flex-grow:1;margin:16px 0 14px;width:100%}._extensions-short-description_tgmgc_110{-webkit-box-orient:vertical;-webkit-line-clamp:2;display:-webkit-box;max-height:40px;overflow:hidden}._redirect-button-wrapper_tgmgc_118{flex-shrink:0;margin-bottom:40px;margin-left:16px;margin-top:20px}._redirect-button_tgmgc_118{height:32px;min-width:100px}._body-loading_tgmgc_130{align-items:center;display:flex;height:100%;justify-content:center}"));const Y="_extensions-mini-directory-modal_tgmgc_1",Q="_extensions-mini-directory-modal-overlay_tgmgc_15",X="_body-wrapper_tgmgc_24",Z="_header-border_tgmgc_31",ee="_title_tgmgc_35",te="_search-bar_tgmgc_41",ie="_empty-search-app-center_tgmgc_45",ne="_directory-entry-point_tgmgc_52",se="_directory-entry-point-text-border_tgmgc_63",ae="_extensions-container_tgmgc_67",oe="_extension-section_tgmgc_74",re="_extensions-icon_tgmgc_88",ce="_extensions-description-link_tgmgc_98",le="_extensions-description_tgmgc_98",de="_extensions-short-description_tgmgc_110",pe="_redirect-button-wrapper_tgmgc_118",ue="_redirect-button_tgmgc_118",me="_body-loading_tgmgc_130",_e=e=>"api_app"===e[".tag"]?`${e[".tag"]}/${e.api_app}`:"first_party_app"===e[".tag"]?`${e[".tag"]}/${e.first_party_app}`:`${e[".tag"]}`;function fe(){return n.React$1.createElement("div",{className:ne},n.React$1.createElement(t.Link,{href:"/apps",hasNoUnderline:!0,variant:"monochromatic",className:se},n.React$1.createElement(t.Text,{isBold:!0},s.intl.formatMessage({id:"LbLi52",defaultMessage:"View all apps"}))))}class ge extends n.React$1.Component{constructor(e){super(e),this.hasUsedSearchBar=!1,this.onScroll=g.throttle((e=>{e>0&&!this.state.showTopBorder&&this.setState({showTopBorder:!0}),0===e&&this.state.showTopBorder&&this.setState({showTopBorder:!1})}),20),this.createClickHandler=e=>()=>{t.Modal$1.close();const{user:i,file:n,featureFlags:s,currentSession:a,telemetryContext:o,updateLinkState:c,onProfileServiceAuth:l}=this.props;if(z(i,[n],e,0,o,c,l),"redirect"===e.handler[".tag"])r.logEvent(a,"select_action",r.getAppActionExtras(e));else if("cloud_editor"===e.handler[".tag"]){const t=r.isWopiAction(e)?r.OpenButtonAction.OPEN_WITH:r.OpenButtonAction.OPEN_WITH_CLOUD_DOC;r.logEvent(this.props.currentSession,"select_legacy_action",{type:t})}},this.handleQueryChange=e=>{const t=e.currentTarget.value;this.setState({searchKey:t}),this.hasUsedSearchBar||(r.logEvent(this.props.currentSession,"start_searching",{}),this.hasUsedSearchBar=!0)},this.filterActions=()=>{const{appActions:e,categoryIdToInfos:t}=this.props,i=this.state.searchKey.trim().toLowerCase(),n=e.map((e=>e.category)).map((e=>t[e])).filter((e=>-1!==e.display_name.toLowerCase().indexOf(i))).map((e=>e.id));return e.filter((e=>{const t=this.getAppDirectoryPageInfo(e);return((e,t)=>t||e.app_directory_id&&"first_party_app"===e.app_directory_id[".tag"]||e.developer_state===J.IN_DEVELOPMENT)(e,t)&&(-1!==e.description.toLowerCase().indexOf(i)||(e=>!(!e||!e.short_description)&&-1!==e.short_description.toLowerCase().indexOf(i))(t)||n.includes(e.category))}))},this.clearSearch=()=>{this.setState({searchKey:""})},this.renderExtensionItem=e=>{const i=e.icon,a=i.is_static?n.static_url("/static/metaserver/static/images/generic_app_icon-vflIPYT1H.png"):i.url,o=r.isLinked(e),c=o?"primary":"opacity",l=o?r.isShareAction(e)?s.intl.formatMessage({id:"NoV3Co",defaultMessage:"Share"}):s.intl.formatMessage({id:"CNPdm5",defaultMessage:"Open"}):s.intl.formatMessage({id:"vV9l+M",defaultMessage:"Connect"});return n.React$1.createElement("div",{"data-testid":`extension-section-${e.id}`,className:oe,key:e.description},n.React$1.createElement("img",{src:a,className:re,alt:""}),this.renderActionInfo(e),n.React$1.createElement("div",{className:pe},n.React$1.createElement(t.Button,{variant:c,onClick:this.createClickHandler(e),className:ue,"data-testid":"extensions-mini-directory-modal-redirect_button"},l)))},this.getAppDirectoryPageInfo=e=>{const t=e.app_directory_id&&_e(e.app_directory_id);return t?this.state.appDirectoryPageInfo.get(t):void 0},this.renderActionInfo=e=>{const i=this.getAppDirectoryPageInfo(e),s=i&&i.short_description,a=i&&i.page_url,o=n.React$1.createElement(n.React$1.Fragment,null,n.React$1.createElement(t.Text,{tagName:"div",isBold:!0},e.description),n.React$1.createElement(t.Text,{color:"faint",className:de,size:"small"},s));return a?n.React$1.createElement("div",{className:le},n.React$1.createElement(t.Link,{href:a,target:"_blank",rel:"noreferrer",variant:"monochromatic",hasNoUnderline:!0,className:ce},o)):n.React$1.createElement("div",{className:le},o)},this.renderEmptySearch=()=>{const e=this.state.searchKey,i=e?`/apps/search?query=${e}`:"/apps",a=e?s.intl.formatMessage({id:"4fGTX4",defaultMessage:"Search “{search_key}” in App Center"},{search_key:e}):s.intl.formatMessage({id:"C5jY7c",defaultMessage:"Search in App Center"});return n.React$1.createElement("div",{className:ie},n.React$1.createElement(t.Text,null,s.intl.formatMessage({id:"niuDq6",defaultMessage:"Looking for something?"})),n.React$1.createElement(t.Link,{href:i,variant:"monochromatic"},n.React$1.createElement(t.Text,null,a)))},this.state={searchKey:"",appDirectoryPageInfo:new Map,loading:!0}}componentDidMount(){const e=this.props.appActions.map((e=>e.app_directory_id)).filter((e=>void 0!==e));this.fetchAppDirectoryPageInfoMap(e).then((e=>this.setState({appDirectoryPageInfo:e,loading:!1})))}fetchAppDirectoryPageInfoMap(e){return i.__awaiter(this,void 0,void 0,(function*(){const n=yield function(e,n){return i.__awaiter(this,void 0,void 0,(function*(){const i=(new t.UserApiV2Client).ns("app_directory").rpc("list_page_info",{app_identifiers:e},{subjectUserId:n});return(yield i).page_infos}))}(e,this.props.user.id);return n.reduce((function(e,t){for(const i of t.app_identifiers)e.set(_e(i),t);return e}),new Map)}))}render(){const{onRequestClose:e,modalTitle:i}=this.props,c=this.filterActions().sort(r.actionCompareFn);return n.React$1.createElement(a.Modal,{ariaLabel:s.intl.formatMessage({id:"wjwJvt",defaultMessage:"App actions"}),className:Y,overlayClassName:Q,bodyId:"extensions-mini-directory-modal",displayCloseButton:!0,open:!0,overlayFixed:!1,onRequestClose:()=>e()},this.state.loading?n.React$1.createElement("div",{className:me}," ",n.React$1.createElement(t.Spinner,{"aria-valuetext":"Loading Apps"})," "):n.React$1.createElement("div",{className:X},n.React$1.createElement("div",{className:t.classnames({[Z]:this.state.showTopBorder})},n.React$1.createElement("div",{className:ee},n.React$1.createElement(t.Title,null,i)),n.React$1.createElement("div",{className:te},n.React$1.createElement(t.TextInput,{"aria-label":"Search Apps",withLeftAccessory:n.React$1.createElement(t.UIIcon,{src:t.SearchLine}),withRightAccessory:this.state.searchKey&&n.React$1.createElement(t.IconButton,{size:"small",variant:"transparent",onClick:this.clearSearch},n.React$1.createElement(t.UIIcon,{src:h.FailFill})),placeholder:s.intl.formatMessage({id:"+enW1p",defaultMessage:"Search by action or app name"}),value:this.state.searchKey,onChange:this.handleQueryChange}))),n.React$1.createElement("div",{className:ae,onScroll:({currentTarget:{scrollTop:e}})=>this.onScroll(e)},c.length>0?c.map((e=>this.renderExtensionItem(e))):this.renderEmptySearch()),n.React$1.createElement(fe,null)),n.React$1.createElement(o.UXAnalyticsModalTracking,{id:"extensions-mini-directory-modal"}))}}ge.displayName="ExtensionsMiniDirectoryModalComponent";const he=t.requireCssWithComponent(ge,[]),ye=g.once((()=>{t.ReactModal.setAppElement(document.body)}));const xe={canOpenWith:function(e,i){return x.fileViewerConfiguration.wopiButtonVisible&&e.bytes<=t.OpenWith.MAX_SUPPORTED_FILE_SIZE_B&&null!==t.OpenWith.getWopiOpenWithButtonInfo(e)}};function ve(e,t){E.UnityFeatures.file_browser_display_name((function(i){e.file_browser_display_name=i,t(e)}),(()=>t(e)))}const Ee={isUnityEnabled:function(){return E.UnityFeatures.isUnitySupported()},isFileInUnityCache:function(e,t){return!!v.UnityCheckFileCache.is_cached_and_locally_available(e,t)},clientSupportsOpenInFileBrowser:function(){return E.UnityFeatures.client_supports_open_in_file_browser()},getFileInfoFromUnityCache:function(e,t){return v.UnityCheckFileCache.get(e,t)},fetchUnityFileInfo:function(e,t,i,n,s){E.UnityFeatures.check_file(e,t,i,(e=>{e.is_locally_available?ve(e,n):n(e)}),s)},getUnityFileInfo:function(e,t,i,n,s){if(Ee.isFileInUnityCache(e,t)){const i=Ee.getFileInfoFromUnityCache(e,t);i.is_locally_available&&null==i.file_browser_display_name?ve(i,n):n(i)}else Ee.fetchUnityFileInfo(e,t,i,n,s)},openFile:function(e,t,i,n){E.UnityFeatures.open_file(e,t,i,E.UnityFeatures.standard_open_file_handler,(()=>E.UnityFeatures.standard_open_file_handler(!1)),n)},isUnityFolderSupported:function(e){return null!=e&&(!!e.is_locally_available||!!e.is_infinite_placeholder)&&Ee.clientSupportsOpenInFileBrowser()},isUnityFileSupported:function(e){return null!=e&&!!e.is_locally_available&&!1!==e.can_open_directly}};function be(e){const{file:n}=e,a=i.__rest(e,["file"]);return y.isBrowseFile(n)?function({file:e,isUnityDisabled:i,isOpenWithDisabled:n,isCloudEditorDisabled:a,unityInfo:o,extraOptions:c,user:l,isCloudBasedDoc:p,actionSource:u,isInActionBar:m,previewActionHandler:_,openDesktopActionHandler:f,openInNewTabActionHandler:g,goToFolderActionHandler:h,replayActionHandler:y}){const x=[];if(y){const e=s.intl.formatMessage({id:"AQCWZx",defaultMessage:"Get feedback"});x.push({handler:y,spriteName:null,text:e,type:r.OpenButtonAction.OPEN_IN_REPLAY,userAction:t.UserAction.OpenInReplay})}_&&x.push({handler:_,spriteName:null,text:s.intl.formatMessage({id:"wHolW4",defaultMessage:"Preview (Dropbox)"}),type:r.OpenButtonAction.PREVIEW_FILE,userAction:t.UserAction.PreviewFile});if(f){const e=b.mac?s.intl.formatMessage({id:"3KanyU",defaultMessage:"Finder"}):s.intl.formatMessage({id:"kJ3mnY",defaultMessage:"File Explorer"});x.push({handler:f,spriteName:null,text:e,type:r.OpenButtonAction.OPEN_IN_DESKTOP,userAction:t.UserAction.OpenInDesktop})}g&&x.push({handler:g,spriteName:null,text:s.intl.formatMessage({id:"HE6Ges",defaultMessage:"Open in new tab"}),type:r.OpenButtonAction.OPEN_IN_NEW_TAB,userAction:t.UserAction.OpenInNewTab});h&&x.push({handler:h,spriteName:null,text:s.intl.formatMessage({id:"mppZEu",defaultMessage:"Go to folder"}),type:r.OpenButtonAction.GO_TO_FOLDER,userAction:t.UserAction.GoToFolder});if(!o)return x;!p&&function({isUnityDisabled:e,unityInfo:t}){return null!=t&&!e&&Ee.isUnityFileSupported(t)}({isUnityDisabled:i,unityInfo:o})&&x.push({handler:Te({file:e,user:l,isFolder:!1}),spriteName:"ow_desktop",text:Me(o,m),type:r.OpenButtonAction.UNITY_FILE,userAction:t.UserAction.OpenInUnity});const v=Ie({file:e,isOpenWithDisabled:n,user:l}),E={gdd:!a,wopi:v},I=t.getOpenWithCloudEditorInfo(e,l,E,u);for(const t of I){const i=we(e,l,u,t);i&&x.push(i)}!m&&function({isUnityDisabled:e,unityInfo:t}){return null!=t&&!e&&Ee.isUnityFolderSupported(t)}({isUnityDisabled:i,unityInfo:o})&&x.push({handler:Te({file:e,user:l,isFolder:!0}),spriteName:"ow_folder",text:Ae(o),type:r.OpenButtonAction.UNITY_FOLDER,userAction:t.UserAction.OpenInUnityFolder});c&&c.forEach((e=>{e&&x.push(e)}));m||x.length||p||x.push({handler:()=>function(e){const t=d.URI.parse(e.href);t.updateQuery({dl:"1"}),w.get({url:t.toString()})}(e),spriteName:null,text:s.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}),type:r.OpenButtonAction.DOWNLOAD,userAction:t.UserAction.Download});return x}(Object.assign({file:n},a)):y.isSharedFile(n)?function(e){const{file:i,user:n,isOpenWithDisabled:s}=e,a=[],o={gdd:!e.isCloudEditorDisabled,wopi:Ie({file:i,isOpenWithDisabled:s,user:n})},r=e.actionSource,c=t.getOpenWithCloudEditorInfo(i,n,o,r);for(const e of c){const t=we(i,n,r,e);t&&a.push(t)}return a}(Object.assign({file:n},a)):[]}function we(e,i,n,s){let a;if(s.provider===t.OpenWithCloudDocProvider.GoogleDSS)a={type:r.OpenButtonAction.OPEN_WITH_CLOUD_DOC,userAction:t.UserAction.OpenWithCloudDocEditor};else{if(s.provider!==t.OpenWithCloudDocProvider.OfficeOnline)return null;a={type:r.OpenButtonAction.OPEN_WITH,userAction:t.UserAction.OpenInOfficeOnline}}return Object.assign({handler:()=>s.handler(e,i,n),spriteName:s.spriteName||null,iconUrl:s.iconUrl,text:s.text},a)}function Ie({file:e,isOpenWithDisabled:t,user:i}){return!t&&xe.canOpenWith(e,i)}function Me(e,t){const i=(e?e.open_application_name:void 0)||s.intl.formatMessage({id:"Uyxn/h",defaultMessage:"Desktop"});return t?i:s.intl.formatMessage({id:"KtD8FA",defaultMessage:"Open in {app_name}"},{app_name:i})}function Ae(e){const t=(null!==e?e.file_browser_display_name:void 0)||s.intl.formatMessage({id:"Bbnzjx",defaultMessage:"File Browser"});return s.intl.formatMessage({id:"suwlZc",defaultMessage:"Show in {file_browser}"},{file_browser:t})}function Te({file:e,isFolder:t,user:i}){return()=>{Ee.openFile(e.ns_id,e.ns_path,i.id,t)}}const Ne=Object.freeze({local_path:null,resolved_local_path:null,is_locally_available:!1,can_open_directly:!1,open_application_identifier:null,open_application_name:null,path_is_dir:!1,is_infinite_placeholder:!1,error_message:null});e.UnityHelpers=Ee,e.authorizeNoRedirect=function(e,t){return i.__awaiter(this,void 0,void 0,(function*(){try{const i=yield V(e,"authorize_no_redirect",{action_id:t});return i&&i.result&&i.result.link_state}catch(e){return null}}))},e.computeSplitShareMenuReferrer=(e,i,n,s)=>{let a=`${i}`;return n&&(a=`${n}`,s&&(a=`${n}_${s}`,s===t.ActionSurfaceLogValue.RIGHT_SIDEBAR&&1===e.length?a=`${n}_${s}_single_file`:s===t.ActionSurfaceLogValue.RIGHT_SIDEBAR&&e.length>1&&(a=`${n}_${s}_multi_file`))),a},e.createTelemetryClient=C,e.getCategoryIdToInfos=function(e){const t={};return e.forEach((e=>{t[e.id]=e})),t},e.getOpenOptionsForFile=function(e){const i=t.getActionSourceFromSurface(e.surface);let{isCloudEditorDisabled:n}=e,s=n;return n||(n=!!e.cloudDocsInfo&&!e.cloudDocsInfo.openWithGddSupported,s=!!e.isOpenWithDisabled),be({file:e.file,isOpenWithDisabled:!!s,unityInfo:e.unityInfo||Ne,extraOptions:e.extraOptions,user:e.user,isCloudBasedDoc:t.isCloudBasedDoc(e.file),actionSource:i,isCloudEditorDisabled:n,isInActionBar:e.isInActionBar,previewActionHandler:e.previewActionHandler,openDesktopActionHandler:e.openDesktopActionHandler,goToFolderActionHandler:e.goToFolderActionHandler,replayActionHandler:e.replayActionHandler,openInNewTabActionHandler:e.openInNewTabActionHandler})},e.getPiiSafeExtension=S,e.redirectToActionOrShowAuth=z,e.showExtensionsMiniDirectoryModal=(e,i,s,a,o,c,l,d,p,u)=>{ye(),t.Modal$1.showInstance(n.React$1.createElement(he,{modalTitle:e,user:i,file:s,onRequestClose:t.Modal$1.close,appActions:a,categoryIdToInfos:o,featureFlags:c,updateLinkState:l,telemetryContext:d,currentSession:p,onProfileServiceAuth:u}));const{connected_apps:m,unconnected_apps:_}=r.partitionActionsByLinkStatus(a);r.logEvent(p,"view_scaling_modal",{connected_apps:m,unconnected_apps:_})},e.toActionBarValue=e=>({nodeType:"dropdown",actionType:3,menuItem:e})}));
//# sourceMappingURL=c_extensions_extensions_utils.js-vfl9CbRCk.map
