define(["require","exports","tslib","react","typescript/dropbox/proto/js_init_data/privacy_consent/privacy_consent_pb","metaserver/static/js/ccpa_iframe/ccpa_preferences","metaserver/static/js/ccpa_iframe/gdpr_preferences","metaserver/static/js/ccpa_iframe/dns_cookie","js/proto_utils/unpack","metaserver/static/js/ccpa_iframe/dns_enrollment_state","metaserver/static/js/ccpa_iframe/api","metaserver/static/js/components/ui/css","metaserver/static/js/core/notify","metaserver/static/js/core/i18n","metaserver/static/js/ccpa_iframe/preferences_button","@dropbox/dig-icons","@dropbox/dig-icons/assets","metaserver/static/js/privacy_consent/i18n","metaserver/static/js/ccpa_iframe/consent_banner","metaserver/static/js/privacy_consent/privacy_consent_cookies","metaserver/static/js/ccpa_iframe/reentry_popout"],(function(e,t,n,o,a,i,r,s,l,c,m,d,g,E,C,_,S,p,u,N,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RootComponent=t.CCPAIFrame=void 0,o=n.__importStar(o),a=n.__importStar(a);const D=E.intl.formatMessage({id:"MURQNI",defaultMessage:"Success! Do not sell or share my personal information is now active."}),y=E.intl.formatMessage({id:"T6SVre",defaultMessage:"Success! Settings are saved."}),P=E.intl.formatMessage({id:"6w278K",defaultMessage:"Something went wrong! Try again later."}),A="settings",I="floating_button",v="floating_button_closed",k="banner",w="nothing";t.CCPAIFrame=e=>{const{consentIframeOrigin:t,dnsState:n,userEmails:l,verifiedEmails:d,unverifiedEmails:b,loggingContext:O,ccpaToken:L,isGpcEnabled:M,localizedTextOverrides:T,csrfToken:h}=e,G=n===a.UserDNSInitState.LOGGED_IN_ENROLLED||n===a.UserDNSInitState.LOGGED_IN_NOT_ENROLLED||n===a.UserDNSInitState.LOGGED_IN_EMAIL_PENDING,U=new URLSearchParams(window.location.search),R="true"===U.get("hide_gdpr"),F="true"===U.get("is_migration_gate_enabled"),B="true"===U.get("should_disable_banner"),j=U.get("parent_domain_consent_cookie"),V=j?JSON.parse(decodeURIComponent(j)):void 0,x=new N.ConsentCookieStore({}),H=V?V.userInteracted:x.hasUserInteracted(),K=navigator.userAgent.toLowerCase(),Y=K.includes("iphone")||K.includes("ipod");(0,o.useEffect)(()=>{const e=(0,c.shouldEnrollLocally)($)||(0,c.shouldUnenrollLocally)($),n=new Date;if(n.setMonth(n.getMonth()+s.DEFAULT_DNS_DURATION_MONTHS),window.parent.postMessage({message_type:"CCPA_IFRAME_INIT",dns_enrolled:(0,c.isEnrollmentSelected)($),localized_text_overrides:T,expireDate:e?n:null},t),(M||navigator.globalPrivacyControl)&&window.parent.postMessage({message_type:"DNS_GPC_SIGNAL"},t),null!=h&&""!==h)try{const e=JSON.parse(atob(h.split(".")[1])).origin;window.top.postMessage({message_type:"CSRF_HANDSHAKE_START",token:h},e)}catch(e){}F&&(xe(W,Ue)?(He(),je()):Ye(),Ke(),rt())},[]);const[q,Q]=(0,o.useState)(()=>""),[z,J]=(0,o.useState)(!1),[W,Z]=(0,o.useState)((e=>e===a.UserDNSInitState.LOGGED_IN_ENROLLED?c.DNSEnrollmentState.EnrolledAccount:e===a.UserDNSInitState.LOGGED_IN_EMAIL_PENDING?c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation:e===a.UserDNSInitState.LOGGED_OUT_ENROLLED?c.DNSEnrollmentState.EnrolledEmail:e===a.UserDNSInitState.LOGGED_OUT_EMAIL_PENDING?c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation:e===a.UserDNSInitState.LOGGED_OUT_GPC_ENABLED?c.DNSEnrollmentState.EnrollmentPendingEmailUIConfirmation:c.DNSEnrollmentState.NotEnrolled)(n)),[$,X]=(0,o.useState)(W),[ee,te]=(0,o.useState)(!1),[ne,oe]=(0,o.useState)({}),[ae,ie]=(0,o.useState)(!1),[re,se]=(0,o.useState)(0),[le,ce]=(0,o.useState)(!1),[me]=(0,o.useState)(!0),[de,ge]=(0,o.useState)(!1),[Ee,Ce]=(0,o.useState)(!1),[_e,Se]=(0,o.useState)(!1),[pe,ue]=(0,o.useState)(!1),[Ne,fe]=(0,o.useState)(!1),[De,ye]=(0,o.useState)(!1),[Pe,Ae]=(0,o.useState)(E.intl.formatMessage(p.SAVE_BUTTON)),[Ie]=(0,o.useState)(E.intl.formatMessage(p.CANCEL_BUTTON)),[ve,ke]=(0,o.useState)(!1),[we,be]=(0,o.useState)(!H),[Oe,Le]=(0,o.useState)(!1),[Me,Te]=(0,o.useState)(!1),[he,Ge]=(0,o.useState)(!1),[Ue]=(0,o.useState)(x.getAllowedCategoriesMap(V)),[Re]=(0,o.useState)(x.getAllowedCategoriesMap(V)),Fe=()=>{const e=(0,c.isEnrollmentSelected)($),t=mt(),n=ae?h:void 0;e?(0,m.submitDNSSettings)(e,at,q,O,L,n,t):e||(0,m.submitDNSSettings)(e,it,q,O,L,n,t)},Be=e=>{if(e.origin===t)switch(e.data.message_type){case"DNS_SETTINGS_CONFIRMED":Fe();break;case"DNS_SETTINGS_CANCELLED":ye(!1),X(W);break;case"PRIVACY_CONSENT_PAGE_INFO":(e=>{const t={};e.hostname&&(t.hostname=e.hostname),e.foreign_session_id&&(t.foreign_session_id=e.foreign_session_id),e.client_info&&(t.client_info=e.client_info),oe(t)})(e.data);break;case"CSRF_HANDSHAKE_END":e.data.token===h&&ie(!0);break;case"SHOW_SETTINGS":ze();break;case"ENABLE_FLOATING_BUTTON":$e()}};(0,o.useLayoutEffect)(()=>{F||window.parent.postMessage({message_type:"CCPA_IFRAME_RESIZE",height:window.document.body.offsetHeight},t)}),(0,o.useEffect)(()=>{if(!Y){const e=()=>{var e;const n=null===(e=document.getElementById("ccpa_consent_banner"))||void 0===e?void 0:e.offsetHeight;n&&window.parent.postMessage({message_type:"CCPA_IFRAME_RESIZE",height:n+10},t)};return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}},[t]),(0,o.useEffect)(()=>(window.addEventListener("message",Be),()=>{window.removeEventListener("message",Be)}),[$,q,ne,ae]),(0,o.useEffect)(()=>{(ee||M||navigator.globalPrivacyControl)&&((0,c.isEnrollmentPendingUIConfirmation)($)?window.parent.postMessage({message_type:"DNS_PENDING_ENABLED",logged_in:G},t):(0,c.isUnenrollmentPendingUIConfirmation)($)?window.parent.postMessage({message_type:"DNS_PENDING_DISABLED"},t):($===W||(0,c.isGPCUserResetState)($,!(!M&&!navigator.globalPrivacyControl)))&&window.parent.postMessage({message_type:"DNS_PENDING_RESET",dns_enabled:(0,c.isEnrollmentSelected)($)},t))},[$]),(0,o.useEffect)(()=>{(ee||M||navigator.globalPrivacyControl)&&(z?(ye(!1),window.parent.postMessage({message_type:"DNS_EMAIL_VALID"},t)):(ye(!0),window.parent.postMessage({message_type:"DNS_EMAIL_INVALID"},t)))},[z]);const je=()=>{R?ze():he?Je():Ze()},Ve=()=>{$===c.DNSEnrollmentState.NotEnrolled||$===c.DNSEnrollmentState.UnenrollmentPendingEmailUIConfirmation||$===c.DNSEnrollmentState.UnenrollmentPendingAccountUIConfirmation?(Ue[N.CookieCategory.StrictlyNecessary]=!0,Ue[N.CookieCategory.MarketingAdvertising]=de,Ue[N.CookieCategory.PerformanceFunctionality]=pe,Ue[N.CookieCategory.SocialMediaAdvertising]=Ee,Ue[N.CookieCategory.Analytics]=_e):tt()},xe=(e,t)=>Boolean((0,c.isEnrollmentSelected)(e)&&(0===Object.keys(Ue).length||!x.onlyStrictlyNecessaryConsent(Ue))),He=()=>{tt(),et(),nt(!0)},Ke=()=>{ge(Re.hasOwnProperty(N.CookieCategory.MarketingAdvertising)&&!0===Re[N.CookieCategory.MarketingAdvertising]),ue(Re.hasOwnProperty(N.CookieCategory.PerformanceFunctionality)&&!0===Re[N.CookieCategory.PerformanceFunctionality]),Ce(Re.hasOwnProperty(N.CookieCategory.SocialMediaAdvertising)&&!0===Re[N.CookieCategory.SocialMediaAdvertising]),Se(Re.hasOwnProperty(N.CookieCategory.Analytics)&&!0===Re[N.CookieCategory.Analytics]);let e=0;Object.values(N.CookieCategory).forEach(t=>{t!==N.CookieCategory.StrictlyNecessary&&t!==N.CookieCategory.AllCookies&&Re.hasOwnProperty(t)&&!0===Re[t]&&++e}),ce(e>0),se(e),X(W),fe(W!==c.DNSEnrollmentState.NotEnrolled),ye(!1),Ae(E.intl.formatMessage(p.SAVE_BUTTON)),Object.values(N.CookieCategory).forEach(e=>{Ue[e]=Re[e]})},Ye=()=>{!we||B||R||We()},qe=(e,t,n)=>{if(te(!0),t===r.GDPRCategories.allCategories)ce(e),ge(e),Ce(e),Se(e),ue(e),se(e?4:0);else{n=void 0===n?0:n,t===r.GDPRCategories.generalMarketing?ge(e):t===r.GDPRCategories.socialMedia?Ce(e):t===r.GDPRCategories.analytics?Se(e):t===r.GDPRCategories.performanceFunctionality&&ue(e);const o=e?n+1:n-1;se(o),ce(0!==o)}},Qe=e=>{const n={message_type:"DISPLAY_STATE_CHANGED",display_state:e};window.parent.postMessage(n,t)},ze=()=>{Le(!0),Te(!1),be(!1),Qe(A)},Je=()=>{Le(!1),Te(!0),be(!1),Qe(I)},We=()=>{Le(!1),Te(!1),be(!0),Qe(k)},Ze=()=>{Le(!1),Te(!1),be(!1),Qe(w)},$e=()=>{Ge(!0),Oe||Me||we||R||Je()},Xe=()=>{Object.values(N.CookieCategory).forEach(e=>{e!==N.CookieCategory.AllCookies&&(Ue[e]=!0)})},et=()=>{Object.values(N.CookieCategory).forEach(e=>{Re[e]=Ue[e]})},tt=()=>{Object.values(N.CookieCategory).forEach(e=>{e!==N.CookieCategory.AllCookies&&(Ue[e]=e===N.CookieCategory.StrictlyNecessary)})},nt=e=>{window.parent.postMessage({message_type:"CONSENT_CHANGED_VIA_CCPA",categories:Ue,should_avoid_reload:e},t)},ot=e=>{te(!0),e?W===c.DNSEnrollmentState.NotEnrolled?G?X(c.DNSEnrollmentState.EnrollmentPendingAccountUIConfirmation):(X(c.DNSEnrollmentState.EnrollmentPendingEmailUIConfirmation),ye(!z),Ae(E.intl.formatMessage(p.SEND_VERIFICATION))):W===c.DNSEnrollmentState.EnrolledEmail||W===c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation?X(W):W!==c.DNSEnrollmentState.EnrolledAccount&&W!==c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation||X(W):(W===c.DNSEnrollmentState.EnrolledEmail||W===c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation?X(c.DNSEnrollmentState.UnenrollmentPendingEmailUIConfirmation):W===c.DNSEnrollmentState.EnrolledAccount||W===c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation?X(c.DNSEnrollmentState.UnenrollmentPendingAccountUIConfirmation):W===c.DNSEnrollmentState.NotEnrolled&&X(c.DNSEnrollmentState.NotEnrolled),Ae(E.intl.formatMessage(p.SAVE_BUTTON)),ye(!1)),fe(F&&e)},at=e=>{e?g.Notify.success(D):g.Notify.error(P),G?(X(c.DNSEnrollmentState.EnrollmentPendingAccountVerificationSent),Z(c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation)):(X(c.DNSEnrollmentState.EnrollmentPendingEmailVerificationSent),Z(c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation));const n=new Date;n.setMonth(n.getMonth()+s.DEFAULT_DNS_DURATION_MONTHS),window.parent.postMessage({message_type:"DNS_ENABLED",logged_in:G,isOptInToDNS:!0,expireDate:n},t),R||nt()},it=e=>{e?g.Notify.success(y):g.Notify.error(P),X(c.DNSEnrollmentState.NotEnrolled),Z(c.DNSEnrollmentState.NotEnrolled),window.parent.postMessage({message_type:"DNS_DISABLED"},t),R||nt()},rt=()=>{window.parent.postMessage({message_type:"CONSENT_CALLBACK",categories:Ue,callback_type:"PRIOR_CONSENT"},t)},st=e=>{Q(e);null!==e.match(/^.+@.+\..+$/)?J(!0):J(!1)},lt=e=>{e.preventDefault(),window.parent.postMessage({message_type:"CCPA_PRIVACY_PAGE_CLICK"},t)},ct=e=>{e.preventDefault(),window.parent.postMessage({message_type:"CCPA_COOKIE_FAQ_CLICK"},t)},mt=()=>({opt_in_source:M||navigator.globalPrivacyControl?m.CCPA_ACTION_SOURCE.GPC_UI:m.CCPA_ACTION_SOURCE.USER_INPUT,opt_in_domain:ne.hostname,opt_in_client:ne.client_info,foreign_session_id:ne.foreign_session_id}),dt=E.intl.formatMessage({id:"bYgnak",defaultMessage:"Dropbox uses different categories of cookies to provide, protect, improve, and promote our website and services. Information on these categories and their purposes are described below. For more information please see our <privacy>Privacy Policy</privacy> and <faq>Cookie FAQ page</faq>."},{privacy:e=>o.default.createElement("button",{id:"privacy-page-link",onClick:lt},e),faq:e=>o.default.createElement("button",{id:"cookie-faq-link",onClick:ct},e)});return o.default.createElement(o.default.Fragment,null,F&&o.default.createElement(o.default.Fragment,null,Oe&&o.default.createElement("div",{className:"migration-ccpa"},o.default.createElement("div",{className:"scrollable-contents"},!R&&o.default.createElement(o.default.Fragment,null,o.default.createElement(_.UIIcon,{src:S.DropboxLine,size:"large",display:"inline-block"}),o.default.createElement("div",{className:"title-divider"}),o.default.createElement("label",{id:"consent-title-label",className:"consent-title-label"},E.intl.formatMessage(p.CONSENT_TITLE)),o.default.createElement("p",{id:"consent-title-blurb",className:"consent-title-blurb"},dt)),o.default.createElement(i.CCPAPreferences,{displayVariant:R?i.CCPAPreferencesVariant.CCPA_ONLY:i.CCPAPreferencesVariant.GDPR_EMBEDDED,checked:(0,c.isEnrollmentSelected)($),disabled:!(!M&&!navigator.globalPrivacyControl),isFlowComplete:(0,c.isFlowComplete)(W,$),onChange:ot,onCookieFAQLinkClick:ct,gpcEnabled:!(!M&&!navigator.globalPrivacyControl),enrollmentState:$,email:q,handleEmailChange:st,userEmails:l,verifiedEmails:d,unverifiedEmails:b}),!R&&o.default.createElement(r.GDPRPreferences,{checked:(0,c.isEnrollmentSelected)($),disabled:Ne,onChange:qe,onCookieFAQLinkClick:ct,gdprCount:re,setGdprCount:se,allGdprToggle:le,strictlyToggle:me,generalToggle:de,socialToggle:Ee,analyticsToggle:_e,performanceToggle:pe})),o.default.createElement(C.PreferencesButton,{disabled:De,onChange:e=>{e?(Ve(),et(),W!==$?Fe():nt()):Ke(),je()},acceptButtonText:Pe,declineButtonText:Ie})),we&&o.default.createElement(u.ConsentBanner,{onClick:e=>{e===u.BannerComponentIDs.acceptAllCookiesButton?(Xe(),et(),qe(!0,r.GDPRCategories.allCategories,0)):e===u.BannerComponentIDs.declineCookiesButton&&tt(),je(),nt(!0)},onSettingsClick:e=>{e.preventDefault(),ze()},onPrivacyPageLinkClick:lt,onPrivacyPolicyFaqLinkClick:e=>{e.preventDefault(),window.parent.postMessage({message_type:"CCPA_PRIVACY_POLICY_FAQ_CLICK"},t)}}),Me&&o.default.createElement(f.CcpaReentryPopout,{onClick:e=>{e===f.PopoutButtonIDs.reentryButton?ze():e===f.PopoutButtonIDs.collapseToggle&&(ke(!ve),Qe(ve?I:v))},isCollapsed:ve})),!F&&o.default.createElement(i.CCPAPreferences,{displayVariant:R?i.CCPAPreferencesVariant.CCPA_ONLY:i.CCPAPreferencesVariant.GDPR_EMBEDDED,checked:(0,c.isEnrollmentSelected)($),disabled:!(!M&&!navigator.globalPrivacyControl),isFlowComplete:(0,c.isFlowComplete)(W,$),onChange:ot,onCookieFAQLinkClick:ct,gpcEnabled:!(!M&&!navigator.globalPrivacyControl),enrollmentState:$,email:q,handleEmailChange:st,userEmails:l,verifiedEmails:d,unverifiedEmails:b}))},t.CCPAIFrame.displayName="CCPAIFrame";t.RootComponent=e=>{const n=(0,l.unmarshalProto)(e.encodedProto,a.CCPAIFrameInitData);n.consentIframeOrigin=`https://${n.consentIframeOrigin}`;const i=(0,d.requireCssWithComponent)(t.CCPAIFrame,["/static/metaserver/static/css/dig-components/index.web-vflvPodS4.css","/static/metaserver/static/css/dig-components/tokens-vfladJ5PH.css"]);return o.default.createElement(i,Object.assign({},n))}}));
//# sourceMappingURL=ccpa_iframe.min.js-vfl3ZrtDO.map