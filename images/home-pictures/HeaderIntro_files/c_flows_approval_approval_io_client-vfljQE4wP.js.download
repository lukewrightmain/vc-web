define(["require","exports","./c_tslib","./e_edison","./c_typeahead_index","./e_ui_page_files_router","./c_form_row_index","./c_core_i18n","./c_file_viewer_sdk_file_viewer_experiments"],(function(e,t,o,a,n,r,l,i,s){"use strict";var c;function d(e){return`CONTACT-${e.email}`}t.ValidationResult=void 0,(c=t.ValidationResult||(t.ValidationResult={})).OK="OK",c.DUPLICATE="DUPLICATE",c.INVALID="INVALID",c.OVER_RECIPIENTS_LIMIT="OVER_RECIPIENTS_LIMIT";const p=/[ ,]+/,u=/^['&A-Za-z0-9\._%+-]+@[A-Za-z0-9-][A-Za-z0-9\.-]*\.[A-Za-z]{2,15}$/i,v=e=>{const[o,i]=a.react.exports.useState(""),[s,c]=a.react.exports.useState(!1),[d,v]=a.react.exports.useState(!1),[m,_]=a.react.exports.useState(!1),h=a.react.exports.useRef(null),{noMatches:R,selectFromSuggestionErrMsg:E}=g();a.react.exports.useEffect((()=>{e.recipients.length>e.recipientNumLimit?v(!0):v(!1),e.recipients.length>0&&e.recipients.filter((e=>e.validationResult!==t.ValidationResult.OK)).length>0?c(!0):c(!1)}),[e.recipients,e.recipientNumLimit]);const w=t=>{const o=e.recipients.filter((e=>e.email!==t.email));e.onRecipientsChange(o)},I=o=>{if(e.recipients.length>e.recipientNumLimit)return t.ValidationResult.OVER_RECIPIENTS_LIMIT;return e.recipients.find((e=>o.email===e.email))?t.ValidationResult.DUPLICATE:u.test(o.email)?t.ValidationResult.OK:t.ValidationResult.INVALID},S=(o,a,n)=>{if(e.onQueryChange(""),i(""),!o)return!1;if(!o&&!n)return!1;const r=o?[o]:n.split(p).filter(Boolean).map((e=>({email:e}))),l={},s=[...e.recipients];for(const e of r){if(e.email in l)continue;const o=I(e);if(o===t.ValidationResult.OVER_RECIPIENTS_LIMIT)break;o!==t.ValidationResult.DUPLICATE&&(l[e.email]=null,e.validationResult=o,s.push(e))}return s.length>e.recipients.length&&e.onRecipientsChange(s),0===s.filter((e=>e.validationResult!==t.ValidationResult.OK)).length},y=t=>{S(t,0,o),e.onTypeAheadSelection&&e.onTypeAheadSelection(t)},A=t=>{const o=t.currentTarget.value;i(o),e.onQueryChange(o)},C=t=>{if(8===t.keyCode&&""===o&&e.recipients.length>0&&w(e.recipients[e.recipients.length-1]),(9==t.keyCode||13===t.keyCode)&&""!==o){let t=null;e.suggestions.length>0?t=e.suggestions[0]:u.test(o)&&(t={email:o}),S(t,0,o)}},b=()=>{e.onFocus&&e.onFocus(),_(!0)},T="flows-typeahead__input",L=e.recipients.length>=e.recipientNumLimit,M=()=>a.React$1.createElement(n.Typeahead.Wrapper,{onSelection:y},(({getTriggerProps:i,getContentProps:c})=>a.React$1.createElement(a.React$1.Fragment,null,a.React$1.createElement(r.TextInput.Container,{isInvalid:s||d||!m&&!!o,ref:h},a.React$1.createElement(r.TextInput.ChipsContainer,null,!!e.recipients.length&&e.recipients.map(((e,o)=>a.React$1.createElement(r.InputChip,{key:o,size:"small",isAlert:e.validationResult!==t.ValidationResult.OK,onDelete:()=>w(e),withAvatarLeft:e.avatarUrl&&a.React$1.createElement(r.Avatar,{hasNoOutline:!0,size:"xsmall",src:e.avatarUrl})},e.name||e.email))),a.React$1.createElement(r.TextInput.Input,Object.assign({autoFocus:!0,id:T,placeholder:L?void 0:e.placeholder,"aria-label":e.placeholder,value:o},i({onChange:A,onKeyDown:C}),{disabled:L,onBlur:()=>_(!1),onFocus:b,style:{fontSize:"12px"},autoComplete:"off"})))),!m&&o&&a.React$1.createElement(l.FormHelperText,{variant:"alert"},E),a.React$1.createElement(n.Typeahead.Container,Object.assign({},c(),{triggerRef:{current:h.current},isEmptyQuery:Boolean(o)&&0==e.suggestions.length&&!u.test(o),emptyPrompt:a.React$1.createElement(n.Typeahead.EmptyPrompt,{placeholderText:R}),onBlur:()=>_(!1),onFocus:()=>_(!0)}),e.suggestions.length>0?a.React$1.createElement(n.Typeahead.Results,{results:e.suggestions,renderRow:e.renderTypeaheadSuggestion}):Boolean(o)&&a.React$1.createElement(n.Typeahead.Results,{results:[{email:o}],renderRow:e=>a.React$1.createElement(f,{suggestion:e})})))));return a.React$1.createElement(a.React$1.Fragment,null,e.label&&a.React$1.createElement(l.FormLabel,{htmlFor:T},a.React$1.createElement(r.Text,{isBold:!0,size:"small",tagName:"label"},e.label),e.labelSubtext),L&&e.maxNumTooltip?a.React$1.createElement(r.Tooltip,{title:e.maxNumTooltip},a.React$1.createElement("span",{style:{display:"inline-block",width:"100%"},tabIndex:0},M())):M())};v.displayName="ContactTypeahead";const m=({suggestion:e,getInitials:t})=>{const o=t(e.name||e.email);return a.React$1.createElement(n.Typeahead.Row,{key:e.email,value:e,withTitle:e.name,withSubtitle:e.email,withLeftAccessory:a.React$1.createElement(r.Avatar,{src:e.avatarUrl,backgroundColor:r.avatarColorForUserIdentifier(o),hasNoOutline:!0},o),onKeyDown:e=>{e.nativeEvent.stopImmediatePropagation()}})};m.displayName="TypeaheadSuggestion";const f=({suggestion:e})=>{const{inviteEmailMsg:t}=g();return a.React$1.createElement(n.Typeahead.Row,{key:e.email,value:e,withTitle:t(e.email)})};function g(){const e=r.useIntl();return{noMatches:e.formatMessage({id:"T2ynaE",defaultMessage:"No matches"}),selectFromSuggestionErrMsg:e.formatMessage({id:"4gphPK",defaultMessage:"Please select an assignee"}),inviteEmailMsg:t=>e.formatMessage({id:"E9a3yV",defaultMessage:"Invite {email}"},{email:t})}}function _(e,t,o,a=!1,n=!1){if(!o)return[];const l=new Set;for(const e of t)l.add(d(e));const i=[];for(const t of o)if(t.email&&(t.type===r.ContactTypes.DBX_ID||t.type===r.ContactTypes.EMAIL)){if(n&&t.email===e.email)continue;if(a&&(!t.dbx_account_id||!t.dbx_team_id||t.dbx_team_id!==e.team_dbtid))continue;const o={name:t.name,email:t.email,avatarUrl:t.photo_url,dbx_account_id:t.dbx_account_id};l.has(d(o))||i.push(o)}return i}function h(e,t,o,a,n,l){const i={file_id:t,comment:{content:l},thread_id:o,status:{".tag":a},approval_type:{".tag":n}};return(new r.UserApiV2Client).ns("flows").rpc("respond_to_approval",i,{subjectUserId:e})}function R(e,t,o,a,n){const l={file_id:t,comment_id:o,comment:{content:n},status:{".tag":a}};return(new r.UserApiV2Client).ns("flows").rpc("edit_approval",l,{subjectUserId:e})}f.displayName="TypeaheadEmailSuggestion";const E=["browse","search","inband_share","shared_link","shared_content_link","shared_link_embed","version_history","home","hellosign","recents","starred","standalone_previews","photos","collections","commerce","transfer","file_locking","backup","video_synthesis"];function w(e){return E.find((t=>t===(null==e?void 0:e.toLowerCase())))}const I=["other","user_not_found"];function S(e){return I.find((t=>t===(null==e?void 0:e.toLowerCase())))}const y=["approved","rejected","pending","other"];function A(e){return y.find((t=>t===(null==e?void 0:e.toLowerCase())))}const C=(()=>{let t;return{getOrLoadPapEvents:()=>o.__awaiter(void 0,void 0,void 0,(function*(){return t||(t=yield new Promise((function(t,o){e(["./c_flows_logging_approvals_logging_events"],t,o)}))),t}))}})(),b={logRequestApprovalClick:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RequestApprovalButton({actionSurface:e,fileId:t,previewsSurface:a?w(a):void 0}))})),logShownRequestForm:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Shown_RequestApprovalForm({actionSurface:t,fileId:e}))})),logFocusApproverTypeahead:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RequestApprovalApproverInput({actionSurface:t,fileId:e}))})),logRequestFormCancelClick:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RequestApprovalFormCancelButton({actionSurface:t,fileId:e}))})),logAddApprover:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RequestApprovalApprover({actionSurface:t,fileId:e,approverId:a}))})),logSubmitApprovalRequest:e=>o.__awaiter(void 0,void 0,void 0,(function*(){const t=yield C.getOrLoadPapEvents();r.logEvent(t.Initiate_RequestApproval(e))})),logSubmitApprovalSuccess:(e,t,a,n,l,i,s)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Succeed_RequestApproval({actionSurface:t,threadId:s,fileId:e,approvalDetailsLength:a,approvers:n,requiresAll:l,numApprovers:i}))})),logSubmitApprovalFailure:e=>o.__awaiter(void 0,void 0,void 0,(function*(){const t=yield C.getOrLoadPapEvents();let o;if("user_not_found"===e.errorReason)o=S("user_not_found");else o=S("other");r.logEvent(t.Fail_RequestApproval({actionSurface:e.actionSurface,fileId:e.fileId,requestApprovalErrorReason:o}))})),logApproverOptionsClick:(e,t,a="request_approval_form")=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RequestApprovalApproverOption({actionSurface:a,fileId:e,requiresAll:t}))})),logRespondClick:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RespondApprovalButton({actionSurface:"respond_approval_form",threadId:t,fileId:e}))})),logShownRespondForm:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Shown_RespondApprovalForm({actionSurface:"respond_approval_form",threadId:t,fileId:e}))})),logApproveChipClick:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();a?r.logEvent(o.Select_RespondApprovalApproveButton({actionSurface:"respond_approval_form",threadId:t,fileId:e})):r.logEvent(o.Select_RespondApprovalRejectButton({actionSurface:"respond_approval_form",threadId:t,fileId:e}))})),logRespondFormCancelClick:e=>o.__awaiter(void 0,void 0,void 0,(function*(){const t=yield C.getOrLoadPapEvents();r.logEvent(t.Select_RespondApprovalFormCancelButton({actionSurface:"respond_approval_form",fileId:e}))})),logSubmitResponseSuccess:(e,t,a,n)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Succeed_RespondApproval({actionSurface:"respond_approval_form",threadId:a,fileId:t,approvalStatus:A(e),approvalDetailsLength:n}))})),logResubmitRequestClick:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_ResubmitApprovalButton({actionSurface:"respond_approval_form",threadId:t,fileId:e}))})),logResubmitRequestSuccess:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Succeed_ResubmitRequestApproval({actionSurface:"respond_approval_form",fileId:e,threadId:t,approvalDetailsLength:a}))})),logShownRemoveApprovalModal:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Shown_RemoveApprovalModal({actionSurface:t,fileId:e,commentId:a}))})),logRemoveApprovalConfirmClick:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RemoveApprovalConfirmButton({actionSurface:t,fileId:e,commentId:a}))})),logRemoveApprovalCancelClick:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RemoveApprovalCancelButton({actionSurface:t,fileId:e,commentId:a}))})),logEditApprovalResponseClick:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RespondApprovalEditButton({actionSurface:"respond_approval_form",fileId:e,threadId:t}))})),logEditApprovalRequestClick:(e,t)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Select_RequestApprovalEditButton({actionSurface:"request_approval_form",fileId:e,threadId:t}))})),logApprovalResponseResubmitSuccess:(e,t,a,n)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Succeed_ResubmitRespondApproval({actionSurface:"respond_approval_form",fileId:e,threadId:t,approvalStatus:A(a),approvalDetailsLength:n}))})),logEditApprovalRequestSuccess:(e,t,a)=>o.__awaiter(void 0,void 0,void 0,(function*(){const o=yield C.getOrLoadPapEvents();r.logEvent(o.Succeed_RequestApprovalEdit({actionSurface:"request_approval_form",fileId:e,threadId:a,approvalDetailsLength:t}))})),logShownApprovalPostPdfEditingToast:e=>o.__awaiter(void 0,void 0,void 0,(function*(){const t=yield C.getOrLoadPapEvents();r.logEvent(t.Shown_ApprovalPostPdfEditingToast({fileId:e}))}))},T=({open:e,title:t,body:o,onCancel:n,onDelete:i,error:s,isLoading:c})=>{const{closeButton:d,deleteButton:p,genericError:u}=P();return a.React$1.createElement(r.Modal,{open:e,onRequestClose:n},a.React$1.createElement(r.Modal.Header,{hasBottomSpacing:"title-standard"},a.React$1.createElement(r.Title,null,t)),a.React$1.createElement(r.Modal.Body,null,a.React$1.createElement(r.Text,null,o),s&&a.React$1.createElement(l.FormHelperText,{variant:"alert"},u)),a.React$1.createElement(r.Modal.Footer,null,a.React$1.createElement(r.Button,{variant:"opacity",onClick:n},d),a.React$1.createElement(r.Button,{variant:"primary",onClick:i,isLoading:c},p)))};T.displayName="ApprovalDeleteModal";const L=({userId:e,fileId:t,actor:o,onDeleteSuccess:n,commentId:l})=>{const[i,s]=a.react.exports.useState(!1),[c,d]=a.react.exports.useState(!0),[p,u]=a.react.exports.useState(!1),{getDeleteCommentTitle:v,getDeleteCommentBody:m}=P();a.React$1.useEffect((()=>{b.logShownRemoveApprovalModal(t,"delete_comment_modal",l)}),[]);const f=v(o),g=m(o);return f&&g?a.React$1.createElement(T,{open:c,onCancel:()=>{b.logRemoveApprovalCancelClick(t,"delete_comment_modal",l),d(!1)},onDelete:()=>{b.logRemoveApprovalConfirmClick(t,"delete_comment_modal",l),s(!1),u(!0),function(e,t,o){const a={file_id:t,comment_id:o};return(new r.UserApiV2Client).ns("flows").rpc("delete_approval",a,{subjectUserId:e})}(e,t,l).then((()=>{n(),d(!1)})).catch((()=>{s(!0),u(!1)}))},title:f,body:g,error:i,isLoading:p}):null};L.displayName="ApprovalDeleteCommentModal";const M=({userId:e,fileId:t,threadId:o,onDeleteSuccess:n})=>{const[l,i]=a.react.exports.useState(!1),[s,c]=a.react.exports.useState(!0),[d,p]=a.react.exports.useState(!1),{deleteThreadTitle:u,deleteThreadBody:v}=P();a.React$1.useEffect((()=>{b.logShownRemoveApprovalModal(t,"delete_approval_modal",o)}),[e,t,o]);return a.React$1.createElement(T,{open:s,onCancel:()=>{b.logRemoveApprovalCancelClick(t,"delete_approval_modal",o),c(!1)},onDelete:()=>{b.logRemoveApprovalConfirmClick(t,"delete_approval_modal",o),i(!1),p(!0),function(e,t,o){const a={file_id:t,comment_id:o};return(new r.UserApiV2Client).ns("flows").rpc("delete_approval_thread",a,{subjectUserId:e})}(e,t,o).then((()=>{n(),c(!1)})).catch((()=>{i(!0),p(!1)}))},title:u,body:v,error:l,isLoading:d})};M.displayName="ApprovalDeleteThreadModal";const P=()=>{const e=r.useIntl();return{getDeleteCommentTitle:t=>"requester"===t?e.formatMessage({id:"l623DN",defaultMessage:"Delete your approval request?"}):"approver"===t?e.formatMessage({id:"a6tb8g",defaultMessage:"Delete your response?"}):null,getDeleteCommentBody:t=>"requester"===t?e.formatMessage({id:"o4wQ1b",defaultMessage:"Your request for approval on this file will be deleted. You’ll be able to start a new approval request."}):"approver"===t?e.formatMessage({id:"lTKaYp",defaultMessage:"Your response to the approval request on this file will be deleted. You’ll be able to submit a new response."}):null,closeButton:e.formatMessage({id:"67AKp5",defaultMessage:"Cancel"}),deleteButton:e.formatMessage({id:"sDOGa0",defaultMessage:"Delete"}),genericError:e.formatMessage({id:"cdCpqV",defaultMessage:"Something went wrong. Please try again later."}),deleteThreadTitle:e.formatMessage({id:"bJ6YI2",defaultMessage:"Remove approval request?"}),deleteThreadBody:e.formatMessage({id:"OtCoJc",defaultMessage:"Your request for approval on this file and all of its responses will be deleted. You can always initiate a new approval request."})}};class q{constructor(e){this.category="web-approvals_feedback",this.user_id=null,this.is_feature_helpful=e.is_feature_helpful,this.feedback=e.feedback,this.timestamp=Date.now(),Object.seal(this)}}const O=new r.HiveLogger;t.ContactTypeahead=v,t.PapLogger=b,t.TypeaheadSuggestion=m,t.approvalIOClient=e=>{const t=e=>{r.UserSurvey.trackEvent(e,"browse")};return{useSuggestions:t=>function(e,t,o=!1,n=!1){const[l,i]=a.react.exports.useState(""),[s,c]=a.react.exports.useState([]),d=r.Viewer.get_viewer().get_user_by_id(e),p=new r.ContactsDataSourceV2(d);return a.react.exports.useEffect((()=>{let e=!1;const a=[];if(l.length)return p.search(l,(e=>{const r=_(d,t,e,o,n);a.push(...r),c(a)}),(r=>{const l=_(d,t,r,o,n);!e&&l.length>0&&(a.push(...l),c(a))})),()=>{e=!0};c(a)}),[l,t]),{suggestions:s,onQueryChange:e=>{i(e)}}}(e,t,!1,!0),getInitials:r.getInitials,createApproval(t,o,a,n){const l=a.map((e=>({email:e.email})));return function(e,t,o,a,n){const l={file_id:t,comment:{content:o},status:{".tag":"pending"},approvers:a,requires_all:n};return(new r.UserApiV2Client).ns("flows").rpc("create_approval",l,{subjectUserId:e})}(e,t,o,l,n)},respondToApprovalRequest:(t,o,a,n)=>function(e,t,o,a,n){return h(e,t,o,a?"approved":"rejected","response",n)}(e,t,o,a,n),editApprovalResponse:(t,o,a,n)=>function(e,t,o,a,n){return R(e,t,o,a?"approved":"rejected",n)}(e,t,o,a,n),showApprovalDeleteCommentModal(t,o,n,l){!function(e,t,o,n,l){r.Modal$1.showInstance(a.React$1.createElement(i.Provider,{value:i.intl},a.React$1.createElement(L,{userId:e,fileId:t,commentId:o,actor:n,onDeleteSuccess:l})))}(e,t,o,n,l)},editApprovalRequest:(t,o,a)=>function(e,t,o,a){return R(e,t,o,"pending",a)}(e,t,o,a),resubmitApprovalRequest:(t,o,a)=>function(e,t,o,a){return h(e,t,o,"pending","request",a)}(e,t,o,a),showApprovalDeleteThreadModal(t,o,n){!function(e,t,o,n){r.Modal$1.showInstance(a.React$1.createElement(i.Provider,{value:i.intl},a.React$1.createElement(M,{userId:e,fileId:t,threadId:o,onDeleteSuccess:n})))}(e,t,o,n)},triggerSprigSurvey(){return o.__awaiter(this,void 0,void 0,(function*(){const{num_requested_approvals:o}=yield function(e){return(new r.UserApiV2Client).ns("flows").rpc("get_submitted_approvals_count",{},{subjectUserId:e})}(e);1===o?t("approval_requested_one_time"):5===o?t("approval_requested_five_times"):25===o&&t("approval_requested_twenty_five_times")}))},trackUserSurveyEvent:t,logApprovalsFeedback(e,t){O.log(new q({is_feature_helpful:e,feedback:t}))},logger:b,getUserExperiments:()=>({flows_approval_flow_variant:s.fileViewerFlowExperiments.approvalFlowVariantByUserId[e],flows_approval_copy_experiment_variant:s.fileViewerFlowExperiments.approvalCopyVariantByUserId[e],flows_approval_flow_enabled:s.fileViewerFlowExperiments.approvalFlowByUserId[e]})}},t.getFileApprovalStatus=function(e,t){const o={file_id:t};return(new r.UserApiV2Client).ns("flows").rpc("get_file_status",o,{subjectUserId:e})},t.getPreviewsSurfaceFromString=w}));
//# sourceMappingURL=c_flows_approval_approval_io_client.js-vflL0Nm_j.map
