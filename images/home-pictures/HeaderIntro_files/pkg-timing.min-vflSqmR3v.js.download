define("metaserver/static/js/metrics/index",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/index","metaserver/static/js/metrics/unload","metaserver/static/js/metrics/server_view_sink","metaserver/static/js/core/exception","metaserver/static/js/core/browser_detection","metaserver/static/js/uuid/insecure_uuid"],(function(e,t,s,i,r,n,a,o,c,l){"use strict";function p(){return new i.BrowserPerformanceClock}function u(){return s.__awaiter(this,void 0,void 0,(function*(){const{NoAuthApiV2Client:t}=yield new Promise((t,s)=>{e(["metaserver/static/js/api_v2/noauth_client"],t,s)}).then(s.__importStar),i=new t;return(0,r.clientBaseAdaptor)(i)}))}function d(){return()=>l.InsecureUUID.v4()}function m(){return{detectBrowser:h,detectOS:f}}function h(){const e=[[!!c.chrome,"chrome"],[!!c.edge,"edge"],[!!c.mozilla,"firefox"],[!!c.msie,"msie"],[!!c.safari,"safari"]];for(const t of e)if(t[0])return t[1];return"other"}function f(){return c.mac?{name:{".tag":"mac"},version:"unknown"}:c.windows?{name:{".tag":"windows"},version:(e=c.windowsInfo,e.windowsXP||e.windowsXPx64?"XP":e.windowsVista?"Vista":e.windows7?"7":e.windows8?"8":e.windows8_1?"8.1":e.windows10?"10 Unknown":"unknown")}:c.is_android()?{name:{".tag":"android"},version:"unknown"}:c.iOS?{name:{".tag":"ios"},version:"unknown"}:{name:{".tag":"unknown_os"},version:"unknown"};var e}Object.defineProperty(t,"__esModule",{value:!0}),t.getUnloadMetricsReporter=t.getMetricsReporter=void 0,o=s.__importStar(o),c=s.__importStar(c);const _=(0,r.makeDefaultCacheFactory)();const S=new a.ServerViewMetricsSink;t.getMetricsReporter=function(){const e=(0,r.getSinkSingleton)({clientFactory:u,platformDetector:m(),exceptionReporter:o,identifierFactory:d(),originKind:"metaserver"});return void 0!==window._clientBridge?i.MetricsReporterImpl.root(S,p(),e.getOriginId()):i.MetricsReporterImpl.root(e,p(),e.getOriginId())},t.getUnloadMetricsReporter=function(){const e=(0,r.getSinkSingleton)({clientFactory:u,platformDetector:m(),exceptionReporter:o,identifierFactory:d(),originKind:"metaserver"}),t=(function(e){void 0===e&&(e=u);const t=(0,r.getSinkSingleton)({clientFactory:e,originKind:"metaserver"});if(window.unloadSinkSingleton)return window.unloadSinkSingleton;const s=new n.UnloadSink(_,t);return window.unloadSinkSingleton=s,s})();return i.MetricsReporterImpl.root(t,p(),e.getOriginId())}})),define("metaserver/static/js/metrics/server_view_sink",["require","exports","tslib"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerViewMetricsSink=void 0;t.ServerViewMetricsSink=class{constructor(){this.spans=[],this.bridgeInitialized=!1}recordSpan(e){this.spans.push(e),this.bridgeInitialized||this.initializeBridgeSink()}recordSetSpan(e){}initializeBridgeSink(){return s.__awaiter(this,void 0,void 0,(function*(){this.bridgeInitialized=!0;const t=yield new Promise((t,s)=>{e(["metaserver/static/js/clean/server_side_client_view_bridge"],t,s)}).then(s.__importStar);(yield t.IsBridgeFunctionSupported("reportMetricsV2"))?(setInterval(()=>{this.spans.length>0&&(t.ReportMetrics(this.spans),this.spans=[])},5e3),window.addEventListener("beforeunload",()=>{this.spans.length>0&&(console.log(`Attempting to send ${this.spans.length} pending AMP spans`),t.ReportMetrics(this.spans),this.spans=[])})):setInterval((function(){this.spans=[]}),6e4)}))}}})),define("metaserver/static/js/metrics/unload",["require","exports","tslib","eventemitter3"],(function(e,t,s,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnloadSink=void 0,i=s.__importDefault(i);t.UnloadSink=class{constructor(e,t){this.cacheFactory=e,this.innerSink=t,this.eventEmitter=new i.default,this.onUnloadChange=()=>{this.isUnload()||this.flushToInner()},this.persistor=new n(this.cacheFactory()),this.listener=new r(this.onUnloadChange),this.onUnloadChange()}flushToInner(){this.persistor.getAllAndClear().forEach(e=>{this.recordSpanToInner(e)})}isUnload(){return Boolean(this.listener.isUnload)}recordSpan(e){if(this.isUnload())return this.persistor.persistSpans([e]),void this.eventEmitter.emit("spansPersistedInUnload");this.recordSpanToInner(e)}recordSetSpan(e){}recordSpanToInner(e){const t=Object.assign(Object.assign({},e),{fromUnloadSink:!0});this.innerSink.recordSpan(t)}};class r{constructor(e){this.onUnloadChange=e,this._isUnload=!1,this.listenForNavigationChanges()}get isUnload(){return this._isUnload}set isUnload(e){this._isUnload!==e&&(this._isUnload=e,this.onUnloadChange())}listenForNavigationChanges(){if("undefined"!=typeof window&&"function"==typeof window.addEventListener&&"function"==typeof document.addEventListener){const e=()=>{"hidden"===document.visibilityState?this.isUnload=!0:"visible"===document.visibilityState&&(this.isUnload=!1)},t=()=>{this.isUnload=!0,window.removeEventListener("pagehide",t),document.removeEventListener("visibilitychange",e)};window.addEventListener("pagehide",t),document.addEventListener("visibilitychange",e)}}}class n{constructor(e){this.cache=e,this.CACHE_KEY="amp-persisted-spans-v2",this.OLD_CACHE_KEY="amp-persisted-spans"}getAllAndClear(){if(!this.cache)return[];const e=this.retrieveSpans();try{this.cache.setItem(this.CACHE_KEY,JSON.stringify([])),this.cache.removeItem(this.OLD_CACHE_KEY)}catch(e){}return e}persistSpans(e){if(!this.cache||!e)return;const t=this.retrieveSpans();t.push(...e);try{this.cache.setItem(this.CACHE_KEY,JSON.stringify(t))}catch(e){}}retrieveSpans(){let e=[];try{e=JSON.parse(this.cache.getItem(this.CACHE_KEY))}catch(e){}return e||[]}}})),define("metaserver/static/js/perf_tools/web_timing_utils",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CancellableCallback=t.WebTimingUtil=void 0;class s{static generateCorrelationId(){return Math.random().toString(36).substring(2)}static getNow(){return Date.now()}static newContext(e,t="unnamed_timer"){let i;return i=e?s.getNow():Date.now()-performance.now(),{initialized:!1,is_pagelet:!1,is_dws:!1,is_dws2:!1,is_early_ensemble:!1,log_time_to_interactive:!1,tti_at_dom_interactive:!1,source_type:"web",subtypes:{},tti_exclusion_flow:"",have_logged_web_timing:!1,delayed_tti_for_css:!1,rollup_format:"off",is_build_time_prefetches_enabled:!1,timing_results:null,start_time:i,time_to_interactive:null,correlation_id:s.generateCorrelationId(),timesStagesWereReached:{},context_name:t}}}t.WebTimingUtil=s;t.CancellableCallback=class{constructor(e){this.canceled=!1,this.callback=e}exec(){this.canceled||this.callback()}cancel(){this.canceled=!0}isCanceled(){return this.canceled}}})),define("metaserver/static/js/uuid/insecure_uuid",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InsecureUUID=void 0;const s=(()=>{let e,t;const s=[];for(t=0,e=t;t<=255;t++,e=t)s.push((e+256).toString(16).substr(1));return s})();t.InsecureUUID=class{static bytesToHex(e){return e.map(e=>s[e]).join("")}static toByte(e){return 255&e}static bytesToUUIDString(e){return[e.slice(0,4),e.slice(4,6),e.slice(6,8),e.slice(8,10),e.slice(10,16)].map(e=>this.bytesToHex(e)).join("-")}static getRandomBytes(){const e=new Array(16);return this.getInsecureRandomValues(e),e.map(e=>this.toByte(e))}static getInsecureRandomValues(e){const t=Math.pow(2,8);for(let s=0;s<e.length;s++)e[s]=Math.floor(Math.random()*t);return e}static v4(){const e=this.getRandomBytes();return e[6]=15&e[6]|64,e[8]=63&e[8]|128,this.bytesToUUIDString(e)}}})),define("typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb",["require","exports","@bufbuild/protobuf"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApexMetricsCacheData_FilterState=t.ApexMetricsCacheData_NamespaceCoinState=t.ApexMetricsCacheData_CoinState=t.ApexMetricsCacheData=t.RecordNamespace_RecordResponse=t.RecordNamespace_StickinessV2=t.RecordNamespace_StickyBiasedCoinV2=t.RecordNamespace_MetricReportingConfigV2=t.RecordNamespace=void 0;class i extends s.Message{constructor(e){super(),s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new i).fromBinary(e,t)}static fromJson(e,t){return(new i).fromJson(e,t)}static fromJsonString(e,t){return(new i).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(i,e,t)}}t.RecordNamespace=i,i.runtime=s.proto3,i.typeName="apex_metrics_web.RecordNamespace",i.fields=s.proto3.util.newFieldList(()=>[]);class r extends s.Message{constructor(e){super(),this.metricNamespace="",this.maxTimeUntilRefreshSeconds=0,this.stopPublicationForSeconds=0,this.dropFractionOfHostsPerMetric=0,this.aggregationIntervalSeconds=0,s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new r).fromBinary(e,t)}static fromJson(e,t){return(new r).fromJson(e,t)}static fromJsonString(e,t){return(new r).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(r,e,t)}}t.RecordNamespace_MetricReportingConfigV2=r,r.runtime=s.proto3,r.typeName="apex_metrics_web.RecordNamespace.MetricReportingConfigV2",r.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"metric_namespace",kind:"scalar",T:9},{no:2,name:"max_time_until_refresh_seconds",kind:"scalar",T:13},{no:3,name:"stop_publication_for_seconds",kind:"scalar",T:13},{no:4,name:"drop_samples",kind:"message",T:n},{no:5,name:"drop_periods",kind:"message",T:n},{no:6,name:"drop_fraction_of_hosts_per_metric",kind:"scalar",T:1},{no:7,name:"aggregation_interval_seconds",kind:"scalar",T:13}]);class n extends s.Message{constructor(e){super(),this.fraction=0,s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new n).fromBinary(e,t)}static fromJson(e,t){return(new n).fromJson(e,t)}static fromJsonString(e,t){return(new n).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(n,e,t)}}t.RecordNamespace_StickyBiasedCoinV2=n,n.runtime=s.proto3,n.typeName="apex_metrics_web.RecordNamespace.StickyBiasedCoinV2",n.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"fraction",kind:"scalar",T:1},{no:2,name:"stickiness",kind:"message",T:a}]);class a extends s.Message{constructor(e){super(),this.limit={case:void 0},s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new a).fromBinary(e,t)}static fromJson(e,t){return(new a).fromJson(e,t)}static fromJsonString(e,t){return(new a).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(a,e,t)}}t.RecordNamespace_StickinessV2=a,a.runtime=s.proto3,a.typeName="apex_metrics_web.RecordNamespace.StickinessV2",a.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"independent",kind:"message",T:s.Empty,oneof:"limit"},{no:2,name:"permanent",kind:"message",T:s.Empty,oneof:"limit"},{no:3,name:"n_results",kind:"scalar",T:13,oneof:"limit"},{no:4,name:"n_seconds",kind:"scalar",T:2,oneof:"limit"}]);class o extends s.Message{constructor(e){super(),this.reportingConfigs=[],this.publicationIntervalSeconds=0,this.maxScopesPerRequest=0,this.stopPublicationForSeconds=0,this.debugInfos=[],s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new o).fromBinary(e,t)}static fromJson(e,t){return(new o).fromJson(e,t)}static fromJsonString(e,t){return(new o).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(o,e,t)}}t.RecordNamespace_RecordResponse=o,o.runtime=s.proto3,o.typeName="apex_metrics_web.RecordNamespace.RecordResponse",o.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"reporting_configs",kind:"message",T:r,repeated:!0},{no:3,name:"publication_interval_seconds",kind:"scalar",T:13},{no:4,name:"max_scopes_per_request",kind:"scalar",T:13},{no:5,name:"stop_publication_for_seconds",kind:"scalar",T:13},{no:6,name:"debug_infos",kind:"scalar",T:9,repeated:!0}]);class c extends s.Message{constructor(e){super(),s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new c).fromBinary(e,t)}static fromJson(e,t){return(new c).fromJson(e,t)}static fromJsonString(e,t){return(new c).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(c,e,t)}}t.ApexMetricsCacheData=c,c.runtime=s.proto3,c.typeName="apex_metrics_web.ApexMetricsCacheData",c.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"config",kind:"message",T:o},{no:2,name:"timeStored",kind:"message",T:s.Timestamp},{no:3,name:"state",kind:"message",T:u}]);class l extends s.Message{constructor(e){super(),this.lastResult=!1,this.numTimesChecked=0,s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new l).fromBinary(e,t)}static fromJson(e,t){return(new l).fromJson(e,t)}static fromJsonString(e,t){return(new l).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(l,e,t)}}t.ApexMetricsCacheData_CoinState=l,l.runtime=s.proto3,l.typeName="apex_metrics_web.ApexMetricsCacheData.CoinState",l.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"lastFlipTime",kind:"message",T:s.Timestamp},{no:2,name:"lastResult",kind:"scalar",T:8},{no:3,name:"numTimesChecked",kind:"scalar",T:13}]);class p extends s.Message{constructor(e){super(),s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new p).fromBinary(e,t)}static fromJson(e,t){return(new p).fromJson(e,t)}static fromJsonString(e,t){return(new p).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(p,e,t)}}t.ApexMetricsCacheData_NamespaceCoinState=p,p.runtime=s.proto3,p.typeName="apex_metrics_web.ApexMetricsCacheData.NamespaceCoinState",p.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"dropPeriodCoin",kind:"message",T:l},{no:2,name:"dropSamplesCoin",kind:"message",T:l}]);class u extends s.Message{constructor(e){super(),this.filterID=0,this.namespaceCoinState={},s.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new u).fromBinary(e,t)}static fromJson(e,t){return(new u).fromJson(e,t)}static fromJsonString(e,t){return(new u).fromJsonString(e,t)}static equals(e,t){return s.proto3.util.equals(u,e,t)}}t.ApexMetricsCacheData_FilterState=u,u.runtime=s.proto3,u.typeName="apex_metrics_web.ApexMetricsCacheData.FilterState",u.fields=s.proto3.util.newFieldList(()=>[{no:1,name:"filterID",kind:"scalar",T:13},{no:2,name:"namespaceCoinState",kind:"map",K:9,V:{kind:"message",T:p}}])})),define("typescript/libraries/shared/apex-metrics/src/index",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/clock","typescript/libraries/shared/apex-metrics/src/executor","typescript/libraries/shared/apex-metrics/src/instant","typescript/libraries/shared/apex-metrics/src/internal","typescript/libraries/shared/apex-metrics/src/metrics","typescript/libraries/shared/apex-metrics/src/metrics_reporter","typescript/libraries/shared/apex-metrics/src/no_op","typescript/libraries/shared/apex-metrics/src/types","typescript/libraries/shared/apex-metrics/src/validate","typescript/libraries/shared/apex-metrics/src/murmur","typescript/libraries/shared/apex-metrics/src/hyperloglog"],(function(e,t,s,i,r,n,a,o,c,l,p,u,d,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),s.__exportStar(i,t),s.__exportStar(r,t),s.__exportStar(n,t),s.__exportStar(a,t),s.__exportStar(o,t),s.__exportStar(c,t),s.__exportStar(l,t),s.__exportStar(p,t),s.__exportStar(u,t),s.__exportStar(d,t),s.__exportStar(m,t)})),define("typescript/libraries/shared/apex-metrics/src/clock",["require","exports","typescript/libraries/shared/apex-metrics/src/types"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserPerformanceClock=void 0;t.BrowserPerformanceClock=class{now(){return{value:performance.now(),unit:s.TimeUnit.MILLISECONDS}}}})),define("typescript/libraries/shared/apex-metrics/src/executor",["require","exports","typescript/libraries/shared/apex-metrics/src/instant"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetTimeoutExecutor=void 0;t.SetTimeoutExecutor=class{constructor(e){this.jitterStrategy=e}executeEvery(e,t){const i=s.Instant.toMilliseconds(e),r=s.Instant.toMilliseconds(this.jitterStrategy());setTimeout(()=>{t()&&this.executeEvery(e,t)},i+r)}}})),define("typescript/libraries/shared/apex-metrics/src/instant",["require","exports","typescript/libraries/shared/apex-metrics/src/types"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Instant=void 0;t.Instant=class{static toMilliseconds(e){switch(e.unit){case s.TimeUnit.NANOSECONDS:return e.value/1e6;case s.TimeUnit.MILLISECONDS:return e.value;case s.TimeUnit.SECONDS:return 1e3*e.value;case s.TimeUnit.MINUTES:return 6e4*e.value;case s.TimeUnit.HOURS:return 36e5*e.value;case s.TimeUnit.DAYS:return 24*e.value*36e5}}}})),define("typescript/libraries/shared/apex-metrics/src/internal",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("typescript/libraries/shared/apex-metrics/src/metrics",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("typescript/libraries/shared/apex-metrics/src/metrics_reporter",["require","exports","typescript/libraries/shared/apex-metrics/src/instant","typescript/libraries/shared/apex-metrics/src/validate","typescript/libraries/shared/apex-metrics/src/hyperloglog"],(function(e,t,s,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MetricsReporterImpl=void 0;class n{constructor(e,t,s,i={}){this.sink=e,this.clock=t,this.originId=s,this.tags=i}static root(e,t,s=""){return new n(e,t,s)}child(e){return new n(this.sink,this.clock,this.originId,Object.assign(Object.assign({},this.tags),(0,i.validateTags)(e)))}createStats(e,t={}){return new a((0,i.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,i.validateTags)(t)),this.sink)}createCounter(e,t={}){return new o((0,i.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,i.validateTags)(t)),this.sink)}createTimer(e,t={}){return new c((0,i.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,i.validateTags)(t)),this.sink,this.clock)}createSet(e,t={}){return new l((0,i.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,i.validateTags)(t)),this.sink,this.originId)}}t.MetricsReporterImpl=n;class a{constructor(e,t,s){this.metric=e,this.tags=t,this.sink=s}record(e){p(e,this.metric,this.tags,this.sink)}recordDuration(e,t){p(s.Instant.toMilliseconds({value:e,unit:t}),this.metric,this.tags,this.sink)}}class o{constructor(e,t,s,i=0){this.metric=e,this.tags=t,this.sink=s,this.value=i}decrement(e=1){this.value-=e}increment(e=1){this.value+=e}reset(e=0){this.value=e}record(){p(this.value,this.metric,this.tags,this.sink),this.reset()}}class c{constructor(e,t,i,r,n=0){this.metric=e,this.tags=t,this.sink=i,this.clock=r,this.value=n,this.value=s.Instant.toMilliseconds(this.clock.now())}record(){p(s.Instant.toMilliseconds(this.clock.now())-this.value,this.metric,this.tags,this.sink),this.reset()}reset(){this.value=s.Instant.toMilliseconds(this.clock.now())}}class l{constructor(e,t,s,i){this.metric=e,this.tags=t,this.sink=s,this.originId=i}observe(e){if("string"!=typeof e)throw new Error("value must be a string");const t=(0,r.hash)(e);this.sink.recordSetSpan({namespace:this.metric.ns,metricName:this.metric.name,tags:this.tags,samples:[t],type:"set"})}observeOriginId(){this.observe(this.originId)}}function p(e,t,s,i){if("number"!=typeof e)throw new Error("value must be a number");i.recordSpan({namespace:t.ns,metricName:t.name,tags:s,samples:[e],type:"histogram"})}})),define("typescript/libraries/shared/apex-metrics/src/no_op",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpExecutor=t.NoOpSink=void 0;t.NoOpSink=class{recordSpan(){}recordSetSpan(){}};t.NoOpExecutor=class{executeEvery(){}}})),define("typescript/libraries/shared/apex-metrics/src/types",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimeUnit=void 0,(function(e){e[e.NANOSECONDS=0]="NANOSECONDS",e[e.MILLISECONDS=1]="MILLISECONDS",e[e.SECONDS=2]="SECONDS",e[e.MINUTES=3]="MINUTES",e[e.HOURS=4]="HOURS",e[e.DAYS=5]="DAYS"})(t.TimeUnit||(t.TimeUnit={}))})),define("typescript/libraries/shared/apex-metrics/src/validate",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateMetricName=t.validateNamespace=t.validateTags=t.validateMetric=void 0;const s=new RegExp("^[^0-9a-zA-Z]+"),i=new RegExp("[^0-9a-zA-Z._-]","g"),r=i,n=new RegExp("[^0-9a-zA-Z/._-]","g"),a=i;function o(e){return l(e,"namespace",256,s,r)}function c(e){return l(e,"metric name",256,s,n)}function l(e,t,s,i,r){const n=[];if("string"!=typeof e&&n.push("identifier is not a string"),i&&i.test(e)&&n.push("invalid prefix"),r&&r.test(e)&&n.push("invalid characters"),e.length>s&&n.push(`exceeds ${s} characters`),0===e.length&&n.push("is empty"),0!==n.length)throw new Error(`${t} identifier '${e}' is invalid: ${n}`);return e}t.validateMetric=function(e){return{ns:o(e.ns),name:c(e.name)}},t.validateTags=function(e){const t={};for(const i in e)if(e.hasOwnProperty(i)){t[l(i,"tag name",256,s,a)]=l(e[i],"tag value",256)}return t},t.validateNamespace=o,t.validateMetricName=c})),define("typescript/libraries/shared/apex-metrics/src/hyperloglog",["require","exports","typescript/libraries/shared/apex-metrics/src/murmur"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripCompress=t.HyperLogLog=t.hash=void 0;const i=[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,.0009765625,.00048828125,.000244140625,.0001220703125,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19,9.5367431640625e-7,4.76837158203125e-7,2.384185791015625e-7,1.1920928955078125e-7,5.960464477539063e-8,2.9802322387695312e-8,1.4901161193847656e-8,7.450580596923828e-9,3.725290298461914e-9,1.862645149230957e-9,9.313225746154785e-10,4.656612873077393e-10,2.3283064365386963e-10];t.hash=function(e){return(0,s.hash32)((0,s.stringToUtf8ByteArray)(e),538513424)};function r(e){if(8!=e.length)throw new Error("Number of registers in stripCompress routine is not 8");const t=[];let s=0;for(let t=0;t<8;t++){if(s*=32,e[t]>=32)throw new Error("Register in HLL greater than max allowed value");s+=e[t]}for(let e=0;e<5;e++)t.unshift(Number(s%256)),s=Math.floor(s/256);return t}t.HyperLogLog=class{constructor(e=[]){this.registers=new Array(512).fill(0),e.forEach(e=>this.add(e))}add(e){if(e>=2**32)throw new Error("add only accepts 32-bit unsigned integers");const t=(function(e,t){let s=1;for(;(2147483648&e)>>>0==0&&s<=t;)s++,e=e<<1>>>0;return s})(e<<9>>>0,23),s=e>>>23;t>this.registers[s]&&(this.registers[s]=t)}count(){let e=this.registers.reduce((e,t)=>e+i[t],0),t=this.registers.reduce((e,t)=>e+(0==t?1:0),0);if(512==t)return 0;let s=188686.82445861166/e;return s<=1280?t>0&&(s=512*Math.log(512/t)):s>1/30*2**32&&(s=-(2**32)*Math.log(1-s/2**32)),s}merge(e){for(let t=0;t<512;t++){const s=e.registers[t];s>this.registers[t]&&(this.registers[t]=s)}}compressed(){const e=[];for(let t=0;t<64;t++){const s=r(this.registers.slice(8*t,8*(t+1)));for(const t of s)e.push(t)}return String.fromCharCode(...e)}},t.stripCompress=r})),define("typescript/libraries/shared/apex-metrics/src/murmur",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringToUtf8ByteArray=t.hash32=void 0;function s(e){if(4!=e.length)throw new Error("strToUint32 expected length 4 byte array");return e[0]+(e[1]<<8)+(e[2]<<16)+(e[3]<<24)}t.hash32=function(e,t){let i=t;const r=Math.floor(e.length/4);for(let t=0;t<r;t++){let r=s(e.slice(4*t,4*t+4));r=Math.imul(r,3432918353),r=(r<<15>>>0|r>>>17)>>>0,r=Math.imul(r,461845907),i^=r,i>>>=0,i=(i<<13>>>0|i>>>19)>>>0,i=Math.imul(i,5)+3864292196>>>0}let n=e.slice(4*r),a=0;const o=3&n.length;return 3==o&&(a^=n[2]<<16>>>0,a>>>=0),o>=2&&(a^=n[1]<<8>>>0,a>>>=0),o>=1&&(a^=n[0],a=Math.imul(a,3432918353),a=(a<<15>>>0|a>>>17)>>>0,a=Math.imul(a,461845907),i^=a,i>>>=0),i^=e.length,i>>>=0,i^=i>>>16,i>>>=0,i=Math.imul(i,2246822507),i^=i>>>13,i>>>=0,i=Math.imul(i,3266489909),i^=i>>>16,i>>>=0,i},t.stringToUtf8ByteArray=function(e){const t=[];let s=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);r<128?t[s++]=r:r<2048?(t[s++]=r>>6|192,t[s++]=63&r|128):(t[s++]=r>>12|224,t[s++]=r>>6&63|128,t[s++]=63&r|128)}return t}})),define("typescript/libraries/shared/apex-metrics/src/sink/apiv2_sink",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/coin","typescript/libraries/shared/apex-metrics/src/sink/database","typescript/libraries/shared/apex-metrics/src/sink/filter","typescript/libraries/shared/apex-metrics/src/sink/instrumentation","@bufbuild/protobuf","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb","typescript/libraries/shared/apex-metrics/src/sink/serialization"],(function(e,t,s,i,r,n,a,o,c,l,p){"use strict";var u;Object.defineProperty(t,"__esModule",{value:!0}),t.Apiv2MetricsSink=t.clientSDKAdaptor=t.clientFetchAdaptor=t.clientBaseAdaptor=t._ORIGIN_IDENTIFIER_KEY=t.makeDefaultCacheFactory=t._PERSISTENTCACHE_KEY=t.makeDefaultInitialization=t.makeNopExceptionReporter=t.makeNopPlatformDetector=t.CLIENT_VERSION=t.PublishType=void 0,l=s.__importStar(l),(function(e){e.ALLOWED="allowed",e.DENIED="denied"})(u=t.PublishType||(t.PublishType={}));const d={".tag":"trigger_heartbeat"},m={".tag":"trigger_publish"};t.CLIENT_VERSION=25;function h(e,s,i,r,n){const a=[];return s.forEach(e=>a.push(e)),{scopes:e,known_namespaces:a,environment:"prod",artifact_name:"dropbox-web",artifact_version:"0000000000000000000000000000000000000000",client_metadata:{client_version:t.CLIENT_VERSION,implementation:{".tag":"typescript"}},trigger:i,os:r,origin_identifier:n}}t.makeNopPlatformDetector=function(){return{detectBrowser:()=>"other",detectOS:()=>({name:{".tag":"unknown_os"},version:"unknown"})}},t.makeNopExceptionReporter=function(){return{reportException:e=>{},reportStack:(e,t)=>{}}},t.makeDefaultInitialization=function(e,i,n){return(a,o)=>s.__awaiter(this,void 0,void 0,(function*(){let s=[];if(a){const e=(function(e,s){const i=e.getItem(t._PERSISTENTCACHE_KEY);if(null===i)return null;const n=Date.now()/1e3;let a,o=[];try{a=(0,p.unmarshalProto)(i,l.ApexMetricsCacheData)}catch(e){return s.reportException({err:e,tags:["js:web:amp-sink","js:web:amp-sink/local-storage"],severity:"non-critical"}),null}if(!a.config||!a.state||!a.timeStored)return s.reportStack("Sink cache was missing data",{tags:["js:web:amp-sink","js:web:amp-sink/local-storage"]}),null;const c=n-(u=a.timeStored.seconds,Number(u.toString()));var u;if(c<0)return s.reportStack("Sink cache was stored in the future instead of the past",{tags:["js:web:amp-sink","js:web:amp-sink/local-storage"],exc_extra:{cacheDataAge:c}}),null;const d={};a.config&&(o=a.config.reportingConfigs.map(e=>e.metricNamespace),d.reporting_configs=a.config.reportingConfigs?a.config.reportingConfigs.filter(e=>c<e.maxTimeUntilRefreshSeconds).map(e=>({metric_namespace:e.metricNamespace,max_time_until_refresh_seconds:e.maxTimeUntilRefreshSeconds,stop_publication_for_seconds:e.stopPublicationForSeconds,drop_samples:e.dropSamples?(0,r.protobufCoinToAPIv2Coin)(e.dropSamples):void 0,drop_periods:e.dropPeriods?(0,r.protobufCoinToAPIv2Coin)(e.dropPeriods):void 0,drop_fraction_of_hosts_per_metric:e.dropFractionOfHostsPerMetric,aggregation_interval_seconds:e.aggregationIntervalSeconds})):[],d.publication_interval_seconds=a.config.publicationIntervalSeconds,d.max_scopes_per_request=a.config.maxScopesPerRequest,d.stop_publication_for_seconds=a.config.stopPublicationForSeconds,d.debug_infos=a.config.debugInfos);return{config:d,state:a.state,knownNamespaces:o}})(a,n);if(e){s=e.knownNamespaces;const t=new Set;if(e.config.reporting_configs.forEach(e=>t.add(e.metric_namespace)),!s.some(e=>!t.has(e)))return e}}const c=new Set;s.forEach(e=>c.add(e));const u=i.detectOS(),m=yield e(),f=(yield m.clientMetricsRecord(h([],c,d,u,o))).result,_=Math.floor(4294967296*Math.random())>>>0;return{knownNamespaces:s,config:f,state:new l.ApexMetricsCacheData_FilterState({filterID:_,namespaceCoinState:{}})}}))},t._PERSISTENTCACHE_KEY="amp-sink-cache",t.makeDefaultCacheFactory=function(){return()=>{try{return window.localStorage||null}catch(e){return null}}},t._ORIGIN_IDENTIFIER_KEY="amp-sink-origin-id",t.clientBaseAdaptor=function(e){return{clientMetricsRecord:t=>e.ns("client_metrics").rpc("record",t,{}).then(e=>({result:e}))}},t.clientFetchAdaptor=function(e){return{clientMetricsRecord:t=>e("/api/2/client_metrics/record",{method:"POST",body:JSON.stringify(t)}).then(e=>{if(e.ok)return e.json().then(e=>e);throw new Error(e.statusText)})}},t.clientSDKAdaptor=function(e){return{clientMetricsRecord:t=>e.clientMetricsRecord(t).then(e=>e).then(e=>{if(e.ok)return e.json().then(e=>e);throw new Error(e.statusText)})}};class f{emit(e,...t){return!0}}t.Apiv2MetricsSink=class{constructor(e,s,i,r,n,a,c,l,p,u,d,m=new f){this.clientFactory=e,this.clock=s,this.initializer=i,this.cacheFactory=r,this.executor=n,this.randomEngine=a,this.databaseFactory=c,this.platformDetector=l,this.excReporter=p,this.originKind=u,this.eventEmitter=m,this.nextRequest=null,this.spanGroupFilter=null,this.knownNamespaces=new Set,this.bufferedSpans=[],this.bufferedSetSpans=[],this.instrumentation=o.Instrumentation.empty(),this.blackoutCallback=null,this.publishTimer=null,this.database=null,this.cache=this.cacheFactory(),this.originIdentifier=(function(e,s){if(e){let i=e.getItem(t._ORIGIN_IDENTIFIER_KEY);return null===i&&(i=s(),e.setItem(t._ORIGIN_IDENTIFIER_KEY,i)),i}return""})(this.cache,d),this.currentRequest=this.initializer(this.cache,this.originIdentifier).then(e=>(e&&this.updateConfiguration(e.config,e.state),this.eventEmitter.emit("initialized"),e.config||null))}getOriginId(){return this.originIdentifier}updateConfiguration(e,s){const{reporting_configs:n=[],stop_publication_for_seconds:a,publication_interval_seconds:o}=e,u=new Set;n.forEach(e=>{this.knownNamespaces.add(e.metric_namespace),u.add(e.metric_namespace)}),this.updateBlackoutCallback({value:a,unit:i.TimeUnit.SECONDS}),this.updatePublishTimer({value:o,unit:i.TimeUnit.SECONDS}),this.updateSpanGroupFilter(e,s,u),this.cache&&(function(e,s,i){try{const n=Math.floor(Date.now()/1e3),a=new l.ApexMetricsCacheData({config:new l.RecordNamespace_RecordResponse({reportingConfigs:s.reporting_configs?s.reporting_configs.map(e=>new l.RecordNamespace_MetricReportingConfigV2({metricNamespace:e.metric_namespace,maxTimeUntilRefreshSeconds:e.max_time_until_refresh_seconds,stopPublicationForSeconds:e.stop_publication_for_seconds,dropSamples:e.drop_samples?(0,r.APIv2CoinToProtobufCoin)(e.drop_samples):void 0,dropPeriods:e.drop_periods?(0,r.APIv2CoinToProtobufCoin)(e.drop_periods):void 0,dropFractionOfHostsPerMetric:e.drop_fraction_of_hosts_per_metric,aggregationIntervalSeconds:e.aggregation_interval_seconds})):[],publicationIntervalSeconds:s.publication_interval_seconds,maxScopesPerRequest:s.max_scopes_per_request,stopPublicationForSeconds:s.stop_publication_for_seconds,debugInfos:s.debug_infos||[]}),timeStored:c.Timestamp.fromDate(new Date(1e3*n)),state:i});e.setItem(t._PERSISTENTCACHE_KEY,(0,p.marshalProto)(a))}catch(e){}})(this.cache,e,s)}updateSpanGroupFilter(e,t,s){const{reporting_configs:i=[],max_scopes_per_request:r}=e,n=new Set,o=s.values();for(let e=o.next();!e.done;e=o.next())n.add(e.value);const c=(0,a.makeNamespaceMap)(i,t);this.spanGroupFilter=this.spanGroupFilter?this.spanGroupFilter.extend(r,c,n):new a.SpanGroupFilter(t.filterID,this.randomEngine,this.clock,r,c,n)}updateBlackoutCallback(e){0!==e.value?(this.blackoutCallback=()=>(this.blackoutCallback=null,this.eventEmitter.emit("publicationResumed"),!1),this.eventEmitter.emit("publicationPaused"),this.executor.executeEvery(e,this.blackoutCallback)):this.blackoutCallback=null}updatePublishTimer(e){const t=e.unit===i.TimeUnit.SECONDS?e.value:i.Instant.toMilliseconds(e)/1e3;if(0===e.value)return void(this.publishTimer=null);if(this.publishTimer&&i.Instant.toMilliseconds(this.publishTimer.period)===i.Instant.toMilliseconds(e))return;const r={period:e,callback:()=>this.publishTimer===r&&(this.nextRequest=this.currentRequest.then(()=>s.__awaiter(this,void 0,void 0,(function*(){this.nextRequest=null;const e=Math.floor(Date.now()/1e3),s=yield this.getDB();if(s)try{(yield(0,n.checkAndSetPublishTime)(s,e,t))&&(this.currentRequest=this.send())}catch(e){this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"})}}))),!0)};this.publishTimer=r,this.executor.executeEvery(this.publishTimer.period,this.publishTimer.callback)}send(){return s.__awaiter(this,void 0,void 0,(function*(){if(this.blackoutCallback)return this.eventEmitter.emit("publish",u.DENIED),null;const e=Math.floor(Date.now()/1e3),t={browser:this.platformDetector.detectBrowser()},s=yield this.getDB();if(!s)return null;let i,r,a,c,l;try{({scopes:i,storedNamespaces:r,spansRetained:a,samplesRetainedByNs:c,observationsRetained:l}=yield this.spanGroupFilter.partitionAndSerializeSpans(s,t,e,[o.SELF_INSTRUMENTATION_NAMESPACE]))}catch(e){return this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"}),null}let p=o.Instrumentation.empty();p.retainedSpans+=a;let d=0;c.forEach((e,t)=>{o.Instrumentation.incrementRetainedSamples(p,t,e),d+=e});let f=i.length>0;if(this.knownNamespaces.forEach(e=>r.add(e)),!f){const e=this.spanGroupFilter.getConfiguredNamespaces(),t=r.values();for(let s=t.next();!s.done;s=t.next())if(!e.has(s.value)){f=!0;break}}let _=null;if(f){p=yield(0,n.loadInstrumentation)(s,p);const e=this.platformDetector.detectOS(),o=h(i,r,m,e,this.originIdentifier),c=this.clock.now();p.requestAttempts++;try{const s=yield this.clientFactory();_=(yield s.clientMetricsRecord(o)).result,p=yield this.reportInstrumentation(e,p,c,t)}catch(e){p.requestDroppedSpans+=a,p.requestDroppedSamples+=d,p.requestDroppedSetObservations+=l}_&&this.updateConfiguration(_,this.spanGroupFilter.getState())}return yield(0,n.storeInstrumentation)(s,p),this.eventEmitter.emit("publish",u.ALLOWED),_}))}reportInstrumentation(e,r,n,a){return s.__awaiter(this,void 0,void 0,(function*(){const s=i.Instant.toMilliseconds(this.clock.now())-i.Instant.toMilliseconds(n);if((function(e){return!!e.name&&("android"===e.name[".tag"]||"ios"===e.name[".tag"])})(e))try{const i=Object.assign({client_version:t.CLIENT_VERSION.toString(),origin_kind:this.originKind},a),n=h([o.Instrumentation.toScope(r,this.originIdentifier,s,i)],new Set([o.SELF_INSTRUMENTATION_NAMESPACE]),m,e,this.originIdentifier),c=yield this.clientFactory();return yield c.clientMetricsRecord(n),o.Instrumentation.empty()}catch(e){return r}return o.Instrumentation.report(r,i.MetricsReporterImpl.root(this,this.clock,this.originIdentifier),s,t.CLIENT_VERSION,this.originKind)}))}getDB(){return s.__awaiter(this,void 0,void 0,(function*(){return this.database||(this.database=yield this.databaseFactory()),this.database}))}recordSpan(e){if(e.namespace!==o.SELF_INSTRUMENTATION_NAMESPACE){let t="UNCONFIGURED";this.spanGroupFilter&&this.spanGroupFilter.getConfiguredNamespaces().has(e.namespace)&&(t=e.namespace),this.instrumentation.submittedSpans++,o.Instrumentation.incrementSubmittedSamples(this.instrumentation,t,e.samples.length)}this.knownNamespaces.add(e.namespace),this.bufferedSpans.push(e),this.maybeScheduleNextRequest()}recordSetSpan(e){if(e.namespace!==o.SELF_INSTRUMENTATION_NAMESPACE){let t="UNCONFIGURED";this.spanGroupFilter&&this.spanGroupFilter.getConfiguredNamespaces().has(e.namespace)&&(t=e.namespace),o.Instrumentation.incrementSetObservations(this.instrumentation,t,e.samples.length)}this.knownNamespaces.add(e.namespace),this.bufferedSetSpans.push(e),this.maybeScheduleNextRequest()}maybeScheduleNextRequest(){this.nextRequest||(this.nextRequest=this.currentRequest.then(()=>s.__awaiter(this,void 0,void 0,(function*(){const e=yield this.getDB();if(!e)return;const t=this.bufferedSpans,s=this.bufferedSetSpans;this.bufferedSpans=[],this.bufferedSetSpans=[];const i=this.instrumentation;this.instrumentation=o.Instrumentation.empty();try{yield Promise.all([(0,n.storeIncomingSpans)(e,t),(0,n.storeIncomingSetSpans)(e,s),(0,n.storeInstrumentation)(e,i)])}catch(e){this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"})}this.publishTimer||(this.currentRequest=this.send()),this.nextRequest=null}))))}}})),define("typescript/libraries/shared/apex-metrics/src/sink/coin",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb","@bufbuild/protobuf"],(function(e,t,s,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.observeCoin=t.APIv2CoinToProtobufCoin=t.protobufCoinToAPIv2Coin=t.newCoinState=void 0,r=s.__importStar(r),t.newCoinState=function(){return new r.ApexMetricsCacheData_CoinState({lastFlipTime:void 0,lastResult:!1,numTimesChecked:0})},t.protobufCoinToAPIv2Coin=function(e){let t=void 0;if(e.stickiness&&e.stickiness.limit)switch(e.stickiness.limit.case){case"independent":t={".tag":"independent"};break;case"permanent":t={".tag":"permanent"};break;case"nResults":t={".tag":"n_results",n_results:e.stickiness.limit.value};break;case"nSeconds":t={".tag":"n_seconds",n_seconds:e.stickiness.limit.value}}return{fraction:null!==e.fraction?e.fraction:void 0,stickiness:t?{limit:t}:void 0}};t.APIv2CoinToProtobufCoin=function(e){let t=void 0;if(e.stickiness&&e.stickiness.limit)switch(e.stickiness.limit[".tag"]){case"independent":t={limit:{case:"independent",value:new n.Empty}};break;case"permanent":t={limit:{case:"permanent",value:new n.Empty}};break;case"n_results":t={limit:{case:"nResults",value:e.stickiness.limit.n_results}};break;case"n_seconds":t={limit:{case:"nSeconds",value:e.stickiness.limit.n_seconds}}}return new r.RecordNamespace_StickyBiasedCoinV2({fraction:e.fraction,stickiness:t?new r.RecordNamespace_StickinessV2(t):void 0})},t.observeCoin=function(e,t,s){if(!t.stickiness||!t.stickiness.limit)return{nextState:s,result:!1};const a=Date.now()/1e3,{lastFlipTime:o=n.Timestamp.fromDate(new Date(0)),lastResult:c,numTimesChecked:l=0}=s;let p=!1;switch(t.stickiness.limit[".tag"]){case"n_results":p=null===l||l%t.stickiness.limit.n_results==0;break;case"n_seconds":if(!o){p=!0;break}p=i.Instant.toMilliseconds({value:a-(u=o.seconds,Number(u.toString())),unit:i.TimeUnit.SECONDS})>i.Instant.toMilliseconds({value:t.stickiness.limit.n_seconds,unit:i.TimeUnit.SECONDS});break;case"permanent":p=0===l;break;case"independent":p=!0;break;case"other":default:return{nextState:s,result:!1}}var u;if(p){const s=e()<(t.fraction||0);return{nextState:new r.ApexMetricsCacheData_CoinState({lastFlipTime:n.Timestamp.fromDate(new Date(1e3*a)),lastResult:s,numTimesChecked:l?l+1:1}),result:s}}return{nextState:new r.ApexMetricsCacheData_CoinState(Object.assign(Object.assign({},s),{numTimesChecked:l?l+1:1})),result:!!c}}})),define("typescript/libraries/shared/apex-metrics/src/sink/database",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/sink/instrumentation"],(function(e,t,s,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadInstrumentation=t.storeInstrumentation=t.storeIncomingSetSpans=t.storeIncomingSpans=t.checkAndSetPublishTime=t.getDatabase=t.getNamespaceRange=t.INSTRUMENTATION_STORE_KEY=t.INSTRUMENTATION_STORE=t.CONTROL_VALUE_LASTPUBLISHTIME=t.CONTROL_VALUE_STORE=t.NAMESPACE_INDEX=t.SET_STORE=t.SPAN_STORE=t.DATABASE_VERSION=void 0;function r(e,s,i){const r=e.result,n=e=>{r.removeEventListener("error",n),i(e)};r.addEventListener("error",n),e.transaction.addEventListener("complete",()=>{r.removeEventListener("error",n)}),e.transaction.addEventListener("error",e=>{r.removeEventListener("error",n),i(e)});const a=(e,t)=>e.oldVersion<t&&(null===e.newVersion||e.newVersion&&e.newVersion>=t);if(a(s,1))try{r.createObjectStore(t.SPAN_STORE,{keyPath:["namespace","tagNames","tagValues"]}).createIndex(t.NAMESPACE_INDEX,"namespace",{unique:!1}),r.createObjectStore(t.CONTROL_VALUE_STORE,{keyPath:"name"})}catch(e){return void n(e)}if(a(s,2)){const s=e.transaction.objectStore(t.SPAN_STORE).openCursor();s.addEventListener("success",()=>{const e=s.result;if(!e)return;let t=!1;for(const s in e.value.spans)e.value.spans.hasOwnProperty(s)&&(t=!0,e.value.spans[s]={spanCount:0,samples:e.value.spans[s]});t&&e.update(e.value),e.continue()})}if(a(s,3))try{r.createObjectStore(t.INSTRUMENTATION_STORE,{keyPath:"name"})}catch(e){return void n(e)}if(a(s,4))try{e.transaction.objectStore(t.SPAN_STORE).clear(),e.transaction.objectStore(t.INSTRUMENTATION_STORE).clear()}catch(e){return void n(e)}if(a(s,5))try{r.createObjectStore(t.SET_STORE,{keyPath:["namespace","tagNames","tagValues"]}).createIndex(t.NAMESPACE_INDEX,"namespace",{unique:!1})}catch(e){return void n(e)}if(a(s,6))try{e.transaction.objectStore(t.SPAN_STORE).clear(),e.transaction.objectStore(t.SET_STORE).clear(),e.transaction.objectStore(t.INSTRUMENTATION_STORE).clear()}catch(e){return void n(e)}}function n(e,t,s,i){return Promise.all(t.map(t=>new Promise((r,n)=>{let a;try{a=e.transaction(s,"readwrite")}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void r();throw e}const o=a.objectStore(s);a.addEventListener("complete",e=>r()),a.addEventListener("error",e=>n(e));const c=[],l=[];for(const e in t.tags)t.tags.hasOwnProperty(e)&&(c.push(e),l.push(t.tags[e]));const p=o.get([t.namespace,c,l]);p.addEventListener("success",()=>{const e=p.result?p.result:{namespace:t.namespace,tagNames:c,tagValues:l,spans:{}};e.spans[t.metricName]||(e.spans[t.metricName]={spanCount:0,samples:[]}),e.spans[t.metricName].spanCount++,e.spans[t.metricName].samples=i(e.spans[t.metricName].samples.concat(t.samples)),o.put(e)})})))}function a(e,t,s){try{return e.transaction(t,s)}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return null;throw e}}function o(e,t){return new Promise((s,i)=>{const r=e.get(t);r.addEventListener("success",()=>{s(r.result)}),r.addEventListener("error",e=>{i(e)})})}t.DATABASE_VERSION=6,t.SPAN_STORE="spans",t.SET_STORE="set_spans",t.NAMESPACE_INDEX="namespace",t.CONTROL_VALUE_STORE="controlValues",t.CONTROL_VALUE_LASTPUBLISHTIME="lastPublishTime",t.INSTRUMENTATION_STORE="selfInstrumentation",t.INSTRUMENTATION_STORE_KEY="instrumentation",t.getNamespaceRange=function(e,s){return new Promise((i,r)=>{const n=e.index(t.NAMESPACE_INDEX).getKey(IDBKeyRange.lowerBound(s,!0));n.addEventListener("success",()=>{if(n.result){const e=n.result[0];i(IDBKeyRange.bound([s],[e],!1,!0))}else i(IDBKeyRange.lowerBound([s]))}),n.addEventListener("error",e=>{r(e)})})},t.getDatabase=function(e=t.DATABASE_VERSION){return s.__awaiter(this,void 0,void 0,(function*(){let t=null;if("undefined"==typeof indexedDB)return t;try{t=yield new Promise((t,s)=>{indexedDB.open("unused",1);const i=indexedDB.open("apexMetrics",e);i.addEventListener("success",()=>{t(i.result)}),i.addEventListener("error",e=>{s(e)}),i.addEventListener("upgradeneeded",e=>{try{r(i,e,s)}catch(e){s(e)}})})}catch(s){s.target&&s.target.error&&s.target.error.name&&"VersionError"===s.target.error.name&&(yield new Promise((e,t)=>{const s=indexedDB.deleteDatabase("apexMetrics");s.addEventListener("success",()=>e()),s.addEventListener("error",e=>t(e))}),t=yield new Promise((t,s)=>{const i=indexedDB.open("apexMetrics",e);i.addEventListener("success",()=>t(i.result)),i.addEventListener("error",e=>s(e)),i.addEventListener("upgradeneeded",e=>{try{r(i,e,s)}catch(e){s(e)}})}))}return t}))},t.checkAndSetPublishTime=function(e,i,r){return new Promise((n,a)=>s.__awaiter(this,void 0,void 0,(function*(){let s;try{s=e.transaction(t.CONTROL_VALUE_STORE,"readwrite").objectStore(t.CONTROL_VALUE_STORE)}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void n(!1);throw e}const o=s.get(t.CONTROL_VALUE_LASTPUBLISHTIME);o.addEventListener("success",()=>{const e=o.result;if(e&&i-+e.value<r)return void n(!1);const c=s.put({name:t.CONTROL_VALUE_LASTPUBLISHTIME,value:i});c.addEventListener("success",()=>{n(!0)}),c.addEventListener("error",e=>{a(e)})}),o.addEventListener("error",e=>{a(e)})})))},t.storeIncomingSpans=function(e,s){return n(e,s,t.SPAN_STORE,e=>(e.sort(),e))},t.storeIncomingSetSpans=function(e,s){return n(e,s,t.SET_STORE,e=>{const t={};return e.filter(e=>!t[e]&&(t[e]=!0,!0))})},t.storeInstrumentation=function(e,r){return new Promise((n,c)=>s.__awaiter(this,void 0,void 0,(function*(){var s,l;const p=a(e,t.INSTRUMENTATION_STORE,"readwrite");if(null===p)return void n();const u=p.objectStore(t.INSTRUMENTATION_STORE);p.addEventListener("complete",()=>{n()}),p.addEventListener("error",c);const d=null!==(l=null===(s=yield o(u,t.INSTRUMENTATION_STORE_KEY))||void 0===s?void 0:s.value)&&void 0!==l?l:i.Instrumentation.empty(),m=i.Instrumentation.merge(r,d);yield(function(e,t){return new Promise((s,i)=>{const r=e.put(t);r.addEventListener("success",()=>{s()}),r.addEventListener("error",e=>{i(e)})})})(u,{name:t.INSTRUMENTATION_STORE_KEY,value:m})})))},t.loadInstrumentation=function(e,r){return new Promise((n,c)=>s.__awaiter(this,void 0,void 0,(function*(){var s,l;const p=a(e,t.INSTRUMENTATION_STORE,"readwrite");if(null===p)return void n(r);p.addEventListener("error",c);const u=p.objectStore(t.INSTRUMENTATION_STORE),d=null!==(l=null===(s=yield o(u,t.INSTRUMENTATION_STORE_KEY))||void 0===s?void 0:s.value)&&void 0!==l?l:i.Instrumentation.empty();p.addEventListener("complete",()=>{n(i.Instrumentation.merge(r,d))}),(function(e,t){new Promise((s,i)=>{const r=e.delete(t);r.addEventListener("success",()=>{s()}),r.addEventListener("error",e=>{i(e)})})})(u,t.INSTRUMENTATION_STORE_KEY)})))}})),define("typescript/libraries/shared/apex-metrics/src/sink/filter",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/sink/coin","typescript/libraries/shared/apex-metrics/src/sink/database","typescript/libraries/shared/apex-metrics/src/sink/serialization","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb","typescript/libraries/shared/apex-metrics/src/hyperloglog","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb"],(function(e,t,s,i,r,n,a,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpanGroupFilter=t.makeNamespaceMap=void 0,a=s.__importStar(a);function l(e,t){return s.__awaiter(this,void 0,void 0,(function*(){let s=null;if(crypto.subtle&&window.TextEncoder){const e=new TextEncoder,i=yield crypto.subtle.digest("SHA-256",e.encode(t));s=new Uint32Array(i).reduce((e,t)=>e^t)}return null===s?0:((s^e)>>>0)/4294967296}))}t.makeNamespaceMap=function(e,t){const s={};for(const r of e){const e=r.metric_namespace;s[e]={dropFractionOfHostsPerMetric:r.drop_fraction_of_hosts_per_metric||null,dropPeriodCoin:r.drop_periods?{config:r.drop_periods,state:t.namespaceCoinState&&t.namespaceCoinState[e]&&t.namespaceCoinState[e].dropPeriodCoin||(0,i.newCoinState)()}:null,dropSamplesCoin:r.drop_samples?{config:r.drop_samples,state:t.namespaceCoinState&&t.namespaceCoinState[e]&&t.namespaceCoinState[e].dropSamplesCoin||(0,i.newCoinState)()}:null}}return s};class p{constructor(e,t,s,i,r,n){this.filterID=e,this.randomEngine=t,this.clock=s,this.maxScopes=i,this.namespaceMap=r,this.configuredNamespaces=n}extend(e,t,s){return new p(this.filterID,this.randomEngine,this.clock,e||this.maxScopes,Object.assign(Object.assign({},this.namespaceMap),t),s)}getState(){const e={filterID:this.filterID,namespaceCoinState:{}};for(const t in this.namespaceMap)this.namespaceMap.hasOwnProperty(t)&&(e.namespaceCoinState[t]=new c.ApexMetricsCacheData_NamespaceCoinState({dropPeriodCoin:this.namespaceMap[t].dropPeriodCoin?new c.ApexMetricsCacheData_CoinState(Object.assign({},this.namespaceMap[t].dropPeriodCoin.state)):void 0,dropSamplesCoin:this.namespaceMap[t].dropSamplesCoin?new c.ApexMetricsCacheData_CoinState(Object.assign({},this.namespaceMap[t].dropSamplesCoin.state)):void 0}));return new a.ApexMetricsCacheData_FilterState(e)}getConfiguredNamespaces(){return this.configuredNamespaces}partitionAndSerializeSpans(e,t,a,c){return s.__awaiter(this,void 0,void 0,(function*(){return new Promise((p,u)=>{const d=[];let m=0;const h=new Map;let f,_=0;const S=new Set;try{f=e.transaction([r.SPAN_STORE,r.SET_STORE],"readwrite")}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void p({scopes:[],storedNamespaces:S,spansRetained:0,samplesRetainedByNs:new Map,observationsRetained:0});throw e}const g=new Map,v=new Set;f.addEventListener("complete",()=>p({scopes:d,storedNamespaces:S,spansRetained:m,samplesRetainedByNs:h,observationsRetained:_})),f.addEventListener("error",e=>u(e));const b=[{storeName:r.SPAN_STORE,serializeSamplesFunc:(e,t,s,i,r)=>{var n;c.includes(i)||(m+=r,h.set(i,(null!==(n=h.get(i))&&void 0!==n?n:0)+s.length)),(function(e,t,s){t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"numerical_data",samples:s}})})(e,t,s)}},{storeName:r.SET_STORE,serializeSamplesFunc:(e,t,s,i,r)=>{c.includes(i)||(_+=s.length),(function(e,t,s){s.length>80?t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",hyperloglog:{registers:new o.HyperLogLog(s).compressed()}}}):t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",samples:s}})})(e,t,s)}}];for(const{storeName:e,serializeSamplesFunc:o}of b){const c=f.objectStore(e);let p;try{p=c.index(r.NAMESPACE_INDEX)}catch(e){return void u(e)}const m=p.count();m.addEventListener("success",()=>{if(0===m.result)return;const e=p.openKeyCursor(null,"nextunique");e.addEventListener("success",()=>s.__awaiter(this,void 0,void 0,(function*(){var p;const m=e.result;if(!m)return;const h=m.key;if(0!==this.maxScopes&&d.length===this.maxScopes&&!v.has(h))return;if(S.add(h),!this.configuredNamespaces.has(h))return void m.continue();const{dropPeriodCoin:f,dropSamplesCoin:_,dropFractionOfHostsPerMetric:b}=this.namespaceMap[h]||{};let y;try{y=yield(0,r.getNamespaceRange)(c,h)}catch(e){return void u(e)}if(f){const{result:e,nextState:t}=(0,i.observeCoin)(this.randomEngine,f.config,f.state);if(f.state=t,e)return c.delete(y),void m.continue()}const E=null!==(p=g.get(h))&&void 0!==p?p:{metric_namespace:h,timestamp_sec:a,tags:(0,n.formatTags)(t),descendants:[]};g.set(h,E);const w=c.openCursor(y);w.addEventListener("success",()=>s.__awaiter(this,void 0,void 0,(function*(){const e=w.result;if(!e)return E.descendants.length>0&&!v.has(h)&&(d.push(E),v.add(h)),void m.continue();const t={tags:(0,n.zipTags)(e.value.tagNames,e.value.tagValues),metrics:[]},s=e.value.spans;for(const e in s){if(!s.hasOwnProperty(e))continue;if(b){if((yield l(this.filterID,e))<b)continue}let r=s[e].samples;if(_&&(r=r.filter(e=>{const{result:t,nextState:s}=(0,i.observeCoin)(this.randomEngine,_.config,_.state);return _.state=s,!t})),0===r.length)continue;const n=s[e].spanCount;o(e,t,r,h,n)}t.metrics.length>0&&E.descendants.push(t),e.delete(),e.continue()})))})))})}})}))}}t.SpanGroupFilter=p})),define("typescript/libraries/shared/apex-metrics/src/sink/index",["require","exports","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/database","typescript/libraries/shared/apex-metrics/src/sink/apiv2_sink","typescript/libraries/shared/apex-metrics/src/sink/apiv2_sink"],(function(e,t,s,i,r,n){"use strict";function a(){return new s.BrowserPerformanceClock}Object.defineProperty(t,"__esModule",{value:!0}),t.getSinkSingleton=t.getMetricsReporter=t.clientSDKAdaptor=t.clientFetchAdaptor=t.clientBaseAdaptor=t.makeDefaultCacheFactory=t.PlatformDetector=t.ExceptionReporter=t.ExcSeverity=t.ClientFactory=t.CacheFactory=t.BrowserName=void 0,Object.defineProperty(t,"BrowserName",{enumerable:!0,get:function(){return n.BrowserName}}),Object.defineProperty(t,"CacheFactory",{enumerable:!0,get:function(){return n.CacheFactory}}),Object.defineProperty(t,"ClientFactory",{enumerable:!0,get:function(){return n.ClientFactory}}),Object.defineProperty(t,"ExcSeverity",{enumerable:!0,get:function(){return n.ExcSeverity}}),Object.defineProperty(t,"ExceptionReporter",{enumerable:!0,get:function(){return n.ExceptionReporter}}),Object.defineProperty(t,"PlatformDetector",{enumerable:!0,get:function(){return n.PlatformDetector}}),Object.defineProperty(t,"makeDefaultCacheFactory",{enumerable:!0,get:function(){return n.makeDefaultCacheFactory}}),Object.defineProperty(t,"clientBaseAdaptor",{enumerable:!0,get:function(){return n.clientBaseAdaptor}}),Object.defineProperty(t,"clientFetchAdaptor",{enumerable:!0,get:function(){return n.clientFetchAdaptor}}),Object.defineProperty(t,"clientSDKAdaptor",{enumerable:!0,get:function(){return n.clientSDKAdaptor}});const o=(0,r.makeDefaultCacheFactory)();function c(e){var t;let n;n="clientFactory"in e?e.clientFactory:"client"in e?()=>Promise.resolve((0,r.clientBaseAdaptor)(e.client)):"sdk"in e?()=>Promise.resolve((0,r.clientSDKAdaptor)(e.sdk)):()=>Promise.resolve((0,r.clientFetchAdaptor)(e.fetch));let{platformDetector:c,exceptionReporter:l,identifierFactory:p,originKind:u}=e,d=null===(t=window.sinkSingleton)||void 0===t?void 0:t.clientFactory;if(void 0!==d&&(n=d),void 0===c&&(c=(0,r.makeNopPlatformDetector)()),void 0===l&&(l=(0,r.makeNopExceptionReporter)()),void 0===p&&(p=()=>""),void 0===u&&(u="unknown"),window.sinkSingleton)return window.sinkSingleton.clientFactory=n,window.sinkSingleton;const m=new r.Apiv2MetricsSink(n,a(),(0,r.makeDefaultInitialization)(n,c,l),o,new s.SetTimeoutExecutor(()=>({value:5*Math.random(),unit:s.TimeUnit.SECONDS})),Math.random,i.getDatabase,c,l,u,p);return window.sinkSingleton=m,m}t.getMetricsReporter=function(e){const t=c(e);return s.MetricsReporterImpl.root(t,a(),t.getOriginId())},t.getSinkSingleton=c})),define("typescript/libraries/shared/apex-metrics/src/sink/instrumentation",["require","exports","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/serialization"],(function(e,t,s,i){"use strict";function r(e,t,s,i){s("samples_sink/submitted_spans",e.submittedSpans),s("samples_sink/submitted_samples",e.submittedSamples);for(const[t,i]of Object.entries(e.submittedSamplesByNs))s("samples_sink/submitted_samples_by_ns",i,{namespace:t});s("samples_sink/retained_spans",e.retainedSpans),s("samples_sink/retained_samples",e.retainedSamples);for(const[t,i]of Object.entries(e.retainedSamplesByNs))s("samples_sink/retained_samples_by_ns",i,{namespace:t});s("samples_sink/request/dropped_samples",e.requestDroppedSamples),s("samples_sink/request/dropped_spans",e.requestDroppedSpans),s("samples_sink/request/attempts",e.requestAttempts),s("samples_sink/request/latency",t),s("samples_sink/submitted_set_observations",e.setObservations);for(const[t,i]of Object.entries(e.setObservationsByNs))s("samples_sink/submitted_set_observations_by_ns",i,{namespace:t});s("samples_sink/request/dropped_set_observations",e.requestDroppedSetObservations),i("samples_sink/reporting_hosts")}Object.defineProperty(t,"__esModule",{value:!0}),t.Instrumentation=t.SELF_INSTRUMENTATION_NAMESPACE=void 0,t.SELF_INSTRUMENTATION_NAMESPACE="amp_client",(function(e){function n(e,t){var s;const i=Object.assign({},e);for(const[e,r]of Object.entries(t))i[e]=(null!==(s=i[e])&&void 0!==s?s:0)+r;return i}e.empty=function(){return{submittedSpans:0,submittedSamples:0,submittedSamplesByNs:{},retainedSpans:0,retainedSamples:0,retainedSamplesByNs:{},requestDroppedSamples:0,requestDroppedSpans:0,requestAttempts:0,setObservations:0,setObservationsByNs:{},requestDroppedSetObservations:0}},e.incrementSubmittedSamples=function(e,t,s){e.submittedSamples+=s;const i=e.submittedSamplesByNs[t];e.submittedSamplesByNs[t]=(null!=i?i:0)+s},e.incrementSetObservations=function(e,t,s){e.setObservations+=s;const i=e.setObservationsByNs[t];e.setObservationsByNs[t]=(null!=i?i:0)+s},e.incrementRetainedSamples=function(e,t,s){e.retainedSamples+=s;const i=e.retainedSamplesByNs[t];e.retainedSamplesByNs[t]=(null!=i?i:0)+s},e.report=function(s,i,n,a,o){if(0===s.retainedSamples)return s.requestAttempts=0,s;const c=i.child({client_version:a.toString(),origin_kind:o});return r(s,n,(e,s,i)=>{c.createStats({ns:t.SELF_INSTRUMENTATION_NAMESPACE,name:e},i).record(s)},e=>{c.createSet({ns:t.SELF_INSTRUMENTATION_NAMESPACE,name:e}).observeOriginId()}),e.empty()},e.toScope=function(e,n,a,o){const c=[];return r(e,a,(e,t,s)=>{c.push({tags:s?(0,i.formatTags)(s):[],metrics:[{name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"numerical_data",samples:[t]}}]})},e=>{c.push({metrics:[{name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",samples:[(0,s.hash)(n)]}}]})}),{metric_namespace:t.SELF_INSTRUMENTATION_NAMESPACE,timestamp_sec:Math.floor(Date.now()/1e3),tags:(0,i.formatTags)(o),descendants:c}},e.merge=function(e,t){var s,i,r,a,o,c,l,p,u,d,m,h;return{submittedSpans:e.submittedSpans+(null!==(s=t.submittedSpans)&&void 0!==s?s:0),submittedSamples:e.submittedSamples+(null!==(i=t.submittedSamples)&&void 0!==i?i:0),submittedSamplesByNs:n(e.submittedSamplesByNs,null!==(r=t.submittedSamplesByNs)&&void 0!==r?r:{}),retainedSpans:e.retainedSpans+(null!==(a=t.retainedSpans)&&void 0!==a?a:0),retainedSamples:e.retainedSamples+(null!==(o=t.retainedSamples)&&void 0!==o?o:0),retainedSamplesByNs:n(e.retainedSamplesByNs,null!==(c=t.retainedSamplesByNs)&&void 0!==c?c:{}),requestDroppedSamples:e.requestDroppedSamples+(null!==(l=t.requestDroppedSamples)&&void 0!==l?l:0),requestDroppedSpans:e.requestDroppedSpans+(null!==(p=t.requestDroppedSpans)&&void 0!==p?p:0),requestAttempts:e.requestAttempts+(null!==(u=t.requestAttempts)&&void 0!==u?u:0),setObservations:e.setObservations+(null!==(d=t.setObservations)&&void 0!==d?d:0),setObservationsByNs:n(e.setObservationsByNs,null!==(m=t.setObservationsByNs)&&void 0!==m?m:{}),requestDroppedSetObservations:e.requestDroppedSetObservations+(null!==(h=t.requestDroppedSetObservations)&&void 0!==h?h:0)}}})(t.Instrumentation||(t.Instrumentation={}))})),define("typescript/libraries/shared/apex-metrics/src/sink/serialization",["require","exports","@bufbuild/protobuf"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unmarshalProto=t.marshalProto=t.zipTags=t.formatTags=void 0,t.formatTags=function(e){const t=[];for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];t.push({name:{value:{".tag":"string_value",string_value:s}},value:{value:{".tag":"string_value",string_value:i}}})}return t},t.zipTags=function(e,t){if(e.length!==t.length)throw new Error("Cannot zip values of different dimensions!");return e.map((e,s)=>({name:{value:{".tag":"string_value",string_value:e}},value:{value:{".tag":"string_value",string_value:t[s]}}}))},t.marshalProto=function(e){return s.protoBase64.enc(e.toBinary())},t.unmarshalProto=function(e,t){const i=s.protoBase64.dec(e);return t.fromBinary(i)}}));
//# sourceMappingURL=pkg-timing.min.js-vfllZTH4G.map