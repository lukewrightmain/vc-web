define(["require","exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_upload_kit_lib_types","./c_core_uri"],(function(e,t,i,o,s,r,n){"use strict";function a(e,t,i){return Object.assign(Object.assign({},i),{bytes:e.size,bytesUploaded:0,destPath:t,file:e,id:s.UUID.v4(),isDir:!1,source:r.FileSource.Computer,status:r.UploadStatus.Staged,manualRetryCount:0})}function l(e){return{bytes:0,bytesUploaded:0,destPath:e,id:s.UUID.v4(),isDir:!0,source:r.FileSource.Computer,status:r.UploadStatus.Staged,manualRetryCount:0}}const d=e=>e.fullPath?e.fullPath.startsWith("/")?e.fullPath.substring(1):e.fullPath:e.name,c=e=>e.split("/")[0];function u(e){return i.__awaiter(this,void 0,void 0,(function*(){return e.map((([e,t])=>a(e,r.isWebkitFile(e)&&""!==e.webkitRelativePath?e.webkitRelativePath:e.name,t)))}))}function h(e,t){return i.__awaiter(this,void 0,void 0,(function*(){const{files:i,items:o,types:s}=e;if(s&&s.length>0&&-1===s.indexOf("Files")){const i=function(e){let t;return t=e.getData("Url")||e.getData("text/x-moz-url")||e.getData("text/uri-list")||"",t=t.split("\n")[0],t}(e),o=n.URI.parse(i).getAuthority();return function(e,t,i){return Promise.resolve([a(e,t,i)])}(new Blob([`[InternetShortcut]\r\nURL=${i}\r\n`],{type:"text/plain"}),`#${o}.url`,t)}if(o&&o.length>0&&o[0]&&o[0].webkitGetAsEntry&&Array.from(o).some((e=>null!=e.webkitGetAsEntry())))return p(Array.from(o).map((e=>e.webkitGetAsEntry())),t);if(i&&i.length>0){return u(Array.from(i).map((e=>[e,t||{}])))}return Promise.resolve([])}))}function p(e,t){return i.__awaiter(this,void 0,void 0,(function*(){const o=yield Promise.all(e.map((e=>i.__awaiter(this,void 0,void 0,(function*(){if(null==e?void 0:e.isFile){const o=yield(e=>i.__awaiter(void 0,void 0,void 0,(function*(){return new Promise((t=>e.file((e=>t(e)))))})))(e);return[a(o,d(e),t)]}if(null==e?void 0:e.isDirectory){const o=e;return p(yield function(e){return i.__awaiter(this,void 0,void 0,(function*(){function t(e){return i.__awaiter(this,void 0,void 0,(function*(){return new Promise(((o,s)=>e.readEntries((s=>i.__awaiter(this,void 0,void 0,(function*(){s.length>0?o([...s,...yield t(e)]):o(s)}))),(e=>s(e)))))}))}return t(e.createReader())}))}(o),t)}return null}))))),s=[];return o.forEach((e=>{e&&s.push(...e)})),s}))}function m(e){const t={};return e.map((e=>s.parent_dir(e.destPath))).forEach((e=>{""!==e&&"/"!==e&&(t[e]=e)})),Object.keys(t).map((e=>l(e)))}function f(e){const t={};return e.forEach((e=>{s.parent_dirs(e.destPath).forEach((e=>{""!==e&&"/"!==e&&(t[e]=e)}))})),Object.keys(t).map((e=>l(e)))}const v=(e,t=[])=>{const i=new Set,o=new Set,r=[];return t&&t.forEach((e=>{o.add(e.id),i.add(c(e.destPath).toLowerCase())})),e.forEach((e=>{if(o.has(e.id))return;const t=-1!==e.destPath.indexOf("/");let n,a=1,l=c(e.destPath);const d=s.split_filename(l);if(i.has(l.toLowerCase()))do{n=`${d.name} (${a})`,l=d.ext?`${n}.${d.ext}`:n,a++}while(i.has(l.toLowerCase()));if(t){const t=e.destPath.split("/");t[0]=l,e.destPath=t.join("/")}else e.destPath=l;o.add(e.id),i.add(e.destPath.toLowerCase()),r.push(e)})),r};const _=new class{init(e){var{onLoaded:t}=e,o=i.__rest(e,["onLoaded"]);this.onLoaded=t,this.controllerProps=o,this.controller&&(this.controller.setOptions(o),this.onLoaded(this.controller))}get(){return this.promise||(this.promise=new Promise((t=>i.__awaiter(this,void 0,void 0,(function*(){const{UploadController:i}=yield new Promise((function(t,i){e(["./c_upload_kit_uploader_controller"],t,i)}));i.setOptions(this.controllerProps),this.onLoaded(i),this.controller=i,t(i)}))))),this.promise}},y=o.React$1.createContext({});let g=0;class U extends o.React$1.PureComponent{constructor(e){super(e),this.fileField=o.React$1.createRef(),this.folderField=o.React$1.createRef(),this.chooseHandled=new Set,this.state={uploadItems:[],isUploading:!1},this.setInitialUploadedItems=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).setInitialUploadedItems(...e)})),this.cancelUploadItem=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).cancelUploadItem(...e)})),this.addFiles=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).addFiles(...e)})),this.chooseFiles=()=>{const e=this.fileField?this.fileField.current:null;return this.chooseLocalFiles(e)},this.chooseFolder=()=>{const e=this.folderField?this.folderField.current:null;return this.chooseLocalFiles(e)},this.chooseLocalFiles=function(e,t=100){let i;return(...o)=>(i||(i=e(...o),setTimeout((()=>{i=void 0}),t)),i)}(((e=null)=>(_.get(),new Promise(((t,o)=>{if(!e)return void o();e.dataset.uploadKitId||(e.dataset.uploadKitId=String(g++));const s=e.dataset.uploadKitId,r=()=>i.__awaiter(this,void 0,void 0,(function*(){if(this.chooseHandled.delete(s),e.removeEventListener("change",r),e.files)try{const i=yield _.get(),o=yield i.addFiles(Array.from(e.files));t(o)}catch(e){o(e)}else o()}));this.chooseHandled.has(s)||(this.chooseHandled.add(s),e.addEventListener("change",r)),e.value="",e.click()}))))),this.chooseDropboxFiles=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).chooseDropboxFiles(...e)})),this.handleDrop=(e,t)=>i.__awaiter(this,void 0,void 0,(function*(){if(!e)return Promise.reject();const[i,o]=yield Promise.all([h(e,{parentPath:t}),_.get()]);return o.addUploadItems(i)})),this.makeDirectory=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).makeDirectory(...e)})),this.moveUploadItem=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).moveUploadItem(...e)})),this.removeUploadItem=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).removeUploadItem(...e)})),this.setItemRetriable=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).setItemRetriable(...e)})),this.retryUpload=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).retryUpload(...e)})),this.renameUploadItem=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).renameUploadItem(...e)})),this.resetUploadProgress=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).resetUploadProgress(...e)})),this.startUploading=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).startUploading(...e)})),this.stopUploading=(...e)=>i.__awaiter(this,void 0,void 0,(function*(){return(yield _.get()).stopUploading(...e)})),_.init(Object.assign(Object.assign({},e),{onLoaded:e=>{this.subscription=e=>{this.setState(e)},e.subscribe(this.subscription),this.state={uploadItems:e.uploadItems,isUploading:e.isUploading}}}))}componentWillUnmount(){return i.__awaiter(this,void 0,void 0,(function*(){if(this.subscription){(yield _.get()).unsubscribe(this.subscription)}}))}render(){const{children:e,fileExtensions:t,selectMultiple:i}=this.props,s=Object.assign(Object.assign({},this.state),{setInitialUploadedItems:this.setInitialUploadedItems,addFiles:this.addFiles,cancelUploadItem:this.cancelUploadItem,chooseFiles:this.chooseFiles,chooseFolder:this.chooseFolder,chooseDropboxFiles:this.chooseDropboxFiles,handleDrop:this.handleDrop,makeDirectory:this.makeDirectory,moveUploadItem:this.moveUploadItem,removeUploadItem:this.removeUploadItem,renameUploadItem:this.renameUploadItem,resetUploadProgress:this.resetUploadProgress,startUploading:this.startUploading,stopUploading:this.stopUploading,setItemRetriable:this.setItemRetriable,retryUpload:this.retryUpload});return o.React$1.createElement(y.Provider,{value:s},e,o.React$1.createElement("input",{type:"file",ref:this.fileField,id:"uploader-file-field","data-testid":"uploader-file-field",style:{display:"none"},multiple:!!i,accept:t?t.join(","):void 0}),o.React$1.createElement("input",Object.assign({type:"file",ref:this.folderField,id:"uploader-folder-field","data-testid":"uploader-folder-field",style:{display:"none"}},{webkitdirectory:""})))}}U.displayName="UploadProvider";const b=y.Consumer;t.UploadConsumer=b,t.UploadProvider=U,t.makeDirectoryUploadItem=l,t.preprocessDataTransfer=h,t.preprocessDropboxFiles=function(e){return i.__awaiter(this,void 0,void 0,(function*(){return e.map((([e,t])=>function(e,t){return Object.assign(Object.assign({},t),{bytes:e.bytes,bytesUploaded:0,destPath:e.name,file:e,id:e.id,isDir:e.isDir,source:r.FileSource.Dropbox,status:r.UploadStatus.Staged,manualRetryCount:0})}(e,t)))}))},t.preprocessFileSystemEntries=p,t.preprocessFiles=u,t.processFilesWithRenaming=(e,t,i)=>Promise.resolve(v(e,i)).then((e=>({errors:t,items:e.concat(m(e))}))),t.processFilesWithRenamingRecursive=(e,t,i)=>Promise.resolve(v(e,i)).then((e=>({errors:t,items:e.concat(f(e))}))),t.renameFilename=function(e,t){const i=e.split("/");return i[i.length-1]=t,i.join("/")},t.reparentFilename=function(e,t){return`${t}/${e.split("/").pop()}`},t.resolveDuplicates=v,t.withCustomUploadProvider=function(e,t){const i=i=>o.React$1.createElement(t,Object.assign({},i),o.React$1.createElement(e,Object.assign({},i)));return i.displayName=`withCustomUploadProvider(${s.getDisplayName(e)}, ${s.getDisplayName(t)})`,i},t.withUploadConsumer=function(e){const t=t=>o.React$1.createElement(b,null,(i=>o.React$1.createElement(e,Object.assign({},t,i))));return t.displayName=`WithUploadConsumer(${s.getDisplayName(e)})`,t}}));
//# sourceMappingURL=c_upload_kit_uploader_context.js-vflnHuihZ.map
