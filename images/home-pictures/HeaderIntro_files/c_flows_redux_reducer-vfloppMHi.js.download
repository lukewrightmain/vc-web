define(["exports","./c_tslib","./e_ui_page_files_router","./c_flows_lib_api","./c_flows_logging_flows_loggers","./c_src_common_constants","./e_core_exception","./c_flows_constants","./c_lodash-es_lodash"],(function(e,t,o,r,i,n,a,s,l){"use strict";var c;e.Actions=void 0,(c=e.Actions||(e.Actions={})).GetUserAutomations="AUTOMATIONS/GET_USER_AUTOMATIONS",c.SetUserAutomations="AUTOMATIONS/SET_USER_AUTOMATIONS",c.AddUserAutomation="AUTOMATIONS/ADD_USER_AUTOMATION",c.EditUserAutomation="AUTOMATIONS/EDIT_USER_AUTOMATION",c.RemoveUserAutomation="AUTOMATIONS/REMOVE_USER_AUTOMATION",c.MergeUserAutomations="AUTOMATIONS/MERGE_USER_AUTOMATIONS",c.ToggleAutomationStatus="TOGGLE_AUTOMATION_STATUS",c.SetUserExperiments="AUTOMATIONS/SET_USER_EXPERIMENTS",c.SetShouldSubscribeToBolt="AUTOMATIONS/SET_SHOULD_SUBSCRIBE_TO_BOLT",c.InitWorkflowBuilder="AUTOMATIONS/INIT_WORKFLOW_BUILDER",c.TearDownWorkflowBuilder="AUTOMATIONS/TEAR_DOWN_WORKFLOW_BUILDER",c.SetWorkflowBuilderOperation="AUTOMATIONS/SET_WORKFLOW_BUILDER_OPERATION",c.UpdateWorkflowActionStep="AUTOMATIONS/UPDATE_WORKFLOW_ACTION_STEP",c.DeleteWorkflowActionStep="AUTOMATIONS/DELETE_WORKFLOW_ACTION_STEP",c.UpdateWorkflowTriggerStep="AUTOMATIONS/UPDATE_WORKFLOW_TRIGGER_STEP",c.SetWorkflowBuilderActions="AUTOMATIONS/SET_WORKFLOW_BUILDER_ACTIONS",c.GetWorkflowStepsConfig="AUTOMATIONS/GET_WORKFLOW_STEPS_CONFIG",c.SetWorkflowStepsConfig="AUTOMATIONS/SET_WORKFLOW_STEPS_CONFIG",c.SetWorkflowBuilderWidth="AUTOMATIONS/SET_WORKFLOW_BUILDER_WIDTH",c.SetWorkflowBuilderApplyToExisting="AUTOMATIONS/SET_WORKFLOW_BUILDER_APPLY_TO_EXISTING",c.SetWorkflowBuilderInheritable="AUTOMATIONS/SET_WORKFLOW_BUILDER_INHERITABLE",c.UpdateWorkflowBuilderIsEnabled="AUTOMATINONS/UPDATE_WORKFLOW_BUILDER_IS_ENABLED",c.UpdateSavedWorkflowTemplateState="AUTOMATIONS/UPDATE_SAVED_WORKFLOW_TEMPLATE_STATE",c.UpdateSavedWorkflowTemplateName="AUTOMATIONS/UPDATE_SAVED_WORKFLOW_TEMPLATE_NAME",c.UpdateSavedWorkflowTemplateOptOut="AUTOMATIONS/UPDATE_SAVED_WORKFLOW_TEMPLATE_OPT_OUT",c.UpdateSavedWorkflowTemplates="AUTOMATIONS/UPDATE_SAVED_WORKFLOW_TEMPLATES",c.SetInheritanceBlockingFqPaths="AUTOMATIONS/SET_INHERITANCE_BLOCKING_FQ_PATHS";const u=["audio_conversion","image_conversion","naming_conventions","pdf_conversion","smart_subfolders","tag","tidy_up","unzip","video_conversion","watermarking","move_file"],d=["file_add","scheduled"],g={file_op:{".tag":"file_add"},".tag":"file_op"},f={triggerType:"file_add",data:{}};function O(e){var o;const r=e.workflow_template?e.workflow_template.sequence[0].workflow_action:null===(o=e.action)||void 0===o?void 0:o.action;if(r){const{".tag":e}=r,o=t.__rest(r,[".tag"]);if("other"!==e)return{actionType:e,data:o};throw new Error(`Received invalid action ${e} from API v2`)}throw new Error("Missing action in payload from API v2")}function _(e){var o;const r=null===(o=e.trigger)||void 0===o?void 0:o.trigger;if(!r)return f;{const{".tag":e}=r,o=t.__rest(r,[".tag"]);switch(e){case"file_op":if("file_op"in o&&o.file_op&&"file_add"===o.file_op[".tag"])return f;throw new Error("Received invalid file_op trigger from API v2");case"scheduled":return{triggerType:e,data:o};default:throw new Error(`Received invalid trigger ${e} from API v2`)}}}function A({actionType:e,data:t}){switch(e){case"pdf_conversion":return Object.assign({".tag":"pdf_conversion"},t);case"unzip":return Object.assign({".tag":"unzip"},t);case"tag":return Object.assign({".tag":"tag"},t);case"smart_subfolders":return Object.assign({".tag":"smart_subfolders"},t);case"image_conversion":return Object.assign({".tag":"image_conversion"},t);case"video_conversion":return Object.assign({".tag":"video_conversion"},t);case"tidy_up":return Object.assign({".tag":"tidy_up"},t);case"naming_conventions":return Object.assign({".tag":"naming_conventions"},t);case"audio_conversion":return Object.assign({".tag":"audio_conversion"},t);case"watermarking":return Object.assign({".tag":"watermarking"},t);case"move_file":return Object.assign({".tag":"move_file"},t);default:throw new Error(`Undefined .tag ${e}`)}}function w({triggerType:e,data:t}){switch(e){case"file_add":return g;case"scheduled":return Object.assign({".tag":"scheduled"},t);default:throw new Error(`Undefined trigger .tag ${e}`)}}function p(e,t,o=f){return{enabled:t,action:{action:A(e)},trigger:{trigger:w(o)}}}function T({actions:e,applyToExistingFiles:o,enabled:n,fqPath:a,papEventProperties:s,trigger:l,inheritable:c}){return t.__awaiter(this,void 0,void 0,(function*(){if(e.length>0&&e.every((e=>{return t=e.actionType,u.includes(t);var t}))&&(t=l.triggerType,d.includes(t)))return i.PapLogger.logInitiateAutoFolderModalUpdateAutomation(Object.assign({actionTag:e[0].actionType},s)),r.updateFolderRules(a,h({actions:e,inheritable:c,isEnabled:n,trigger:l}),o).then((t=>(i.PapLogger.logSucceedAutoFolderModalUpdateAutomation(Object.assign({actionTag:e[0].actionType},s)),t)),(t=>{throw i.PapLogger.logFailAutoFolderModalUpdateAutomation(Object.assign({actionTag:e[0].actionType},s)),t}));var t;throw new Error(`Undefined action .tag ${e} or trigger .tag ${l}`)}))}function b(e){return n.WORKFLOW_BUILDER_ACTIONS.includes(e)}function v(e){const t=e.split("/");return t[t.length-1]}function m({workflow_action:e}){if(!e)return;const{".tag":o}=e,r=t.__rest(e,[".tag"]);return b(o)?{actionType:o,data:r}:void 0}function S(e){var t;const o=null===(t=e.workflow_template)||void 0===t?void 0:t.sequence;return o?o.reduce(((e,t)=>{const o=m(t);return o&&e.push(o),e}),[]):e.action?[O(e)]:[]}function k(e){return{workflow_action:Object.assign({".tag":e.actionType},e.data)}}function E(e){return{sequence:e.map(k)}}function j({actions:e,isEnabled:t=!0,trigger:o,inheritable:r}){const i={enabled:t,inheritable:r,workflow_template:{sequence:e.map(k)}};return o&&(i.trigger=function({triggerType:e,data:t}){switch(e){case"file_add":return{trigger:g};case"scheduled":return{trigger:Object.assign({".tag":"scheduled"},t)};default:throw new Error(`Undefined trigger .tag ${e}`)}}(o)),i}function h(e){return{rules:[j(e)]}}var W=Object.freeze({__proto__:null,DEFAULT_API_V2_FOLDER_TRIGGER:g,DEFAULT_CLIENT_FOLDER_TRIGGER:f,getClientFolderActionFromFolderRule:O,getClientFolderTriggerFromFolderRule:_,getApiV2FolderAction:A,getApiV2FolderTrigger:w,makeFolderRule:p,makeFolderRuleSet:function(e,t,o=f){return{rules:[p(e,t,o)]}},updateFolderRule:T,isValidWorkflowAction:b,getFolderName:v,getClientWorkflowActionFromApiWorkflowAction:m,getClientWorkflowActionsFromFolderRule:S,getClientWorkflowActionsFromFolderRuleResult:function(e){var t,o;const r=null===(o=null===(t=e.folder_rule_set)||void 0===t?void 0:t.rules)||void 0===o?void 0:o[0];return r?S(r):[]},getClientFolderTriggerFromFolderRuleResult:function(e){var o,r,i,n;const a=null===(r=null===(o=e.folder_rule_set)||void 0===o?void 0:o.rules)||void 0===r?void 0:r[0];if(!a)return;const s=null===(i=a.trigger)||void 0===i?void 0:i.trigger;if(s){const o={folderName:e.fq_path?v(e.fq_path):void 0,fqPath:e.fq_path,nsId:e.ns_id},{".tag":r}=s,i=t.__rest(s,[".tag"]);switch(r){case"file_op":return"file_op"in i&&"file_add"===(null===(n=i.file_op)||void 0===n?void 0:n[".tag"])?Object.assign(Object.assign({},f),o):void 0;case"scheduled":return Object.assign({triggerType:r,data:i},o);default:return}}},makeApiWorkflowAction:k,makeWorkflowTemplate:E,makeFolderRuleFromClientWorkflow:j,makeFolderRuleSetFromClientWorkflow:h,getClientWorkflowDetails:function(e){var o;return t.__awaiter(this,void 0,void 0,(function*(){try{const t=yield r.getFolderRules(e),i=null==t?void 0:t.get_rule_result;if("folder_rule_set"===(null==i?void 0:i[".tag"])){const e=null===(o=i.rules)||void 0===o?void 0:o[0];if(e)return{editActions:S(e),isEnabled:e.enabled,trigger:_(e)}}}catch(e){}}))},getFlowsMapValueFromFolderRule:function(e){var t,o,r,i;const n=null===(t=e.workflow_template)||void 0===t?void 0:t.sequence;if(n&&n.length>0){const e=null===(o=n[0].workflow_action)||void 0===o?void 0:o[".tag"];if(e&&b(e))return e}const a=null===(i=null===(r=e.action)||void 0===r?void 0:r.action)||void 0===i?void 0:i[".tag"];if(a&&b(a))return a}});function U(e,t){return e.toLocaleLowerCase().localeCompare(t.toLocaleLowerCase())}function I(e,t){const r=function(e,t){return o.filename(e.fqPath).toLocaleLowerCase().localeCompare(o.filename(t.fqPath).toLocaleLowerCase())}(e,t);return 0!==r?r:U(e.fqPath,t.fqPath)}function R(e,t){const o=[];let r=!1;for(const i of e)!r&&I(t,i)<0&&(o.push(Object.assign({},t)),r=!0),0!==U(t.fqPath,i.fqPath)&&o.push(Object.assign({},i));return r||o.push(Object.assign({},t)),o}function F(e,t,o,r){var i,n;const a=[],s=e.rules;if(s&&s.length>0){const e=s[0],r=null===(i=e.action)||void 0===i?void 0:i.action,l=null===(n=e.trigger)||void 0===n?void 0:n.trigger,c=e.workflow_template;(r||c)&&l&&a.push(L(e,t,o))}return a.sort(I),a}function B(e){var t,o,r,i,n;if(!e.err&&(null===(t=e.folder_rule_set)||void 0===t?void 0:t.rules)&&(null===(o=e.folder_rule_set)||void 0===o?void 0:o.rules.length)>0){const t=null===(r=e.folder_rule_set)||void 0===r?void 0:r.rules[0],o=null===(i=t.action)||void 0===i?void 0:i.action,a=null===(n=t.trigger)||void 0===n?void 0:n.trigger,s=t.workflow_template;if(!o&&!s||!a)return;if(e.fq_path)return L(t,e.fq_path,e.ns_id)}}function L(e,t,o,r){return{actions:S(e),fqPath:t,inheritable:!!e.inheritable,inheritedFromFqPath:r,isEnabled:!!e.enabled,nsId:o,trigger:_(e)}}const N={userAutomations:{status:"initial"},userExperiments:{status:"initial"},shouldSubscribeToBolt:!1,workflowStepsConfig:{status:"initial"},inheritanceBlockingFqPaths:new Set};e.AutomationsReducer=(o=N,r)=>{var i,n;switch(r.type){case e.Actions.SetUserAutomations:return Object.assign(Object.assign({},o),{userAutomations:r.payload});case e.Actions.AddUserAutomation:{const e="completed"===o.userAutomations.status?o.userAutomations.data:void 0;if(!e)return o;const t=R(e,r.payload);return Object.assign(Object.assign({},o),{userAutomations:{status:"completed",data:t}})}case e.Actions.EditUserAutomation:{const e="completed"===o.userAutomations.status?o.userAutomations.data:void 0;if(!e)return o;const t=r.payload,i=e.map((e=>0===U(e.fqPath,t.fqPath)?Object.assign(Object.assign({},e),t):e));return Object.assign(Object.assign({},o),{userAutomations:{status:"completed",data:i}})}case e.Actions.RemoveUserAutomation:{const e="completed"===o.userAutomations.status?o.userAutomations.data:void 0;if(!e)return o;const t=r.payload,i=e.filter((e=>0!==U(t.fqPath,e.fqPath)));return Object.assign(Object.assign({},o),{userAutomations:{status:"completed",data:i}})}case e.Actions.MergeUserAutomations:{let e;return e="completed"!==o.userAutomations.status?r.payload:r.payload.reduce(((e,t)=>R(e,t)),o.userAutomations.data),Object.assign(Object.assign({},o),{userAutomations:{status:"completed",data:e}})}case e.Actions.ToggleAutomationStatus:{const e="completed"===o.userAutomations.status?o.userAutomations.data:void 0;if(!e)return o;const t=r.payload,i=e.map((e=>0===U(e.fqPath,t.fqPath)?Object.assign(Object.assign({},e),t):e));return Object.assign(Object.assign({},o),{userAutomations:{status:"completed",data:i}})}case e.Actions.SetUserExperiments:return Object.assign(Object.assign({},o),{userExperiments:r.payload});case e.Actions.SetShouldSubscribeToBolt:return Object.assign(Object.assign({},o),{shouldSubscribeToBolt:r.payload});case e.Actions.InitWorkflowBuilder:return Object.assign(Object.assign({},o),{workflowBuilder:r.payload});case e.Actions.TearDownWorkflowBuilder:return Object.assign(Object.assign({},o),{workflowBuilder:void 0});case e.Actions.SetWorkflowBuilderOperation:{const e=o.workflowBuilder;return e?Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{operation:r.payload})}):o}case e.Actions.UpdateWorkflowActionStep:{const e=o.workflowBuilder;if(!e||!e.actions)return o;const i=e.actions.findIndex((e=>e.id===r.payload.id));if(-1===i)return o;const n=e.actions[i],a=r.payload.action,{id:s}=a,c=t.__rest(a,["id"]),u=Object.assign(Object.assign({},n),c);if(l.isEqual(n,u))return o;const d=[...e.actions];return d[i]=Object.assign(Object.assign({},d[i]),u),Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{actions:d})})}case e.Actions.DeleteWorkflowActionStep:{const e=o.workflowBuilder;if(!e||!e.actions)return o;const t=e.actions.filter((e=>e.id!==r.payload.id));return Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{actions:t})})}case e.Actions.UpdateWorkflowTriggerStep:{const e=o.workflowBuilder;if(!e)return o;if(null==r.payload)return Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{trigger:void 0})});if(!(null==e?void 0:e.trigger))return o;const t=Object.assign(Object.assign({},e.trigger),r.payload);return Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{trigger:t})})}case e.Actions.SetWorkflowBuilderActions:{const e=o.workflowBuilder;return e?Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{actions:r.payload})}):o}case e.Actions.SetWorkflowStepsConfig:return Object.assign(Object.assign({},o),{workflowStepsConfig:r.payload});case e.Actions.SetWorkflowBuilderWidth:{const e=o.workflowBuilder;return e?Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{width:r.payload})}):o}case e.Actions.SetWorkflowBuilderApplyToExisting:{const e=o.workflowBuilder;return e?Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{applyToExistingFiles:r.payload})}):o}case e.Actions.SetWorkflowBuilderInheritable:{const e=o.workflowBuilder;return e?Object.assign(Object.assign({},o),{workflowBuilder:Object.assign(Object.assign({},e),{inheritable:r.payload})}):o}case e.Actions.UpdateWorkflowBuilderIsEnabled:return Object.assign(Object.assign({},o),o.workflowBuilder&&{workflowBuilder:Object.assign(Object.assign({},o.workflowBuilder),{isEnabled:r.payload})});case e.Actions.UpdateSavedWorkflowTemplateState:return Object.assign(Object.assign({},o),o.workflowBuilder&&{workflowBuilder:Object.assign(Object.assign({},o.workflowBuilder),{savedWorkflowTemplateState:r.payload})});case e.Actions.UpdateSavedWorkflowTemplateName:return Object.assign(Object.assign({},o),o.workflowBuilder&&{workflowBuilder:Object.assign(Object.assign({},o.workflowBuilder),{savedWorkflowTemplateState:o.workflowBuilder.savedWorkflowTemplateState&&Object.assign(Object.assign({},o.workflowBuilder.savedWorkflowTemplateState),{name:r.payload})})});case e.Actions.UpdateSavedWorkflowTemplateOptOut:return"A"===(null===(n=null===(i=o.workflowBuilder)||void 0===i?void 0:i.savedWorkflowTemplateState)||void 0===n?void 0:n.variant)?o:Object.assign(Object.assign({},o),o.workflowBuilder&&o.workflowBuilder.savedWorkflowTemplateState&&{workflowBuilder:Object.assign(Object.assign({},o.workflowBuilder),{savedWorkflowTemplateState:Object.assign(Object.assign({},o.workflowBuilder.savedWorkflowTemplateState),{optOut:r.payload})})});case e.Actions.UpdateSavedWorkflowTemplates:return Object.assign(Object.assign({},o),{savedWorkflowTemplates:r.payload});case e.Actions.SetInheritanceBlockingFqPaths:return Object.assign(Object.assign({},o),{inheritanceBlockingFqPaths:new Set([...o.inheritanceBlockingFqPaths,...r.payload])});default:return o}},e.DEFAULT_CLIENT_FOLDER_TRIGGER=f,e.api_helpers_esnext=W,e.buildAutomationDataFromGetRuleBatchResult=function(e){var t;let o=[];if("folder_rule_batch_result"===(null===(t=e.get_rule_batch_result)||void 0===t?void 0:t[".tag"])){o=function(e){const t=[];for(const o of e){const e=B(o);e&&t.push(e)}return t}((null==e?void 0:e.get_rule_batch_result.folder_rule_results)||[])}return o.sort(I),o},e.buildAutomationDataFromGetRuleResult=function(e,t,o){var r;return"folder_rule_set"===(null===(r=e.get_rule_result)||void 0===r?void 0:r[".tag"])?F(e.get_rule_result,t,o):[]},e.convertFolderRuleToAutomation=L,e.convertSubfolderRulesResultToAutomations=function(e,t){const o=e.inherited_rule_set_result,r=e.rule_set_results,i=[];if((null==o?void 0:o.rule_set)&&(null==o?void 0:o.fq_path)){const e=F(o.rule_set,o.fq_path,t);i.push(...e)}if(r)for(const e of r)i.push(...F(e.rule_set,e.fq_path,t));return i},e.createSavedWorkflowTemplateObject=function(e){var t;const o=[];try{const r=null===(t=e.workflow_template)||void 0===t?void 0:t.sequence;if(r&&r.forEach((e=>{const t=m(e);t&&o.push(t)})),o)return{name:e.name,templateId:e.template_id,clientWorkflowActions:o}}catch(e){a.reportException({err:e,force:!0,tags:[s.EXCLOG_TAG_SAVED_WORKFLOW_TEMPLATE],severity:"non-critical"})}},e.defaultAutomationsState=N,e.getFolderName=v,e.getInheritanceBlockingFqPathResult=function(e){const t=e.inherited_rule_set_result;return(null==t?void 0:t.fq_path)&&!(null==t?void 0:t.rule_set)?[t.fq_path]:[]},e.isInherited=function(e){return!!e.inheritedFromFqPath},e.makeFolderRuleSetFromClientWorkflow=h,e.makeWorkflowTemplate=E,e.updateFolderRule=T}));
//# sourceMappingURL=c_flows_redux_reducer.js-vflSrt3gb.map
