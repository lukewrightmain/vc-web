define(["exports","./c_lodash-es_lodash","./c_core_browser_detection","./c_security_crypto"],(function(e,t,r,n){"use strict";var o,s={},i={},a=a||{},u=a;a.EXTENSION_ID="kmendfapggjehodndflmmgagdbamhnfd",a.MessageTypes={U2F_REGISTER_REQUEST:"u2f_register_request",U2F_REGISTER_RESPONSE:"u2f_register_response",U2F_SIGN_REQUEST:"u2f_sign_request",U2F_SIGN_RESPONSE:"u2f_sign_response",U2F_GET_API_VERSION_REQUEST:"u2f_get_api_version_request",U2F_GET_API_VERSION_RESPONSE:"u2f_get_api_version_response"},a.ErrorCodes={OK:0,OTHER_ERROR:1,BAD_REQUEST:2,CONFIGURATION_UNSUPPORTED:3,DEVICE_INELIGIBLE:4,TIMEOUT:5},a.U2fRequest,a.U2fResponse,a.Error,a.Transport,a.Transports,a.SignRequest,a.SignResponse,a.RegisterRequest,a.RegisterResponse,a.RegisteredKey,a.GetJsApiVersionResponse,a.getMessagePort=function(e){if("undefined"!=typeof chrome&&chrome.runtime){var t={type:a.MessageTypes.U2F_SIGN_REQUEST,signRequests:[]};chrome.runtime.sendMessage(a.EXTENSION_ID,t,(function(){chrome.runtime.lastError?a.getIframePort_(e):a.getChromeRuntimePort_(e)}))}else a.isAndroidChrome_()?a.getAuthenticatorPort_(e):a.isIosChrome_()?a.getIosPort_(e):a.getIframePort_(e)},a.isAndroidChrome_=function(){var e=navigator.userAgent;return-1!=e.indexOf("Chrome")&&-1!=e.indexOf("Android")},a.isIosChrome_=function(){return["iPhone","iPad","iPod"].indexOf(navigator.platform)>-1},a.getChromeRuntimePort_=function(e){var t=chrome.runtime.connect(a.EXTENSION_ID,{includeTlsChannelId:!0});setTimeout((function(){e(new a.WrappedChromeRuntimePort_(t))}),0)},a.getAuthenticatorPort_=function(e){setTimeout((function(){e(new a.WrappedAuthenticatorPort_)}),0)},a.getIosPort_=function(e){setTimeout((function(){e(new a.WrappedIosPort_)}),0)},a.WrappedChromeRuntimePort_=function(e){this.port_=e},a.formatSignRequest_=function(e,t,r,n,s){if(void 0===o||o<1.1){for(var i=[],u=0;u<r.length;u++)i[u]={version:r[u].version,challenge:t,keyHandle:r[u].keyHandle,appId:e};return{type:a.MessageTypes.U2F_SIGN_REQUEST,signRequests:i,timeoutSeconds:n,requestId:s}}return{type:a.MessageTypes.U2F_SIGN_REQUEST,appId:e,challenge:t,registeredKeys:r,timeoutSeconds:n,requestId:s}},a.formatRegisterRequest_=function(e,t,r,n,s){if(void 0===o||o<1.1){for(var i=0;i<r.length;i++)r[i].appId=e;var u=[];for(i=0;i<t.length;i++)u[i]={version:t[i].version,challenge:r[0],keyHandle:t[i].keyHandle,appId:e};return{type:a.MessageTypes.U2F_REGISTER_REQUEST,signRequests:u,registerRequests:r,timeoutSeconds:n,requestId:s}}return{type:a.MessageTypes.U2F_REGISTER_REQUEST,appId:e,registerRequests:r,registeredKeys:t,timeoutSeconds:n,requestId:s}},a.WrappedChromeRuntimePort_.prototype.postMessage=function(e){this.port_.postMessage(e)},a.WrappedChromeRuntimePort_.prototype.addEventListener=function(e,t){var r=e.toLowerCase();"message"==r||"onmessage"==r?this.port_.onMessage.addListener((function(e){t({data:e})})):console.error("WrappedChromeRuntimePort only supports onMessage")},a.WrappedAuthenticatorPort_=function(){this.requestId_=-1,this.requestObject_=null},a.WrappedAuthenticatorPort_.prototype.postMessage=function(e){var t=a.WrappedAuthenticatorPort_.INTENT_URL_BASE_+";S.request="+encodeURIComponent(JSON.stringify(e))+";end";document.location=t},a.WrappedAuthenticatorPort_.prototype.getPortType=function(){return"WrappedAuthenticatorPort_"},a.WrappedAuthenticatorPort_.prototype.addEventListener=function(e,t){if("message"==e.toLowerCase()){window.addEventListener("message",this.onRequestUpdate_.bind(this,t),!1)}else console.error("WrappedAuthenticatorPort only supports message")},a.WrappedAuthenticatorPort_.prototype.onRequestUpdate_=function(e,t){var r=JSON.parse(t.data);r.intentURL,r.errorCode;var n=null;r.hasOwnProperty("data")&&(n=JSON.parse(r.data)),e({data:n})},a.WrappedAuthenticatorPort_.INTENT_URL_BASE_="intent:#Intent;action=com.google.android.apps.authenticator.AUTHENTICATE",a.WrappedIosPort_=function(){},a.WrappedIosPort_.prototype.postMessage=function(e){var t=JSON.stringify(e),r="u2f://auth?"+encodeURI(t);location.replace(r)},a.WrappedIosPort_.prototype.getPortType=function(){return"WrappedIosPort_"},a.WrappedIosPort_.prototype.addEventListener=function(e,t){"message"!==e.toLowerCase()&&console.error("WrappedIosPort only supports message")},a.getIframePort_=function(e){var t="chrome-extension://"+a.EXTENSION_ID,r=document.createElement("iframe");r.src=t+"/u2f-comms.html",r.setAttribute("style","display:none"),document.body.appendChild(r);var n=new MessageChannel,o=function(t){"ready"==t.data?(n.port1.removeEventListener("message",o),e(n.port1)):console.error('First event on iframe port was not "ready"')};n.port1.addEventListener("message",o),n.port1.start(),r.addEventListener("load",(function(){r.contentWindow.postMessage("init",t,[n.port2])}))},a.EXTENSION_TIMEOUT_SEC=30,a.port_=null,a.waitingForPort_=[],a.reqCounter_=0,a.callbackMap_={},a.getPortSingleton_=function(e){a.port_?e(a.port_):(0==a.waitingForPort_.length&&a.getMessagePort((function(e){for(a.port_=e,a.port_.addEventListener("message",a.responseHandler_);a.waitingForPort_.length;)a.waitingForPort_.shift()(a.port_)})),a.waitingForPort_.push(e))},a.responseHandler_=function(e){var t=e.data,r=t.requestId;if(r&&a.callbackMap_[r]){var n=a.callbackMap_[r];delete a.callbackMap_[r],n(t.responseData)}else console.error("Unknown or missing requestId in response.")},a.isSupported=function(e){var t=!1;function r(r){t||(t=!0,e(r))}a.getApiVersion((function(e){o=void 0===e.js_api_version?0:e.js_api_version,r(!0)})),setTimeout(r.bind(null,!1),500)},a.sign=function(e,t,r,n,s){void 0===o?a.getApiVersion((function(i){o=void 0===i.js_api_version?0:i.js_api_version,console.log("Extension JS API Version: ",o),a.sendSignRequest(e,t,r,n,s)})):a.sendSignRequest(e,t,r,n,s)},a.sendSignRequest=function(e,t,r,n,o){a.getPortSingleton_((function(s){var i=++a.reqCounter_;a.callbackMap_[i]=n;var u=void 0!==o?o:a.EXTENSION_TIMEOUT_SEC,d=a.formatSignRequest_(e,t,r,u,i);s.postMessage(d)}))},a.register=function(e,t,r,n,s){void 0===o?a.getApiVersion((function(i){o=void 0===i.js_api_version?0:i.js_api_version,console.log("Extension JS API Version: ",o),a.sendRegisterRequest(e,t,r,n,s)})):a.sendRegisterRequest(e,t,r,n,s)},a.sendRegisterRequest=function(e,t,r,n,o){a.getPortSingleton_((function(s){var i=++a.reqCounter_;a.callbackMap_[i]=n;var u=void 0!==o?o:a.EXTENSION_TIMEOUT_SEC,d=a.formatRegisterRequest_(e,r,t,u,i);s.postMessage(d)}))},a.getApiVersion=function(e,t){a.getPortSingleton_((function(r){if(r.getPortType){var n;switch(r.getPortType()){case"WrappedIosPort_":case"WrappedAuthenticatorPort_":n=1.1;break;default:n=0}e({js_api_version:n})}else{var o=++a.reqCounter_;a.callbackMap_[o]=e;var s={type:a.MessageTypes.U2F_GET_API_VERSION_REQUEST,timeoutSeconds:void 0!==t?t:a.EXTENSION_TIMEOUT_SEC,requestId:o};r.postMessage(s)}}))},function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=u,r="undefined"!=typeof navigator&&!!navigator.userAgent,n=r&&navigator.userAgent.match(/Safari\//)&&!navigator.userAgent.match(/Chrome\//),o=r&&navigator.userAgent.match(/Edge\/1[2345]/),s=null;function i(){return s||(s=new Promise((function(e,s){function i(){e({u2f:null})}return r?n?i():void 0!==window.u2f&&"function"==typeof window.u2f.sign?e({u2f:window.u2f}):o||"http:"===location.protocol||"undefined"==typeof MessageChannel?i():void t.isSupported((function(r){r?e({u2f:t}):i()})):i()}))),s}function a(t,r){var n=null!=r?r.errorCode:1,o=e.ErrorNames[""+n],s=new Error(t);return s.metaData={type:o,code:n},s}function d(e){if(!e.u2f){if("http:"===location.protocol)throw new Error("U2F isn't supported over http, only https");throw new Error("U2F not supported")}}e.ErrorCodes={OK:0,OTHER_ERROR:1,BAD_REQUEST:2,CONFIGURATION_UNSUPPORTED:3,DEVICE_INELIGIBLE:4,TIMEOUT:5},e.ErrorNames={0:"OK",1:"OTHER_ERROR",2:"BAD_REQUEST",3:"CONFIGURATION_UNSUPPORTED",4:"DEVICE_INELIGIBLE",5:"TIMEOUT"},e.isSupported=function(){return i().then((function(e){return!!e.u2f}))},e.ensureSupport=function(){return i().then(d)},e.register=function(e,t,r){return Array.isArray(e)||(e=[e]),"number"==typeof t&&void 0===r&&(r=t,t=null),t||(t=[]),i().then((function(n){d(n);var o=n.u2f;return new Promise((function(n,s){var i=e[0].appId;o.register(i,e,t,(function(e){e.errorCode?s(a("Registration failed",e)):(delete e.errorCode,n(e))}),r)}))}))},e.sign=function(e,t){return Array.isArray(e)||(e=[e]),i().then((function(r){d(r);var n=r.u2f;return new Promise((function(r,o){var s=e[0].appId,i=e[0].challenge;n.sign(s,i,e,(function(e){e.errorCode?o(a("Sign failed",e)):(delete e.errorCode,r(e))}),t)}))}))}}(i),function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=i;!function(t){for(var r in t)e.hasOwnProperty(r)||(e[r]=t[r])}(i),e.default=t}(s);var d,c=t.getDefaultExportFromCjs(s);!function(e){let t;var r;!function(e){e.bt="bt",e.ble="ble",e.nfc="nfc",e.usb="usb"}(t||(t={})),(r=e.ErrorCode||(e.ErrorCode={}))[r.OK=0]="OK",r[r.OTHER_ERROR=1]="OTHER_ERROR",r[r.BAD_REQUEST=2]="BAD_REQUEST",r[r.CONFIGURATION_UNSUPPORTED=3]="CONFIGURATION_UNSUPPORTED",r[r.DEVICE_INELIGIBLE=4]="DEVICE_INELIGIBLE",r[r.TIMEOUT=5]="TIMEOUT"}(d||(d={}));const p={"u2f_js1.1":""},l="u2f_js1.1",_=window.u2f;function f(){return!0===r.chrome&&parseInt(r.version,10)>=38&&!r.is_mobile_or_tablet()||Boolean(_)}const g={webauthn_wd07:""},E="webauthn_wd07";var h;!function(e){e[e.OtherError=1]="OtherError",e[e.SecurityError=2]="SecurityError",e[e.NotAllowedError=3]="NotAllowedError",e[e.InvalidStateError=4]="InvalidStateError",e[e.Canceled=5]="Canceled",e[e.Timeout=6]="Timeout",e[e.NotSupportedError=7]="NotSupportedError"}(h||(h={}));const m={SecurityError:h.SecurityError,NotAllowedError:h.NotAllowedError,InvalidStateError:h.InvalidStateError,AbortError:h.Canceled,TimeoutError:h.Timeout,NotSupportedError:h.NotSupportedError};var I;function R(){return window.PublicKeyCredential&&(!0===r.mozilla&&parseInt(r.version,10)>=60||!0===r.chrome&&parseInt(r.version,10)>=66||!0===r.edge&&parseFloat(r.version)>=17.17682||!0===r.safari&&parseFloat(r.version)>=12.2)}function S(e){return!(!e||!R())&&((!0!==r.edge||!0!==e.disable_on_edge)&&(!0!==r.safari||!0!==e.disable_on_safari))}function v(e){return S(e)&&function(e){if(!0===r.edge&&parseFloat(r.version)>=17.17682&&parseFloat(r.version)<17.17713||!0===r.chrome&&69===parseInt(r.version,10)||!0===r.safari&&parseFloat(r.version)<13.1){if(e.allowCredentials)for(const t of e.allowCredentials)if(t.key_format===I.COSE)return!0;return!1}return!0}(e)}function T(e){if(e instanceof DOMException){const t=m[e.name];if(void 0!==t)return{errorCode:t,errorData:e.toString&&e.toString()}}return{errorCode:h.OtherError,errorData:e.toString&&e.toString()}}!function(e){e[e.COSE=0]="COSE",e[e.DER=1]="DER"}(I||(I={}));const P=Object.assign(Object.assign({},p),g);function O(e){return function(e){return S(e)}(e.webauthn_wd07)?E:function(e){return!!e&&f()}(e["u2f_js1.1"])?l:null}function y(e){return v(e.webauthn_wd07)?E:function(e){return!!e&&f()}(e["u2f_js1.1"])?l:null}const C={error:"Authenticator devices are not supported on this browser"},N={error:"Authenticator protocol not supported"};function U(e,t){let r;return r="register"===e?O(t):y(t),null!==r?Promise.resolve(r):f()||R()?Promise.reject(N):Promise.reject(C)}e.PROTOCOLS=P,e.canRegisterAuthenticator=function(e){return void 0===e?f():null!==O(e)},e.canUseAuthenticator=function(e){return null!==y(e)},e.isWebAuthnEnabled=function(e){return!!e&&!!e.webauthn_wd07},e.register=function(e){return U("register",e).then((function(t){return t in g?function(e){const t={challenge:n.b64urldecode(e.challenge),timeout:e.timeout,rp:{id:e.rp.id,name:e.rp.name,icon:e.rp.icon},user:{id:n.b64urldecode(e.user.id),name:e.user.name,displayName:e.user.displayName,icon:e.user.icon},authenticatorSelection:e.authenticatorSelection};return void 0!==e.excludeCredentials&&(t.excludeCredentials=e.excludeCredentials.map((e=>({type:e.type,id:n.b64urldecode(e.id),transports:e.transports})))),void 0!==e.pubKeyCredParams&&(t.pubKeyCredParams=e.pubKeyCredParams.map((e=>({type:e.type,alg:e.alg})))),void 0===e.attestation&&(t.attestation="direct"),navigator.credentials.create({publicKey:t}).then((e=>({response:{clientDataJSON:n.b64urlencode(e.response.clientDataJSON),attestationObject:n.b64urlencode(e.response.attestationObject)}}))).catch((e=>T(e)))}(e[t]).then((r=>({protocol:t,challenge_id:e.challenge_id,response:r}))):t in p?(r=e[t],new Promise(((e,t)=>{(_||c).register(r.appId,r.registerRequests,r.registeredKeys,e,r.opt_timeoutSeconds)}))).then((r=>({protocol:t,challenge_id:e.challenge_id,response:r}))):Promise.reject(N);var r}))},e.sign=function(e){return U("sign",e).then((function(t){return t in g?function(e){const t={challenge:n.b64urldecode(e.challenge),timeout:e.timeout,rpId:e.rpId,userVerification:e.userVerification,extensions:e.extensions};return void 0!==e.allowCredentials&&(t.allowCredentials=e.allowCredentials.map((e=>{let t;return e.transports&&e.transports.length>0&&(t=e.transports),{type:e.type,id:n.b64urldecode(e.id),transports:t}}))),navigator.credentials.get({publicKey:t}).then((e=>({id:e.id,response:{clientDataJSON:n.b64urlencode(e.response.clientDataJSON),authenticatorData:n.b64urlencode(e.response.authenticatorData),signature:n.b64urlencode(e.response.signature),userHandle:e.response.userHandle&&n.b64urlencode(e.response.userHandle)}}))).catch((e=>T(e)))}(e[t]).then((r=>({protocol:t,challenge_id:e.challenge_id,response:r}))):t in p?(r=e[t],new Promise(((e,t)=>{(_||c).sign(r.appId,r.challenge,r.registeredKeys,e,r.opt_timeoutSeconds)}))).then((r=>({protocol:t,challenge_id:e.challenge_id,response:r}))):Promise.reject(N);var r}))}}));
//# sourceMappingURL=c_auth_authenticator.js-vfl30HaG3.map
