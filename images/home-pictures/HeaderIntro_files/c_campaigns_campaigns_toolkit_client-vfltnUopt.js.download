define(["exports","./c_tslib","./e_edison","metaserver/static/js/modules/constants/page_load","./e_ui_page_files_router","./c_api_v2_noauth_client","./e_core_exception","./c_core_exception_info","./c_campaigns_campaign_enums","./c_lodash-es_lodash","./c_core_uri","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./c_core_notify","./c_core_i18n","./c_src_sink_index","./c_core_browser_detection","metaserver/static/js/modules/core/langpack","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","metaserver/static/js/modules/constants/request","./c_csrf","./c_browser_cookies","./c_core_xhr","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/login_and_register"],(function(e,t,a,n,s,i,o,c,r,p,m,_,l,g,d,u,v,E,f,C,O,S,h,A,I,j,P,y,D,T,x,L,b,N,w,q,M,G){"use strict";function R(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(a){if("default"!==a){var n=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,n.get?n:{enumerable:!0,get:function(){return e[a]}})}})),t.default=e,Object.freeze(t)}var U=R(n);const k=()=>a.React$1.createElement(s.CampaignSlot,{slotId:"fullscreen_overlay"}),F=e=>{for(const t of e)window.clearTimeout(t)},H=(e,t)=>{const a=[];return e.forEach((e=>{var n,i,o;if(null===(n=null==e?void 0:e.campaign)||void 0===n?void 0:n.delay_in_seconds){s.logDelaySchedulingEvent(e,e.campaign.delay_in_seconds);const n=(i=()=>{s.emitCampaignToSlot(e,t)},o=1e3*e.campaign.delay_in_seconds,window.setTimeout(i,o));a.push(n)}else s.emitCampaignToSlot(e,t)})),a},V=e=>e.map((e=>{const t=e.campaign;return{campaign_id:t.campaign_id,version_id:t.version_id,slot:e.slotId[".tag"],load_method:s.LOAD_METHOD_TOOLKIT}})),W=(e={},a,n,r,p)=>t.__awaiter(void 0,void 0,void 0,(function*(){try{if(!e||!e.page)return[];const m=a=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=[],{campaigns_result:p,campaigns_to_slots:m}=yield function(e){if(!e.campaign_properties||0===Object.keys(e.campaign_properties).length)throw new Error("campaign_properties cannot be empty");let t=new i.NoAuthApiV2Client;const a=s.getActiveUser();return void 0!==a&&(t=new s.DefaultUserApiV2Client(a)),t.ns("campaigns_toolkit").rpc("get_best_campaigns_for_user",e,{}).catch((t=>(o.reportException({err:t,tags:["fetchCampaigns","campaigns"],severity:c.SEVERITY.NONCRITICAL,exc_extra:{args:e}}),{campaigns:[],campaigns_to_slots:{}})))}({campaign_properties:e,event_context:{file_extension:(null==n?void 0:n.file_extension)&&n.file_extension,file_name:(null==n?void 0:n.file_name)&&n.file_name,upload_error_type:(null==n?void 0:n.upload_error_type)&&n.upload_error_type,file_path:(null==n?void 0:n.file_path)&&n.file_path,file_extensions_in_directory:(null==n?void 0:n.file_extensions_in_directory)&&n.file_extensions_in_directory,page_path:null==n?void 0:n.page_path},locale:U.PAGE_LOCALE,load_method:r,orchestration_state:a});return null==p||p.campaigns.forEach((e=>{var a,n;t.push({campaign:e,requestId:null==p?void 0:p.request_id,slotId:null!==(a=null==m?void 0:m[e.version_id])&&void 0!==a?a:{".tag":"other"},currentSequenceStep:null===(n=e.sequence)||void 0===n?void 0:n.root})})),t}));return yield a.enqueueFetch(s.LOAD_METHOD_TOOLKIT,m,V,p,e)}catch(t){o.reportException({err:t,tags:["fetchCampaigns","campaigns"],severity:c.SEVERITY.NONCRITICAL,exc_extra:{args:e}})}return[]})),B=e=>{const t={};return e.forEach((e=>{e.currentSequenceStep&&(t[e.campaign.campaign_id]=e.currentSequenceStep)})),t},Q=[s.CampaignEvents.DOWNLOAD_BUTTON_CLICKED,s.CampaignEvents.FILE_SHARE_SUCCESS,s.CampaignEvents.FILE_UPLOAD_FAILURE,s.CampaignEvents.SHARE_MODAL_CLOSED,s.CampaignEvents.PAGE_LOAD,s.CampaignEvents.FILE_UPLOAD_SUCCESS,s.CampaignEvents.DELETE_SUCCESS];e.CampaignsToolkit=({emitter:e=s.campaignsEmitter,loadMethod:n,shouldExpectPromptToLoad:i})=>{const[{campaigns:o,page:c,context:m,sequenceMap:_,hasLegacyPromptConflict:l,selectiveCampaign:g,delayCampaignTimeouts:d},u]=a.react.exports.useState({campaigns:[],page:"",context:void 0,sequenceMap:{},hasLegacyPromptConflict:void 0,selectiveCampaign:void 0,delayCampaignTimeouts:[]}),v=s.OrchestrationFactory.getInstance();return a.react.exports.useEffect((()=>{const t=({data:{page:e,context:t}})=>{var a;const n=new URL(window.location.href),i=null!==(a=n.searchParams.get("_spec_campaign"))&&void 0!==a?a:void 0;F(d),u((a=>Object.assign(Object.assign({},a),{page:e,context:t&&Object.assign(Object.assign({},t),{page_path:n.pathname}),selectiveCampaign:i}))),s.resetHistoryForEvent(s.PAGE_LOADED),s.setPageName(e)};return e.on(s.PAGE_LOADED,t),()=>{e.off(s.PAGE_LOADED,t),F(d)}}),[]),a.react.exports.useEffect((()=>{const t=({loadEventType:e})=>{e===s.PreviewPageLoadEventType.Mount?v.stashPromptShownCampaigns():v.popStashedPromptShownCampaigns()};return e.on(s.PREVIEW_PAGE_LOADED,t),()=>{e.off(s.PREVIEW_PAGE_LOADED,t)}}),[]),a.react.exports.useEffect((()=>{const t=()=>{s.resetHistoryForEvent(s.PAGE_CHANGED),F(d),v.clearToolkitCampaignsFromState(),u((e=>(e.campaigns.forEach((e=>{s.clearCampaignInSlot(e)})),Object.assign(Object.assign({},e),{campaigns:[],page:""}))))};return e.on(s.PAGE_CHANGED,t),()=>{e.off(s.PAGE_CHANGED,t)}}),[]),a.react.exports.useEffect((()=>{s.promptBufferedEventEmitter.on(s.Events.ON_PROMPT_INITIALIZED,(e=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=e&&(e.didMainCampaignLoad()||e.didTopNotificationLoad());u((e=>Object.assign(Object.assign({},e),{hasLegacyPromptConflict:t})))}))))}),[]),a.react.exports.useEffect((()=>{const t=e=>{const t=o.filter((t=>{var a;const n=null===(a=null==t?void 0:t.campaign)||void 0===a?void 0:a.campaign_id;return!!n&&String(n)!==e})),a=p.cloneDeep(_);delete a[parseInt(e,10)],u((e=>Object.assign(Object.assign({},e),{campaigns:t,sequenceMap:a})))};return e.on(s.CAMPAIGN_DISMISSED,t),()=>{e.off(s.CAMPAIGN_DISMISSED,t)}}),[o]),a.react.exports.useEffect((()=>{const t=({campaignId:e,ctaId:t})=>{var a,n,i;const c=parseInt(e,10),r=o.find((e=>e.campaign.campaign_id===c)),m=null==r?void 0:r.currentSequenceStep,l=null!==(n=null===(a=null==r?void 0:r.campaign.sequence)||void 0===a?void 0:a.nodes)&&void 0!==n?n:{},g={campaign:{campaign_id:c,version_id:-1,prompt_queried_at_ms:-1,campaign_name:"campaignWithOnlyCampaignId"},requestId:"",slotId:{".tag":"other"}};if(!(r&&m&&t&&m in l))return void s.logCampaignSequenceEvent(s.CampaignsToolkitSequenceEvents.MISSING_OR_INVALID_PARAMETERS,null!=r?r:g,m,t);const d=null===(i=l[m].children)||void 0===i?void 0:i[t];if(!d)return s.logCampaignSequenceEvent(s.CampaignsToolkitSequenceEvents.SEQUENCE_COMPLETED,r,m,t),void s.emitCampaignDismissed(e);const v=Object.assign(Object.assign({},r),{currentSequenceStep:d}),E=o.map((e=>e.campaign.campaign_id===c?v:e)),f=p.cloneDeep(_);f[c]=d,u((e=>Object.assign(Object.assign({},e),{campaigns:E,sequenceMap:f}))),s.logCampaignSequenceEvent(s.CampaignsToolkitSequenceEvents.PROGRESS_SEQUENCE,r,d,t),s.emitCampaignToSlot(v)};return e.on(s.CAMPAIGN_SEQUENCE_ACTION,t),()=>{e.off(s.CAMPAIGN_SEQUENCE_ACTION,t)}}),[o,_]),a.react.exports.useEffect((()=>{const a=({name:e,data:{context:a,loggingParams:o}={}})=>t.__awaiter(void 0,void 0,void 0,(function*(){if(!Q.includes(e))return;F(d);const t=yield W({page:c,action:e,path:window.location.pathname},v,a,n,i),o=B(t);u((e=>Object.assign(Object.assign({},e),{campaigns:p.uniqBy([...e.campaigns,...t].reverse(),s.getSlotFromCampaignFormatProps),sequenceMap:Object.assign(Object.assign({},e.sequenceMap),o),delayCampaignTimeouts:H(t,a)})))}));return e.on(s.CAMPAIGN_EVENT,a),()=>{e.off(s.CAMPAIGN_EVENT,a)}}),[c]),a.react.exports.useEffect((()=>{const e=()=>t.__awaiter(void 0,void 0,void 0,(function*(){const e=yield W({page:c,selective_campaign:g||void 0,path:window.location.pathname},v,m,n,i),t=B(e);u((a=>Object.assign(Object.assign({},p.omit(a,"context")),{campaigns:e,sequenceMap:t,selectiveCampaign:void 0,delayCampaignTimeouts:H(e,m)})))}));c&&((e=>r.CampaignPageName.BROWSE===e)(c)?!1===l&&e():e())}),[c,l]),a.React$1.createElement(k,null)},e.fetchCampaigns=W}));
//# sourceMappingURL=c_campaigns_campaigns_toolkit_client.js-vfleaLmjM.map
