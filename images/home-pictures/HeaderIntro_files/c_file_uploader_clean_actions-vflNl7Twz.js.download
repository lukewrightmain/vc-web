define(["exports","./c_tslib","./e_ui_page_files_router","./c_pap-events_manual_upload_select_upload_folder","./c_file_uploader_utils","./c_hive_schemas_web-modal-activity","./c_file_uploader_types","./c_file_uploader_result_type","metaserver/static/js/modules/constants/global_file_upload","metaserver/static/js/modules/constants/web_experience_constants","./e_core_exception","./c_core_exception_info","./c_file_uploader_actions_adapter","metaserver/static/js/modules/constants/trademark","./c_core_i18n","./c_src_sink_index","./c_apex-metrics_src_types","./c_data_slice","./c_data_store","./c_folder_dialog_async","./c_growth_ui_teams_web_actions_logger_events","./c_sharing_actions_cdm_new_folder_modal_actions","./c_sharing_browse_exports","./c_sharing_default_permissions_web_uploads_exports","./c_core_uri","./c_core_notify","./c_sharing_default_permissions_web_uploads_utils","./c_sharing_async_share_modal_util"],(function(e,t,o,r,a,s,i,l,n,d,c,p,u,h,_,g,m,E,S,U,f,I,A,T,C,R,O,F){"use strict";const b=new class{constructor(){this.errorCount=0,this.lastError=Date.now(),this.shouldReport=!0}log(e,t,r){if(r=Object.assign(Object.assign(Object.assign({},r),r.extra),{extra:void 0}),this.shouldReport&&(this.errorCount<10||Date.now()-this.lastError>6e4)){const s=()=>new Promise(((a,s)=>{o.SilentBackgroundRequest$1({url:"/log/web_upload_action",data:{_subject_uid:e,event_type:t,extra_params:JSON.stringify(r)},error:e=>{if(0===e.status)return a(l.error(e,e.status,{isRetriable:!0,maxRetries:1/0}));429===e.status?this.errorCount=10:this.errorCount++,this.lastError=Date.now(),a(l.error(e,e.status,{isRetriable:429!==e.status,maxRetries:4}))},success:e=>{try{const t=JSON.parse(e);return t&&!t.continue_sending&&(this.shouldReport=!1),this.errorCount=0,a(l.ok(t))}catch(e){throw this.errorCount++,this.lastError=Date.now(),a(l.error(e,0,{isRetriable:!0,maxRetries:4})),e}}})}));return a.newPromiseWithRetries({promiseToTry:s.bind(this),exponentialBackoffBase:100,showNetworkSnackbar:!1})}return Promise.resolve({response:l.ok({}),retryCount:0})}};var y;function v(){const e=o.get_pathname();return"/h"===e?"HOME":"/recents"===e?"RECENTS":"/starred"===e?"STARRED":e.startsWith("/share")?"SHARED":"/requests"===e?"FILE_REQUESTS":"/deleted_files"===e?"DELETED_FILES":"/team/admin/content/home"===e?"CONTENT_MANAGER":e.startsWith("/collections")?"COLLECTIONS":"BROWSE"}e.WebUploadActionEvent=void 0,(y=e.WebUploadActionEvent||(e.WebUploadActionEvent={})).UPLOAD_ATTEMPT="upload_attempt",y.UPLOAD_FAILURE="upload_failure",y.UPLOAD_CANCELED="upload_canceled",y.UPLOAD_SUCCESS="upload_success",y.UPLOAD_METRICS="upload_metrics",y.UPLOAD_ABANDONED="upload_abandoned",y.UPLOAD_DEQUEUE="upload_dequeue",y.UPLOAD_VISUALLY_COMPLETE="upload_visually_complete",y.UPLOAD_START_SUCCESS="upload_start_success",y.UPLOAD_APPEND_SUCCESS="upload_append_success";const L=new Set([o.WebUserActionLogEvent.UPLOAD_BUTTON_CLICK,o.WebUserActionLogEvent.ADD_MORE_FILES_CLICK,o.WebUserActionLogEvent.VIEW_DETAILS_CLICK,o.WebUserActionLogEvent.CLOSE_MODAL_CLICK,o.WebUserActionLogEvent.UPLOAD_FILES_CLICK,o.WebUserActionLogEvent.UPLOAD_FOLDER_CLICK,o.WebUserActionLogEvent.CANCEL_UPLOAD_CLICK,o.WebUserActionLogEvent.RETRY_UPLOAD_CLICK,o.WebUserActionLogEvent.UPLOAD_SCROLL_TO_ERRORS,o.WebUserActionLogEvent.UPLOAD_DRAWER_COLLAPSE,o.WebUserActionLogEvent.UPLOAD_DRAWER_EXPAND]);const M=[a.UploadErrorType.IGNORED,a.UploadErrorType.EMPTY_OR_FOLDER,a.UploadErrorType.INVALID_EXTENSION,a.UploadErrorType.INVALID_FILE_NAME,a.UploadErrorType.UPLOAD_PRECHECK_INVALID_CHAR_ERROR,a.UploadErrorType.PACKAGE_FILE],P=[a.UploadErrorType.PERMISSIONS_AT_UPLOAD_ERROR,a.UploadErrorType.OVER_QUOTA_ERROR,a.UploadErrorType.LOCKED_TEAM_ERROR,a.UploadErrorType.COMMIT_PERMISSIONS_ERROR],D=e=>{if(void 0!==e)return M.indexOf(e)>-1?a.UploadErrorClass.IGNORED:P.indexOf(e)>-1?a.UploadErrorClass.REJECTED:a.UploadErrorClass.ERROR};function N({action:t,upload:r,chooser_type:s,upload_method:i,num_files:l,num_invalid_files:u,num_files_abandoned:h,total_file_size:_,num_dirs:g,errorType:m,extra:E,batchId:S,taskTrackingId:U,user:f,uploadPath:I,source:A,dropzoneArea:T}){var C;let R={num_files:l,num_invalid_files:u,num_files_abandoned:h,total_file_size:_,num_dirs:g,chooser_type:s,upload_method:i,extra:Object.assign({origin:v(),uploader:a.shouldUseHybridUploader()?"hybrid_uploader":"legacy_uploader",use_autoretry_optimization:n.UPLOAD_AUTORETRY_OPTIMIZATION?"true":"false",default_drag_and_drop:d.DEFAULT_DRAG_AND_DROP,dropzone_area:T||"",effectiveConnection:(null===(C=null===navigator||void 0===navigator?void 0:navigator.connection)||void 0===C?void 0:C.effectiveType)||"na"},A&&{source:A})};if(function(e){return e&&!!e.uploadId}(r)){const s=r,i=t===e.WebUploadActionEvent.UPLOAD_FAILURE?s.errorType===a.UploadErrorType.GENERIC&&m?m:s.errorType:void 0;R=Object.assign(Object.assign({},R),{upload_id:s.uploadId,file_size:s.size,file_extension:o.file_extension(s.name),failure_reason:i,error_class:D(i),batch_id:s.batchId,upload_destination:s.dest,current_path:o.get_pathname(),file_name:s.name,upload_method:B(s.uploadId)})}else if(function(e){return e&&!!e.batchId}(r)){const e=r;R=Object.assign(Object.assign({},R),{file_size:e.size,file_extension:o.file_extension(e.name),batch_id:e.batchId})}!R.chooser_type&&r&&"chooserType"in r&&r.chooserType&&(R.chooser_type=r.chooserType),S&&(R.batch_id=S),U&&(R.task_tracking_id=U),I&&(R.batch_dest_folder_level=a.getFolderLevel(I),f&&(R.member_folder=a.isInMemberFolder(f,I))),E&&(R.extra=Object.assign(Object.assign({},R.extra),E)),f?!function(e){return L.has(e)}(t)?(t=t,R.client_timestamp=Math.round(Date.now()/1e3),b.log(f.id,t,R)):o.WebUserActionLog.log(f.id,t,R):c.reportStack("Trying to log web upload event but user is null",{severity:p.SEVERITY.NONCRITICAL})}const w={},B=e=>e&&w[e]||i.UploadMethod.CHOOSER;class k{constructor(){this.fileCount=0,this.files={},this.filesInProgress=0,this.firstBlockUploadStartTime=void 0,this.numChunks=0,this.numFiles=0,this.numFilesCancelled=0,this.numFilesIgnoredOrRejected=0,this.numFilesErrored=0,this.retriedBlocks=0,this.retriedCommits=0,this.size=0,this.startTime=void 0,this.useBatchCommit=!1}}var x;!function(e){e.START="START",e.APPEND="APPEND",e.COMMIT="COMMIT",e.FINISH="FINISH",e.VISIBLE="VISIBLE"}(x||(x={}));const W=(e,t)=>{c.reportException({err:new Error("currentBatch was undefined in an upload eventHandler, logging was dropped"),severity:"non-critical",tags:["web_upload","upload_logging"],exc_extra:{uploadId:t,eventType:e}})},z=e=>a.shouldUseHybridUploader()&&a.shouldUseSessionUploadForFile(e.uploadItemMetadata.bytes)?"session_api":"legacy_api";class j{constructor(e){this.blockStartTimes=new Map,this.batches={},this.fileBatch={},this.user=e,this.amisLogger=new V}init(){u.ActionsAdapter.on("setUser",(({user:e})=>{this.user=e})),u.ActionsAdapter.on("filesAdded",(({uploadItems:e})=>{if(0===e.length)return;const t=performance.now(),o=new k;this.batches[this.currentBatchId]=o,o.fileCount=e.length,o.filesInProgress=e.length,e.forEach((e=>{const r={fileUpload:this.convertItemToFileUpload(e,{batchId:this.currentBatchId}),uploadItemMetadata:e,addTime:t,uploadStartTime:t,commitStartTime:0,commitEndTime:0,currentStep:x.START,retriedBlocks:0,retriedCommits:0,chunks:[]};o.files[e.id]=r,this.fileBatch[e.id]=this.currentBatchId,this.amisLogger.recordFileUploadStart(r,o)})),this.amisLogger.recordBatchStart(o)})),u.ActionsAdapter.on("beforeUpload",(({uploadItems:e})=>{if(e.length>0){const t=this.fileBatch[e[0].id],o=t&&this.batches[t];if(t&&o)return void(o.startTime=performance.now())}W("beforeUpload")})),u.ActionsAdapter.on("uploadItemDequeue",(({uploadItem:t})=>{const{currentFile:o}=this.getBatchAndCurrentFileFromItemId(t.id);o?this.reportUploadActionToHive(e.WebUploadActionEvent.UPLOAD_DEQUEUE,o):W("uploadItemDequeue",t.id)})),u.ActionsAdapter.on("blockUploadStart",(({blob:t,uploadItem:o})=>{const r=performance.now(),{currentBatch:a,currentFile:s}=this.getBatchAndCurrentFileFromItemId(o.id);a&&s?(a.firstBlockUploadStartTime||(a.firstBlockUploadStartTime=r),this.blockStartTimes.set(t,r),(null==s?void 0:s.currentStep)===x.START&&(a.files[o.id]=Object.assign(Object.assign({},s),{uploadStartTime:r,currentStep:x.APPEND}),this.reportUploadActionToHive(e.WebUploadActionEvent.UPLOAD_START_SUCCESS,s,{parallelCommit:"true",timeInStep:(r-s.addTime).toString()}))):W("blockUploadStart",o.id)})),u.ActionsAdapter.on("blockUploadEnd",(({blob:e,uploadItem:t,totalRetryCount:o})=>{const{currentBatch:r,currentFile:a}=this.getBatchAndCurrentFileFromItemId(t.id),s=this.blockStartTimes.get(e);r&&a?(s&&(null==a||a.chunks.push({duration:performance.now()-s,sizeBytes:e.size}),r.size+=e.size,r.numChunks++,this.blockStartTimes.delete(e)),a&&(a.retriedBlocks+=o||0),r.retriedBlocks+=o||0):W("blockUploadEnd",t.id)})),u.ActionsAdapter.on("filesCommitting",(({uploadItems:t})=>{const o=performance.now();t.forEach((t=>{const{currentBatch:r,currentFile:a}=this.getBatchAndCurrentFileFromItemId(t.id);r&&a?(null==a?void 0:a.currentStep)===x.APPEND&&(r.files[t.id]=Object.assign(Object.assign({},a),{commitStartTime:o,currentStep:x.COMMIT}),this.reportUploadActionToHive(e.WebUploadActionEvent.UPLOAD_APPEND_SUCCESS,a,{parallelCommit:"true",timeInStep:(o-a.uploadStartTime).toString()})):W("filesCommitting",t.id)}))})),u.ActionsAdapter.on("fileUploaded",(({uploadItem:t,totalRetryCount:o,useBatchCommit:r})=>{const{currentBatch:a,currentFile:s}=this.getBatchAndCurrentFileFromItemId(t.id),i=performance.now();a&&s?(a.numFiles++,a.retriedCommits+=o||0,a.useBatchCommit=r,(null==s?void 0:s.currentStep)===x.COMMIT&&(s.retriedCommits=o||0,s.commitEndTime=i,s.currentStep=x.FINISH,this.reportUploadActionToHive(e.WebUploadActionEvent.UPLOAD_SUCCESS,s,Object.assign(Object.assign({parallelCommit:"true",timeInStep:(i-s.commitStartTime).toString(),overallTime:(i-s.addTime).toString()},this.getFileUploadMetrics(s)),this.getRetriesData(s))),this.amisLogger.recordFileUploadSuccess(s,a),this.amisLogger.recordFileUploadPerformance(s,a)),this.reportMetricsIfBatchEmpty(s)):W("fileUploaded",t.id)})),u.ActionsAdapter.on("fileCanceled",(({uploadItems:t,uploadFiles:r})=>{var a;(null!==(a=null!=t?t:r)&&void 0!==a?a:[]).forEach((t=>{var r;const a=null!==(r=t.uploadId)&&void 0!==r?r:t.id,{currentBatch:s,currentFile:i}=this.getBatchAndCurrentFileFromItemId(a);i&&s&&(s.numFilesCancelled++,this.reportUploadActionToHive(e.WebUploadActionEvent.UPLOAD_CANCELED,i,Object.assign({},this.getRetriesData(i))),this.reportUploadActionToHive(o.WebUserActionLogEvent.CANCEL_UPLOAD_CLICK,i),this.reportMetricsIfBatchEmpty(i),this.amisLogger.recordFileUploadCancel(i,s))}))})),u.ActionsAdapter.on("error",(e=>{const{uploadItem:t,totalRetryCount:o,errorType:r}=e,{currentBatch:s,currentFile:i}=this.getBatchAndCurrentFileFromItemId(t.id),l=D(r);this.reportUploadError(e,Object.assign({},this.getRetriesData(i,r,o))),s&&i?(!l||l!==a.UploadErrorClass.IGNORED&&l!==a.UploadErrorClass.REJECTED?s.numFilesErrored++:s.numFilesIgnoredOrRejected++,i.errorLogged||(this.amisLogger.recordFileUploadError(i,s,r,l),i.errorLogged=!0),this.reportMetricsIfBatchEmpty(i)):W("error")})),u.ActionsAdapter.on("boltUpdate",(({ts:e})=>{this.logVisuallyComplete(e)}))}reportBatchUploadMetrics(t,o){const{size:r,startTime:a,firstBlockUploadStartTime:s,numFiles:i,numChunks:l,retriedBlocks:n,retriedCommits:d,useBatchCommit:c}=o;if(0===i)return;const p=performance.now();if(!a||!s)return;if(Object.keys(o.files).filter((e=>o.files[e].errorLogged)).length)return;const u=p-a,h=s-a,_=Object.values(o.files).reduce(((e,t)=>e+this.countBlocksForSize(t.uploadItemMetadata.bytes)),0);N({user:this.user,action:e.WebUploadActionEvent.UPLOAD_METRICS,batchId:t,num_files:i,extra:Object.assign(Object.assign({numBlocks:String(_),numChunks:String(l),retriedBlocks:String(n),retriedCommits:String(d),fullDuration:u.toFixed(0),timeToFirstBlockUpload:h.toFixed(0)},this.calculateAggregateTimings(o)),{batchSize:String(r),sizeNormalizedSpeed:(r/(u/1e3)).toFixed(0),batchMbps:(r/125e3/(u/1e3)).toFixed(4),useBatchCommit:c?"true":"false"})})}getFileUploadMetrics(e){const t=performance.now(),o=e.uploadItemMetadata.bytes,r=t-e.addTime,a=e.uploadStartTime-e.addTime,s=e.commitStartTime-e.uploadStartTime,i=this.calculateThreadUploadTime(e),l=e.commitEndTime-e.commitStartTime;return{numBlocks:String(this.countBlocksForSize(o)),numChunks:String(e.chunks.length),retriedBlocks:String(e.retriedBlocks),retriedCommits:String(e.retriedCommits),fullDuration:r.toFixed(0),preUploadDuration:a.toFixed(0),blockUploadWallDuration:s.toFixed(0),blockUploadThreadDuration:i.toFixed(0),commitDuration:l.toFixed(0),fileSize:String(o),effectiveUploadSpeed:(o/(s/1e3)).toFixed(0),sizeNormalizedSpeed:(o/(r/1e3)).toFixed(0),fileMbps:(o/125e3/(r/1e3)).toFixed(4),apiUsed:z(e)}}reportUploadError({errorMessage:t,errorMethodSource:o,totalRetryCount:r,useBatchCommit:a,errorCode:s,errorType:l,uploadItem:n},d){const c=E.getTargetSurface(S.getStoreForUpload().getState()),p="none"===c?i.UploadMethod.CHOOSER:i.UploadMethod.DRAG,{currentFile:h}=this.getBatchAndCurrentFileFromItemId(n.id);let _=null==h?void 0:h.fileUpload;_||(_=u.convertUploadItem(n));let g=Object.assign(Object.assign({},d),{errorCode:s.toString(),targetSurface:c,useBatchCommit:String(Boolean(a))});t&&(g=Object.assign(Object.assign({},g),{errorMessage:t})),o&&(g=Object.assign(Object.assign({},g),{errorMethodSource:o})),r&&(g=Object.assign(Object.assign({},g),{totalRetryCount:String(r)})),N({user:this.user,action:e.WebUploadActionEvent.UPLOAD_FAILURE,upload:_,errorType:l,upload_method:p,extra:g})}setBatchId(e){this.currentBatchId=e}getRetriesData(e,t,o=0){if(!e)return{autoRetryCount:"0",manualRetryCount:"0"};const r=e.uploadItemMetadata.manualRetryCount.toString()||"0",a=e.retriedBlocks+e.retriedCommits+o,s={autoRetryCount:a?a.toString():"0",manualRetryCount:r};return t&&(s.failure_reason=t),s}calculateAggregateTimings(e){let t=0,o=0,r=0,a=0;return Object.values(e.files).forEach((e=>{t+=e.uploadStartTime-e.addTime,o+=e.commitEndTime-e.commitStartTime,r+=e.commitStartTime-e.uploadStartTime,a+=this.calculateThreadUploadTime(e)})),{preUploadDuration:t.toFixed(0),commitDuration:o.toFixed(0),blockUploadWallDuration:r.toFixed(0),blockUploadThreadDuration:a.toFixed(0)}}calculateThreadUploadTime(e){return e.chunks.map((e=>e.duration)).reduce(((e,t)=>e+t),0)}convertItemToFileUpload(e,t){return u.convertUploadItem(e,t)}countBlocksForSize(e){return Math.ceil(e/4194304)}reportUploadActionToHive(e,t,o={},r){const a=this.batches[t.fileUpload.batchId];o=Object.assign(Object.assign({},o),{apiUsed:z(t)}),N({user:this.user,action:e,num_files:null==a?void 0:a.fileCount,upload:t.fileUpload,errorType:r,extra:o})}cleanupBatch(e){const t=this.batches[e];t&&(Object.keys(t.files).forEach((e=>{delete this.fileBatch[e]})),delete this.batches[e])}reportMetricsIfBatchEmpty(e){var t;const o=null===(t=null==e?void 0:e.fileUpload)||void 0===t?void 0:t.batchId;if(o&&this.batches[o]){const e=this.batches[o];e.filesInProgress--,e.fileCount>0&&e.filesInProgress<=0&&(this.reportBatchUploadMetrics(o,e),this.amisLogger.recordBatchFinish(e))}}logVisuallyComplete(t){Object.entries(this.batches).forEach((([t,o])=>{if(!o)return;let r=!0;Object.values(o.files).forEach((o=>{o.currentStep===x.FINISH?(o.currentStep=x.VISIBLE,this.reportUploadActionToHive(e.WebUploadActionEvent.UPLOAD_VISUALLY_COMPLETE,o,{batchId:t})):r=!1})),r&&this.cleanupBatch(t)}))}getBatchAndCurrentFileFromItemId(e){const t=this.fileBatch[e];if(!t)return{};const o=this.batches[t];return{currentBatch:o,currentFile:null==o?void 0:o.files[e]}}}class V{constructor(){this.ns="web_file_actions"}recordFileUploadStart(e,t){g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_start"},this.getFileUploadMetricTags(e,t)).record(1)}recordFileUploadSuccess(e,t){g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_success"},this.getFileUploadMetricTags(e,t)).record(1)}recordFileUploadCancel(e,t){g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_cancel"},this.getFileUploadMetricTags(e,t)).record(1)}recordFileUploadError(e,t,o,r){g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_error"},Object.assign({errorType:o,errorClass:r?r.toString():"UNKNOWN"},this.getFileUploadMetricTags(e,t))).record(1)}recordFileUploadPerformance(e,t){const o=e.commitEndTime-e.uploadStartTime,r=e.uploadItemMetadata.bytes/125/o;g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_speed"},this.getFileUploadMetricTags(e,t)).recordDuration(r,m.TimeUnit.MILLISECONDS)}recordBatchStart(e){g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_batch_start"},this.getBatchUploadMetricTags(e)).record(1)}recordBatchFinish(e){if(g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_batch_finish"},Object.assign({state:this.getBatchFinalState(e)},this.getBatchUploadMetricTags(e))).record(1),e.numFiles===e.fileCount&&e.startTime){const t=performance.now()-e.startTime,o=e.size/125/t;g.getMetricsReporter$1().createStats({ns:this.ns,name:"upload/upload_batch_speed"},Object.assign({},this.getBatchUploadMetricTags(e))).recordDuration(o,m.TimeUnit.MILLISECONDS)}}getBatchFinalState(e){const{numFiles:t,numFilesCancelled:o,numFilesErrored:r,numFilesIgnoredOrRejected:a,fileCount:s}=e;return t+o+a>=s?"COMPLETED":t>0&&r>0?"COMPLETED_PARTIALLY":0===t&&r>0?"FAILED":"UNKNOWN"}getFileUploadMetricTags(e,t){var o;return{uploader:a.shouldUseHybridUploader()?"hybrid_uploader":"legacy_uploader",apiUsed:z(e),sizeBucket:this.getUploadSizeBucket(null===(o=null==e?void 0:e.uploadItemMetadata)||void 0===o?void 0:o.bytes),isSingleFile:(1===(null==t?void 0:t.fileCount)).toString()}}getBatchUploadMetricTags(e){return{uploader:a.shouldUseHybridUploader()?"hybrid_uploader":"legacy_uploader",isSingleFile:(1===(null==e?void 0:e.fileCount)).toString(),sizeBucket:this.getUploadSizeBucket(null==e?void 0:e.size)}}getUploadSizeBucket(e){const t=1048576,o=1073741824;return e<=t?"1MB":e<=4194304?"4MB":e<=16777216?"16MB":e<=67108864?"64MB":e<=262144e3?"250MB":e<=o?"1GB":e<=4294967296?"4GB":e<=17179869184?"16GB":e<=53687091200?"50GB":"OVER50GB"}}var H;function G(e){return{class:"manual_upload",action:"upload",object:"file",properties:e}}e.UploaderOverQuotaModalContexts=void 0,(H=e.UploaderOverQuotaModalContexts||(e.UploaderOverQuotaModalContexts={})).UNKNOWN="unknown",H.WENT_OQ_DURING_UPLOAD="went_oq_during_upload",H.ALREADY_OQ_DRAG_AND_DROP="already_oq_drag_and_drop",H.ALREADY_OQ_CLICK_BUTTON="already_oq_upload_button",H.LOCKED_TEAM_DRAG_AND_DROP="locked_team_drag_and_drop",H.LOCKED_TEAM_CLICK_BUTTON="locked_team_click_button";const K={};function Q({eventState:e,metadata:t}){"start"===e&&(K[t.batch_id_string]=t),o.logEvent({class:"manual_upload",action:"upload",object:"batch",properties:{eventState:e,failedCount:"failed_count"in t?t.failed_count:void 0,cancelCount:"cancel_count"in t?t.cancel_count:void 0,successCount:"success_count"in t?t.success_count:void 0,totalFileSize:t.total_file_size,itemCount:t.item_count,batchIdString:t.batch_id_string,isFolder:t.is_folder,actionScreen:t.actionScreen,actionElement:t.actionElement?t.actionElement:void 0,taskTrackingIdString:t.task_tracking_id_string}})}function Y(e,t,o,r){const s=E.getFilesForBatch(t(),e);let i=0,l=0,n=0;const d=r||0;let p;if(s.forEach((e=>{e.status===a.FileStatusType.COMPLETE&&i++,e.status===a.FileStatusType.FAILED&&l++,e.status===a.FileStatusType.CANCELLED&&n++})),i+l+n<s.size&&!o)return;p=l?"failed":n||o?"canceled":"success";const u=K[e];u||c.reportException({err:new Error("logged a batch end event without first logging a start event for that batch"),severity:"non-critical",tags:["web_upload","upload_logging"],exc_extra:{batchId:e}}),Q({eventState:p,metadata:Object.assign({failed_count:l,cancel_count:n+d,success_count:i,total_file_size:0,item_count:s.size,batch_id_string:e,is_folder:!1,actionScreen:"browse_screen",actionElement:null,task_tracking_id_string:""},u)})}const q=["1password","abbu","agilekeychain","aplibrary","app","band","cmproj","dvdproj","fcpbundle","gameproj","graffle","imovielibrary","imovieproject","itlp","key","logic","logicx","lpdf","lrdata","mindnode","mindnode","mpkg","numbers","pages","photolibrary","rcproject","rtfd","screenflow","scriv","sketch","theater","xcodeproj","xd","ydevice","bundle","framework","plugin","kext","pkg"];function $(e,t,o,r){const a=r[r.length-1];if(!a)return[{ts:o,bytesUploaded:e,uploadSize:t}];if(o-a.ts<2e3)return r;const s=function(e,t,o,r){if(e.uploadSize>r)return{type:"snapshots_invalid"};{const r=o-e.bytesUploaded,a=t-e.ts;return{type:"snapshots_valid",bytesPerSecond:r>0?Math.ceil(r/(a/1e3)):void 0}}}(r[0],o,e,t),i={ts:o,bytesUploaded:e,uploadSize:t,bytesPerSecond:"snapshots_valid"===s.type&&s.bytesPerSecond||a.bytesPerSecond};return"snapshots_invalid"===s.type?[i]:[...r.slice(Math.max(r.length-10-1,0)),i]}const J=()=>({upload:_.intl.formatMessage({id:"HudAZo",defaultMessage:"Upload"}),fileUploadError:_.intl.formatMessage({id:"q9Pk1n",defaultMessage:"This folder or empty file could not be uploaded because of browser limitations. Try zipping up the content before uploading it, or use the Dropbox desktop client to sync it."}),fileIsPackageError:_.intl.formatMessage({id:"+X+iho",defaultMessage:"This file is a package file and can’t be uploaded directly. To upload a package file via the web, try zipping it first."}),serverError:_.intl.formatMessage({id:"9b4XvT",defaultMessage:"Something went wrong while uploading this file. There was a server error during the upload request."}),invalidCharacterError:_.intl.formatMessage({id:"rNoDTo",defaultMessage:"Something went wrong while uploading this file. The filename contains an invalid character."})}),X=new class{constructor(){this.uploadSnapshots=[],this.hasInit=!1,this.convertUploadItemWithUser=(e,t={})=>{const o=E.getUser(this.store.getState()).id;return u.convertUploadItem(e,Object.assign({userId:o},t))},this._createHandlers=({chooseDestination:r,isContentManager:s,autoTeamGroupId:l,getBrowseContext:n,handleClickNewFolder:d,uploadConsumerInterface:u})=>({handleFilesAdded:(t,r)=>{const s={};for(const e of t)s[e.dest]=null;const d=E.getUser(this.store.getState()),c=E.getTargetSurface(this.store.getState()),p="none"===c?i.UploadMethod.CHOOSER:i.UploadMethod.DRAG,h=[],_=[],g=[],m=e=>"#.url"===e.name,S=e=>null==e.size,U=e=>q.includes(o.file_extension(e.name))&&e.size%34==0;for(const e of t)S(e)&&h.push(e),U(e)&&_.push(e),m(e)&&g.push(e);for(const t of h){this.store.dispatch(E.uploadActionCreators.addNewFailedFile({file:t,errorType:a.UploadErrorType.EMPTY_OR_FOLDER,errorMessage:this.strings.fileUploadError}));const r=E.getUploadById(this.store.getState(),t.uploadId);N({user:d,action:e.WebUploadActionEvent.UPLOAD_FAILURE,upload:r,upload_method:p,extra:{targetSurface:c}}),o.logEvent(G({eventState:"failed",fileSize:null==r?void 0:r.size,fileType:r&&a.getFileType(r),batchIdString:null==r?void 0:r.batchId,uploadId:null==r?void 0:r.uploadId}))}for(const t of _){this.store.dispatch(E.uploadActionCreators.addNewFailedFile({file:t,errorType:a.UploadErrorType.PACKAGE_FILE,errorMessage:this.strings.fileIsPackageError}));const r=E.getUploadById(this.store.getState(),t.uploadId);N({user:d,action:e.WebUploadActionEvent.UPLOAD_FAILURE,upload:r,upload_method:p,extra:{targetSurface:c}}),o.logEvent(G({eventState:"failed",fileSize:null==r?void 0:r.size,fileType:r&&a.getFileType(r),batchIdString:null==r?void 0:r.batchId,uploadId:null==r?void 0:r.uploadId}))}for(const t of g){this.store.dispatch(E.uploadActionCreators.addNewFailedFile({file:t,errorType:a.UploadErrorType.INVALID_EXTENSION,errorMessage:this.strings.fileUploadError}));const r=E.getUploadById(this.store.getState(),t.uploadId);N({user:d,action:e.WebUploadActionEvent.UPLOAD_FAILURE,upload:r,upload_method:p,extra:{targetSurface:c}}),o.logEvent(G({eventState:"failed",fileSize:null==r?void 0:r.size,fileType:r&&a.getFileType(r),batchIdString:null==r?void 0:r.batchId,uploadId:null==r?void 0:r.uploadId}))}t=t.filter((e=>!m(e)&&!U(e)&&!S(e))),h.length&&this.cancelUploads({files:h},u||!1),_.length&&this.cancelUploads({files:_},u||!1),g.length&&this.cancelUploads({files:g},u||!1),this.store.dispatch(E.uploadActionCreators.queueUploads(t));if(!a.getFileUploadsWithStatus(E.getFileList(this.store.getState()),[a.FileStatusType.SET_PERMISSIONS]).length)return void(r&&r());const f=this.canSeeMultiFolderPermissionsAtUploadModal(),I=l&&n&&this.canSeeNewFolderViaUploadModal(),A=()=>{this.readyFilesForUpload(),this._startNextUploadIfAvailable(),null==r||r()};f||I?O.getDefaultPermissionForFolderUploads(d.id).then((e=>{const t=e!==O.DefaultPermissionForFolderUploadsOptions.INHERIT;f&&t?this.showMultiFolderPermissionsAtUploadModal(u||!1,r,n):I&&t?this.showCdmNewFolderViaUploadModal(l,n,u||!1,r):A()})):A()},handleUploadProgress:(e,t)=>{if(e&&!E.isUploadCancelled(this.store.getState(),e.uploadId)){const o=e.percentUploaded,r=e,s=E.getFileList(this.store.getState());if(null===r)return void(e.uploadId in this.reportedFileUploadExceptions||(c.reportException({err:new Error("uploadSelectors.getCurrentUpload(this.store.getState()) is null"),severity:p.SEVERITY.NONCRITICAL}),this.reportedFileUploadExceptions[e.uploadId]=!0));const i=o/100*r.size,l=i+function(e){return e.reduce(((e,t)=>(t.status===a.FileStatusType.COMPLETE?e+=t.size:t.status===a.FileStatusType.UPLOADING&&(e+=t.percentUploaded/100*t.size),e)),0)}(s.filter((e=>e.uploadId!==r.uploadId))),n=a.calculateSizeOfUploads(s,[a.FileStatusType.COMPLETE,a.FileStatusType.PENDING,a.FileStatusType.UPLOADING]),d=this.calculateBytesPerSecond(l,n),u=s.count((e=>e.status===a.FileStatusType.PENDING||e.status===a.FileStatusType.UPLOADING)),h=void 0!==d?(n-l)/d+u:void 0,_=void 0!==d?(r.size-i)/d+1:void 0,g=s.get(e.uploadId);if((null==g?void 0:g.percentUploaded)===o&&g&&_&&Math.floor(g.numSecondsLeft)===Math.floor(_))return;this.store.dispatch(E.uploadActionCreators.setUploadProgress({uploadId:r.uploadId,percentComplete:o,numSecondsLeft:t?h:void 0,secondsLeftForFile:_}))}},handleFileUploaded:(e,t)=>{E.isUploadCancelled(this.store.getState(),e.uploadId)||(this.store.dispatch(E.uploadActionCreators.completeUpload({uploadId:e.uploadId})),o.logEvent(G({eventState:"success",fileSize:e.size,fileType:a.getFileType(e),uploadId:e.uploadId,batchIdString:e.batchId})),o.UserSurvey.trackEvent("upload_item","browse"),a.logMediaFileToUserSurvey(e.name),a.uploadSuccessEmitEventIsOn()&&o.publishEvent(o.CampaignEvents.FILE_UPLOAD_SUCCESS,{context:{file_name:e.name,file_extension:o.file_extension(e.name),file_path:T.getFilePath(e)}}),this._startNextUploadIfAvailable())},handleUploadComplete:()=>{E.getFileList(this.store.getState()).valueSeq().filter((e=>e.status===a.FileStatusType.SET_PERMISSIONS)).toArray().length||this.store.dispatch(E.uploadActionCreators.resetTeamAccessLevel()),this.resetCreatedFolders(),this.resetFoldersWithError(),this.resetUploadSnapshots()},handleError:(e,t,r)=>{e&&(a.uploadFailureEmitEventIsOn()&&o.publishEvent(o.CampaignEvents.FILE_UPLOAD_FAILURE,{context:{file_name:e.name,upload_error_type:t,file_extension:o.file_extension(e.name),file_path:T.getFilePath(e)}}),E.getFileList(this.store.getState()).has(e.uploadId)?this.store.dispatch(E.uploadActionCreators.handleUploadError({uploadId:e.uploadId,errorType:t,errorMessage:r})):this.store.dispatch(E.uploadActionCreators.addNewFailedFile({file:e,errorType:t,errorMessage:r})),t!==a.UploadErrorType.OVER_QUOTA_ERROR&&t!==a.UploadErrorType.LOCKED_TEAM_ERROR||this.store.dispatch(E.uploadActionCreators.setHasOverquotaError(!0)),this._startNextUploadIfAvailable())},handleBeforeUpload:(e,r,s,i)=>{if(!e)return;const n=this.strings.serverError,d=this.getUploadPath();if(this.canShowUploadModal()&&l){const o=T.getRootPath(e,d),a=r;r=()=>t.__awaiter(this,void 0,void 0,(function*(){yield this.createSharedFolder(e,l),this.addCreatedFolder(o),a()}))}if(E.getConfirmedFSWBatchIds(this.store.getState()).filter((t=>e.batchId===t)).length)return void r();let c={path:e.dest,to_path:e.name,fsw_request:"check",_subject_uid:e.userId};this.ajaxInterceptor&&(c=this.ajaxInterceptor.interceptUploadPrecheck(c));return o.SilentBackgroundRequest$1({url:"/cmd/upload_precheck",data:c,success:t=>{this.handleUploadPrecheckSuccess(t,e,r,n,i,s)},error:t=>{this.manuallySetInErrorState({file:e,errorType:a.UploadErrorType.UPLOAD_PRECHECK_ERROR,errorMessage:n,extra:{type:"ajax-error",errorCode:t.status.toString(),errorText:t.responseText,requestId:t.getResponseHeader("x-dropbox-request-id")||""}})}})}}),this.chooseFiles=(e,t,o)=>{const r=E.getPath(this.store.getState());e.chooseFiles().then((({items:e,errors:s})=>{this.logUploadAttempts({chooserType:a.ChooserType.FILE,uploadPath:r,items:e,errors:s,upload_method:i.UploadMethod.CHOOSER,actionElement:t,taskTrackingId:o})}))},this.chooseFolder=(e,t,o)=>{const r=E.getPath(this.store.getState());e.chooseFolder().then((({items:e,errors:s})=>{this.logUploadAttempts({chooserType:a.ChooserType.FOLDER,uploadPath:r,items:e,errors:s,upload_method:i.UploadMethod.CHOOSER,actionElement:t,taskTrackingId:o})}))},this.logUploadAttempts=({chooserType:r,uploadPath:s,items:i,errors:l,upload_method:n,actionElement:d,taskTrackingId:c})=>t.__awaiter(this,void 0,void 0,(function*(){const t=function(e){return e.reduce(((e,{bytes:t})=>e+t),0)}(i),p=a.getCurrentActionScreen();i.forEach((e=>{const t=u.convertUploadItem(e);o.logEvent(G({eventState:"start",fileSize:t.size,fileType:a.getFileType(t),batchIdString:this.currentBatchId,uploadId:t.uploadId,actionElement:d||void 0,actionScreen:p,taskTrackingIdString:c}))})),N({user:E.getUser(this.store.getState()),action:e.WebUploadActionEvent.UPLOAD_ATTEMPT,chooser_type:r,upload_method:n,num_files:i.length,num_invalid_files:l.length,uploadPath:s,total_file_size:t,batchId:this.currentBatchId}),Q({eventState:"start",metadata:{total_file_size:t,item_count:i.length,is_folder:r===a.ChooserType.FOLDER||r===a.ChooserType.FILE_FOLDER,batch_id_string:this.currentBatchId,actionElement:d,actionScreen:p,task_tracking_id_string:c}})})),this.reportedFileUploadExceptions={},this.resetCreatedFolders(),this.resetFoldersWithError(),this.store=S.getStoreForUpload(),this.strings=J()}get currentBatchId(){return this._currentBatchId}_test_only_set_store(e){this.store=e}init({chooseDestination:e=!1,isContentManager:r=!1,rootNSIDForCM:s,autoTeamGroupId:i,getBrowseContext:l,handleClickNewFolder:n,uploadConsumerInterface:d}){const{handleFilesAdded:g,handleUploadProgress:m,handleFileUploaded:S,handleUploadComplete:U,handleError:f,handleBeforeUpload:I}=this._createHandlers({chooseDestination:e,autoTeamGroupId:i,getBrowseContext:l,handleClickNewFolder:n,uploadConsumerInterface:d});this.hasInit=!0,u.ActionsAdapter.on("beforeUpload",(({uploadItems:e,beforeUploadComplete:o})=>t.__awaiter(this,void 0,void 0,(function*(){const t=(e,t)=>new Promise((o=>{I(this.convertUploadItemWithUser(e,{batchId:t}),(()=>o({uploadCanceled:!1})),d,(()=>o({uploadCanceled:!0})))})),r=[];let a=0;for(;a<e.length;){if((yield t(e[a],this.currentBatchId)).uploadCanceled){const t=e.slice(a).map((e=>this.convertUploadItemWithUser(e)));this.store.dispatch(E.uploadActionCreators.setUploadsCancelling(t)),this.store.dispatch(E.uploadActionCreators.cancelUploads(t)),a=e.length}else r.push(e[a]),a++}o({items:r,errors:[]})})))),u.ActionsAdapter.on("filesAdded",(({uploadItems:e,allUploadItems:r,filesAddedComplete:s,chooseDestination:i,actionScreen:l})=>t.__awaiter(this,void 0,void 0,(function*(){this._currentBatchId=a.generateBatchId(),this.uploadMetricsReporter.setBatchId(this.currentBatchId);const d=(e,r)=>t.__awaiter(this,void 0,void 0,(function*(){yield new Promise((t=>{g(e.map((e=>this.convertUploadItemWithUser(e,{batchId:this.currentBatchId}))),t)}));const t=a.getFileUploadsWithStatus(E.getFileList(this.store.getState()),[a.FileStatusType.PENDING,a.FileStatusType.UPLOADING]).map((e=>`${e.dest}/${e.name}`)),i=r.filter((e=>t.includes(`${o.normalize(e.parentPath)}/${e.destPath}`)));s(i)}));if(i&&0!==e.length){const t=()=>{u.ActionsAdapter.emit("fileCanceled",{uploadItems:e})},o=()=>{const t=E.getPath(this.store.getState()),o=e.map((e=>Object.assign(Object.assign({},e),{parentPath:t}))),a=r.map((e=>Object.assign(Object.assign({},e),{parentPath:t})));d(o,a)};this.asyncShowChooseFolderModal(t,o,n,l)}else d(e,r)})))),u.ActionsAdapter.on("fileUploaded",(({uploadItem:e,useBatchCommit:t})=>{const o=this.convertUploadItemWithUser(e);S(o,t),Y(o.batchId||"",this.store.getState),this.onNextFileUploadComplete&&(this.onNextFileUploadComplete(),this.onNextFileUploadComplete=null)})),u.ActionsAdapter.on("uploadProgress",(({uploadItem:e})=>{m(this.convertUploadItemWithUser(e),!0)})),u.ActionsAdapter.on("error",(({uploadItem:e,errorType:t,loggingOnly:r})=>{var s;!function(e,t,o){switch(e){case a.UploadErrorType.BLOCKS_MISSING_ERROR:c.reportException({err:new Error("Blocks missing from web upload."),tags:["web_upload","blocks_missing"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.UPLOAD_BLOCK_ERROR:c.reportException({err:new Error("Server error encountered when trying to upload a block."),tags:["web_upload","upload_block_error"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.CHUNKS_NOT_ENABLED_ERROR:c.reportException({err:new Error("Chunks not enabled."),tags:["web_upload","chunks_not_enabled_error"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.SERVER_RESPONSE_ERROR:c.reportException({err:new Error("Server response error."),tags:["web_upload","server_response_error"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.HASHES_NOT_EQUAL_ERROR:c.reportException({err:new Error("Client and server hashes are not equal."),tags:["web_upload","hashes_not_equal"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.CLIENT_HASH_DIGEST_ERROR:c.reportException({err:new Error("Client hash digest error."),tags:["web_upload","client_hash_digest_error"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.FILE_READER_NULL_RESULT_ERROR:c.reportException({err:new Error("File reader null result error."),tags:["web_upload","file_reader_null_result_error"],severity:p.SEVERITY.USER_ERROR,exc_extra:{filename:t,size:o}});break;case a.UploadErrorType.COMMIT_READINESS_ERROR:c.reportException({err:new Error("Commit readiness error."),tags:["web_upload","commit_readiness_error"],severity:p.SEVERITY.CRITICAL,exc_extra:{filename:t,size:o}})}}(t,o.filename(e.destPath),e.bytes);const{batchId:i}=null!==(s=E.getUploadById(this.store.getState(),e.id))&&void 0!==s?s:{};i&&Y(i,this.store.getState);const l=u.convertUploadItem(e);if(o.logEvent(G({eventState:"failed",fileSize:l.size,fileType:a.getFileType(l),uploadId:l.uploadId,batchIdString:l.batchId})),!r){const o=this.convertUploadItemWithUser(e),r=function(e){switch(e){case a.UploadErrorType.OVER_QUOTA_ERROR:return _.intl.formatMessage({id:"fnG2Ew",defaultMessage:"This file can’t be uploaded because you are over your storage quota. If you believe this message to be in error, try refreshing the page."});case a.UploadErrorType.LOCKED_TEAM_ERROR:return _.intl.formatMessage({id:"tQ1bJN",defaultMessage:"Can’t upload. Your team no longer has full use of {trademark_business} features."},{trademark_business:h.TRADEMARK_BUSINESS});case a.UploadErrorType.FILE_SIZE_ERROR:return _.intl.formatMessage({id:"4SqdmQ",defaultMessage:"This file is too large to upload using the Dropbox website. Please use the desktop client."});case a.UploadErrorType.HTTP_ERROR:return _.intl.formatMessage({id:"eIIEty",defaultMessage:"Something went wrong while uploading this file. There was a server error during the upload request."});case a.UploadErrorType.CONNECTION_ERROR:return _.intl.formatMessage({id:"Lp9J2f",defaultMessage:"Something went wrong while uploading this file. Check your connection to the internet and try again."});case a.UploadErrorType.FOLDER_SAFARI:return _.intl.formatMessage({id:"CeMx7Q",defaultMessage:"Can’t upload folders in Safari. Upload the files separately or try another browser."});case a.UploadErrorType.BLOCKS_MISSING_ERROR:case a.UploadErrorType.CHUNKS_NOT_ENABLED_ERROR:case a.UploadErrorType.BLOCK_INDEX_ERROR:case a.UploadErrorType.BLOCK_EMPTY_ERROR:case a.UploadErrorType.BLOB_EMPTY_ERROR:case a.UploadErrorType.BLOB_MISSING_ERROR:case a.UploadErrorType.CLIENT_HASH_DIGEST_ERROR:case a.UploadErrorType.FILE_READER_NULL_RESULT_ERROR:return _.intl.formatMessage({id:"RVsdJD",defaultMessage:"Something went wrong while uploading this file."});case a.UploadErrorType.COMMIT_HTTP_ERROR:case a.UploadErrorType.UPLOAD_BLOCK_ERROR:case a.UploadErrorType.SERVER_RESPONSE_ERROR:case a.UploadErrorType.SERVER_TOKEN_EMPTY_ERROR:case a.UploadErrorType.SERVER_TOKENS_MISSING_ERROR:case a.UploadErrorType.SERVER_HASH_RESPONSE_ERROR:case a.UploadErrorType.BLOCK_RUNTIME_ID_MISSING_ERROR:case a.UploadErrorType.CLIENT_HASH_EMPTY_ERROR:case a.UploadErrorType.SERVER_HASH_EMPTY_ERROR:case a.UploadErrorType.HASHES_NOT_EQUAL_ERROR:return _.intl.formatMessage({id:"eIIEty",defaultMessage:"Something went wrong while uploading this file. There was a server error during the upload request."});default:return _.intl.formatMessage({id:"RVsdJD",defaultMessage:"Something went wrong while uploading this file."})}}(t);null==d||d.setItemRetriable(o.uploadKitDest),f(o,t,r)}})),u.ActionsAdapter.on("uploadComplete",(()=>{U()})),this.uploadMetricsReporter=this.createMetricsReporter()}createMetricsReporter(){const e=new j(E.getUser(this.store.getState()));return e.init(),e}canShowUploadModal(){return"work"===E.getUser(this.store.getState()).role}canSeeNewFolderViaUploadModal(){const e=E.getUser(this.store.getState()),t=E.getFileList(this.store.getState()),o=this.getUploadPath(),r=a.uploadContainsFolder(t,o),s=a.isMultifolderUpload(t,o),i=a.isUploadInTmf(t,e);return this.canShowUploadModal()&&!s&&r&&"work"===e.role&&e.is_cdm_member&&!i}canSeeMultiFolderPermissionsAtUploadModal(){const e=E.getUser(this.store.getState()),t=E.getFileList(this.store.getState()),o=this.getUploadPath(),r=!a.uploadContainsFolder(t,o),s=a.isMultifolderUpload(t,o),i=a.isUploadInTmf(t,e);return!E.getShouldSuppressNextPermissionAtUploadWarning(this.store.getState())&&(s||r)&&this.canShowUploadModal()&&"work"===e.role&&e.is_cdm_member&&!i}resetCreatedFolders(){this.createdFolders=[]}resetUploadSnapshots(){this.uploadSnapshots=[]}addCreatedFolder(e){this.createdFolders.includes(e)||this.createdFolders.push(e)}resetFoldersWithError(){this.foldersWithError=[]}addFolderWithError(e){this.isFolderWithError(e)||this.foldersWithError.push(e)}isFolderWithError(e){return this.foldersWithError.includes(e)}readyFilesForUpload(){const e=a.getFileUploadsWithStatus(E.getFileList(this.store.getState()),[a.FileStatusType.SET_PERMISSIONS]);this.store.dispatch(E.uploadActionCreators.readyUploads(e))}cancelStagedUploads(e){const t=a.getFileUploadsWithStatus(E.getFileList(this.store.getState()),[a.FileStatusType.SET_PERMISSIONS]);this.cancelUploads({files:t},e)}asyncShowChooseFolderModal(e,t,r,i){const l=E.getUser(this.store.getState());if(!l)return;const n=(e,t)=>{this.setPath({path:e}),void 0!==t&&this.setFolderNsId({folderNsId:t})},d=c=>{U.showFolderDialog({modalName:s.ModalName.UPLOAD,user:l,title:a.folderModalTitle,primaryActionLabel:this.strings.upload,primaryActionOnClick:()=>{i&&o.logEvent({class:"manual_upload",action:"select",object:"upload_confirm",properties:{actionScreen:i,actionElement:"modal"}})},onSuccess:(e,r)=>{n(e,r),t(),o.TeamsWebActionsLogger.log("upload_choose_dest_clk_confirm",a.getUploadLocationMetadataToLog(l,E.getPath(this.store.getState())))},onCancel:e,getFolderContents:c?o.getFolderContents:o.getFolderContentsWithCache,handleClickNewFolder:r?r(d):void 0,initialPath:c})};d()}showCdmNewFolderViaUploadModal(e,t,r,s){const i=E.getUser(this.store.getState());if(!i)return;const l=this.getUploadPath(),n=a.getFileUploadsWithStatus(E.getFileList(this.store.getState()),[a.FileStatusType.SET_PERMISSIONS]),d=n[0],c=d.chooserType,p=t(),u=l.split("/"),h=o.normalize(d.dest).split("/"),_=u.concat(h[u.length]).join("/");if(n.length){const e=T.PermissionsAtUploadStats.createCounter(T.PermissionsAtUploadAmpMetrics.PAU_FILE_UPLOAD_PROCESSED,{type:T.PermissionsAtUploadModalTypes.SINGLE});e.increment(n.length),e.record()}const g=e=>{e&&this.manuallySetInErrorState({file:d,errorType:a.UploadErrorType.PERMISSIONS_AT_UPLOAD_ERROR,errorMessage:e,startNextUploadIfAvailable:!1}),this.cancelStagedUploads(r),s&&s()},m=()=>{this.readyFilesForUpload(),this._startNextUploadIfAvailable(),s&&s()};A.asyncShowCdmNewFolderViaUploadModal((t=>{this.handleCreateFolderWithCdmNewFolderViaUploadModal(c,l,i,e,g,m,t)}),p,_,i,(()=>{this.handleCancelWithCdmNewFolderViaUploadModal(c,g)}),(()=>{o.TeamsWebActionsLogger.log(f.TeamSpaceTsdAccessVisibilityEvents.PERMISSIONS_AT_UPLOAD_MODAL_OPEN,{parent_ns_id:p.currentNSID,folder_level:o.normalize(p.currentFQPath).split("/").length,number_of_files:1}),T.PermissionsAtUploadStats.log(T.PermissionsAtUploadAmpMetrics.PAU_MODAL_DISPLAY,{type:T.PermissionsAtUploadModalTypes.SINGLE}),this.handleCdmNewFolderViaUploadModalShow(c)}))}showMultiFolderPermissionsAtUploadModal(e,t,r){const s=this.getUploadPath(),i=o.Viewer.get_viewer(),l=s?a.TeamAccessLevel.INHERIT:a.TeamAccessLevel.WRITER;this.store.dispatch(E.uploadActionCreators.addTeamLevelAccess({path:s,accessLevel:l})),A.asyncShowMultiFolderPermissionsAtUploadModal({cancelUploads:t=>{this.cancelUploads({files:t},e)},onCancel:()=>{this.cancelStagedUploads(e),t&&t()},onClose:()=>{this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!1})},onShow:e=>{if(!E.isPermissionsAtUploadModalOpen(this.store.getState())&&e.length&&(o.TeamsWebActionsLogger.log("upload_choose_audience_impression_multi",{batch_id:e[0].batchId}),T.PermissionsAtUploadStats.log(T.PermissionsAtUploadAmpMetrics.PAU_MODAL_DISPLAY,{type:T.PermissionsAtUploadModalTypes.MULTI})),r){const t=r();o.TeamsWebActionsLogger.log(f.TeamSpaceTsdAccessVisibilityEvents.PERMISSIONS_AT_UPLOAD_MODAL_OPEN,{parent_ns_id:t.currentNSID,folder_level:o.normalize(t.currentFQPath).split("/").length,number_of_files:e.length})}},onSuccess:(e=[])=>{if(r){const t=r();o.TeamsWebActionsLogger.log(f.TeamSpaceTsdAccessVisibilityEvents.PERMISSIONS_AT_UPLOAD_CLICK,{parent_ns_id:t.currentNSID,folder_level:o.normalize(t.currentFQPath).split("/").length,file_list:e.map((e=>({access:e.teamAccessLevel,type:e.file.type}))),number_of_files:e.length})}this.readyFilesForUpload(),this._startNextUploadIfAvailable(),t&&t()},teamName:i.team_name,uploadPath:s}).catch((()=>{this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!1}),t&&t()})),this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!0})}getUploadPath(){return o.normalize(E.getPath(this.store.getState()))}getTeamAccessLevel(e){const t=T.getFilePath(e);return E.getTeamAccessLevel(this.store.getState(),t)}createSharedFolder(e,o){return t.__awaiter(this,void 0,void 0,(function*(){const t=E.getUser(this.store.getState());if(!t)return;const r=this.getTeamAccessLevel(e),s=this.getUploadPath();try{const a=()=>{T.PermissionsAtUploadStats.log(T.PermissionsAtUploadAmpMetrics.PAU_SHARED_FOLDER_CREATE)};yield T.createSharedFolder({user:t,uploadPath:s,file:e,teamAccessLevel:r,createdFolders:this.createdFolders,foldersWithError:this.foldersWithError,autoTeamGroupId:o,onAttempt:a})}catch(t){const o=this.strings.serverError;this.manuallySetInErrorState({file:e,errorType:a.UploadErrorType.PERMISSIONS_AT_UPLOAD_ERROR,errorMessage:o});const r=T.getRootPath(e,s);this.addFolderWithError(r)}}))}handleUploadPrecheckSuccess(e,t,r,s,i,l){let n,d=!1,p=!1;try{n=JSON.parse(e),d=!(!n||!n.failure_details),p=!(!n||!n.error||"invalid_character"!==n.error)}catch(o){return c.reportException({err:o,tags:["web_upload"],severity:"non-critical"}),void this.manuallySetInErrorState({file:t,errorType:a.UploadErrorType.UPLOAD_PRECHECK_ERROR,errorMessage:s,extra:{type:"json-parse",errorText:o.toString(),fswData:e}})}if(p){const e=this.strings.invalidCharacterError;this.manuallySetInErrorState({file:t,errorType:a.UploadErrorType.UPLOAD_PRECHECK_INVALID_CHAR_ERROR,errorMessage:e})}else if(d){const e=this.canSeeMultiFolderPermissionsAtUploadModal(),s=this.canSeeNewFolderViaUploadModal(),l=n.failure_details.filter((t=>!E.getShouldSuppressNextPermissionAtUploadWarning(this.store.getState())&&((!e||"action_missing_parent"!==t.id||!E.getTeamAccessLevelsDefinition(this.store.getState()).hasDefinitions())&&((!s&&!e||"action_commit_to_tsd_root"!==t.id)&&!E.getConfirmedFSWs(this.store.getState()).includes(t.id)))));if(0===l.length)return void r();const d=l.map((e=>e.id));o.logFileUploadFSWReturned({uid:t.userId,file_name:t.name,upload_id:t.uploadId,filtered_fsw_ids:d.join(","),all_fsw_ids:n.failure_details.map((e=>e.id)).join(",")});const c=()=>{i&&i()},p=()=>{r(),this.store.dispatch(E.uploadActionCreators.confirmFSW({fswIds:l.map((e=>e.id)),batchId:t.batchId}))};o.TeamsWebActionsLogger.log("upload_warning_impression",Object.assign({file_type:t.chooserType},a.getFSWMetadataToLog(d)));const u=()=>{this.handleFileSystemWarningsModalFinalAccept(t.chooserType,p)},h=()=>{this.handleFileSystemWarningsModalAbortAction(t.chooserType,c)};o.showFileSystemWarningsModal({confirmText:this.strings.upload,fsws:l,onFinalAccept:u,onAbortAction:h})}else this.store.dispatch(E.uploadActionCreators.confirmFSW({fswIds:[],batchId:t.batchId})),r()}handleFileSystemWarningsModalFinalAccept(e,t){o.TeamsWebActionsLogger.log("upload_warning_clk_confirm",{file_type:e}),t()}handleFileSystemWarningsModalAbortAction(e,t){o.TeamsWebActionsLogger.log("upload_warning_clk_cancel",{file_type:e}),t()}handleCreateFolderWithCdmNewFolderViaUploadModal(e,t,r,s,i,l,{folderName:n,isConfidential:d,autoTeamGroupAccessLevel:c}){o.TeamsWebActionsLogger.log("upload_choose_audience_click",{file_type:e,audience:d?"individuals":"team"});const p=()=>{T.asyncShowDefaultPermissionAtUploadIfNeeded({user:r,files:[{type:o.FileTypes.FOLDER,teamAccessLevel:d||c!==o.ACCESS_LEVEL.OWNER&&c!==o.ACCESS_LEVEL.WRITER?a.TeamAccessLevel.NO_ACCESS:a.TeamAccessLevel.WRITER}]})};if(d){const o=()=>{this.handleShareViaUploadModalShow(e)},a=(t,o)=>{this.handleShareViaUploadShareButtonClick(e,t,o),p()},s=()=>{this.handleShareViaUploadModalCancel(e,i)},d=()=>{this.handleShareViaUploadModalClose(e,o)},c=e=>{e&&R.Notify.error(e)};document.addEventListener("modalOpened",o),F.asyncShowNewFolderShareModal({defaultBasePath:t,initialContentName:n,isNonUserRelativeContext:this.isContentManager,onCancel:s,onClose:d,onSetContentNameAndSendShareFail:c,onShareClick:a,onSuccessSharing:l,shareAsConfidential:!0,shareButtonLabelOverride:this.strings.upload,shouldCloseImmediately:!0,shouldSuppressRedirectToBrowse:!0,user:r})}else T.PermissionsAtUploadStats.log(T.PermissionsAtUploadAmpMetrics.PAU_FOLDER_ENQUEUED_ON_UPLOAD_INIT),this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!1}),c&&I.createTSDPlus1NsfFolder({user:r,pathName:t,folderName:n,autoTeamGroupAccessLevel:c,autoTeamGroupId:s,onPending:p,onComplete:l,onCancel:i})}handleShareViaUploadModalShow(e){o.TeamsWebActionsLogger.log("add_member_permission_impression",{file_type:e})}handleShareViaUploadShareButtonClick(e,t,r){T.PermissionsAtUploadStats.log(T.PermissionsAtUploadAmpMetrics.PAU_FOLDER_ENQUEUED_ON_UPLOAD_INIT),o.TeamsWebActionsLogger.log("add_member_permission_upload",{file_type:e,num_invites:t.length,permission_level:r})}handleShareViaUploadModalClose(e,t){document.removeEventListener("modalOpened",t),this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!1})}handleShareViaUploadModalCancel(e,t){o.TeamsWebActionsLogger.log("add_member_permission_cancel",{file_type:e}),t()}handleCancelWithCdmNewFolderViaUploadModal(e,t){o.TeamsWebActionsLogger.log("upload_choose_audience_cancel",{file_type:e}),this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!1}),t()}handleCdmNewFolderViaUploadModalShow(e){o.TeamsWebActionsLogger.log("upload_choose_audience_impression",{file_type:e}),this.setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:!0})}setPath({path:e,hasPermissionToUploadToFolder:t=!0,isMovingIntoVault:o=!1,targetSurface:r="none"}){e===E.getPath(this.store.getState())&&t===E.hasPermissionToUploadToFolder(this.store.getState())&&o===E.isMovingIntoVault(this.store.getState())&&r===E.getTargetSurface(this.store.getState())||this.store.dispatch(E.uploadActionCreators.setPath({path:e,hasPermissionToUploadToFolder:t,isMovingIntoVault:o,targetSurface:r}))}setFolderNsId({folderNsId:e}){this.store.dispatch(E.uploadActionCreators.setFolderNsId(e))}setUser({user:e}){u.ActionsAdapter.emit("setUser",{user:e}),this.store.dispatch(E.uploadActionCreators.setUser(e))}setNumDraggingFiles({numDraggingFiles:e,isInternalTransfer:t=!1}){this.store.dispatch(E.uploadActionCreators.setNumDraggingFiles({numDraggingFiles:e,isInternalTransfer:t}))}setDropzoneActive({isActive:e}){this.store.dispatch(E.uploadActionCreators.setDropzoneActive({isActive:e}))}setIsPermissionsAtUploadModalOpen({isPermissionsAtUploadModalOpen:e}){this.store.dispatch(E.uploadActionCreators.setIsPermissionsAtUploadModalOpen(e))}setAjaxInterceptor(e){this.ajaxInterceptor=e}setIsContentManager(e=!1){this.isContentManager=e}getFilePath({name:e,dest:t}){return""===t||"/"===t?e:`${t.slice(1)}/${e}`}cancelUploads({files:e},o){return t.__awaiter(this,void 0,void 0,(function*(){this.store.dispatch(E.uploadActionCreators.setUploadsCancelling(e)),o&&o.uploadItems.length&&(yield Promise.all(e.map((({uploadKitDest:e})=>e)).map((e=>t.__awaiter(this,void 0,void 0,(function*(){yield o.cancelUploadItem(e),o.setItemRetriable(e)})))))),this.store.dispatch(E.uploadActionCreators.cancelUploads(e)),o&&!o.isUploading&&this._startNextUploadIfAvailable()}))}retryUploads({files:e},t){e.forEach((e=>{t.retryUpload(e.uploadKitDest)})),this.store.dispatch(E.uploadActionCreators.resetUploadProgress(e))}manuallySetInErrorState({file:t,errorType:r,errorMessage:s,extra:l,startNextUploadIfAvailable:n=!0}){this.store.dispatch(E.uploadActionCreators.handleUploadError({uploadId:t.uploadId,errorType:r,errorMessage:s}));const d=E.getUploadById(this.store.getState(),t.uploadId),c=E.getTargetSurface(this.store.getState()),p="none"===c?i.UploadMethod.CHOOSER:i.UploadMethod.DRAG;N({user:E.getUser(this.store.getState()),action:e.WebUploadActionEvent.UPLOAD_FAILURE,upload:d,errorType:r,extra:Object.assign(Object.assign({},l),{targetSurface:c}),upload_method:p}),o.logEvent(G({eventState:"failed",fileSize:t.size,fileType:a.getFileType(t),batchIdString:t.batchId,uploadId:t.uploadId,fileSystemWarning:null==l?void 0:l.fswData})),n&&this._startNextUploadIfAvailable()}_startUpload({file:e}){return this.store.dispatch(E.uploadActionCreators.startUpload({file:e})),!0}cancelPendingFileUploads(e){const t=a.getFileUploadsWithStatus(E.getFileList(this.store.getState()),[a.FileStatusType.SET_PERMISSIONS,a.FileStatusType.PENDING,a.FileStatusType.UPLOADING]);this.cancelUploads({files:t},e),this.store.dispatch(E.uploadActionCreators.resetTeamAccessLevel())}handleUploadButtonClick({folderUpload:t,uploadConsumerInterface:s,actionElement:l,actionScreen:n,source:d,onNextFileUploadComplete:c}){const p=E.getUser(this.store.getState()),u=E.getPath(this.store.getState()),h=a.generateTaskTrackingId();this.store.dispatch(E.uploadActionCreators.setLastFileUploadMethod("upm"));const _=E.getOverQuotaStatus(this.store.getState());if(_!==a.OverQuotaStatusType.NONE&&_!==a.OverQuotaStatusType.BASIC_NEAR_QUOTA){let t={};return o.Viewer.get_viewer().team_is_locked&&(t={forceLocked:!0,context:e.UploaderOverQuotaModalContexts.LOCKED_TEAM_CLICK_BUTTON}),void this.store.dispatch(E.uploadActionCreators.setUploadModalType(Object.assign({type:"OVER_QUOTA_MODAL"},t)))}U.prewarmFolderDialog(),c&&(this.onNextFileUploadComplete=c),t?(this.chooseFolder(s,l,h),N({user:p,action:o.WebUserActionLogEvent.UPLOAD_FOLDER_CLICK,chooser_type:a.ChooserType.FOLDER,upload_method:i.UploadMethod.CHOOSER,taskTrackingId:h,source:d}),o.TeamsWebActionsLogger.log("upload_folder_clk",a.getUploadLocationMetadataToLog(p,u)),o.logEvent(r.PAP_Select_UploadFolder({actionScreen:n||void 0,actionElement:i.UploadElement.ACTION_BAR,taskTrackingIdString:h}))):(this.chooseFiles(s,l,h),N({user:p,action:o.WebUserActionLogEvent.UPLOAD_FILES_CLICK,chooser_type:a.ChooserType.FILE,upload_method:i.UploadMethod.CHOOSER,taskTrackingId:h,source:d}),o.TeamsWebActionsLogger.log("upload_file_clk",a.getUploadLocationMetadataToLog(p,u)),o.logEvent(r.PAP_Select_UploadFile({actionScreen:n||void 0,actionElement:i.UploadElement.ACTION_BAR,taskTrackingIdString:h})))}_startNextUploadIfAvailable(){if(E.isPermissionsAtUploadModalOpen(this.store.getState()))return;const e=E.getNextUpload(this.store.getState());null!=e&&(C.assert(e instanceof a.FileUpload,"the nextUpload is not of type FileUpload"),this._startUpload({file:e}))}calculateBytesPerSecond(e,t){var o;return this.uploadSnapshots=$(e,t,Date.now(),this.uploadSnapshots),null===(o=this.uploadSnapshots[this.uploadSnapshots.length-1])||void 0===o?void 0:o.bytesPerSecond}};var Z=Object.freeze({__proto__:null,updateUploadSnapshots:$,UploaderActions:X});e.PAP_Upload_File=G,e.UploaderActions=X,e.actions_esnext=Z,e.logUploadAction=N,e.reportBatchEndStateIfDone=Y,e.setMethodForFileUpload=(e,t)=>{w[e]=t}}));
//# sourceMappingURL=c_file_uploader_clean_actions.js-vfl4EYuBa.map
