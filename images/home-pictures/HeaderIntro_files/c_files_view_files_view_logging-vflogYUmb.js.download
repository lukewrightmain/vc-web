define(["require","exports","./c_tslib","./e_ui_page_files_router","./c_files_view_file_actions_file_from_metadata","./c_file_actions_strings","./c_src_sink_index","./c_action_bar_file_actions_logging","./c_files_view_file_actions_snackbars","./c_core_i18n","./c_lodash-es_lodash"],(function(e,t,s,n,r,o,a,i,l,c,_){"use strict";const u=({state:e,eventName:t,num_files_selected:s,num_folders_selected:r,batch_success_count:o,batch_fail_count:a,lookup_error_type:i,error_summary:l})=>{n.logFileAction({uid:n.user$1(e).id,action:t,num_files_selected:s,num_folders_selected:r,view_type:n.selectViewType(e,{instanceId:n.SEARCH_FILES_VIEW_ID}),batch_success_count:o,batch_fail_count:a,lookup_error_type:i,error_summary:l})},d=(e,t,s)=>_.compact(s.toArray().map((s=>{if(n.isFile(s)&&t.includes(s.fq_path))return new n.File(Object.assign(Object.assign({},s),{isDeleted:e,thumbnail_url_tmpl:e?null:s.thumbnail_url_tmpl}))})));const f=({files:e,checkFSWs:t})=>function(_,m){return s.__awaiter(this,void 0,void 0,(function*(){const g=n.user$1(m()),h=n.context$1(m());yield function({files:e,user:t,context:r}){return s.__awaiter(this,void 0,void 0,(function*(){return new Promise((s=>{n.showDelete(t,e,r,"/",s)}))}))}({user:g,files:e,context:h});const S=a.getMetricsReporter$1(),b={surface:"search",batchSizeBucket:r.bucketForBatchSize(e.length),contentType:r.batchContentType(e)},E=S.createTimer({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"delete/batch/latency_total_ms"},b),p=Date.now(),w=S.createStats({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"delete/batch/latency_average_ms"},b),v=S.createStats({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"delete/batch/completed"},b);n.Snackbar.sync(c.intl.formatMessage(o.deleteSnackbarProgressMessage,{count:e.length}),!0,"browse-action"),u({state:m(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_ATTEMPT,num_files_selected:e.length,num_folders_selected:0});const F=yield n.deleteFiles(e,g.id,t);if(F.isError&&"path"===F.error[".tag"]&&"file_system_warnings"===F.error.path[".tag"])return void _((({files:e,details:t})=>(r,a)=>s.__awaiter(void 0,void 0,void 0,(function*(){n.Snackbar.close("browse-action"),n.showFileSystemWarningsModal({fsws:t,onFinalAccept:()=>{r(f({files:e,checkFSWs:!1}))},confirmText:c.intl.formatMessage(o.deleteFswConfirmText)})})))({files:e,details:F.error.path.details}));if(E.record(),w.record((Date.now()-p)/e.length),F.isError)return _((({files:e,result:t})=>(r,o)=>s.__awaiter(void 0,void 0,void 0,(function*(){n.Snackbar.fail(l.deleteError(e.length,t.error),"browse-action");const s=n.selectedFiles$1(o()),{num_files_selected:r,num_folders_selected:a}=n.countFilesAndFolders(s);u({state:o(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_FAIL,num_files_selected:r,num_folders_selected:a,batch_success_count:0,batch_fail_count:e.length,error_summary:t.error_summary})})))({files:e,result:F})),void v.record(0);const A=F.result.entries.filter((e=>"success"===e[".tag"])),k=A.map((e=>e.metadata.path_display));_(n.updateResults({results:d(!0,k,n.results(m()))}));const M=()=>s.__awaiter(this,void 0,void 0,(function*(){n.Snackbar.close("browse-action"),u({state:m(),eventName:n.WebUserActionLogEvent.DELETE_UNDO,num_files_selected:F.result.changeset_data.length,num_folders_selected:0}),i.rollback({changeset_data:F.result.changeset_data,userId:g.id,onSuccess:()=>{n.Snackbar.complete(c.intl.formatMessage(o.deleteUndoSnackbarMessage),"browse-action"),u({state:m(),eventName:n.WebUserActionLogEvent.DELETE_UNDO_REQUEST_SUCCESS,num_files_selected:F.result.changeset_data.length,num_folders_selected:0}),_(n.updateResults({results:d(!1,k,n.results(m()))}))}})}));n.setHandleUndo(M);const y=F.result.entries.filter(n.isFailure),T=y[0];let P,L;if(void 0!==T){const e=T.failure;P=e[".tag"],n.isPathLookupFailure(e)&&(L=e.path_lookup[".tag"])}const N=F.result.entries.filter((e=>n.isFailure(e)&&!n.isPathLookupFailure(e.failure))).length;v.record(N>0?0:1),r.recordPathLookupErrors(y,"delete",b),y.length===F.result.entries.length?(n.Snackbar.fail(l.deleteCompleteError(y),"browse-action"),u({state:m(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_FAIL,num_files_selected:F.result.changeset_data.length,num_folders_selected:0,batch_success_count:F.result.entries.length-y.length,batch_fail_count:y.length,lookup_error_type:L,error_summary:P})):(n.Snackbar.completeWithUndo(l.deleteCompleteSuccess(e.length,A.length),M,"browse-action"),u({state:m(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_SUCCESS,num_files_selected:F.result.changeset_data.length,num_folders_selected:0,batch_success_count:F.result.entries.length,batch_fail_count:0,lookup_error_type:L,error_summary:P}))}))},m=({file:e,name:t,checkFSWs:i})=>function(_,u){return s.__awaiter(this,void 0,void 0,(function*(){const d=n.user$1(u()),f=a.getMetricsReporter$1(),g={surface:"browse",contentType:e.is_dir?"folders":"files"},h={latency:f.createTimer({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"rename/latency_ms"},g),completed:f.createStats({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"rename/completed"},g)};if(-1!==t.indexOf("/"))return n.Snackbar.fail(c.intl.formatMessage(o.renameErrorInvalidName),"browse-action"),void _(n.setFileRename({file:e,renameState:null}));_(n.setFileRename({file:e,renameState:n.RenameState.SAVING_INPUT})),n.Snackbar.sync(c.intl.formatMessage(o.renameSnackbarProgressMessage),!1,"browse-action");const S=yield n.renameFile(e.fq_path,t,d.id,{checkFSWs:i});if(S.isError&&"to"===S.error[".tag"]&&"file_system_warnings"===S.error.to[".tag"])return void _((({file:e,name:t,details:r})=>a=>s.__awaiter(void 0,void 0,void 0,(function*(){n.Snackbar.close("browse-action"),n.showFileSystemWarningsModal({fsws:r,onFinalAccept:()=>{a(m({file:e,name:t,checkFSWs:!1}))},onAbortAction:()=>{a(n.setFileRename({file:e,renameState:null}))},confirmText:c.intl.formatMessage(o.renameFswConfirmText)})})))({file:e,name:t,details:S.error.to.details}));if(h.latency.record(),S.isError||"success"!==S.result.entries[0][".tag"]){const t=S.isError?S:n.createUndefinedRpcResult();return _((({file:e,result:t})=>(r,o)=>s.__awaiter(void 0,void 0,void 0,(function*(){r(n.setFileRename({file:e,renameState:null})),n.Snackbar.fail(l.renameError(t.error,e.fq_path),"browse-action")})))({file:e,result:t})),void h.completed.record(0)}const b=S.result.entries[0],E=r.fileFromMetadata(e,b.success);_(n.updateResults({results:[E]})),_(n.setSelection({selection:new n.Selection({selected:n.immutable.exports.OrderedSet([E.fq_path]),anchor:null}),skipLogging:!0})),_(n.fileRename$1({file:e,newFile:E})),_(n.setFileRename({file:e,renameState:null})),h.completed.record(1);const p=()=>{_((({file:e,result:t})=>(i,l)=>s.__awaiter(void 0,void 0,void 0,(function*(){const s=n.user$1(l()),_=a.getMetricsReporter$1(),u={surface:"search",contentType:e.is_dir?"folders":"files",batchSizeBucket:"single"},d={latency:_.createTimer({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"undo/latency_ms"},u),completed:_.createStats({ns:r.FILE_ACTIONS_AMP_NAMESPACE,name:"undo/completed"},u)};n.Snackbar.sync(c.intl.formatMessage(o.renameUndoSnackbarProgressMessage),!1,"browse-action"),(yield n.undo(t.result.changeset_data,s)).isError?(n.Snackbar.fail(c.intl.formatMessage(o.renameUndoSnackbarErrorMessage),"browse-action"),d.completed.record(0)):(n.Snackbar.complete(c.intl.formatMessage(o.renameUndoSnackbarSuccessMessage),"browse-action"),i(n.updateResults({results:[e]})),i(n.setSelection({selection:new n.Selection({selected:n.immutable.exports.OrderedSet([e.fq_path]),anchor:null}),skipLogging:!0})),d.completed.record(1)),d.latency.record()})))({file:e,result:S}))};n.setHandleUndo(p),n.Snackbar.completeWithUndo(c.intl.formatMessage(o.renameSnackbarSuccessMessage),p,"browse-action")}))};t.deleteFiles=f,t.logEvent=({user:t,action:n,extra:r})=>s.__awaiter(void 0,void 0,void 0,(function*(){(yield new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.action_logger_esnext}))).logWebUserAction({user_id:t.id,event_name:n,extra:r})})),t.logEventWithNumberOfFiles=t=>{const{isSearchMode:s,file:r,extra:o,action:a,action_source:i,action_surface:l,user:c}=t;if(s){const t=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.logger_esnext})),s=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.index_esnext})),c=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.store_esnext$1}));Promise.all([t,s,c]).then((([e,t,s])=>{const c=s.getStoreForSearch().getState(),_=t.selectedFiles(c),{num_files_selected:u,num_folders_selected:d}=n.countFilesAndFolders(_),f=Object.assign(Object.assign({},o),{num_files_selected:u.toString(),num_folders_selected:d.toString()});e.logResultAction(a,t.resultsList(c),r,l,i,f)}))}else{const t=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.action_logger_esnext})),s=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.store_esnext$2})),_=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.Selectors}));Promise.all([t,s,_]).then((([{logBrowseAction:e},{getStoreForBrowse:t},s])=>{const _=s.selectedFiles(t().getState()),{num_files_selected:u,num_folders_selected:d}=n.countFilesAndFolders(_);e({uid:c.id,action:a,result:r,num_files_selected:u,num_folders_selected:d,action_surface:l,action_source:i,extra:o})}))}},t.renameFile=m}));
//# sourceMappingURL=c_files_view_files_view_logging.js-vflGc_CG0.map
