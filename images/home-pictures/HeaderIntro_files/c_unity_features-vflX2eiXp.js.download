define(["exports","./e_ui_page_files_router","metaserver/static/js/modules/constants/unity","./c_core_uri","./c_core_browser_detection","./c_lodash-es_lodash","./c_core_i18n","./c_core_notify","./e_edison","./c_tslib","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_api_v2_noauth_client","./c_browser_cookies","./c_src_sink_index","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","./c_csrf","./c_core_xhr","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/core/langpack"],(function(e,t,s,_,n,i,r,a,o,c,h,l,u,d,E,p,N,S,I,f,g,m,O,R,k,v,w,C,b,y,T,U,P,D,L,M,H,B){"use strict";function W(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var _=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,_.get?_:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var A,j,Y=W(s);!function(e){e.CONNECTION_TIMEOUT="connection_timeout",e.CONNECTION_CLOSED="connection_closed",e.COULD_NOT_SEND="could_not_send",e.UNEXPECTED_ERROR="unexpected_error"}(A||(A={})),function(e){e[e.LATEST=16]="LATEST",e[e.INITIAL_UNITY=1]="INITIAL_UNITY",e[e.UNITY_HANDSHAKE=2]="UNITY_HANDSHAKE",e[e.REUNITY=3]="REUNITY",e[e.OPEN_IN_FILE_BROWSER=4]="OPEN_IN_FILE_BROWSER",e[e.CHECK_FILE_RETURNS_OBJ=5]="CHECK_FILE_RETURNS_OBJ",e[e.PERMISSION_LEVELS=6]="PERMISSION_LEVELS",e[e.WEB_DESTINY=7]="WEB_DESTINY",e[e.WEB_DESTINY_V2=8]="WEB_DESTINY_V2",e[e.PORT_CHECK=9]="PORT_CHECK",e[e.CHIME_OPEN=10]="CHIME_OPEN",e[e.GROWTH_DEEP_LINK=15]="GROWTH_DEEP_LINK",e[e.OPEN_COLLAB_BROWSE=16]="OPEN_COLLAB_BROWSE"}(j||(j={}));var K=j;class G{constructor(){this._data={logging_source:"web",web_unity_version:K.LATEST}}update(e){return this._data=Object.assign(Object.assign({},this._data),e),this._data}report_event(e,s={}){if(this._data.event_name=e,this._data.local_ts=(new Date).getTime()/1e3,this._data.extra=JSON.stringify(Object.assign(Object.assign({},s),{user_id:s.user_id||t.getActiveUserId()})),t.SilentBackgroundRequest$1({url:new _.URI({path:"/unity_connection_log"}),data:this._data}),Y.UNITY_WEB_DEBUG)return console.log(this._data)}get_log_data_for_client(){return{web_unity_version:this._data.web_unity_version,user_agent:window.navigator.userAgent}}unity_session_id(){return this._data.unity_session_id}}const x={canUnityConnect:()=>x.canBrowserSupportNonSecureWebsocket(),canBrowserSupportNonSecureWebsocket(){const e=parseInt(n.version,10);return!!(n.safari&&e<9)||(!!(n.mozilla&&e>=55)||(!!(n.chrome&&e>=53)||!!n.edgeChromium()))}},V={create(e){const t=new G;return x.canUnityConnect()&&t.report_event("using_default_web_socket"),new WebSocket(e)},web_sockets_supported:()=>x.canUnityConnect()};var F,$,J;!function(e){e.CONNECTION_OPENED="CONNECTION_OPENED",e.VERSION_CHECK="VERSION_CHECK",e.FETCHING_NONCE="FETCHING_NONCE",e.NONCE_RETURNED_TO_CLIENT="NONCE_RETURNED_TO_CLIENT",e.HANDSHAKE_COMPLETED="HANDSHAKE_COMPLETED"}(F||(F={})),function(e){e.PENDING="PENDING",e.ESTABLISHED="ESTABLISHED",e.CLOSED="CLOSED",e.RETRYING="RETRYING"}($||($={})),function(e){e.SECURE_PERMISSION="secure",e.INSECURE_WEB_PERMISSION="insecure_web",e.INSECURE_CLIENT_PERMISSION="insecure_client",e.INSECURE_PERMISSION="insecure"}(J||(J={}));class q{constructor(){this.client_version=null,this.logger=new G,this._on_open_callbacks=[],this._on_open_failed_callbacks=[],this._on_close_callbacks=[],this._pending_callbacks=[],this._response_callbacks={},this._webSocket=null,this._port=null,this._active_ports={},this._connection_state=$.PENDING,this._current_message_id=1,this._permission_level=null,this._on_close=e=>t=>{[1e3,1001,1005,1006].includes(t.code)||this.logger.report_event("unity_failure",{message:`WebSocket closed. Code: ${t.code}. Reason: ${t.reason}`,port:e}),this._close_port(e)},this._on_error=e=>t=>{this.logger.report_event("unity_failure",{message:"WebSocket unknown error",port:e}),this._close_port(e)},this._set_connection_state=e=>{if(e===this._connection_state)return;const t=this._connection_state;if(_.assert(t!==$.CLOSED,"Shouldn't unclose a closed connection."),this._connection_state=e,e===$.ESTABLISHED){_.assert(this._is_connection_in_progress(t),"Can only establish from pending or retrying."),this.logger.report_event("handshake_complete"),t===$.PENDING&&this._on_open_callbacks.forEach((e=>e()));const e=[];for(;this._pending_callbacks.length;){const{callback:t,error_callback:s}=this._pending_callbacks.pop();this.is_ready()?e.push(t()):e.push("function"==typeof s?s(A.UNEXPECTED_ERROR):void 0)}return e}if(e!==$.RETRYING){if(e===$.CLOSED){t===$.PENDING?(this.logger.report_event("connection_not_established"),this._on_open_failed_callbacks.forEach((e=>e()))):t===$.RETRYING?(this.logger.report_event("connection_terminated"),this._on_close_callbacks.forEach((e=>e()))):_.assert(!1,"CONNECTION_CLOSED can only be set from PENDING or RETRYING");const e=[];for(;this._pending_callbacks.length;){const{error_callback:t}=this._pending_callbacks.pop();e.push("function"==typeof t?t(A.CONNECTION_CLOSED):void 0)}return e}return _.assert(!1,"Changing connection_state to CONNECTION_PENDING not supported.")}},this._on_message=e=>t=>{const s=JSON.parse(t.data);if(s.func&&s.header&&s.header.message_id&&void 0!==s.header.should_respond)if(s.header.log_data&&this.logger.update(s.header.log_data),this.logger.update({port:e.port}),"response"===s.func)this._on_response(s.header.message_id,s.data);else{const t=this._routes[s.func];if(null==t)return void this._terminate_handshake(e.ws,"Unknown function.",{function:s.func});const _=this.is_ready()?t(s.data):t(e,s.data);s.header&&s.header.should_respond&&this.send("response",_,null,null,s.header.message_id)}else this._terminate_handshake(e.ws,"Malformed message from client.",{message:t.data})},this._on_response_timeout=e=>()=>{const{error_callback:t}=this._response_callbacks[e];delete this._response_callbacks[e],t&&t(A.CONNECTION_TIMEOUT)},this._check_unity_version=(e,t)=>{if(e.state!==F.CONNECTION_OPENED)return void this._terminate_handshake(e.ws,"Handshake version check at wrong time of protocol.");if(e.state=F.VERSION_CHECK,e.client_version=t.client_version,t.client_version<K.UNITY_HANDSHAKE)return void this._terminate_handshake(e.ws,"Client version is too old.");const s=this._web_has_auth();if(!(t.client_version<K.PERMISSION_LEVELS)||s)return this.logger.report_event("handshake_version_check"),t.client_version>=K.PERMISSION_LEVELS?this._send_with_ws(e.ws,"initiate_handshake",{secure_web:s}):this._send_with_ws(e.ws,"initiate_handshake");this._terminate_handshake(e.ws,"Client version is too old to support insecure web connections.")},this._fetch_unity_nonce=(e,t)=>{e.state===F.VERSION_CHECK?(e.state=F.FETCHING_NONCE,this.logger.report_event("handshake_fetch_nonce"),this._retrieve_unity_nonce(e,t.nonce_key)):this._terminate_handshake(e.ws,"Fetch Unity nonce at wrong time of protocol.")},this._complete_handshake=(e,t)=>{if(e.state===F.NONCE_RETURNED_TO_CLIENT&&t.is_success)if(e.state=F.HANDSHAKE_COMPLETED,this._connection_state===$.CLOSED)this._terminate_handshake(e.ws,"No more handshakes are allowed to complete.");else if(null!=this._webSocket){const t="Only one Unity handshake can succeed! There's likely a MITM attack, so close all connections.";this._terminate_handshake(e.ws,t),this._terminate_handshake(this._webSocket,t),this.client_version=null,this._webSocket=null,this._port=null,this._set_connection_state($.CLOSED)}else this.client_version=e.client_version,this._webSocket=e.ws,this._port=e.port,this._set_connection_state($.ESTABLISHED);else this._terminate_handshake(e.ws,"Unable to complete handshake.")},this._routes={check_unity_version:this._check_unity_version,fetch_unity_nonce:this._fetch_unity_nonce,complete_handshake:this._complete_handshake}}start(){x.canUnityConnect()?this._attempt_handshake():(this._set_connection_state($.CLOSED),this.logger.report_event("unity_failure",{message:"WebSocket creation failed. Not able to create web socket."}))}_getWebSocketURI(e){const t={scheme:"ws",authority:`127.0.0.1:${e.toString()}`,path:"/ws"};return new _.URI(t).toString()}_attempt_handshake(){for(let e=17600;e<=17602;e++)try{this._active_ports[e]=!0;const t=V.create(this._getWebSocketURI(e));t.onmessage=this._on_message({ws:t,port:e,state:F.CONNECTION_OPENED,client_version:null,client_has_auth:null}),t.onclose=this._on_close(e),t.onerror=this._on_error(e)}catch(t){this.logger.report_event("unity_failure",{message:`WebSocket creation failed. Message: ${t.message}`,error_name:t.name,port:e}),this._set_connection_state($.CLOSED)}this.logger.report_event("handshake_started")}_close_port(e){if(e in this._active_ports&&(delete this._active_ports[e],i.isEmpty(this._active_ports)))return this._connection_state===$.ESTABLISHED?this._retry_connection():this._set_connection_state($.CLOSED)}_retry_connection(){return this.logger.report_event("connection_retrying"),this._set_connection_state($.RETRYING),this.client_version=this._webSocket=this._port=null,this._attempt_handshake()}send(e,t=null,s=null,_=null,n=null){if(this._webSocket)return this._send_with_ws(this._webSocket,e,t,s,_,n)}_send_with_ws(e,t,s=null,n=null,i=null,r=null){if(null==r&&(r=this._current_message_id,_.assert(this._current_message_id%2==1,"Web-initiated message_ids should remain odd"),this._current_message_id+=2),null!==n){const e=window.setTimeout(this._on_response_timeout(r),5e3);this._response_callbacks[r]={response_callback:n,error_callback:i,timeout_id:e}}const a={func:t,header:{message_id:r,should_respond:null!==n,log_data:this.logger.get_log_data_for_client()}};null!=s&&(a.data=s);try{return e.send(JSON.stringify(a))}catch(e){this.logger.report_event("unity_failure",{message:`WebSocket send failed. Message: ${e.message}`,error_name:e.name}),i&&i(A.COULD_NOT_SEND)}}_on_response(e,t){if(e in this._response_callbacks){const{response_callback:s,timeout_id:_}=this._response_callbacks[e];delete this._response_callbacks[e],window.clearTimeout(_),s&&s(t)}}_web_has_auth(){return t.Viewer.get_viewer().is_signed_in}_retrieve_unity_nonce(e,s){return t.WebRequest$2({url:new _.URI({path:"/retrieve_unity_nonce"}),dataType:"json",data:{nonce_key:s},success:t=>{switch(t.status){case"OK":if(e.state=F.NONCE_RETURNED_TO_CLIENT,(null===e.client_version||e.client_version>=K.PORT_CHECK)&&(_.assert(t.message.client_port,`Port check must happen in version ${e.client_version}`),t.message.client_port!==e.port))return void this._terminate_handshake(e.ws,"Mismatched ports.",{client_port:t.message.client_port,web_port:e.port});e.client_has_auth=t.message.client_has_auth;const s=this._web_has_auth();return e.client_has_auth&&s?this._permission_level=q.SECURE_PERMISSION:(_.assert(null===e.client_version||e.client_version>=K.PERMISSION_LEVELS,`Insecure connections only supported by client_version >= ${K.PERMISSION_LEVELS}.`),this._permission_level=e.client_has_auth?q.INSECURE_WEB_PERMISSION:s?q.INSECURE_CLIENT_PERMISSION:q.INSECURE_PERMISSION),this.logger.update({unity_permission_level:this._permission_level}),this.logger.report_event("handshake_nonce_sent_to_unity_server"),this._send_with_ws(e.ws,"verify_unity_nonce",{nonce:t.message.nonce});case"MISMATCHED_USER_IDS":return this._terminate_handshake(e.ws,"Mismatched user_ids.",{client_user_ids:t.message.client_user_ids,web_user_ids:t.message.web_user_ids});case"INVALID":return this._terminate_handshake(e.ws,"Could not find nonce with given nonce_key.");case"AUTH_REQUIRED":return this._terminate_handshake(e.ws,"Did not have the necessary authentication to retrieve nonce.");case"LOCAL_INFORMATION_PERMISSION_REQUIRED":return this._terminate_handshake(e.ws,"Did not have permission to start a local-information-allowed connection.")}},error:(t,s,_)=>{this._terminate_handshake(e.ws,"Unable to retrieve nonce from server",{status:s,error_string:_})}})}_terminate_handshake(e,t,s={}){const _=Object.assign({message:t},s);Y.UNITY_WEB_DEBUG&&console.error(_),this.logger.report_event("unity_failure",_),e&&e.close()}_is_connection_in_progress(e){return e===$.PENDING||e===$.RETRYING}add_on_open_callback(e){this._on_open_callbacks.push(e)}add_on_open_failed_callback(e){this._on_open_failed_callbacks.push(e)}add_on_close_callback(e){this._on_close_callbacks.push(e)}call_when_ready(e,t=null){return this.is_ready()?e():this._is_connection_in_progress(this._connection_state)?this._pending_callbacks.push({callback:e,error_callback:t}):t?t(A.CONNECTION_CLOSED):void 0}is_ready(){return this._webSocket&&this._webSocket.readyState===WebSocket.OPEN&&this._connection_state===$.ESTABLISHED}feature_supported(e,t=[]){return _.assert(null!==this._permission_level,"Connection is not ready."),!(null!==this.client_version&&this.client_version<e)&&t.includes(this._permission_level)}isUnityServerRunning(e){return new Promise((t=>{setTimeout((()=>t(!1)),e);for(let e=17600;e<=17602;e++){const s=new WebSocket(this._getWebSocketURI(e));s.onopen=function(){s.close(),t(!0)}}}))}}q.SECURE_PERMISSION=J.SECURE_PERMISSION,q.INSECURE_WEB_PERMISSION=J.INSECURE_WEB_PERMISSION,q.INSECURE_CLIENT_PERMISSION=J.INSECURE_CLIENT_PERMISSION,q.INSECURE_PERMISSION=J.INSECURE_PERMISSION;const z=()=>V.web_sockets_supported(),Q={_uc:new q,_has_handshake_started:!1,_cached_file_browser_display_name:null,_start_handshake_if_needed(){this._has_handshake_started||(this._uc.start(),this._has_handshake_started=!0)},continue_as_user(e,t,s,_=null){return this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.WEB_DESTINY,[q.INSECURE_WEB_PERMISSION]))return this._uc.logger.report_event("continue_as_user",{browser:e,refresh_token:t}),this._uc.send("continue_as_user",{browser:e,refresh_token:t},s,_)}),_)},continue_as_user_direct(e,t=null){return this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.WEB_DESTINY_V2,[q.INSECURE_WEB_PERMISSION]))return this._uc.logger.report_event("continue_as_user_direct"),this._uc.send("continue_as_user_direct",null,e,t)}),t)},web_destiny_info(e,t=null){return this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.WEB_DESTINY_V2,[q.INSECURE_WEB_PERMISSION]))return this._uc.logger.report_event("web_destiny_info"),this._uc.send("web_destiny_info",null,e,t)}),t)},client_supports_open_in_file_browser(){return this._uc.feature_supported(K.OPEN_IN_FILE_BROWSER,[q.SECURE_PERMISSION])},ensure_unity_ready(){return this._start_handshake_if_needed(),new Promise((e=>this._uc.call_when_ready((()=>{e(!0)}),(()=>{this._uc=new q,this._has_handshake_started=!1,e(!1)}))))},open_file(e,s,n,i,r=null,a=!1){this._start_handshake_if_needed();const o=this.server_path(e,s);return this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.UNITY_HANDSHAKE,[q.SECURE_PERMISSION])){this._uc.logger.report_event("open_file",{user_id:n,path_id:o,file_extension:t.file_extension(o),in_file_browser:a}),t.SilentBackgroundRequest$1({url:new _.URI({path:"/unity_open_log"}),data:{user_id:n,server_path:o,file_extension:t.file_extension(o),in_file_browser:a,unity_session_id:this._uc.logger.unity_session_id(),buildno:this._uc.logger._data.buildno,host_id:this._uc.logger._data.host_id}});const e={server_path:o,user_id:n};this._uc.client_version>=K.OPEN_IN_FILE_BROWSER?e.in_file_browser=a:_.assert(!a,"The connected client doesn't support opening in file browser."),this._uc.send("open_file",e,i,r)}}),r)},standard_open_file_handler(e){if(!e)return a.Notify.error(r.intl.formatMessage({id:"9HWjA9",defaultMessage:"Error opening file"}))},check_file(e,s,_,n,i=null){this._start_handshake_if_needed();const r=this.server_path(e,s),a=e=>{this._check_file_deprecated_on_client()&&(e={is_locally_available:e}),n(e)};this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.UNITY_HANDSHAKE,[q.SECURE_PERMISSION]))return this._uc.logger.report_event("check_file",{user_id:_,path_id:r,file_extension:t.file_extension(r)}),this._uc.send("check_file",{server_path:r,user_id:_},a,i)}),i)},add_on_ready_callback(e){return this._uc.call_when_ready(e)},check_file_batch(e,s,_,n=null){return new Promise(((i,r)=>{this._start_handshake_if_needed();const a=e.map((e=>this.server_path(e.ns_id,e.ns_path))),o=e=>{if(this._check_file_deprecated_on_client())for(const t in e){const s=e[t];e[t]={is_locally_available:s}}_&&_(e),i(e)},c=function(e){n&&n(e),r(e)};this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.UNITY_HANDSHAKE,[q.SECURE_PERMISSION]))return this._uc.logger.report_event("check_file_batch",{user_id:s,path_ids:a,file_extensions:a.map(t.file_extension)}),this._uc.send("check_file_batch",{server_paths:a,user_id:s},o,c)}),c)}))},file_browser_display_name(e,t=null){if(null!=this._cached_file_browser_display_name)return void e(this._cached_file_browser_display_name);const s=t=>(this._cached_file_browser_display_name=t,e(t));this._start_handshake_if_needed();return this._uc.call_when_ready((()=>this._uc.feature_supported(K.CHECK_FILE_RETURNS_OBJ,[q.SECURE_PERMISSION])?(this._uc.logger.report_event("file_browser_display_name"),this._uc.send("file_browser_display_name",null,s,t)):e(null)),t)},_check_file_deprecated_on_client(){return K.UNITY_HANDSHAKE<=this._uc.client_version&&this._uc.client_version<K.CHECK_FILE_RETURNS_OBJ},server_path:(e,t)=>`${e}:${t}`,has_chime(e,t=null){this._start_handshake_if_needed();return this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.CHIME_OPEN,[q.SECURE_PERMISSION]))return this._uc.logger.report_event("has_chime"),this._uc.send("has_chime",null,e,t)}),t)},open_chime(e,t,s=null){this._start_handshake_if_needed();return this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.CHIME_OPEN,[q.SECURE_PERMISSION]))return this._uc.logger.report_event("open_chime",{parameters:e}),this._uc.send("open_chime",e,t,s)}),s)},growth_deep_link(e,t={}){return new Promise(((s,_)=>{this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(K.GROWTH_DEEP_LINK,[q.SECURE_PERMISSION]))return this._uc.logger.report_event("growth_deep_link"),this._uc.send("growth_deep_link",{resource:e,data:t},s,_);_("featured_unsupported")}),_)}))},can_open_apollo(){return new Promise(((e,t)=>(this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{this._uc.feature_supported(K.OPEN_COLLAB_BROWSE,[q.SECURE_PERMISSION,q.INSECURE_WEB_PERMISSION])&&this._uc.send("can_open_apollo",{},e,t)}),t))))},open_apollo_main_window(){return new Promise(((e,t)=>(this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{this._uc.feature_supported(K.OPEN_COLLAB_BROWSE,[q.SECURE_PERMISSION,q.INSECURE_WEB_PERMISSION])&&this._uc.send("open_apollo_main_window",{},e,t)}),t))))},isUnityServerRunning(){return this._uc.isUnityServerRunning(200)},isUnitySupported:()=>z()},X=z()?Q:void 0;e.UnityFeatures=Q,e.default=X}));
//# sourceMappingURL=c_unity_features.js-vflFcJQvW.map
