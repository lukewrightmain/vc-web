define(["exports","./c_tslib","./c_core_i18n","./e_edison","./e_ui_page_files_router","./c_core_uri","./c_file_store_utils","./c_flows_logging_flows_loggers","./c_downloads","./c_src_common_constants","./c_core_exception_info","metaserver/static/js/modules/constants/web_experience_constants","./c_browse_tts","./c_flows_lib_api","./c_flows_redux_store","./c_flows_redux_actions","./c_flows_utils_browse_logger","./c_workflow_builder_workflow_actions_action_ui_config","./c_flows_redux_selectors","./c_flows_constants","./c_ui-icon_line_automation","./c_flows_redux_reducer","./c_flows_utils_async_modal_launchers","./c_flows_flows_client","./c_api_v2_noauth_client"],(function(e,t,o,i,n,r,a,s,l,c,u,d,_,f,p,g,m,v,h,b,w,y,k,A,C){"use strict";function T(e,t){return a.isBrowseFile(e)||(null==t?void 0:t.linkType)===n.SharedLinkType.Content?{identifier:{file_id:e.file_id,".tag":"file_id"}}:{identifier:{shared_link_url:e.href?e.href:"",".tag":"shared_link_url"}}}const E={generic_error:"failGeneric",permission_error:"failGeneric",unsupported_error:"failGeneric",filesystem_error:"failGeneric",filesystem_transient_error:"failRetryable",over_quota_error:"failOverQuota",riviera_permanent_error:"failGeneric",riviera_retryable_error:"failRetryable",riviera_too_large_error:"failTooLarge",riviera_source_corrupt_error:"failCorrupt",riviera_password_protected_error:"failPassword",password_protected_shared_link_error:"failPasswordLink",riviera_invalid_request_error:"failGeneric",riviera_unsupported_format_error:"failGeneric",other:"failGeneric"};function S(e){const t=null==e?void 0:e.error;return function(e){return e&&e[".tag"]&&e[".tag"]in E}(t)?E[t[".tag"]]:"failGeneric"}function M(e,t,o){const i=n.filename(e),r=n.parentDirName(e);return r?t(i,r):o(i)}function O(e,t,o,i){const r={update_adoption_status_arg:{".tag":"update_automated_adoption_status_arg",conversion_type:e,folder_rule_action:t,do_not_show:i}};return(new n.UserApiV2Client).ns("flows").rpc("update_adoption_status",r,{subjectUserId:o})}n.injectInternalStyle("metaserver/static/js/flows/conversions/adoption.module.out.css",(e=>"._adoptionTooltipContainer_kztpv_1{background-color:var(--color__core__primary);bottom:0;height:210px;margin-bottom:150px;margin-right:50px;padding:15px 15px 10px;position:fixed;right:0;width:220px;z-index:1000}._additionalButton_kztpv_14{margin-left:var(--spacing__unit--2)}._tooltipCloseButton_kztpv_18{margin-right:var(--spacing__unit--1);margin-top:var(--spacing__unit--1);position:absolute;right:0;top:0}@media only screen and (max-width:640px){._adoptionTooltipContainer_kztpv_1{display:none}}"));const R={icon:w.AutomationLine,name:"automate_current_folder",text:o.intl.formatMessage({id:"/Z33r/",defaultMessage:"Yes, automate folder"}),onClick:x((function e(t){P();const{filePath:o,conversionArg:i,userId:r,ns_id:a}=t;if(!i)return;const{conversionType:s,folderRuleAction:l}=i;O(s,l,r,!1);const c=n.parent_dir(o),u=n.parentDirName(o);m.showPendingSnackbar({folderName:u,type:"add"});const d=p.getStoreForAutomations(),_=L(i);if(!_)return void m.showErrorSnackbar({folderName:u,onRetry:()=>{e(t)},type:"generic-add"});y.updateFolderRule({fqPath:c,actions:[{actionType:l,data:_}],enabled:!0,applyToExistingFiles:!1,trigger:y.DEFAULT_CLIENT_FOLDER_TRIGGER}).then((()=>{m.logAutoFolderEvent(n.WebUserActionLogEvent.CONFIRM_ADD_FOLDER_RULES,{user_id:r,file_nsid:a,extra:{rule_type:l,entry_point:"adoption_snackbar"}}),d.dispatch(g.addUserAutomation({actions:[{actionType:l,data:_}],inheritable:!1,fqPath:c,isEnabled:!0,nsId:a,trigger:y.DEFAULT_CLIENT_FOLDER_TRIGGER})),m.showSuccessSnackbar({folderName:u,shouldShowDashboardCta:!0,type:"add"})}),(o=>{var i;m.logAutoFolderEvent(n.WebUserActionLogEvent.CONFIRM_ADD_FOLDER_RULES,{user_id:r,file_nsid:a,extra:{rule_type:l,error:null===(i=o.error)||void 0===i?void 0:i[".tag"],entry_point:"adoption_snackbar"}}),m.showErrorSnackbar({folderName:u,onRetry:()=>{e(t)},type:"generic-add"})}))}),"automate_folder")},F={name:"show_me_how_to_automate",text:o.intl.formatMessage({id:"Y2ppp4",defaultMessage:"Show me"}),onClick:x(U,"show_me")},I={name:"do_not_show_me_this_again",text:o.intl.formatMessage({id:"g74H0b",defaultMessage:"Skip"}),onClick:x(j,"dont_show_again")};function x(e,t){return o=>{const{userId:i,conversionArg:r,ns_id:a}=o;if(!r)return;const{folderRuleAction:s,source:l}=r;n.logAutoFolderAdoptionSnackbar({user_id:i,action_source:"adoption",event_name:n.WebUserActionLogEvent.AUTOMATED_FOLDER_ADOPTION_SNACKBAR_CLICK,file_nsid:a,trigger_rule:s,snackbar_click_option:t,source:l}),e(o)}}function U({userId:e,filePath:t,ns_id:o,conversionArg:i}){if(!i)return;const{conversionType:r,folderRuleAction:a}=i,s=n.parent_dir(t),l=L(i);O(r,a,e,!1),k.asyncLaunchWorkflowBuilder({operation:"add",folderFqPath:s,surface:"browse",entryPoint:"adoption_snackbar",initialActionType:a,initialActionData:l,initialScreen:"settings",initialTriggerType:"file_add"}),P()}function j({userId:e,conversionArg:t}){if(!t)return;const{conversionType:o,folderRuleAction:i}=t;O(o,i,e,!0),P()}function P(){n.Snackbar.close("flows-conversion-snackbar")}function L(e){const{folderRuleAction:t,fileType:o}=e,i=v.loadWorkflowActionUi(t),n=null==i?void 0:i.defaultAction.data;if(n)switch(t){case"image_conversion":case"video_conversion":n.format=o}return n}const N="flows_adoption_tooltip";function D(){const e=document.getElementById(N);e&&e.remove()}const z=({outputExt:e,folderRuleAction:t,clickHandlerArgs:r})=>{const a="unzip"===t?o.intl.formatMessage({id:"7bOS9k",defaultMessage:"Automatically unzip compressed files"}):o.intl.formatMessage({id:"W0dLEK",defaultMessage:"Automatically convert files to {outputExt}s"},{outputExt:null==e?void 0:e.toUpperCase()}),s="unzip"===t?o.intl.formatMessage({id:"kLjQYK",defaultMessage:"Set up this folder to automatically unzip compressed files as they are added."}):o.intl.formatMessage({id:"r7sQQK",defaultMessage:"Set up this folder to automatically convert files to {outputExt}s as they are added."},{outputExt:null==e?void 0:e.toUpperCase()});return i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(n.Title,{size:"standard",inverse:!0},a),i.React$1.createElement(n.IconButton,{variant:"borderless",className:"_tooltipCloseButton_kztpv_18",inverse:!0,onClick:D},i.React$1.createElement(n.UIIcon,{src:n.CloseLine})),i.React$1.createElement(n.Text,{inverse:!0,size:"small",tagName:"p"},s),i.React$1.createElement(n.Button,{onClick:()=>{U(r),D()},variant:"outline",inverse:!0},o.intl.formatMessage({id:"vvt1hU",defaultMessage:"Yes, show me"})),i.React$1.createElement(n.Button,{className:"_additionalButton_kztpv_14",onClick:()=>{j(r),D()},variant:"transparent",inverse:!0},o.intl.formatMessage({id:"tEEvw9",defaultMessage:"Skip"})))};z.displayName="AdoptionTooltip";function B(e){var o;return t.__awaiter(this,void 0,void 0,(function*(){const{file:r,user:l,shareToken:c,conversionFn:u,loggingFunctions:d,conversionType:w,folderRuleAction:y,getAdoptionSnackbarProps:k,source:E,template:M,outputExt:O}=e;if(_.logBrowseTTS("workflows_save_as"),d.logConvert(E),r.bytes>268435456&&M)return m.updateSnackbar({variant:"sync",title:"Loading"}),void(yield function(e,o,i,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=p.getStoreForAutomations();t.dispatch(g.setShouldSubscribeToBolt(!0));const l=v.mapConversionSourceToWorkflowEntrypoint(i),c=T(e,r);let u;if(c&&c.identifier&&(u="shared_link_url"===c.identifier[".tag"]&&""!==c.identifier.shared_link_url?c.identifier.shared_link_url:void 0),a.isSharedFile(e)){t.dispatch(g.getWorkflowStepsConfig());const i=n.getActiveUser(),{submitFileWorkflow:r}=A.makeFlowsClient((e=>e?new n.DefaultUserApiV2Client(e):new C.NoAuthApiV2Client)(i));r({template:o,file_ids:[e.file_id],shared_link_url:u},60)}else try{yield f.submitFileWorkflow(o,[e.file_id],u),s.PapLogger.logSucceedSubmitManualWorkflow(l,o,1)}catch(e){s.PapLogger.logFailSubmitManualWorkflow(l,o,1,e)}}))}(r,M,E,c));W(Object.assign(Object.assign({},e),{state:"saving"}));try{const t=yield u(r,l,c);if(t){const a=k?k(t):void 0;let s=!1;if(a&&y){const e=yield function(e,t,o){const i={check_adoption_status_arg:{".tag":"check_automation_adoption_status_arg",conversion_type:e,folder_rule_action:t}};return(new n.UserApiV2Client).ns("flows").rpc("check_adoption_status",i,{subjectUserId:o})}(w,y,l.id);s="show_automation_adoption_tooltips"===(null===(o=e.check_automation_adoption_status_result)||void 0===o?void 0:o[".tag"])&&e.check_automation_adoption_status_result.show_automation_adoption_tooltips.valueOf()}if(s&&"video-home"!==E){(function(){const e=p.getStoreForAutomations().getState(),t=h.getUserExperiments(e).find((e=>e.feature===b.UI_EXPERIMENTS.ADOPTION_UI_VARIANT));return"V3_TOOLTIP"===(null==t?void 0:t.variant)})()?(W(Object.assign(Object.assign({},e),{state:"success",resultPath:t})),function(e,t,o){if(!e&&"unzip"!==t||!t||!o)return;let n=document.getElementById(N);n&&n.remove(),n=document.createElement("div"),n.className="_adoptionTooltipContainer_kztpv_1",n.id=N,document.body.insertBefore(n,document.body.firstChild);const r=i.React$1.createElement(z,{outputExt:e,folderRuleAction:t,clickHandlerArgs:o});i.reactDom.exports.render(r,n)}(O,y,null==a?void 0:a.clickHandlerArgs)):(n.logAutoFolderAdoptionSnackbar({user_id:l.id,action_source:"adoption",event_name:n.WebUserActionLogEvent.AUTOMATED_FOLDER_ADOPTION_SNACKBAR_SHOW,file_nsid:r.ns_id,source:E,trigger_rule:y}),W(Object.assign(Object.assign({},e),{state:"successAutomatedAdoption",resultPath:t,adoptionSnackbarProps:a})))}else W(Object.assign(Object.assign({},e),{state:"success",resultPath:t}))}else W(Object.assign(Object.assign({},e),{state:"failGeneric"}));return t}catch(t){const o=S(t);return void W(Object.assign(Object.assign({},e),{state:o}))}}))}function W(e){const{user:t,getStrings:r,state:a,resultPath:s,loggingFunctions:l,adoptionSnackbarProps:c,source:u}=e,d=Object.assign(Object.assign({},r(s||"",{clickableFileName:!!c,loggingFunctions:l,source:u})),{open:o.intl.formatMessage({id:"+JIEsO",defaultMessage:"Open"}),close:o.intl.formatMessage({id:"In8b64",defaultMessage:"Close"}),retry:o.intl.formatMessage({id:"Y/tkCj",defaultMessage:"Try again"})}),_={closeButtonText:d.close,onCloseClick:()=>l.logConvertClose(u)},f={saving:{variant:"sync",syncProgressLoop:!0},failGeneric:Object.assign({variant:"fail"},_),failOverQuota:Object.assign({variant:"fail"},_),failTooLarge:Object.assign({variant:"fail"},_),failCorrupt:Object.assign({variant:"fail"},_),failPassword:Object.assign({variant:"fail"},_),failPasswordLink:Object.assign({variant:"fail"},_),failRetryable:Object.assign({variant:"fail",onActionClick:()=>{l.logConvertRetry(u),B(e)}},_),successAutomatedAdoption:Object.assign({variant:"complete",onActionClick:()=>G(t,s,l,u),richSnackbarProps:c},_),success:Object.assign({variant:"complete",actionButtonText:d.open,onActionClick:()=>G(t,s,l,u)},_)};n.Snackbar.update(i.React$1.createElement(n.Snackbar,Object.assign({id:"flows-conversion-snackbar",title:d[a]},f[a])))}function G(e,t,o,i){o.logConvertOpen(i);const a=t,s=n.get_browse_root(e)+r.URI.encode_parts(a);n.replace_location(s)}e.archive=function(e,o,i,r,a){return t.__awaiter(this,void 0,void 0,(function*(){if(r&&r.blockHash){const t=r.currentFQPath,s=o.map((e=>e.fq_path)),c=yield l.getZipDownloadUrl({block_hash:r.blockHash,fq_paths:s,parent_path:t,subjectUserId:e,flat_mode:!1});if(c.isError)return l.showGetZipUrlErrorSnackbar(c.error),Promise.resolve({path:void 0});{const t=o.map((e=>T(e)));i=i||"archive.zip";const r={file:t,dest_path:a,zip_url:c.result.url,archive_name:i};return(new n.UserApiV2Client).ns("flows").rpc("archive",r,{subjectUserId:e})}}return Promise.resolve({path:void 0})}))},e.canConvertFile=function(e,t){return a.isBrowseFile(e)||t&&t.canDownloadRoles.length>0},e.convertDocToImage=function(e,t,o,i){const r={file:t,format:o,dest_path:i};return(new n.UserApiV2Client).ns("flows").rpc("convert_doc_to_image",r,{subjectUserId:e})},e.convertFileAndShowSnackbar=B,e.convertImageFormat=function(e,t,o,i){const r={file:t,format:o,dest_path:i};return(new n.UserApiV2Client).ns("flows").rpc("convert_image_format",r,{subjectUserId:e})},e.convertToPdf=function(e,t,o){const i={file:t,dest_path:o};return(new n.UserApiV2Client).ns("flows").rpc("convert_to_pdf",i,{subjectUserId:e})},e.convertVideoToGif=function(e,t,o,i,r,a){const s={file:t,dest_path:a,start_offset:o,duration:i,resolution:r};return(new n.UserApiV2Client).ns("flows").rpc("convert_video_to_gif",s,{subjectUserId:e})},e.getAdoptionSnackbarProps=function(e){const{user:t,conversionType:i,folderRuleAction:r,resultPath:a,source:s,nsId:l}=e;if(!function(e){const t=!!n.isInsideFlowsEligibleFolder(n.getStoreForBrowse().getState()),o=null!=h.getUserAutomation(n.parent_dir(e))(p.getStoreForAutomations().getState());return t&&!o}(a))return;const c={user:t,conversionType:i,folderRuleAction:r,fileType:"unzip"===r?void 0:e.fileType,source:s},u={userId:t.id,filePath:a||"",ns_id:l,conversionArg:c},d="unzip"===r?o.intl.formatMessage({id:"+Ath7j",defaultMessage:"Want to automatically unzip files by setting up an automated folder?"}):o.intl.formatMessage({id:"+9Utp7",defaultMessage:"Want to automatically save {fileType} copies by setting up an automated folder?"},{fileType:e.fileType.toUpperCase()});return{actions:[R,F,I],helperText:d,clickHandlerArgs:u}},e.getConversionLoggingFunctions=function(e){return{logConvert:(t,o=1)=>{s.PapLogger.logInitiateFileConversion(e,o,t)},logConvertRetry:(t,o=1)=>{s.PapLogger.logSelectFileConversionRetryButton(e,o,t)},logConvertClose:(t,o=1)=>{s.PapLogger.logDimissFileConversionSnackbar(e,o,t)},logConvertOpen:t=>{s.PapLogger.logSelectFileConversionOpenButton(e,t)}}},e.getDefaultConversionStrings=function(e,t,a,s){const l=o.intl.formatMessage({id:"WthXj+",defaultMessage:"Couldn't save as {fileType}"},{fileType:e}),c=M(t,((e,l)=>o.intl.formatMessage({id:"jyMgWg",defaultMessage:"<a>{fileName}</a> saved to {dirName} folder"},{fileName:e,dirName:l,a:e=>(null==s?void 0:s.clickableFileName)?i.React$1.createElement(n.Link,{inverse:!0,href:n.get_browse_root(a)+r.URI.encode_parts(t),onClick:()=>{var e;null===(e=null==s?void 0:s.loggingFunctions)||void 0===e||e.logConvertOpen(null==s?void 0:s.source)}},e):e})),(e=>o.intl.formatMessage({id:"ukwwi2",defaultMessage:"{fileName} saved to your main Dropbox folder"},{fileName:e})));return{saving:o.intl.formatMessage({id:"Bdb4J5",defaultMessage:"Saving {fileType}..."},{fileType:e}),success:c,successAutomatedAdoption:c,failGeneric:l,failRetryable:l,failOverQuota:o.intl.formatMessage({id:"QP2WHb",defaultMessage:"Couldn't save as {fileType} because your Dropbox account is out of space"},{fileType:e}),failTooLarge:o.intl.formatMessage({id:"cmnQAC",defaultMessage:"Couldn't save as {fileType} because the file is too large"},{fileType:e}),failCorrupt:o.intl.formatMessage({id:"INKSmo",defaultMessage:"Couldn't save as {fileType} because the file is damaged"},{fileType:e}),failPassword:o.intl.formatMessage({id:"dnnNdt",defaultMessage:"Couldn't save as {fileType} because the file is password protected"},{fileType:e}),failPasswordLink:o.intl.formatMessage({id:"qzTamN",defaultMessage:"Couldn't save as {fileType} because the file was shared using a password-protected link"},{fileType:e})}},e.getFileIdentifier=T,e.getSuccessString=M,e.mediaRemux=function(e,t,o,i){const r={file:t,dest_path:i,container:o};return(new n.UserApiV2Client).ns("flows").rpc("media_remux",r,{subjectUserId:e})},e.multiFileWithExtensionSelector=function(e){return t=>!(t.length<1||t.some((e=>e.is_dir)))&&t.every((t=>e.includes(a.getExtension(t))))},e.singleFileWithExtensionSelector=function(e){return t=>{if(1!==t.length||t[0].is_dir)return!1;const o=a.getExtension(t[0]);return e.includes(o)}},e.strictMultiFileWithExtensionSelector=function(e){return t=>!(t.length<=1||t.some((e=>e.is_dir)))&&t.every((t=>e.includes(a.getExtension(t))))},e.unzip=function(e,t,o){const i={file:t,dest_path:o};return(new n.UserApiV2Client).ns("flows").rpc("unzip",i,{subjectUserId:e})}}));
//# sourceMappingURL=c_flows_conversions_convert.js-vflpGkZpI.map
