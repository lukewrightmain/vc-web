define(["exports","./e_edison","./e_ui_page_files_router","./c_core_notify","./c_core_i18n","./c_contacts_contact_token_state","./c_loggers_join_flow_logger","./c_contacts_tokenizer_v2","./c_tslib","./c_core_uri","./c_lodash-es_lodash","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_api_v2_noauth_client","./c_browser_cookies","./c_src_sink_index","./c_core_browser_detection","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","./c_csrf","./c_core_xhr","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/core/langpack","./c_typeahead_index","./c_ui-icon_line_import-contacts"],(function(e,t,s,a,n,i,o,r,c,l,m,d,u,g,_,h,f,v,p,M,b,k,R,$,E,y,S,w,C,j,T,I,x,A,D,F,N,q,L,B,U,W){"use strict";class V{constructor(){this.inFlight=!0,this.canInvite=!1,this.reason="checking",this.callbacks=[]}whenReady(e){this.inFlight?this.callbacks.push(e):e()}resultArrived(e,t){if(this.inFlight){this.inFlight=!1,this.canInvite=e,this.reason=t;for(const e of this.callbacks)e();this.callbacks=[]}}}class z{constructor(e){this.checkEmails=(e,t)=>{const a={};let n=e.length;if(0===n)return t(a);const i=[];for(const s of e){let e=this.checkedEmails[s];e||(e=this.checkedEmails[s]=new V,i.push(s)),e.whenReady((function(){a[s]=e,0==--n&&t(a)}))}i.length>0&&(e=>{s.WebRequest$2({url:this.checkUrl,data:{emails:e.join(",")},subject_user:s.mustGetActiveUserId(),success:e=>{const t=JSON.parse(e);for(const e in t)if(t[e]){const{can_invite:s,reason:a}=t[e];this.checkedEmails[e]&&this.checkedEmails[e].resultArrived(s,a)}},error:()=>{for(const t of e)delete this.checkedEmails[t]}})})(i)},this.checkUrl=e,this.checkedEmails={}}getEmailCheckResult(e){return this.checkedEmails[e]}}const O=s.Viewer.get_viewer();function G({open:e,onClose:c,user:l,numAvailableLicenses:m,source:d,membersSendInviteDomainRestrictionEnabled:u=!1,teamBusinessDomains:g=[],isSuggestionMode:_,prepopulatedEmails:h=[]}){const[f,v]=t.React$1.useState(!1),[p,M]=t.React$1.useState(null),[b,k]=t.React$1.useState([]),[R,$]=t.React$1.useState(!1),[E]=t.React$1.useState(new z("/team/manage/check_can_invite")),[y,S]=t.React$1.useState(),[w,C]=t.React$1.useState(),[j,T]=t.React$1.useState(h?h.map((e=>s.Contact.buildFromRawEmail(e))):[]),[I,x]=t.React$1.useState(j),[A,D]=t.React$1.useState(""),F=u&&g.length>0,N=F?g:null;if(!_&&void 0===m)throw"numAvailableLicenses is required in invite mode";function q(e,t){const a=e.filter((e=>e.type===s.ContactTypes.EMAIL&&!e.invalid&&!e.on_team)),n=a.map((e=>e.email));E.checkEmails(n,(()=>{t(a)}))}if(p){const a=()=>{T([]),M(null),k([]),S(void 0),C(void 0),c(p)};return t.React$1.createElement(s.Modal,{open:e,withCloseButton:n.intl.formatMessage({id:"a2rDhR",defaultMessage:"Close"}),onRequestClose:a,className:"suggestion-fallback-modal"},t.React$1.createElement(s.Modal.Header,{hasBottomSpacing:"title-standard"},t.React$1.createElement(s.Title,null,n.intl.formatMessage({id:"qn5twm",defaultMessage:"Member requests were sent to the admin"}))),t.React$1.createElement(s.Modal.Body,{hasVerticalSpacing:!1},t.React$1.createElement("ul",null,b.map((e=>t.React$1.createElement("li",{key:e},e))))),t.React$1.createElement(s.Modal.Footer,null,t.React$1.createElement(s.Button,{variant:"primary",onClick:a},n.intl.formatMessage({id:"MNcs5F",defaultMessage:"Got it"}))))}const L=()=>{f||(S(void 0),C(void 0),T([]),c())},B=g.map((e=>`@${e}`)),U=n.intl.formatMessage({id:"GoJlu1",defaultMessage:"name"});let W="";if(F)switch(B.length){case 1:W=n.intl.formatMessage({id:"m6/l0s",defaultMessage:"Add any email that ends in {oneDomain}"},{oneDomain:B[0]});break;case 2:W=n.intl.formatMessage({id:"xw8mQ6",defaultMessage:"Add any email that ends in {firstDomain} or {secondDomain}"},{firstDomain:B[0],secondDomain:B[1]});break;default:W=n.intl.formatMessage({id:"7aBsbD",defaultMessage:"Add any email that ends in {headDomains} or {lastDomain}"},{headDomains:B.slice(0,B.length-1).join(", ")+",",lastDomain:B[B.length-1]})}function V(e,a){const n="invite-validation-message";let i=n,o=s.FailLine;switch(e){case"warn":o=s.WarningLine,i=s.classnames(i,`${n}__non-admin-invite-modal-warn-extensions`);break;case"error":i=s.classnames(i,`${n}__non-admin-invite-modal-error-extensions`)}return t.React$1.createElement("div",{className:i},t.React$1.createElement(s.UIIcon,{size:"small",src:o,className:`${n}__icon`}),t.React$1.createElement(s.Text,{size:"small",color:"inherit"},a))}return t.React$1.createElement(n.Provider,{value:n.intl},t.React$1.createElement(s.Modal,{open:e,withCloseButton:n.intl.formatMessage({id:"62wFTu",defaultMessage:"Cancel"}),onRequestClose:L,className:"non-admin-invite-modal"},t.React$1.createElement(s.Modal.Header,{hasBottomSpacing:"title-standard"},t.React$1.createElement(s.Title,null,_?n.intl.formatMessage({id:"YF+G2c",defaultMessage:"Request Invite"}):n.intl.formatMessage({id:"veD/Im",defaultMessage:"Invite people to {team_name}"},{team_name:O.team_name}))),t.React$1.createElement(s.Modal.Body,{hasVerticalSpacing:!1},F&&t.React$1.createElement("div",{className:"non-admin-invite-modal-team-business-domains"},W),t.React$1.createElement(r.ContactsTokenizerV2,{user:l,placeholder:B.length>0?B.map((e=>`${U}${e}`)).join(", "):n.intl.formatMessage({id:"w5JCcS",defaultMessage:"Add an email"}),onContentsChange:function(e){x(e),q(e,(()=>{!function(e){let t,s,a=!0;for(const n of e){const{state:e,msg:o}=J(n,E,N);e!==i.ContactTokenState.ok&&(e===i.ContactTokenState.warn?s=null!=s?s:o:(t=null!=t?t:o,a=!1))}C(s),S(t),$(a)}(e)}))},onQueryChange:D,focusOnMount:!0,initialContacts:j,contactValidator:e=>J(e,E,N),contactFilter:function(e){return!(e.type!==s.ContactTypes.EMAIL||e.team||!e.name||e.email===l.email)},disabled:f}),y&&V("error",y),w&&V("warn",w)),t.React$1.createElement(s.Modal.Footer,null,t.React$1.createElement(s.Button,{disabled:f,variant:"opacity",onClick:L,"data-testid":"cancel-button"},n.intl.formatMessage({id:"62wFTu",defaultMessage:"Cancel"})),t.React$1.createElement(s.Button,{variant:"primary",disabled:!R||!!A,onClick:function(){var e;f||(e=({emails:e})=>{if(!function(){const e=[i.ContactTokenState.ok,i.ContactTokenState.warn];return 0===I.length||I.every((t=>e.includes(J(t,E,N).state)))}())return;const t=e=>{T([]),c(e)};v(!0),_?function(e,t,i,o){s.WebRequest$2({url:"/team/manage/suggest-members",data:{emails:e,url:s.get_href(),source:i},subject_user:s.mustGetActiveUserId(),complete:()=>o(!1),success:()=>(a.Notify.success(n.intl.formatMessage({id:"lMqVLz",defaultMessage:"{num_suggested, plural, one {Thanks for your suggestion! We’ve sent it to the team admin.} other {Thanks for your suggestions! We’ve sent them to the team admin.}}"},{num_suggested:e.length})),t())})}(e,t,d,v):function(e,t,i,r,c,l,m){s.TeamsWebActionsLogger.log("invite_member_open_invite_click",{source:r,member_invite_on:!0,invite_count:e.length});const d={emails:e,team_id:O.team_id,invite_source:o.InviteSource.MEMBER_INVITE,poll_events_on_commit:!1,extra:JSON.stringify({member_send_invite_experiment_enabled:!0,origin:r})},u=Array.isArray(e);t<(u?e.length:1)&&(d.charge_for_new_licenses=!0),s.WebRequest$2({url:"/account/team/add_users",subject_user:O.work_user,data:d,complete:()=>c(!1),success:t=>{t=JSON.parse(t);const s=Object.values(t.users),o=t.num_suggested||0;if(s.length>0||o>0){if(0!==o)return o>0&&s.length>0?(a.Notify.success(`${n.intl.formatMessage({id:"SX0gpY",defaultMessage:"{num_invites, plural, one {Invited # person} other {Invited # people}}."},{num_invites:s.length})} ${n.intl.formatMessage({id:"lbndFp",defaultMessage:"{num_suggested, plural, one {# invite sent to admin} other {# invites sent to admin}}."},{num_suggested:o})}`),m(e.filter((e=>!s.map((e=>e.email)).includes(e)))),l({num_invited:s.length,invitedUsers:s})):(m(e),l({num_invited:0}));a.Notify.success(n.intl.formatMessage({id:"axSi6e",defaultMessage:"{num_invited, plural, one {Invited.} other {Invited # people.}}"},{num_invited:s.length}))}else a.Notify.error(n.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}));return i({num_invited:s.length,invitedUsers:s})},error:e=>("rate-limit"===e.getResponseHeader("x-dropbox-app-error")?a.Notify.error(new a.HTML(n.intl.formatMessage({id:"hQ0rRo",defaultMessage:"{team_name} has reached the maximum number of team members allowed on Dropbox Basic. Please <a>contact sales</a> to add more members to your team."},{team_name:O.team_name,a:e=>`<a href="/business/contact">${e}</a>`}))):(s.TeamsWebActionsLogger.log("invite_member_open_invite_error",{source:r,member_invite_on:!0,client:!0}),a.Notify.error(n.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}))),i({num_invited:0}))})}(e,m,t,d,v,M,k)},q(I,(t=>{const s=t.map((e=>e.email));e({emails:s})})))},"data-testid":"submit-button"},f?t.React$1.createElement(s.Spinner,{inverse:!0,size:"small"}):n.intl.formatMessage({id:"rPSCOl",defaultMessage:"Invite to join"})))))}function J(e,t,s){var a;const o=e.email;let r;if(e.invalid)r={state:i.ContactTokenState.invalid,msg:n.intl.formatMessage({id:"iWy49e",defaultMessage:"{email} is not a valid email address."},{email:o})};else if(e.on_team)r={state:i.ContactTokenState.invalid,msg:n.intl.formatMessage({id:"w6S6LE",defaultMessage:"User is already a member of this team."})};else{const e=t.getEmailCheckResult(o);let c;if(e)if(e.inFlight)r={state:i.ContactTokenState.pending,msg:c};else if(e.canInvite){if(r={state:i.ContactTokenState.ok,msg:c},s){const e=null===(a=o.match(/@(.*)$/))||void 0===a?void 0:a[1];e&&!s.includes(e)&&(r={state:i.ContactTokenState.warn,msg:n.intl.formatMessage({id:"LuEFa+",defaultMessage:"Only approved emails are automatically approved"})})}}else"team_member"===e.reason?c=n.intl.formatMessage({id:"/bTRGP",defaultMessage:"This person is already on another team."}):"already_on_this_team"===e.reason?c=n.intl.formatMessage({id:"gUZ177",defaultMessage:"User is already invited to this team."}):"error"===e.reason&&(c=n.intl.formatMessage({id:"I1RVgD",defaultMessage:"User isn’t eligible to join this team."})),r={state:i.ContactTokenState.invalid,msg:c};else r={state:i.ContactTokenState.invalid,msg:c}}return r}const H=s.requireCssWithComponent(G,["/static/metaserver/static/css/react/contacts_tokenizer-vflR-o-P-.css","/static/metaserver/static/css/teams/let_members_invite-vfllwVROJ.css"]);e.MemberInviteModal=G,e.MemberInviteModalWithCSS=H}));
//# sourceMappingURL=c_teams_let_members_invite_non_admin_invite_modal.js-vflhCyWm8.map
