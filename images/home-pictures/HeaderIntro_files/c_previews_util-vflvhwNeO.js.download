define(["exports","./c_file_viewer_utils","./e_ui_page_files_router","./c_tslib","./c_api_v2_noauth_client","./e_core_exception","./c_lodash-es_lodash","./c_core_exception_info","./c_sharing_share_page_action_types","metaserver/static/js/modules/constants/python","./c_flux_base_store","./c_core_i18n","./c_sharing_ui_util","./c_core_uri","./c_sharing_settings_utils_sharing_settings_util","./c_core_logging_constants","./c_core_types_preview_type","./c_src_file_extension_extension_constants"],(function(e,t,s,n,i,a,r,o,c,_,h,u,d,l,E,S,p,I){"use strict";function m(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var n=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var f=m(_);class g{static passPermissionRequest(e){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.PASS_PERMISSION_REQUEST,data:{fileId:e}})}static updatePermissions(e,t){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_PERMISSIONS,data:{fileId:e,partialPermission:t}})}static fetchPassError(e){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.FETCH_PASS_ERROR,data:{fileId:e}})}static fetchPassConcluded(e){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.FETCH_PASS_CONCLUDED,data:{fileId:e}})}static receivePresenceDelta(e,t,n,i){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.RECEIVE_PRESENCE_DELTA,data:{userId:e,fileId:t,onlineUniqueUsers:n,offlineUniqueUsers:i}})}static receivePresenceSnapshot(e,t,n){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.RECEIVE_PRESENCE_SNAPSHOT,data:{userId:e,fileId:t,onlineUniqueUsers:n}})}static resetPassInfo(e){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.RESET_PASS_INFO,data:{fileId:e}})}static updateSeenStateInfo(e,t,n){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_SEEN_STATE_INFO,data:{fileId:e,seenStateInfo:t,seenStateCursor:n}})}static updateUserTeamInteractionInfo(e,t){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_USER_TEAM_INTERACTION_INFO,data:{fileId:e,userTeamInteractionInfo:t}})}static updateSeenStateInfoContinue(e,t,n){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_SEEN_STATE_INFO_CONTINUE,data:{fileId:e,seenStateInfo:t,seenStateCursor:n}})}static discontinueSeenStateInfo(e){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.DISCONTINUE_SEEN_STATE_INFO,data:{fileId:e}})}static updateSeenStateUnavailable(e,t){s.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_SEEN_STATE_UNAVAILABLE,data:{userId:e,fileId:t}})}}const A=256,T="-",C={WEB:0,IOS:1,ANDROID:2,DESKTOP:3};class N{constructor(e,t,s){this.platform=e,this.surface=t,this.identifier=null!=s?s:"";let n=!1;for(const e in C){const t=C[e];if(this.platform===t){n=!0;break}}if(!n)throw new Error("platform must be from Beacon.Platforms");if(this.surface.length>32||0===this.surface.length)throw new Error("surface must be populated and <= 32 chars.");if(this.identifier.length>128)throw new Error("identifier must be <= 128 chars.")}static from_json(e){return new N(e.platform,e.surface,e.identifier)}}class R{constructor(e,t,s,n){if(this.user_id=e,this.app=t,this.context=s,this.source=n,this.user_id.length>A)throw new Error("user_id must be <= 256 chars.");if(this.app.length>32||0===this.app.length)throw new Error("app must be populated and <= 32 chars.");if(this.context.length>64||0===this.context.length)throw new Error("context must be populated and <= 64 chars.")}static from_json(e){const t=N.from_json(e.source);return new R(e.user_id,e.app,e.context,t)}}class O{constructor(e,t,s){if(this.agent=e,this.status=t,this.auth_key=s,this.status.length>32)throw new Error("status must be <= 32 chars")}static from_json(e){return new O(R.from_json(e.agent),e.status)}}const b="UserContext",L="UserApp",P="Context";class M{constructor(e,t,s,n,i){if(this.type=e,this.user_id=t,this.app=s,this.context=n,this.token=i,this.type!==b&&this.type!==L&&this.type!==P)throw new Error(`Unsupported type: ${this.type}.`);if((null!=this.user_id?this.user_id.length:0)>A)throw new Error("user_id must be <= 256 chars.");if(this.app.length>32)throw new Error("app must be <= 32 chars.");if((null!=this.context?this.context.length:0)>64)throw new Error("context must be <= 64 chars.")}}class U{constructor(e,t){this.presence_params=e,this.agents=t}}class F{constructor(e,t){this.presence_params=e,this.status=t}}F.Status={Offline:1,Online:2};class D{constructor(e,t,s){this.presence_params=e,this.snapshot=t,this.delta=s}}class y{constructor(e,t,s=(()=>{})){this._heartbeat=()=>{if(!this._started||0===this._presence_data.length)return;this._offline_agents=this._presence_data.filter((e=>""!==e.status)).map((e=>e.agent)),this._has_changes=!1;const e=new AbortController;this._heartbeat_xhr=fetch("https://beacon.dropbox.com/1/update",{method:"POST",body:JSON.stringify({token:this._token,updates:this._presence_data}),headers:{"Content-Type":"application/json; charset=utf-8"},credentials:"include",signal:e.signal}).then((e=>e.json())).then(this._handle_heartbeat_success).catch(this._handle_heartbeat_error),setTimeout((()=>e.abort()),5e3)},this._handle_heartbeat_success=e=>{if(this._heartbeat_xhr=void 0,!this._started)return;const t=[];for(const s of e.agent_errors||[]){const e=s.error,n=R.from_json(s.agent);"authorization_error"===e?t.push(n):"invalid_agent"===e&&a.reportStack(`Input error: ${s}`),this._presence_data=this._presence_data.filter((e=>!r.isEqual(e.agent,n)))}if(t.length){const e=this._authz_cb;window.setTimeout((()=>e(t)),0)}for(const e of this._offline_agents)for(let t=0;t<this._presence_data.length;t++){const s=this._presence_data[t];if(r.isEqual(s.agent,e)&&""===s.status){this._presence_data.splice(t,1);break}}const s=this._has_changes?0:6e4;this._backoff_window=5e3,this._timeout_id=window.setTimeout(this._heartbeat,s)},this._handle_heartbeat_error=e=>{if(this._heartbeat_xhr=void 0,!this._started)return;if(e.status>=400&&e.status<500){if(401===e.status)return window.setTimeout(this._authn_cb,0),void this.stop();400===e.status&&a.reportStack(`Bad request: ${e.responseText}`)}const t=Math.random()*this._backoff_window;this._backoff_window=Math.min(2*this._backoff_window,12e4),this._timeout_id=window.setTimeout(this._heartbeat,t)},this._token=e,this._authn_cb=t,this._authz_cb=s,this._started=!1,this._presence_data=[],this._offline_agents=[],this._has_changes=!1}start(){if(!this._started)return this._backoff_window=5e3,this._started=!0,this._has_changes=!1,this._heartbeat()}stop(){this._started=!1,this._heartbeat_xhr=void 0,window.clearTimeout(this._timeout_id),this._timeout_id=void 0}add_or_update_agents(e){for(const t of e)this._has_changes=this._add_or_update_agent(t)||this._has_changes;!this._heartbeat_xhr&&this._started&&(window.clearTimeout(this._timeout_id),this._timeout_id=window.setTimeout(this._heartbeat,0))}_add_or_update_agent(e){for(let t=0;t<this._presence_data.length;t++){const s=this._presence_data[t];if(r.isEqual(s.agent,e.agent))return(s.status!==e.status||s.auth_key!==e.auth_key)&&(this._presence_data[t]=e,!0)}return this._presence_data.push(e),!0}}class k{constructor(e,t,n){this._compact_context_updates=(e,t)=>{let s,n,i=!1,a=[];for(const e of t)if(null!=e.snapshot)i=!0,a=e.snapshot;else if(null!=e.delta)for(const t of e.delta){let e=!1;for(let s=0;s<a.length;s++){const n=a[s];if(r.isEqual(n.agent,t.agent)){e=!0,a[s]=t;break}}e||a.push(t)}return i?(n=a,s=void 0):(n=void 0,s=a),new D(e,n,s)},this._on_update=e=>{const t=[];for(const n of e){const{channel_state:e}=n,i=new s.ChannelId(e.app_id,e.unique_id),a=this._bolt_channel_to_presence_params(i);switch(a.type){case b:{const{payload:e}=n.payloads.slice(-1)[0],s=null!=e.agents?e.agents.map(O.from_json):[];t.push(new U(a,s));break}case L:{const{payload:e}=n.payloads.slice(-1)[0];t.push(new F(a,e.status));break}case P:{const e=function(e){const t=N.from_json(e.source),s=new R(e.user_id,a.app,a.context,t);return new O(s,e.status)},s=function(t){var s,n,i,a;return{snapshot:null===(n=null===(s=t.snapshot)||void 0===s?void 0:s.agents)||void 0===n?void 0:n.map(e),delta:null===(a=null===(i=t.delta)||void 0===i?void 0:i.agents)||void 0===a?void 0:a.map(e)}},i=n.payloads.map((e=>s(e.payload)));t.push(this._compact_context_updates(a,i));break}}}return this._update_callback(t)},this._on_refresh=e=>this._refresh_callback(e.map(this._bolt_channel_to_presence_params)),this._presence_params=e,this._update_callback=t,this._refresh_callback=n;const i=this._presence_params.map(this._presence_params_to_bolt_channel);this._thunder_client=new s.ThunderClient(i,this._on_update,this._on_refresh)}start(){return this._thunder_client.start()}stop(){return this._thunder_client.unsubscribe()}_presence_params_to_bolt_channel(e){switch(e.type){case b:return new s.SignedChannelState(`beacon_uc-${e.app}`,`${e.user_id}|${e.context}`,"0",e.token);case L:return new s.SignedChannelState(`beacon_ua-${e.app}`,e.user_id||"","0",e.token);case P:return new s.SignedChannelState(`beacon_c-${e.app}`,e.context,"0",e.token);default:throw new Error(`Unknown type: ${e.type}`)}}_bolt_channel_to_presence_params(e){const t=e.app_id.split(T),s=e.unique_id.split("|");if(2!==t.length)throw new Error(`Unexpected format of Bolt app_id: ${e.app_id}.`);const n=t[1];let i="",a="",r=b;switch(t[0]){case"beacon_uc":if(2!==s.length)throw new Error(`Unexpected format of beacon_uc: ${e.unique_id}.`);r=b,i=s[0],a=s[1];break;case"beacon_ua":if(1!==s.length)throw new Error(`Unexpected format of beacon_ua: ${e.unique_id}.`);r=L,i=s[0];break;case"beacon_c":if(1!==s.length)throw new Error(`Unexpected format of beacon_c: ${e.unique_id}.`);r=P,a=s[0];break;default:throw new Error(`Unknown Bolt app_id: ${e.app_id}.`)}return new M(r,i,n,a,void 0)}}const v=[s.LoggingActions.PRESENCE_RECEIVE,s.LoggingActions.TRANSMITTER_TOKEN_BEGIN,s.LoggingActions.TRANSMITTER_TOKEN_RECEIVE,s.LoggingActions.RECEIVER_TOKEN_BEGIN,s.LoggingActions.RECEIVER_TOKEN_RECEIVE,s.LoggingActions.SEEN_STATE_USERS_BEGIN,s.LoggingActions.SEEN_STATE_USERS_RECEIVE];const w=new class{constructor(){this.allTimestamps={}}record(e,t){const s=(new Date).getTime()/1e3;this.allTimestamps[t]=this.allTimestamps[t]||{};const n=this.allTimestamps[t];n.hasOwnProperty(e)?this.reportStackForRepeatedAction(n,e,t,s):n[e]=s}get(e){return this.allTimestamps[e]||{}}reportStackForRepeatedAction(e,t,s,n){if(v.indexOf(t)>=0)return;const i=e[t];a.reportStack("Attempted to record action for which there existed a previous record",{severity:o.SEVERITY.NONCRITICAL,tags:["pass:actionTimestampsTracker"],exc_extra:{pass_session_id:s,action:t,oldTimestamp:i,newTimestamp:n}})}};function H(e){g.resetPassInfo(e),g.fetchPassError(e)}function j(e,t){return{file_identifier:e,shared_link_details:t?{url:t}:void 0}}var x;!function(e){e.create=function(e){return e?new i.FetchAsyncTransport:new i.FetchSyncTransport}}(x||(x={}));class B{static constructFakeSeenStateInfo(e,t,s){const n=s.seen_states,i=[];for(const e of n)i.push(e.seen_state_user.user_id);for(const s of e)if(!i.includes(s.user_id)){s.sharing_access_type&&(s.sharing_access_type=this.convertToUnion(s.sharing_access_type));const e={seen_state_user:s,when_last_seen:t,seen_events:[]};n.unshift(e)}return s.seen_states=n,s}static convertToUnion(e){return e?i.Union.parse(e):null}static parseSeenStatePassPlatform(e){if(e){switch(i.Union.parse(e).type){case"web":return s.PassPlatform.WEB;case"mobile":return s.PassPlatform.MOBILE;case"desktop":return s.PassPlatform.DESKTOP}}return s.PassPlatform.UNKNOWN}static fetchSeenStateUsers(e,t,i,a,r,o){return n.__awaiter(this,void 0,void 0,(function*(){const n=Date.now()/1e3;let c;o&&w.record(s.LoggingActions.SEEN_STATE_USERS_BEGIN,o);try{c=yield(new s.UserApiV2Client).ns("seen_state").rpc("get_seen_state_users",{user_ids:i,file_info:j(a,r)},{subjectUserId:e})}catch(e){return void H(a)}o&&w.record(s.LoggingActions.SEEN_STATE_USERS_RECEIVE,o);const _=this.constructFakeSeenStateInfo(c,n,t);g.updateSeenStateInfo(a,_)}))}static processAndUpdateSeenStateInfo(e,t,s,n){const{seen_state_info:a,seen_state_error:r,seen_state_cursor:o}=s[0];if(r)if(n)g.discontinueSeenStateInfo(t);else{if("no_permission"===i.Union.parse(r).type)return;H(t)}else{for(const e of a.seen_states)e.seen_state_user.sharing_access_type=this.convertToUnion(e.seen_state_user.sharing_access_type),e.platform_type=this.parseSeenStatePassPlatform(e.platform_type);n?g.updateSeenStateInfoContinue(t,a,o):g.updateSeenStateInfo(t,a,o)}}static fetchSeenStateInfo(e,t,i,a,r){return n.__awaiter(this,void 0,void 0,(function*(){let n;r&&w.record(s.LoggingActions.SEEN_STATE_BEGIN,r);try{n=yield(new s.UserApiV2Client).ns("seen_state").rpc("get_seen_state_info",{file_infos:[j(t,a)],limit:i},{subjectUserId:e.id})}catch(e){return void H(t)}let o=!0;const{seen_state_info:c,seen_state_error:_}=n[0];o=!(!c||_),g.updatePermissions(t,{canReadSeenState:o}),o||g.updateSeenStateUnavailable(e.id,t),o&&r&&w.record(s.LoggingActions.SEEN_STATE_RECEIVE,r),this.processAndUpdateSeenStateInfo(e,t,n,!1),o&&this.fetchRemainingSeenStateInfo(e,t,n,a)}))}static fetchRemainingSeenStateInfo(e,t,s,n){const i=s[0].seen_state_cursor;if(i&&i.has_next){const s=i.cursor_state;s&&this.fetchSeenStateInfoContinue(e,t,s,1e5,n)}}static fetchSeenStateInfoContinue(e,t,i,a,r){return n.__awaiter(this,void 0,void 0,(function*(){let n;try{n=yield(new s.UserApiV2Client).ns("seen_state").rpc("get_seen_state_info/continue",{file_infos:[j(t,r)],cursor:i,limit:a},{subjectUserId:e.id})}catch(e){return void g.discontinueSeenStateInfo(t)}this.processAndUpdateSeenStateInfo(e,t,n,!0)}))}static updateSeenStateOnResign(e,t,n,a,r,o){const c=x.create(n);return function(e,t,n,a,r){return e?t(new s.UserApiV2Client(r).ns("seen_state"),a,{subjectUserId:e.id}):n(new i.NoAuthApiV2Client(r).ns("seen_state"),a,{})}(e,((e,t,s)=>e.rpc("update_timestamps_and_mark_offline",t,s)),((e,t,s)=>e.rpc("logged_out/mark_offline",t,s)),{beacon_infos:[{beacon_user_id:a,context:o,shared_link_url:t.url,identifier:r}]},c)}}const V="online";function G(e){g.resetPassInfo(e),g.fetchPassError(e)}class q{static resetClassState(){delete this.receiverData,delete this.transmitterData,delete this.lastFileIdForReceiverTokenRequest,delete this.lastFileIdForTransmitterTokenRequest}static shutdown({beaconFileData:e,user:t,async:n,shouldWritePresence:i=!0}){if(delete this.lastFileIdForReceiverTokenRequest,delete this.lastFileIdForTransmitterTokenRequest,this.transmitterData){const{beaconUserId:a,context:r,identifier:o}=this.transmitterData;this.transmitterData.transmitter.stop(),delete this.transmitterData,!s.Viewer.get_viewer().is_assume_user_session&&i&&B.updateSeenStateOnResign(t,e,n,a,o,r)}this.receiverData&&this.receiverData.receiver&&(this.receiverData.receiver.stop(),delete this.receiverData)}static receiveBeaconData({beaconFileData:e,user:t,passSessionId:i,onUpdate:a}){return n.__awaiter(this,void 0,void 0,(function*(){const{fileId:n}=e;i&&w.record(s.LoggingActions.RECEIVER_TOKEN_BEGIN,i),this.lastFileIdForReceiverTokenRequest=n;const r=yield this.fetchReceiverToken(t,e);if(this.lastFileIdForReceiverTokenRequest!==n)return;if(r.beacon_presence_error)return g.updatePermissions(n,{canReadPresence:!1}),void("no_permission"===r.beacon_presence_error[".tag"]||G(n));g.updatePermissions(n,{canReadPresence:!0}),i&&w.record(s.LoggingActions.RECEIVER_TOKEN_RECEIVE,i);const o=[new M(P,t.account_id,this.APP,r.beacon_presence_info.context,r.beacon_presence_info.token)];this.receiverData&&this.receiverData.receiver&&this.receiverData.receiver.stop(),this.receiverData={authKey:r.beacon_presence_info.auth_key,receiver:new k(o,(n=>{i&&w.record(s.LoggingActions.PRESENCE_RECEIVE,i);const r=this.parseBeaconUpdates(n[0]);a(r,t.id,e)}),(()=>this.receiveBeaconData({user:t,beaconFileData:e,passSessionId:i,onUpdate:a}))),context:r.beacon_presence_info.context},this.receiverData.receiver.start()}))}static fetchReceiverToken(e,t){const{fileId:n,url:i}=t,a={file_info:K(n,i)};return(new s.UserApiV2Client).ns("file_presence").rpc("get_pass_receiver_token",a,{subjectUserId:e.id})}static isOnline(e){return e&&this.HARMONY_ONLINE_STATUSES.includes(e)||e===V}static parseBeaconUpdates(e){const t={},s={},n="delta"in e?"delta":"snapshot",i="delta"in e&&e.delta?e.delta:"snapshot"in e&&e.snapshot?e.snapshot:[];for(const e of i){const n=e.agent,i=n.user_id,a=n.source.identifier;this.isOnline(e.status)?(i in t||(t[i]={}),t[i][a]=!0):(i in s||(s[i]={}),s[i][a]=!0)}return{onlineUniqueUsers:t,offlineUniqueUsers:s,type:n}}static transmitBeaconData({user:e,passSessionId:t,beaconFileData:i,prevBeaconFileData:a}){return n.__awaiter(this,void 0,void 0,(function*(){const{fileId:n}=i;this.transmitterData&&a&&(this.transmitterData.transmitter.add_or_update_agents([this.getAgentStatusForFile(this.transmitterData.beaconUserId,this.transmitterData.identifier,this.transmitterData.authKey,this.transmitterData.context,"")]),setTimeout((()=>{this.transmitterData.transmitter.stop()}),1)),t&&w.record(s.LoggingActions.TRANSMITTER_TOKEN_BEGIN,t),this.lastFileIdForTransmitterTokenRequest=n;const r=yield this.fetchTransmitterToken(e,i);if(this.lastFileIdForTransmitterTokenRequest===n){if(r.beacon_presence_error)return g.updatePermissions(n,{canWritePresence:!1}),void("no_permission"===r.beacon_presence_error[".tag"]||G(n));g.updatePermissions(n,{canWritePresence:!0}),t&&w.record(s.LoggingActions.TRANSMITTER_TOKEN_RECEIVE,t),this.transmitterData={identifier:s.UUID.v4({allowInsecure:!0}),beaconUserId:r.beacon_presence_info.beacon_user_id,authKey:r.beacon_presence_info.auth_key,transmitter:new y(r.beacon_presence_info.token,(()=>this.transmitBeaconData({user:e,passSessionId:t,beaconFileData:i,prevBeaconFileData:null}))),context:r.beacon_presence_info.context},this.transmitterData.transmitter.add_or_update_agents([this.getAgentStatusForFile(this.transmitterData.beaconUserId,this.transmitterData.identifier,this.transmitterData.authKey,this.transmitterData.context,V)]),this.transmitterData.transmitter.start()}}))}static getAgentStatusForFile(e,t,s,n,i){const a=new N(this.PLATFORM,this.SURFACE,t),r=new R(e,this.APP,n,a);return new O(r,i,s)}static fetchTransmitterToken(e,t){const{fileId:n,url:r}=t,o={file_info:K(n,r)};return e||r||a.reportStack("For logged out user URL is needed for get_pass_transmitter_token",{tags:["file_presence","file_presence_js"],severity:"non-critical"}),e?(new s.UserApiV2Client).ns("file_presence").rpc("get_pass_transmitter_token",o,{subjectUserId:e.id}):(new i.NoAuthApiV2Client).ns("file_presence").rpc("logged_out/get_pass_transmitter_token",o,{})}}function K(e,t){return t?{".tag":"shared_link_details",url:t}:{".tag":"file_identifier",file_identifier:e}}q.APP="harmony",q.PLATFORM=C.WEB,q.SURFACE="file_viewer",q.HARMONY_ONLINE_STATUSES=["modifier","viewer"];class W{constructor(e,t){this.isLoaded=e,this.data=t}static create(e){return new W(!0,e)}static createNotLoaded(){return new W(!1,null)}}class ${constructor(e,t){this.fileId=e,this.url=t}}const Q=c.withActionNamespace("share-modal-actions",{SHARE_MODAL_OPEN:"share-modal-open",SHARE_MODAL_CLOSE:"share-modal-close",RESET_MODAL_STATE:"reset-modal-state",OPEN_LINK_SETTINGS_MODAL:"open-link-settings-modal",OPEN_FOLDER_SETTINGS_MODAL:"open-folder-settings-modal",OPEN_SHARED_LINK_MODAL:"open-shared-link-modal",CLOSE_LINK_SETTINGS_MODAL:"close-link-settings-modal",CLOSE_FOLDER_SETTINGS_MODAL:"close-folder-settings-modal",CLOSE_SHARED_LINK_MODAL:"close-shared-link-modal",CLEAR_METADATA:"clear-metadata",FETCH_METADATA_REQUEST:"metadata-request",FETCH_METADATA_SUCCESS:"metadata-success",FETCH_METADATA_FAILURE:"metadata-failure",CLEAR_LINK_METADATA:"clear-link-metadata",FETCH_LINK_METADATA_REQUEST:"link-metadata-request",FETCH_LINK_METADATA_SUCCESS:"link-metadata-success",FETCH_LINK_METADATA_FAILURE:"link-metadata-failure",CLEAR_SHARING_PREFS:"clear-sharing-prefs",FETCH_SHARING_PREFS_REQUEST:"sharing-prefs-request",FETCH_SHARING_PREFS_SUCCESS:"sharing-prefs-success",FETCH_SHARING_PREFS_FAILURE:"sharing-prefs-failure",ERROR_MESSAGE:"error-message",ERROR_MESSAGE_CLEAR:"error-message-clear",CLEAR_FILE_MEMBERSHIP:"clear-file-membership",FETCH_FILE_MEMBERSHIP_REQUEST:"fetch-file-membership-request",FETCH_FILE_MEMBERSHIP_SUCCESS:"fetch-file-membership-success",FETCH_FILE_MEMBERSHIP_FAILURE:"fetch-file-membership-failure",CLEAR_FOLDER_MEMBERSHIP:"clear-folder-membership",FETCH_FOLDER_MEMBERSHIP_REQUEST:"fetch-folder-membership-request",FETCH_FOLDER_MEMBERSHIP_SUCCESS:"fetch-folder-membership-success",FETCH_FOLDER_MEMBERSHIP_FAILURE:"fetch-folder-membership-failure",FETCH_USER_ACCOUNTS_REQUEST:"fetch-user-accounts-request",FETCH_USER_ACCOUNTS_SUCCESS:"fetch-user-accounts-success",FETCH_USER_ACCOUNTS_FAILURE:"fetch-user-accounts-failure",FETCH_USER_ACCOUNTS_CONTINUED_REQUEST:"fetch-user-accounts-continued-request",FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS:"fetch-user-accounts-continued-success",CLEAR_FILE_MEMBERSHIP_LAST_SEEN_INFO:"clear-file-membership-last-seen-info",FETCH_FILE_MEMBER_COUNT_REQUEST:"fetch-file-member-count-request",FETCH_FILE_MEMBER_COUNT_SUCCESS:"fetch-file-member-count-success",CHANGE_RECIPIENTS:"change-recipients",CHANGE_RECIPIENT_MESSAGE:"change-recipient-message",APPEND_TO_RECIPIENT_MESSAGE:"append-to-recipient-message",CHANGE_RECIPIENT_ACCESS:"change-recipient-access",CHANGE_LINK_RECIPIENT_ACCESS:"change-link-recipient-access",CHANGE_EMAIL_RECIPIENT_ACCESS:"change-email-recipient-access",UPDATE_RECIPIENT_VALIDATION:"update-recipient-validation",CREATE_LINK_REQUEST:"create-link-request",CREATE_LINK_SUCCESS:"create-link-success",CREATE_LINK_FAILURE:"create-link-failure",DISPLAY_CONTENT_NAME_INFO:"display-content-name-info",SEND_SHARE_REQUEST:"send-share-request",SEND_SHARE_SUCCESS:"send-share-success",SEND_SHARE_FAILURE:"send-share-failure",SHARE_FOLDER_REQUEST:"share-folder-request",SHARE_FOLDER_SUCCESS:"share-folder-success",SHARE_FOLDER_FAILURE:"share-folder-failure",SEND_FOLDER_SHARE_REQUEST:"send-folder-share-request",SEND_FOLDER_SHARE_SUCCESS:"send-folder-share-success",SEND_FOLDER_SHARE_FAILURE:"send-folder-share-failure",CHANGE_MEMBER_ACCESS_REQUEST:"change-member-access-request",CHANGE_MEMBER_ACCESS_SUCCESS:"change-member-access-success",CHANGE_MEMBER_ACCESS_FAILURE:"change-member-access-failure",MEMBER_ACTION_PENDING:"member-action-pending",MEMBER_ACTION_COMPLETE:"member-action-complete",REMOVE_MEMBER_SUCCESS:"remove-member-success",REMOVE_MEMBER_KEEP_ACCESS:"remove-member-keep-access",TRANSFER_OWNER_SUCCESS:"transfer-owner-success",FETCH_CURRENT_ACCOUNT_REQUEST:"fetch-current-account-request",FETCH_CURRENT_ACCOUNT_SUCCESS:"fetch-current-account-success",FETCH_MEMBER_COUNTS_REQUEST:"fetch-member-counts-request",FETCH_MEMBER_COUNTS_SUCCESS:"fetch-member-counts-success",HANDLE_CONTENT_NAME_CHANGE:"handle-content-name-change",VALIDATE_CONTENT_NAME_SUCCESS:"validate-content-name-success",VALIDATE_CONTENT_NAME_ERROR:"validate-content-name-error",CHANGE_LINK_AUDIENCE_REQUEST:"change-link-audience-request",CHANGE_LINK_AUDIENCE_SUCCESS:"change-link-audience-success",CHANGE_LINK_AUDIENCE_FAILURE:"change-link-audience-failure",UNBLOCK_MEMBER_LIST_ON_PASS_LOAD:"unblock-member-list-on-pass-load",UPDATE_SHARING_SETTINGS_SUCCESS:"update-sharing-settings-success",DELETE_LINK_METADATA_SUCCESS:"delete-link-metadata-success",CHANGE_CREATE_COMMENT_CHECKBOX:"change-create-comment-checkbox",SET_UPSELL_COUNTER_PREF:"set-upsell-counter-pref",SET_UPSELL_COUNTER_PREF_SUCCESS:"set-upsell-counter-pref-success",CHANGE_LINK_AUDIENCE_SELECTION:"change-link-audience-selection",REMOVE_LINK_AUDIENCE_SELECTION:"remove-link-audience-selection",TOGGLE_SEND_APPROVAL:"toggle-send-approval",CHANGE_NEEDS_ALL_APPROVERS:"change-needs-all-approvers",CREATE_APPROVAL_REQUEST:"create-approval-request",CREATE_APPROVAL_SUCCESS:"create-approval-success",CREATE_APPROVAL_FAILURE:"create-approval-failure",TOGGLE_OPEN_AUTOMATIONS:"toggle-open-automations",UPDATE_SHARING_TASKS:"update-sharing-tasks",DOCSEND_ANALYTICS_LINK_REQUEST:"docsend-analytics-link-request",DOCSEND_ANALYTICS_LINK_SUCCESS:"docsend-analytics-link-success",DOCSEND_ANALYTICS_LINK_FAILURE:"docsend-analytics-link-failure"}),Y=c.withActionNamespace("sharing-actions",{CLEAR_EVERYTHING:"clear-everything",FETCH_METADATA_BATCH_ATTEMPT:"fetch-metadata-batch-attempt",FETCH_METADATA_BATCH_SUCCESS:"fetch-metadata-batch-success",FETCH_METADATA_BATCH_FAIL:"fetch-metadata-batch-fail"});function X(e){const t=(e.isFolder?e.targetNsId:e.fileId)||e.fqPath;if(null===t)throw new Error("Not enough fields provided for extras");return t}class z extends(s.immutable.exports.Record({extras:null,id:null},"ContentInfo")){static createFromParams(e){const t=new J(e);return new z({extras:t,id:X(t)})}setNsId(e){const t=this.setIn(["extras","targetNsId"],e);return t.set("id",X(t.extras))}setFQPath(e){const t=this.setIn(["extras","fqPath"],e);return t.set("id",X(t.extras))}isFolder(){return this.extras.isFolder}isFile(){return!this.isFolder()}isFileFolder(){return this.isFolder()&&!this.isSharedFolder()}isSharedFolder(){return Boolean(this.extras.targetNsId)}isTeamSharedFolder(){return this.extras.isTeamSharedFolder}isFolderInsideTeamFolderTree(){return this.extras.isFolderInsideTeamFolderTree}isInSharedFolder(){return Boolean(this.extras.nsId&&this.extras.nsId!==this.extras.userHomeNs)}isNestedSharedFolder(){return this.isInSharedFolder()&&this.isSharedFolder()}isMounted(){return!this.extras.url}url(){return this.extras.url}pathExists(){return Boolean(this.extras.exists)}name(){return this.displayPath()?this.displayPath().split("/").pop():this.filename()}idForLink(){const e=this.extras.fileId||this.extras.fqPath;if(!e)throw new Error("No identifiers for getting links");return e}sharedFolderId(){const e=this.extras.targetNsId;if(!e)throw new Error("No shared folder ID");return e}displayPath(){return this.extras.fqPath}fileId(){return this.extras.fileId}filename(){return this.extras.filename}nsId(){if(!this.extras.nsId)throw new Error("Can't determine nsId");return this.extras.nsId}nsPath(){if(null===this.extras.nsPath)throw new Error("Can't determine nsPath");return this.extras.nsPath}sjid(){return this.extras.sjid}teamGroupInfo(){return this.extras&&this.extras.teamGroupInfo}}class J extends(s.immutable.exports.Record({exists:!0,fileId:null,filename:null,fqPath:null,isFolder:null,isTeamSharedFolder:!1,isFolderInsideTeamFolderTree:!1,modalSessionId:null,nsId:null,nsPath:null,origin:null,sjid:null,targetNsId:null,url:null,userHomeNs:null,teamGroupInfo:null},"ContentInfoExtras")){}var Z,ee,te,se,ne,ie,ae;!function(e){e[e.NO_MEMBERS=0]="NO_MEMBERS",e[e.INPUT_CONTENT_NAME=1]="INPUT_CONTENT_NAME"}(Z||(Z={})),e.CONTENT_NAME_MESSAGE_LEVELS=void 0,(ee=e.CONTENT_NAME_MESSAGE_LEVELS||(e.CONTENT_NAME_MESSAGE_LEVELS={}))[ee.INFO=0]="INFO",ee[ee.ERROR=1]="ERROR",e.FETCH_METADATA_STATUS=void 0,(te=e.FETCH_METADATA_STATUS||(e.FETCH_METADATA_STATUS={}))[te.FETCHING=0]="FETCHING",te[te.SUCCESS=1]="SUCCESS",te[te.FAIL=2]="FAIL",e.LinkabilityStates=void 0,(se=e.LinkabilityStates||(e.LinkabilityStates={})).CAN_LINK="CAN_LINK",se.INVITE_NO_LINK="INVITE_NO_LINK",se.NO_INVITE_NO_LINK="NO_INVITE_NO_LINK",se.CANT_LINK_TEAM_FOLDER="CANT_LINK_TEAM_FOLDER",se.ERROR_FETCHING_LINK_INFO="ERROR_FETCHING_LINK_INFO",e.MODES=void 0,(ne=e.MODES||(e.MODES={})).LINK_ONLY="link-only",ne.LOADING="loading",ne.MEMBERSHIP="membership",ne.POINTER="pointer",ne.SHARE="share",ne.SHARE_SENDING="share-sending",ne.EVOLUTION="evolution",e.LINK_ONLY_REASON=void 0,(ie=e.LINK_ONLY_REASON||(e.LINK_ONLY_REASON={})).INSIDE_SHARED_FOLDER="inside_shared_folder",ie.CONTAINS_SHARED_FOLDER="contains_shared_folder",ie.LINKS_PAGE="links_page",ie.TOTAL_MOUNTS_EXCEEDED="total_mounts_exceeded",ie.HOME_MOUNTS_EXCEEDED="home_mounts_exceeded",ie.TREE_SIZE_EXCEEDED="tree_size_exceeded",e.NS_LIMIT_ERROR=void 0,(ae=e.NS_LIMIT_ERROR||(e.NS_LIMIT_ERROR={})).TOTAL_MOUNTS_EXCEEDED="total_mounts_exceeded",ae.HOME_MOUNTS_EXCEEDED="home_mounts_exceeded",ae.TREE_SIZE_EXCEEDED="tree_size_exceeded";const re=u.intl.formatMessage({id:"mYGncD",defaultMessage:"Name your shared folder"});var oe;r.values(e.MODES),r.values(Z),r.values(e.CONTENT_NAME_MESSAGE_LEVELS),e.LINK_CREATION_SURFACE=void 0,(e.LINK_CREATION_SURFACE||(e.LINK_CREATION_SURFACE={})).COPY_OR_CREATE_LINK_SECTION="COPY_OR_CREATE_LINK_SECTION",e.EXP_LINK_IN_MEMBER_LIST_VARIANT=void 0,(oe=e.EXP_LINK_IN_MEMBER_LIST_VARIANT||(e.EXP_LINK_IN_MEMBER_LIST_VARIANT={})).ON="ON",oe.OFF="OFF",oe.CONTROL="CONTROL";const ce={canRelinquishMembership:!1,contentInfo:z.createFromParams({fqPath:"",isFolder:!1}),contentNameInputValue:"",contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.INFO,initialProps:{},initialRecipientTokens:[],isContentNameFocused:!1,pendingMemberAction:s.immutable.exports.Set(),recipientMessage:"",recipientRawInput:"",recipientTokens:[],recipientValidation:{},linkRecipientAccess:void 0,emailRecipientAccess:void 0,referrer:"",shareAsConfidential:!1,uiMode:e.MODES.MEMBERSHIP,fetchMetadataStatus:e.FETCH_METADATA_STATUS.FETCHING,sendApproval:!1,needsAllApprovers:!0,creatingApprovalRequest:!1,automationOptionChecked:!1,sharingTasks:["save_copy"],docsendAnalyticsLink:{status:"initial"}};function _e(e,t){return t.shared_folder_id?e.setNsId(t.shared_folder_id):e}const he={areMembersFullyLoaded:!1,areSharingPrefsLoaded:!1,hasDisplayableMembers:!1,isLinkMetadataLoaded:!1,isCurrentAccountLoaded:!1,shouldBlockMemberListOnPassLoad:!0,memberCounts:new s.MemberCounts,members:new s.SharingMembership,sharingPrefs:new s.SharingPrefs,sharedLinks:[],selectedAudienceByAccessLevel:{}};function ue(e,t){const s=e.metadata,n=t.permissions||s&&s.permissions;return t.set("permissions",n)}const de=e=>[e.shared_folder_id,e.id,e.path_lower].filter((e=>!!e)),le=(e,t)=>((t=String(t)).startsWith("id:")||(t=t.toLowerCase()),`${e}::${t}`);class Ee extends h.Store{constructor(){super(),this.sharingInfoMap={}}getSharingInfo(e,t){return t?this.sharingInfoMap[le(e,t)]:null}mapContentIdsToSharingInfo(e,t,s){for(const n of t)n&&(this.sharingInfoMap[le(e,n)]=s)}_new_payload(e){if(e&&e.action&&e.action.type)switch(e.action.type){case Y.CLEAR_EVERYTHING:this.sharingInfoMap={};break;case Y.FETCH_METADATA_BATCH_SUCCESS:{const t=e.action.user;e.action.data.forEach((e=>{this._new_payload_for_single_content(Q.FETCH_METADATA_SUCCESS,t,de(e),{metadata:e})})),this.emit_change();break}default:if(!e.action.contentIds)return;this._new_payload_for_single_content(e.action.type,e.action.user,e.action.contentIds,e.action.data),this.emit_change()}}_new_payload_for_single_content(t,n,i,a){let r;l.assert(Boolean(n.id),"valid user needed"),l.assert(i.length>0,"contentIds cannot be empty");for(const e of i){const t=le(n.id,e);if(t in this.sharingInfoMap){r=this.sharingInfoMap[t];break}}r||(r=new Ie(n));const o={type:t,payload:a,user:n};return r.setState(((t,n)=>{const i=n.payload;switch(n.type){case Q.CHANGE_CREATE_COMMENT_CHECKBOX:return Object.assign(Object.assign({},t),{isShareMessageAsCommentExplicitlyChecked:i.checked});case Q.CHANGE_RECIPIENTS:{const s=i.recipientTokens,n=i.recipientRawInput;let a=t.uiMode;return s.length>0||n.length>0?a===e.MODES.MEMBERSHIP&&(a=e.MODES.SHARE):a===e.MODES.SHARE&&(a=e.MODES.MEMBERSHIP),Object.assign(Object.assign({},t),{recipientTokens:s,recipientRawInput:n,uiMode:a})}case Q.CHANGE_RECIPIENT_ACCESS:return Object.assign(Object.assign({},t),{recipientAccess:i.newAccess});case Q.CHANGE_LINK_RECIPIENT_ACCESS:return Object.assign(Object.assign({},t),{linkRecipientAccess:i.newAccess});case Q.CHANGE_EMAIL_RECIPIENT_ACCESS:return Object.assign(Object.assign({},t),{emailRecipientAccess:i.newAccess});case Q.CHANGE_RECIPIENT_MESSAGE:return Object.assign(Object.assign({},t),{recipientMessage:i.message});case Q.APPEND_TO_RECIPIENT_MESSAGE:const n=t.recipientMessage,a=i.messageToAppend;return Object.assign(Object.assign({},t),{recipientMessage:0===n.length?a:n+"\n"+a});case Q.UPDATE_RECIPIENT_VALIDATION:const r=i.recipientValidation,o=i.resetCurrentValidations?{}:t.recipientValidation,c={};return s.ACCESS_VALUES.forEach((e=>{const t=o[e]||{},s=r[e]||{};c[e]=Object.assign(Object.assign({},t),s)})),Object.assign(Object.assign({},t),{recipientValidation:c});case Q.FETCH_METADATA_FAILURE:return Object.assign(Object.assign({},t),{uiMode:e.MODES.LINK_ONLY,linkOnlyReason:t.linkOnlyReason!==e.LINK_ONLY_REASON.LINKS_PAGE?i.reason:t.linkOnlyReason,fetchMetadataStatus:e.FETCH_METADATA_STATUS.FAIL,countsExceedNsLimit:i.countExceedNsLimit});case Q.FETCH_METADATA_SUCCESS:{const n=i.metadata,a=n.path_lower&&s.isPointerByExtension(n.path_lower)?e.MODES.POINTER:t.uiMode;return Object.assign(Object.assign({},t),{uiMode:a,contentInfo:_e(t.contentInfo,n),fetchMetadataStatus:e.FETCH_METADATA_STATUS.SUCCESS})}case Q.HANDLE_CONTENT_NAME_CHANGE:return Object.assign(Object.assign({},t),{contentNameInputValue:i.name,contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.INFO,contentNameMessage:""===i.name?re:void 0});case Q.HANDLE_CONTENT_NAME_FOCUS_CHANGE:return Object.assign(Object.assign({},t),{isContentNameFocused:i.focus});case Q.MEMBER_ACTION_COMPLETE:return Object.assign(Object.assign({},t),{pendingMemberAction:t.pendingMemberAction.delete(i.member.memberKey())});case Q.MEMBER_ACTION_PENDING:return Object.assign(Object.assign({},t),{pendingMemberAction:t.pendingMemberAction.add(i.member.memberKey())});case Q.REMOVE_MEMBER_KEEP_ACCESS:case Q.REMOVE_MEMBER_SUCCESS:return Object.assign(Object.assign({},t),{pendingMemberAction:t.pendingMemberAction.delete(i.member.memberKey())});case Q.SEND_SHARE_FAILURE:return Object.assign(Object.assign({},t),{uiMode:e.MODES.SHARE});case Q.SEND_SHARE_REQUEST:return Object.assign(Object.assign({},t),{uiMode:e.MODES.SHARE_SENDING});case Q.SEND_SHARE_SUCCESS:return Object.assign(Object.assign({},t),{uiMode:e.MODES.SHARE});case Q.SHARE_FOLDER_SUCCESS:return Object.assign(Object.assign({},t),{contentInfo:_e(t.contentInfo,i.metadata)});case Q.SHARE_MODAL_OPEN:{const n=i.shareModalInfoAttrs.contentInfo,a=i.shareModalInfoAttrs.inLinksPage,r=n.isFolder()&&!n.pathExists(),o=r&&!i.initialProps.initialContentName;let c,_=ce.uiMode;return s.isPointerByExtension(n.displayPath()||"")?_=e.MODES.POINTER:r?_=e.MODES.SHARE:a&&(_=e.MODES.LINK_ONLY,c=e.LINK_ONLY_REASON.LINKS_PAGE),Object.assign(Object.assign({},t),{contentInfo:n,linkOnlyReason:c,uiMode:_,contentNameInputValue:i.initialProps.initialContentName,contentNameMessage:o?re:"",initialProps:i.initialProps,initialRecipientTokens:i.shareModalInfoAttrs.initialRecipientTokens||[],isContentNameFocused:o,onCreateGroupCallback:i.initialProps.onCreateGroupCallback,recipientAccess:i.initialProps.defaultRecipientAccessLevel||void 0,recipientMessage:i.initialProps.recipientMessage||"",recipientTokens:[],recipientValidation:{},linkRecipientAccess:void 0,emailRecipientAccess:void 0,referrer:i.initialProps.referrer,experiments:i.initialProps.experiments,sendApproval:!1,needsAllApprovers:!0,creatingApprovalRequest:!1,automationOptionChecked:i.initialProps.automationOptionChecked||!1})}case Q.SHARE_MODAL_CLOSE:return Object.assign(Object.assign({},t),{initialRecipientTokens:i.tokens||t.initialRecipientTokens||[]});case Q.VALIDATE_CONTENT_NAME_ERROR:return Object.assign(Object.assign({},t),{contentNameMessage:i.errorMsg,contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.ERROR});case Q.VALIDATE_CONTENT_NAME_SUCCESS:return Object.assign(Object.assign({},t),{contentInfo:t.contentInfo.setFQPath(i.newFolderPath)});case Q.TOGGLE_SEND_APPROVAL:return Object.assign(Object.assign({},t),{sendApproval:!t.sendApproval});case Q.CHANGE_NEEDS_ALL_APPROVERS:return Object.assign(Object.assign({},t),{needsAllApprovers:i.needsAllApprovers});case Q.CREATE_APPROVAL_REQUEST:return Object.assign(Object.assign({},t),{creatingApprovalRequest:!0});case Q.CREATE_APPROVAL_SUCCESS:case Q.CREATE_APPROVAL_FAILURE:return Object.assign(Object.assign({},t),{creatingApprovalRequest:!1});case Q.TOGGLE_OPEN_AUTOMATIONS:return Object.assign(Object.assign({},t),{automationOptionChecked:!t.automationOptionChecked});case Q.UPDATE_SHARING_TASKS:return Object.assign(Object.assign({},t),{sharingTasks:i.sharingTasks});case Q.DOCSEND_ANALYTICS_LINK_REQUEST:return Object.assign(Object.assign({},t),{docsendAnalyticsLink:{status:"loading"}});case Q.DOCSEND_ANALYTICS_LINK_SUCCESS:return Object.assign(Object.assign({},t),{docsendAnalyticsLink:{status:"ready",linkData:i.linkData}});case Q.DOCSEND_ANALYTICS_LINK_FAILURE:return Object.assign(Object.assign({},t),{docsendAnalyticsLink:{status:"error"}});default:return t}})(r.modalInfoState(),o),((e=he,t)=>{const n=t.payload;switch(t.type){case Q.CHANGE_MEMBER_ACCESS_FAILURE:return Object.assign(Object.assign({},e),{members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.prevAccess)});case Q.CHANGE_MEMBER_ACCESS_REQUEST:return Object.assign(Object.assign({},e),{members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.newAccess)});case Q.CLEAR_FILE_MEMBERSHIP_LAST_SEEN_INFO:return Object.assign(Object.assign({},e),{members:e.members.update("users",(e=>e.map((e=>e.set("time_last_seen",null)))))});case Q.CREATE_LINK_SUCCESS:return Object.assign(Object.assign({},e),{hasCreatedLink:!0,linkMetadata:n.linkMetadata,sharedLinks:e.sharedLinks.concat(n.linkMetadata)});case Q.FETCH_MEMBER_COUNTS_SUCCESS:return Object.assign(Object.assign({},e),{memberCounts:n.memberCounts});case Q.FETCH_METADATA_FAILURE:return Object.assign(Object.assign({},e),{fetchingMetadataPromise:void 0});case Q.FETCH_METADATA_REQUEST:return Object.assign(Object.assign({},e),{fetchingMetadataPromise:n.promise});case Q.FETCH_METADATA_SUCCESS:return Object.assign(Object.assign({},e),{metadata:ue(e,n.metadata),fetchingMetadataPromise:void 0});case Q.FETCH_SHARING_PREFS_REQUEST:return Object.assign({},e);case Q.FETCH_SHARING_PREFS_SUCCESS:return Object.assign(Object.assign({},e),{areSharingPrefsLoaded:!0,sharingPrefs:n.sharingPrefs});case Q.FETCH_LINK_METADATA_FAILURE:return Object.assign(Object.assign({},e),{isLinkMetadataLoaded:!0,linkMetadata:void 0,sharedLinks:[]});case Q.FETCH_LINK_METADATA_SUCCESS:return Object.assign(Object.assign({},e),{isLinkMetadataLoaded:!0,linkMetadata:n.sharedLinks.length>0?n.sharedLinks[0]:null,sharedLinks:n.sharedLinks,selectedAudienceByAccessLevel:{}});case Q.DELETE_LINK_METADATA_SUCCESS:{const t=[];for(const s of e.sharedLinks)s.url!==n.deletedLink.url&&t.push(s);return Object.assign(Object.assign({},e),{hasCreatedLink:!1,hasIncrementedUpsellCounter:!1,linkMetadata:t[0]?t[0]:null,sharedLinks:t})}case Q.FETCH_USER_ACCOUNTS_REQUEST:return Object.assign(Object.assign({},e),{fetchingMembersRequest:{limitNonNull:n.limitNonNull,promise:n.promise,requestId:n.requestId}});case Q.FETCH_USER_ACCOUNTS_SUCCESS:return e.fetchingMembersRequest&&e.fetchingMembersRequest.requestId!==n.requestId||e.hasDisplayableMembers&&e.fetchingMembersRequest&&e.fetchingMembersRequest.limitNonNull<e.members.getMemberCount()?e:Object.assign(Object.assign({},e),{hasDisplayableMembers:!0,areMembersFullyLoaded:!n.members.cursor,fetchingMembersRequest:n.members.cursor?e.fetchingMembersRequest:void 0,members:n.members});case Q.FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS:return e.fetchingMembersRequest&&e.fetchingMembersRequest.requestId!==n.requestId?e:Object.assign(Object.assign({},e),{areMembersFullyLoaded:!n.members.cursor,fetchingMembersRequest:n.members.cursor?e.fetchingMembersRequest:void 0,members:e.members.mergeDeep(n.members)});case Q.FETCH_CURRENT_ACCOUNT_REQUEST:return Object.assign(Object.assign({},e),{isCurrentAccountLoaded:!1});case Q.FETCH_CURRENT_ACCOUNT_SUCCESS:return Object.assign(Object.assign({},e),{isCurrentAccountLoaded:!0,isFamilyUser:n.isFamilyUser,teamPolicy:n.teamPolicy});case Q.FETCH_FILE_MEMBER_COUNT_SUCCESS:return Object.assign(Object.assign({},e),{memberCounts:new s.MemberCounts({total_unique_users:n.count,users_outside_team:0,exceeds_count:n.exceeds_limit})});case Q.REMOVE_MEMBER_KEEP_ACCESS:return Object.assign(Object.assign({},e),{members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.access)});case Q.REMOVE_MEMBER_SUCCESS:return Object.assign(Object.assign({},e),{members:e.members.deleteIn([n.member.type(),n.member.memberKey()])});case Q.SHARE_FOLDER_FAILURE:return Object.assign(Object.assign({},e),{shareFolderPromise:void 0});case Q.SHARE_FOLDER_REQUEST:return Object.assign(Object.assign({},e),{shareFolderPromise:n.promise});case Q.SHARE_FOLDER_SUCCESS:return Object.assign(Object.assign({},e),{metadata:ue(e,n.metadata),shareFolderPromise:n.promise});case Q.TRANSFER_OWNER_SUCCESS:return Object.assign(Object.assign({},e),{metadata:void 0,isLinkMetadataLoaded:!1,hasDisplayableMembers:!1});case Q.UNBLOCK_MEMBER_LIST_ON_PASS_LOAD:return Object.assign(Object.assign({},e),{shouldBlockMemberListOnPassLoad:!1});case Q.UPDATE_SHARING_SETTINGS_SUCCESS:return Object.assign(Object.assign({},e),{metadata:ue(e,n.metadata)});case Q.SET_UPSELL_COUNTER_PREF_SUCCESS:return Object.assign(Object.assign({},e),{hasIncrementedUpsellCounter:!0});case Q.CHANGE_LINK_AUDIENCE_SELECTION:const t=e.selectedAudienceByAccessLevel;return t[n.accessLevel]=n.audience,Object.assign(Object.assign({},e),{selectedAudienceByAccessLevel:t});case Q.REMOVE_LINK_AUDIENCE_SELECTION:if(e.selectedAudienceByAccessLevel){const t=Object.keys(e.selectedAudienceByAccessLevel).reduce(((t,s)=>(e.selectedAudienceByAccessLevel&&s!==n.accessLevel&&(t[s]=e.selectedAudienceByAccessLevel[s]),t)),{});return Object.assign(Object.assign({},e),{selectedAudienceByAccessLevel:t})}return e;case Q.SHARE_MODAL_OPEN:return Object.assign(Object.assign({},e),{selectedAudienceByAccessLevel:{}});default:return e}})(r.sharingInfoState(),o)),i.push(r.fqPath()),this.mapContentIdsToSharingInfo(n.id,i,r),r}}const Se=new Ee;class pe{constructor(e){this.change_options=r.get(e,"change_options.allow",!1),this.edit_contents=r.get(e,"edit_contents.allow",!1),this.invite_editor=r.get(e,"invite_editor.allow",!1),this.invite_viewer=r.get(e,"invite_viewer.allow",!1),this.relinquish_membership=r.get(e,"relinquish_membership.allow",!1),this.leave_a_copy=r.get(e,"leave_a_copy.allow",!1),this.create_edit_link=r.get(e,"create_edit_link.allow"),this.create_view_link=r.get(e,"create_view_link.allow",!1),this.unshare=r.get(e,"unshare.allow",!1),this.update_confidentiality=r.get(e,"update_confidentiality.allow",!1),this.is_file_permissions=e instanceof s.FilePermissions,this.share_message_as_comment=r.get(e,"share_message_as_comment.allow",!1)}canChangeOptions(){return this.change_options}canEdit(){return this.edit_contents}canInviteEditor(){return this.invite_editor}canInviteViewer(){return this.invite_viewer}canInvite(){return this.canInviteViewer()||this.canInviteEditor()}canRelinquishMembership(){return this.relinquish_membership}canCreateEditLink(){return this.is_file_permissions&&this.create_edit_link}canCreateViewLink(){return this.is_file_permissions&&this.create_view_link}canUnshare(){return this.unshare}canUpdateConfidentiality(){return this.update_confidentiality}canLeaveACopy(){return this.leave_a_copy}canShareMessageAsComment(){return this.share_message_as_comment}}class Ie{constructor(e){this._user=e,this.setState(ce,he)}static createFromParams(e){return new Ie(e)}setState(e,t){this._modalInfo=e,this._sharingInfoState=t,t.metadata&&Se.mapContentIdsToSharingInfo(this._user.id,de(t.metadata),this)}sharingInfoState(){return this._sharingInfoState}modalInfoState(){return this._modalInfo}user(){return this._user}hasDirectMemberSelf(){const e=this.members();if(e&&1===e.users.count()){return e.users.first().account_id===this._user.account_id}return!1}hasNonSelfMembers(){const e=this.members(),t=e&&e.getMemberCount();if(!t)return!1;if(1===t&&1===e.users.count()){return e.users.first().account_id!==this._user.account_id}return!0}hasNonOwnerMembers(){return this.hasNonSelfMembers()&&this.isOwner()}hasOutsideTeamMembers(){const e=this.memberCounts();return(e?e.users_outside_team:0)>0}memberNum(){const e=this.memberCounts(),t=this.members();return e&&e.total_unique_users?e.total_unique_users:t?t.getMemberCount():void 0}memberCountWithRecipients(){return(this.memberNum()||0)+d.getMemberCountForTokens(this.recipientTokens())}getInitialProps(){return this.modalInfoState().initialProps}areMembersFullyLoaded(){return this.sharingInfoState().areMembersFullyLoaded}areSharingPrefsLoaded(){return this.sharingInfoState().areSharingPrefsLoaded}setSharingPrefs(e){this._sharingInfoState.sharingPrefs=e}sharingPrefs(){return this.sharingInfoState().sharingPrefs}canShareLink(){return(!this.isConfidentialFolder()||this.isConfidentialFolderLinksEnabled())&&!this.isTeamSharedFolder()&&this.contentInfo().pathExists()&&this.contentInfo().isMounted()}canDeleteLink(){const e=this.linkMetadata();return Boolean(e&&e.link_permissions.can_revoke)}contactsError(){return d.validateContacts(this.recipientTokens(),this._user,this.recipientValidation()[this.recipientAccess()]||{},this.isTeamSharedFolder(),this.isFolderInsideTeamFolderTree(),this.memberCountWithRecipients(),this.recipientAccess(),this.isFolder(),this.sharedLinks())}contentId(){return this.contentInfo().id}contentInfo(){return this.modalInfoState().contentInfo}contentNameInputValue(){return this.modalInfoState().contentNameInputValue}contentNameMessage(){return this.modalInfoState().contentNameMessage}contentNameMessageLevel(){return this.modalInfoState().contentNameMessageLevel}displayPath(){const e=this.metadata();return this.contentInfo().displayPath()||e&&e.path_display||""}parentFolderName(){const e=this.metadata();if(e&&e instanceof s.SharedFileMetadata){const t=e.path_display;if(t){const e=t.split("/");if(e.length>1)return e[e.length-2]}}return e&&e instanceof s.SharedFolderMetadata&&e.parent_folder_name||""}fetchingMembersRequest(){return this.sharingInfoState().fetchingMembersRequest}fetchingMetadataPromise(){return this.sharingInfoState().fetchingMetadataPromise}filePolicy(){const e=this.metadata();return e&&e.file_policy}folderPolicy(){const e=this.metadata();return e&&e.policy}fqPath(){return this.contentInfo().displayPath()}hasDisplayableMembers(){return this.sharingInfoState().hasDisplayableMembers}hasParentSharedFolder(){const e=this.metadata();return!!e&&e.is_inside_team_folder}initialRecipientTokens(){return this.modalInfoState().initialRecipientTokens}isNonUserRelativeContext(){return this.getInitialProps().isInContentManager}isFolder(){return this.contentInfo().isFolder()}isConfidentialFolder(){const e=this.metadata();return Boolean(e&&e.is_confidential)}isContentNameFocused(){return this.modalInfoState().isContentNameFocused}isFolderInsideTeamFolderTree(){const e=this.metadata();return!!e&&e.is_inside_team_folder}isInsideSharedFolder(){const e=this.metadata();return Boolean(e&&e.parent_shared_folder_id||this.contentInfo().isInSharedFolder())}isLinkMetadataLoaded(){return this.sharingInfoState().isLinkMetadataLoaded}isMetadataLoaded(){return Boolean(this.metadata())}isOwner(){const e=this.metadata();return Boolean(e&&e.access_type===s.ACCESS_LEVEL.OWNER)}isOSXPackage(){const e=this.displayPath(),t=e.substr(e.lastIndexOf("."));return f.PACKAGE_EXTS.indexOf(t)>=0}isConfidentialFolderLinksEnabled(){return this.sharingPrefs().confidential_folder_links_enabled}isShareModalUpsellPremiumSharing(){return this.sharingPrefs().in_share_modal_upsell_premium_sharing}shareModalUpsellPremiumSharingVariant(){return this.sharingPrefs().in_share_modal_upsell_premium_sharing_variant}hasSeenUpsellCounter(){return this.sharingPrefs().has_seen_share_modal_upsell_premium_sharing_counter}hasCreatedLink(){return this.sharingInfoState().hasCreatedLink}hasIncrementedUpsellCounter(){return this.sharingInfoState().hasIncrementedUpsellCounter}inviteAfterSharingModalVariant(){return this.sharingPrefs().invite_after_sharing_modal_variant}getExperiments(){return this.modalInfoState().experiments}hasSeenEsignPostSharing(){return this.sharingPrefs().has_seen_esign_post_sharing}isInEsignPostSharingExclusionPeriod(){return this.sharingPrefs().is_in_esign_post_sharing_exclusion_period}isShowingFileUploadToolkitCampaign(){return this.sharingPrefs().is_showing_file_upload_toolkit_campaign}getReferrer(){return this.modalInfoState().referrer}isUserOnOwnerTeam(){const e=this.metadata();return Boolean(e&&e.owner_team&&e.owner_team.id===this._user.team_dbtid)}isCurrentAccountLoaded(){return this.sharingInfoState().isCurrentAccountLoaded}isTeamSharedFolder(){const e=this.metadata();return Boolean(e&&e.is_team_folder||this.contentInfo().isTeamSharedFolder())}isTokenizerEmpty(){return 0===this.recipientRawInput().length&&0===this.recipientTokens().length}linkMetadata(){return this.sharingInfoState().linkMetadata}sharedLinks(){return this.sharingInfoState().sharedLinks||[]}shmodelLink(){return this.sharedLinks().filter((e=>!e.isRighteousLink()))[0]}editRighteousLink(){return this.sharedLinks().filter((e=>"editor"===e.link_permissions.link_access_level))[0]}viewRighteousLink(){return this.sharedLinks().filter((e=>"viewer"===e.link_permissions.link_access_level))[0]}linkOnlyReason(){return this.modalInfoState().linkOnlyReason}countsExceedNsLimit(){return this.modalInfoState().countsExceedNsLimit}memberCounts(){return this.sharingInfoState().memberCounts}members(){return this.sharingInfoState().members}metadata(){return this.sharingInfoState().metadata}name(){const e=this.contentInfo(),t=this.metadata();return e&&e.name()||t&&t.name||""}ownerTeam(){const e=this.metadata();return e&&e.owner_team}parentSharedFolderId(){const e=this.metadata();return e&&e.parent_shared_folder_id}pendingMemberAction(){return this.modalInfoState().pendingMemberAction}permissionsObj(){return new pe(this.permissions())}permissions(){const e=this.metadata();return e&&e.permissions}recipientAccess(){const e=this.modalInfoState();if(e.recipientAccess)return e.recipientAccess;{const e=this.permissionsObj().canInviteEditor()||this.permissionsObj().canCreateEditLink(),t=this.getDefaultSharingAccessLevel();if(t){const n=t===s.ACCESS_LEVEL.WRITER,i=t===s.ACCESS_LEVEL.READER;if(n&&e||i)return t}return e||this.editRighteousLink()?s.ACCESS_LEVEL.WRITER:s.ACCESS_LEVEL.READER}}canCreateLink(e,t){switch(e){case"writer":return this.isFolder()?this.permissionsObj().canInviteEditor()&&!this.isTeamSharedFolder()&&(!this.isConfidentialFolder()||this.isConfidentialFolderLinksEnabled()):!this.isTeamSharedFolder()&&this.permissionsObj().canCreateEditLink();case"reader":return!("writer"===(null==t?void 0:t.access_type)&&!(null==t?void 0:t.path_lower))&&(this.isCloudDoc()?this.permissionsObj().canCreateViewLink():!this.isTeamSharedFolder()&&this.permissionsObj().canCreateViewLink()||this.canShareLink());default:return!1}}canInvite(e){switch(e){case"writer":return this.permissionsObj().canInviteEditor();case"reader":return this.permissionsObj().canInviteViewer();default:return!1}}linkRecipientAccess(e){const t=this.modalInfoState();if(t.linkRecipientAccess)return t.linkRecipientAccess;{const t=this.canCreateLink(s.ACCESS_LEVEL.WRITER,e),n=this.canCreateLink(s.ACCESS_LEVEL.READER,e),i=this.getDefaultSharingAccessLevel();if(i){const e=i===s.ACCESS_LEVEL.WRITER,a=i===s.ACCESS_LEVEL.READER;if(e&&t||a&&n)return i}return t||this.editRighteousLink()?s.ACCESS_LEVEL.WRITER:s.ACCESS_LEVEL.READER}}emailRecipientAccess(){const e=this.modalInfoState();if(e.emailRecipientAccess)return e.emailRecipientAccess;{const e=this.canInvite(s.ACCESS_LEVEL.WRITER),t=this.canInvite(s.ACCESS_LEVEL.READER),n=this.getDefaultSharingAccessLevel();if(n){const i=n===s.ACCESS_LEVEL.WRITER,a=n===s.ACCESS_LEVEL.READER;if(i&&e||a&&t)return n}return e?s.ACCESS_LEVEL.WRITER:s.ACCESS_LEVEL.READER}}recipientMessage(){return this.modalInfoState().recipientMessage}onCreateGroupCallback(){return this.modalInfoState().onCreateGroupCallback}recipientRawInput(){return this.modalInfoState().recipientRawInput}recipientTokens(){return this.modalInfoState().recipientTokens}recipientValidation(){return this.modalInfoState().recipientValidation}shareAsConfidential(){return Boolean(this.getInitialProps().shareAsConfidential)}shareFolderPromise(){return this.sharingInfoState().shareFolderPromise}shouldBlockMemberListOnPassLoad(){return this.sharingInfoState().shouldBlockMemberListOnPassLoad}shouldSyncThisFolder(){return this.getInitialProps()?this.getInitialProps().shouldSyncThisFolder:null}teamPolicy(){return this.sharingInfoState().teamPolicy}isFamilyUser(){return this.sharingInfoState().isFamilyUser}uiMode(){return this.modalInfoState().uiMode}isCloudDoc(){const e=this.metadata();return!(!e||!e.is_cloud_doc)}fetchMetadataStatus(){return this.modalInfoState().fetchMetadataStatus}isUlssClientOn(){return"ON"===this.sharingPrefs().user_level_sharing_settings_client_variant}isShareMessageAsCommentChecked(){const e=this.modalInfoState().isShareMessageAsCommentExplicitlyChecked;return void 0===e?this.permissionsObj().canShareMessageAsComment():e}shouldSuppressRedirectToBrowse(){return this.getInitialProps()?this.getInitialProps().shouldSuppressRedirectToBrowse:null}shouldCloseImmediately(){return this.getInitialProps()?this.getInitialProps().shouldCloseImmediately:null}shouldFetchLinkMetadata(){return this.canShareLink()&&!this.isNonUserRelativeContext()&&this.contentInfo().isMounted()}getSelectedAudienceByAccessLevel(e){return this.sharingInfoState().selectedAudienceByAccessLevel[e]}getEligibleInviteAfterSharingContacts(){return((e,t)=>{const s=new Set(e.filter((e=>!e.invalid)).map((e=>e.getKey()))),n=Object.values(t),i=new Set,a=new Set;for(const e of n)for(const t in e)if(e.hasOwnProperty(t)&&s.has(t)){const s=e[t];if(s&&s.inviteAfterSharingEligibility){const e=s.inviteAfterSharingEligibility[".tag"];"eligible_not_seen"===e?i.add(t):"eligible_seen"===e&&a.add(t)}}return{inviteEligibleNotSeenContacts:e.filter((e=>i.has(e.getKey())&&!e.invalid)),inviteEligibleSeenContacts:e.filter((e=>a.has(e.getKey())&&!e.invalid))}})(this.recipientTokens(),this.recipientValidation())}sendApproval(){return this.modalInfoState().sendApproval}needsAllApprovers(){return this.modalInfoState().needsAllApprovers}creatingApprovalRequest(){return this.modalInfoState().creatingApprovalRequest}automationOptionChecked(){return this.modalInfoState().automationOptionChecked}isExpBsxOrganizeAroundPeopleEnabled(){return this.sharingPrefs().bsx_organize_around_people}isDTLSM1Enabled(){return"ON"===this.sharingPrefs().default_to_link_sharing_m1_variant}getSharingTasks(){return this.modalInfoState().sharingTasks}getDefaultSharingAccessLevel(){const e=this.sharingPrefs().default_sharing_access_level_setting?s.DEFAULT_SHARING_ACCESS_LEVEL[this.sharingPrefs().default_sharing_access_level_setting[".tag"]]:s.ACCESS_LEVEL.WRITER;return e===s.SharingAccessLevel.UNKNOWN?s.ACCESS_LEVEL.WRITER:e}getDefaultSharingLinkAudience(){const e=this.sharingPrefs().default_sharing_link_audience_setting?this.sharingPrefs().default_sharing_link_audience_setting[".tag"]:E.LINK_AUDIENCE.PUBLIC;return e===s.SharingLinkAudience.UNKNOWN?E.LINK_AUDIENCE.PUBLIC:e}getLastSeenTeamPolicyAudience(){const e=this.sharingPrefs().last_seen_team_policy_audience?this.sharingPrefs().last_seen_team_policy_audience[".tag"]:E.LINK_AUDIENCE.PUBLIC;return e===s.SharingLinkAudience.UNKNOWN?E.LINK_AUDIENCE.PUBLIC:e}}const me={loadFileMetadataBatch:(e,t)=>new s.FileShareApiClient({userId:e.id}).getMetadataBatchAlpha({contentIds:t,actions:Object.keys(s.ALPHA_FILE_METADATA_PERMISSIONS)}).then((t=>s.dispatcherSingleton.dispatch({type:Y.FETCH_METADATA_BATCH_SUCCESS,user:e,data:t}))),loadFileMetadata:({user:e,contentId:t,sourceUrl:n,client:i})=>{const a=Se.getSharingInfo(e.id,t);if(a&&a.fetchingMetadataPromise())return a.fetchingMetadataPromise();const r=(i=i||new s.FileShareApiClient({userId:e.id})).getMetadataAlpha({contentId:t,actions:Object.keys(s.ALPHA_FILE_METADATA_PERMISSIONS),sourceURL:n}).then((t=>{s.dispatcherSingleton.dispatch({type:Y.FETCH_METADATA_BATCH_SUCCESS,user:e,data:[t]}),s.dispatcherSingleton.dispatch({type:c.SharePageActionTypes.FETCH_METADATA_SUCCESS,metadata:t,user:e})}));return s.dispatcherSingleton.dispatch({type:Q.FETCH_METADATA_REQUEST,contentIds:[t],data:{promise:r},user:e}),r},listMembers:({user:e,contentId:t,isFolder:n,limit:i,url:a,members:r,client:o,includeSeenState:c=!0,passSessionId:_,isNonUserRelativeContext:h=!1})=>{l.assert(!i||i<=100,"listMembers not implemented for limit > 100");const u=i||9999999,d=Se.getSharingInfo(e.id,t);if(d){const e=d.fetchingMembersRequest();if(e&&u<=e.limitNonNull)return e.promise;if(d.hasDisplayableMembers()&&u<d.members().getMemberCount())return Promise.resolve({})}const E=Math.random().toString(),S=!n;o||(o=n?new s.FolderShareApiClient({userId:e.id,isNonUserRelativeContext:h}):new s.FileShareApiClient({userId:e.id,isNonUserRelativeContext:h}));const p=n=>n?(s.dispatcherSingleton.dispatch({type:Q.FETCH_USER_ACCOUNTS_CONTINUED_REQUEST,contentIds:[t],user:e}),o.listMembersContinue({cursor:n,url:a,isAlpha:S}).then((n=>{s.dispatcherSingleton.dispatch({type:Q.FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS,contentIds:[t],data:{members:n,requestId:E},user:e}),p(n.cursor)}))):Promise.resolve({});let I;return _&&w.record(s.LoggingActions.LIST_MEMBERS_BEGIN,_),I=r?Promise.resolve(r):o.listMembers({contentId:t,url:a,limit:i,isAlpha:S,includeSeenState:c}),I=I.then((n=>{_&&w.record(s.LoggingActions.LIST_MEMBERS_RECEIVE,_),s.dispatcherSingleton.dispatch({type:Q.FETCH_USER_ACCOUNTS_SUCCESS,contentIds:[t],data:{members:n,requestId:E},user:e}),i||p(n.cursor)})),s.dispatcherSingleton.dispatch({type:Q.FETCH_USER_ACCOUNTS_REQUEST,contentIds:[t],data:{limitNonNull:u,requestId:E,promise:I},user:e}),I},fetchFileMemberCount:({user:e,contentId:t,limit:n,url:i,client:a,countGroupsAsMembers:r=!1,passSessionId:o,runViewerInfoChecks:c=!1})=>{a=a||new s.FileShareApiClient({userId:e.id}),o&&w.record(s.LoggingActions.MEMBER_COUNTS_BEGIN,o);const _=a.getMemberCounts({contentId:t,limit:n,url:i,countGroupsAsMembers:r,runViewerInfoChecks:c});return s.dispatcherSingleton.dispatch({type:Q.FETCH_FILE_MEMBER_COUNT_REQUEST,contentIds:[t],user:e}),_.then((n=>{o&&w.record(s.LoggingActions.MEMBER_COUNTS_RECEIVE,o),s.dispatcherSingleton.dispatch({type:Q.FETCH_FILE_MEMBER_COUNT_SUCCESS,contentIds:[t],data:n,user:e})}))},fetchFolderMemberCount:({user:e,contentId:t,client:n})=>(s.dispatcherSingleton.dispatch({type:Q.FETCH_MEMBER_COUNTS_REQUEST,data:{},contentIds:[t],user:e}),n.getMemberCounts({contentId:t}).then((n=>{s.dispatcherSingleton.dispatch({type:Q.FETCH_MEMBER_COUNTS_SUCCESS,data:{memberCounts:n},contentIds:[t],user:e})})))},fe=s.MAX_FACES_NORMAL+s.MAX_OVERFLOW_BUTTON_INDICATOR+1;class ge{static setup({user:e,fileData:t,prevFileData:s,passSessionId:n,shouldWritePresence:i=!0,skipSharingEndpoints:a=!1,limit:r=150}){const o=t.file.file_id;this.shouldInitializePass(e,o,i)&&setTimeout((()=>{g.passPermissionRequest(o),ge.makeAllRequests({user:e,fileData:t,prevFileData:s,passSessionId:n,shouldWritePresence:i,skipSharingEndpoints:a,limit:r})}),0)}static teardown({user:e,fileData:t,async:s,shouldWritePresence:n=!0}){const{file:i,url:a}=t,r=i.file_id;if(this.shouldInitializePass(e,r,n)){ge.removeUnloadHandler();const t=new $(r,a);q.shutdown({beaconFileData:t,user:e,async:s,shouldWritePresence:n})}}static shouldInitializePass(e,s,n){return t.getSourceContext()!==S.SourceContext.SharedLinkCollection&&(null!==e||n)&&s}static onBeaconUpdate(e,t,s){const n=s.fileId;"delta"===e.type?g.receivePresenceDelta(t,n,e.onlineUniqueUsers,e.offlineUniqueUsers):"snapshot"===e.type&&g.receivePresenceSnapshot(t,n,e.onlineUniqueUsers)}static makeAllRequests({user:e,fileData:t,prevFileData:n,passSessionId:i,limit:a=150,shouldWritePresence:r=!0,skipSharingEndpoints:o=!1}){const{file:c,url:_}=t,{file_id:h,fq_path:u}=c,d=h||u,l=new $(c.file_id,_);e?(d&&!o&&(me.fetchFileMemberCount({user:e,contentId:d,limit:fe,countGroupsAsMembers:!1,url:_,passSessionId:i,runViewerInfoChecks:!0}),me.listMembers({user:e,contentId:d,isFolder:!1,limit:6,url:_,passSessionId:i,includeSeenState:!1})),B.fetchSeenStateInfo(e,h,a,_,i),q.receiveBeaconData({beaconFileData:l,user:e,passSessionId:i,onUpdate:this.onBeaconUpdate})):g.updatePermissions(h,{canReadPresence:!1,canReadSeenState:!1});const E=s.Viewer.get_viewer().is_assume_user_session;if(!r||E)g.updatePermissions(h,{canWritePresence:!1});else{const s=n&&new $(n.file,n.url);q.transmitBeaconData({user:e,passSessionId:i,beaconFileData:l,prevBeaconFileData:s}),ge.removeUnloadHandler(),ge.onUnload=s=>(this.teardown({user:e,fileData:t,async:!1,shouldWritePresence:!0}),s.returnValue=void 0,null),document.addEventListener("beforeunload",ge.onUnload)}}}ge.removeUnloadHandler=()=>{ge.onUnload&&document.removeEventListener("beforeunload",ge.onUnload),ge.onUnload=void 0};class Ae{constructor(){this.userIdToUniqueIds={}}addUniqueUser(e,t){e in this.userIdToUniqueIds||(this.userIdToUniqueIds[e]={}),this.userIdToUniqueIds[e][t]=!0}removeUniqueUser(e,t){e in this.userIdToUniqueIds&&t in this.userIdToUniqueIds[e]&&(delete this.userIdToUniqueIds[e][t],Object.keys(this.userIdToUniqueIds[e]).length||delete this.userIdToUniqueIds[e])}getOnlineUserIds(){return Object.keys(this.userIdToUniqueIds)}}class Te extends h.Store{constructor(e){super(e),this.seenStateInfos={},this.seenStateCursors={},this.presenceInfos={},this.passFetchingStatusMap={},this.userIdsWithoutSeenStateInfoMap={},this.userIdsWithoutTeamInteractionInfoMap={},this.userTeamInteractionInfoMap={},this.passPermissions={}}presence(e){return e in this.presenceInfos?this.presenceInfos[e].getOnlineUserIds():null}seenStateInfo(e){return this.seenStateInfos[e]||null}identifiedSeenStateInfo(e){if(e in this.seenStateInfos){return{seen_states:r.reject(this.seenStateInfos[e].seen_states,s.AnonymousViewerUtils.isAnonymousSeenState)}}return null}seenStateCursorHasNext(e){return e in this.seenStateCursors?this.seenStateCursors[e].has_next:null}seenStateCursorState(e){return e in this.seenStateCursors?this.seenStateCursors[e].cursor_state:null}passFetchingStatus(e){return this.passFetchingStatusMap[e]||s.PassFetchingStatus.NOT_YET_KNOWN}getLinkAndGroupSeenStateInfo(e){let t=null,n=null;if(!this.seenStateInfos[e])return{linkSeenStateInfo:t,groupSeenStateInfo:n};t=[],n={};for(const i of this.seenStateInfos[e].seen_states)if(!s.AnonymousViewerUtils.isAnonymousSeenState(i)){const{seen_state_user:{sharing_access_type:e}}=i;if(e)switch(e.type){case"link_only":case"view_link_access":case"edit_link_access":t.push(i);break;case"view_member_access":case"edit_member_access":const s=e.value.group_ids;for(const e of s)e in n||(n[e]=[]),n[e].push(i)}}return{linkSeenStateInfo:t,groupSeenStateInfo:n}}anonymousPresence(e){return e in this.presenceInfos?s.AnonymousViewerUtils.getAnonymousUserIds(this.presenceInfos[e].getOnlineUserIds()):null}userIdsWithoutSeenStateInfo(e){return this.userIdsWithoutSeenStateInfoMap[e]||[]}userIdsWithoutTeamInteractionInfo(e){return this.userIdsWithoutTeamInteractionInfoMap[e]||[]}userTeamInteractionInfo(e){return this.userTeamInteractionInfoMap[e]||{}}isPassPermissionsPending(e){const t=this.passPermissions[e];return null!=t&&!(t.hasOwnProperty("canReadPresence")&&t.hasOwnProperty("canReadSeenState")&&t.hasOwnProperty("canWritePresence"))}getPassPermissions(e){if(!e)return null;const t=this.passPermissions[e];return null==t||this.isPassPermissionsPending(e)?null:t}resetPassInfo(e){delete this.seenStateInfos[e],delete this.seenStateCursors[e],delete this.presenceInfos[e],delete this.passFetchingStatusMap[e],delete this.passPermissions[e],delete this.userIdsWithoutSeenStateInfoMap[e],this.emit_change()}setPassPermissionRequest(e){this.passPermissions[e]||(this.passPermissions[e]={}),this.setPassFetchingStatus(e,s.PassFetchingStatus.FETCHING)}updatePermissions(e,t){this.passPermissions.hasOwnProperty(e)&&(this.passPermissions[e]=Object.assign(Object.assign({},this.passPermissions[e]),t),this.emit_change())}markPassConcludedIfNecessary(e){const t=this.passPermissions[e];!(t&&t.hasOwnProperty("canReadPresence")&&t.hasOwnProperty("canReadSeenState"))||t.canReadPresence||t.canReadSeenState||(this.resetPassInfo(e),this.setPassFetchingStatus(e,s.PassFetchingStatus.CONCLUDED),this.updateSeenStateInfoWithEmptyData(e))}receivePresenceDelta(e,t,n,i){l.assert(-1===[s.PassFetchingStatus.FETCHING,s.PassFetchingStatus.NOT_YET_KNOWN].indexOf(this.passFetchingStatus(t)),"Before handling a presence delta, you must call assurePresenceSuccessRegistered");const a=this.getOnlineUsersForFileId(t);this.updatePresenceInfos(t,n,i),this.updateUserIdsWithoutSeenStateInfo(e,t,a),this.emit_change()}receivePresenceSnapshot(e,t,n){l.assert(-1===[s.PassFetchingStatus.FETCHING,s.PassFetchingStatus.NOT_YET_KNOWN].indexOf(this.passFetchingStatus(t)),"Before handling a presence snapshot, you must call assurePresenceSuccessRegistered");const i=this.getOnlineUsersForFileId(t);this.presenceInfos[t]=new Ae,this.updatePresenceInfos(t,n,{}),this.updateUserIdsWithoutSeenStateInfo(e,t,i),this.emit_change()}getOnlineUsersForFileId(e){return e in this.presenceInfos||(this.presenceInfos[e]=new Ae),this.presenceInfos[e].getOnlineUserIds()}updatePresenceInfos(e,t,s){for(const t of Object.keys(s))for(const n of Object.keys(s[t]))this.presenceInfos[e].removeUniqueUser(t,n);for(const s of Object.keys(t))for(const n of Object.keys(t[s]))this.presenceInfos[e].addUniqueUser(s,n)}updateUserIdsWithoutSeenStateInfo(e,t,n){let i;const a=s.AnonymousViewerUtils.filterAnonymousUserIds(this.getOnlineUsersForFileId(t)),o=s.AnonymousViewerUtils.filterAnonymousUserIds(n),c=r.difference(o,a),_=r.difference(a,o);if(t in this.seenStateInfos){let e;const n=this.passFetchingStatus(t);if(-1!==[s.PassFetchingStatus.SEEN_STATE_DISALLOWED,s.PassFetchingStatus.PASS_MIXED_SUCCESS].indexOf(n))({userIdsWithoutSeenStateInfo:i,baseSeenStateInfo:e}=this.createMinimalBaseSeenStateInfo(t,a)),this.updateSeenStateInfo(t,e);else{const s=this.makeSeenStateAgreeWithUpdatedPresence(t,a,c,_);({userIdsWithoutSeenStateInfo:i,baseSeenStateInfo:e}=s)}}else i=[];this.userIdsWithoutSeenStateInfoMap[t]=i}makeSeenStateAgreeWithUpdatedPresence(e,t,s,n){const i=[],a=this.seenStateInfos[e],r=a.seen_states,o=[],c=[],_=[],h=Date.now()/1e3;for(const e of r){const t=e.seen_state_user.user_id;t&&(i.push(t),n.includes(t)?(e.when_last_seen=h,e.seen_events=e.seen_events||[],c.push(e)):s.includes(t)?(e.when_last_seen=h,e.seen_events=e.seen_events||[],e.seen_events.push({ts:h}),_.push(e)):o.push(e))}return a.seen_states=[...c,..._,...o],{userIdsWithoutSeenStateInfo:t.filter((e=>!i.includes(e))),baseSeenStateInfo:a}}createMinimalBaseSeenStateInfo(e,t){const s=[],n=[];for(const i of this.seenStateInfos[e].seen_states){const e=i.seen_state_user.user_id;e&&t.includes(e)&&(s.push(i),n.push(e))}return{userIdsWithoutSeenStateInfo:r.difference(t,n),baseSeenStateInfo:{seen_states:s}}}updateSeenStateInfo(e,t,n=!1){l.assert(-1===[null,s.PassFetchingStatus.FETCHING].indexOf(this.passFetchingStatus(e)),"Before updating seen state info, you must call assureSeenStateSuccessRegistered or onFetchSeenStateDisabled"),n&&e in this.seenStateInfos?this.seenStateInfos[e].seen_states=this.seenStateInfos[e].seen_states.concat(t.seen_states):this.seenStateInfos[e]=t,this.userIdsWithoutTeamInteractionInfoMap[e]=this.userIdsWithoutSeenStateInfoMap[e],this.userIdsWithoutSeenStateInfoMap[e]=[],this.emit_change()}updateSeenStateInfoWithEmptyData(e){this.updateSeenStateInfo(e,{seen_states:[]})}setPassFetchingStatus(e,t){this.passFetchingStatusMap[e]=t,this.emit_change()}updateSeenStateCursor(e,t){t&&(this.seenStateCursors[e]=t,this.emit_change())}assureSeenStateSuccessRegistered(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.SEEN_STATE_SUCCESS);break;case s.PassFetchingStatus.PRESENCE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_SUCCESS);break;case s.PassFetchingStatus.SEEN_STATE_DISALLOWED:a.reportStack("Debugging FETCHING_STATUS: pass fetching status is seen state disallowed",{severity:o.SEVERITY.NONCRITICAL,tags:["pass:fetch_seen_state_disallowed"],exc_extra:{storeHasPresence:e in this.presenceInfos,storeHasSeenState:e in this.seenStateInfos,passPermissions:JSON.stringify(this.passPermissions[e]),fetchingStatus:this.passFetchingStatusMap[e]}});break;case s.PassFetchingStatus.NOT_YET_KNOWN:a.reportStack("Debugging FETCHING_STATUS: pass fetching status is not yet known",{severity:o.SEVERITY.CRITICAL,tags:["pass:fetch_seen_state_success"],exc_extra:{fetchingStatus:this.passFetchingStatusMap[e]}})}}onFetchSeenStateDisabled(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.PRESENCE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_MIXED_SUCCESS);break;case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.SEEN_STATE_DISALLOWED);break;case s.PassFetchingStatus.NOT_YET_KNOWN:a.reportStack("Debugging FETCHING_STATUS: pass fetching status is not yet known",{severity:o.SEVERITY.CRITICAL,tags:["pass:fetch_seen_state_success"],exc_extra:{fetchingStatus:this.passFetchingStatusMap[e]}})}}assurePresenceSuccessRegistered(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.SEEN_STATE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_SUCCESS);break;case s.PassFetchingStatus.SEEN_STATE_DISALLOWED:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_MIXED_SUCCESS);break;case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.PRESENCE_SUCCESS);break;case s.PassFetchingStatus.NOT_YET_KNOWN:a.reportStack("Debugging FETCHING_STATUS: pass fetching status is not yet known",{severity:o.SEVERITY.CRITICAL,tags:["pass:fetch_presence_success"],exc_extra:{fetchingStatus:this.passFetchingStatusMap[e]}})}}updateUserTeamInteractionInfo(e,t){if(e in t)for(const s of Object.keys(t))this.userTeamInteractionInfoMap[e][s]=t[s];else this.userTeamInteractionInfoMap[e]=t;this.userIdsWithoutTeamInteractionInfoMap[e]=[],this.emit_change()}_new_payload(e){const{type:t,data:n}=e.action;if(!n)return;let{userId:i,fileId:a,teamId:r,seenStateInfo:o,seenStateCursor:c,onlineUniqueUsers:_,offlineUniqueUsers:h,partialPermission:u,userTeamInteractionInfo:d,userTeamInteractionUserIds:l}=n;switch(i=i,a=a,r=r,o=o,c=c,_=_,h=h,u=u,d=d,l=l,t){case s.ActionTypes$3.FETCH_PASS_ERROR:this.setPassFetchingStatus(a,s.PassFetchingStatus.ERROR);break;case s.ActionTypes$3.FETCH_PASS_CONCLUDED:this.setPassFetchingStatus(a,s.PassFetchingStatus.CONCLUDED),this.updateSeenStateInfoWithEmptyData(a);break;case s.ActionTypes$3.PASS_PERMISSION_REQUEST:this.setPassPermissionRequest(a);break;case s.ActionTypes$3.RECEIVE_PRESENCE_DELTA:this.assurePresenceSuccessRegistered(a),this.receivePresenceDelta(i,a,_,h);break;case s.ActionTypes$3.RECEIVE_PRESENCE_SNAPSHOT:this.assurePresenceSuccessRegistered(a),this.receivePresenceSnapshot(i,a,_);break;case s.ActionTypes$3.RESET_PASS_INFO:this.resetPassInfo(a);break;case s.ActionTypes$3.UPDATE_PERMISSIONS:this.updatePermissions(a,u),this.markPassConcludedIfNecessary(a);break;case s.ActionTypes$3.DISCONTINUE_SEEN_STATE_INFO:c={cursor_state:"",has_next:!1},this.updateSeenStateCursor(a,c);break;case s.ActionTypes$3.UPDATE_SEEN_STATE_INFO:this.assureSeenStateSuccessRegistered(a),this.updateSeenStateInfo(a,o),this.updateSeenStateCursor(a,c);break;case s.ActionTypes$3.UPDATE_SEEN_STATE_INFO_CONTINUE:this.assureSeenStateSuccessRegistered(a),this.updateSeenStateInfo(a,o,!0),this.updateSeenStateCursor(a,c);break;case s.ActionTypes$3.UPDATE_SEEN_STATE_UNAVAILABLE:this.onFetchSeenStateDisabled(a),this.updateSeenStateInfoWithEmptyData(a),this.updateUserIdsWithoutSeenStateInfo(i,a,[]);break;case s.ActionTypes$3.UPDATE_USER_TEAM_INTERACTION_INFO:this.updateUserTeamInteractionInfo(a,d)}}}const Ce=new Te;function Ne(e,t){return function(e,t){const s={};return s._subject_uid=String(t),e.updateQuery(s)}(new l.URI({path:"/history"+e.fq_path}),t.id)}const Re=[p.PreviewType.Archive,p.PreviewType.Audio,p.PreviewType.CloudDoc,p.PreviewType.Excel,p.PreviewType.HTML,p.PreviewType.Image,p.PreviewType.Linkfile,p.PreviewType.Other,p.PreviewType.SsrDoc,p.PreviewType.RawHTML,p.PreviewType.Restricted,p.PreviewType.Video,p.PreviewType.Doc,p.PreviewType.Photo,p.PreviewType.Text];e.ActionTimestampsTracker=w,e.BeaconFileData=$,e.BeaconPresenceHelpers=q,e.ContentInfo=z,e.FacepileInfo=W,e.PassActions=g,e.PassHelpers=ge,e.SeenStateHelpers=B,e.ShareModalActionTypes=Q,e.SharingActions=me,e.UserInfo=class{constructor(e,t,s,n,i,a,r,o,c,_,h,u,d){this.key=e,this.displayName=t,this.isActive=s,this.isViewer=n,this.incrementOverflowBasis=i,this.email=a,this.accessLevel=r,this.whenLastSeen=o,this.photoUrl=c,this.userId=_,this.platformType=h,this.same_team=u,this.is_guest=d}},e.VALID_PREVIEW_TYPES=Re,e.getContentIdsForContentInfo=e=>{const t=[];return e.isSharedFolder()?t.push(e.sharedFolderId()):(e.extras.fileId&&t.push(e.extras.fileId),e.extras.nsId&&e.extras.nsPath&&t.push(`ns:${e.nsId()}${e.nsPath()}`)),e.displayPath()&&t.push(e.displayPath()),t},e.getWhitelistedExtension=function(e){const t=s.file_extension(e);return I.LOGGING_ALLOWED_EXTS.includes(`.${t}`)?t:I.LOGGING_UNALLOWED_EXT_PLACEHOLDER},e.passStore=Ce,e.redirectToVersionHistory=function(e,t){s.UserActivityLogger.log("web","view_version_history");const n=Ne(e,t);s.redirect(n.toString())},e.sharingInfoStore=Se}));
//# sourceMappingURL=c_previews_util.js-vfl00bN7c.map
