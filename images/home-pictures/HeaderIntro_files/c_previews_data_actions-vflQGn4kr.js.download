define(["exports","./c_tslib","./e_ui_page_files_router","./c_file_store_utils","./c_lodash-es_lodash","./c_api_v2_noauth_client"],(function(e,t,r,i,n,s){"use strict";var a;e.ActionTypes=void 0,(e.ActionTypes||(e.ActionTypes={})).UpdatePreviewData="FileViewer/Previews/UpdatePreviewData",function(e){e.Fetch="Fetch",e.Request="Request",e.Success="Success",e.Error="Error"}(a||(a={}));const o={data:void 0,status:a.Error};function u(e,t){const n=function(e){return r.getStateAtNamespace(e,r.PREVIEW_NAMESPACE_KEY)}(e);if(!n||!t)return o;const s=i.getFileRevisionId(t),a=n.filePreviews[s];return a&&a.status?a:o}function c(e,t){return t.reduce(((t,r)=>(t[i.getFileRevisionId(r)]=u(e,r),t)),{})}function d(e,t,i=!1){if(!t)return Promise.reject(new Error("user not logged in, no support for un-auth'd users yet"));const n={files:e.map((e=>({ns_id:e.ns_id,sj_id:e.sjid}))),include_dimensions:i};return t?(new r.UserApiV2Client).ns("previews").rpc("get_preview_data_batch",n,{subjectUserId:t.id}):(new s.NoAuthApiV2Client).ns("previews").rpc("get_preview_data_batch",n,{})}function l(t){const r={};return t.forEach((e=>{const t=i.getFileRevisionId(e),n=e.preview;n&&(r[t]={data:n,status:a.Success})})),{type:e.ActionTypes.UpdatePreviewData,payload:r}}function p(e,r,s,o){return(u,l)=>t.__awaiter(this,void 0,void 0,(function*(){const p=function(e,t,r=!1){if(r)return t;const s=c(e,t);return n.filter(t,(e=>{const t=i.getFileRevisionId(e);return!e.is_dir&&(!s[t]||!s[t].data&&s[t].status===a.Error)}))}(l(),e,s);if(0===p.length)return;const f=function(e,t){if(e.length<=0)return[];if(e.length<t)return[e];const r=Array(Math.ceil(e.length/t));let i=0,n=0;for(;i<e.length;)r[n++]=e.slice(i,i+=t);return r}(p,50),h=f.map((e=>function(e,r,n,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=function(e){return e.reduce(((e,t)=>(e[i.getFileRevisionId(t)]={data:void 0,status:a.Request},e)),{})}(r);e(v(t));try{const i=yield d(r,n,s);return e(_(Object.keys(t),i))}catch(r){return e(w(t))}}))}(u,e,r,o)));return Promise.all(h)}))}function f(t){return{type:e.ActionTypes.UpdatePreviewData,payload:t}}const v=f;function _(t,r){const n=r.results.reduce(((e,t)=>(e[i.getFileRevisionId({ns_id:t.file.ns_id,sjid:t.file.sj_id})]=t,e)),{});return{type:e.ActionTypes.UpdatePreviewData,payload:t.reduce(((e,t)=>{const r=n[t],i={data:null==r?void 0:r.preview,status:a.Success};return e[t]=i,e}),{})}}function w(t){return{type:e.ActionTypes.UpdatePreviewData,payload:n.mapValues(t,(e=>({data:void 0,status:a.Error})))}}var h=Object.freeze({__proto__:null,populateFilesPreviewData:l,fetchPreviewData:p,fetchPreviewUrl:function(e,t){return d([e],t).then((e=>{if(e.results.length>0){const t=e.results[0].preview;if(t&&t.preview_url)return t.preview_url}}))},updatePreviewData:f,apiRequestInFlightAction:v,apiRequestSuccessAction:_,apiRequestErrorAction:w});e.actions_esnext=h,e.fetchPreviewData=p,e.getApiDataForFiles=c,e.populateFilesPreviewData=l,e.previewDataInFlight=function(e,t){return function(e,t){const r=u(e,t);return r?r.status:void 0}(e,t)===a.Request},e.previewDataPresentForFile=function(e,t){const r=u(e,t);return!(!r||!r.data||r.status===a.Error)}}));
//# sourceMappingURL=c_previews_data_actions.js-vflcNYZr2.map
