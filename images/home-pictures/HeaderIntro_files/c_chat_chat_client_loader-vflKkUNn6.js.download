define(["require","exports","./e_ui_page_files_router","./e_edison","./c_tslib","./c_core_uri","./c_lodash-es_lodash","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","./c_core_notify","./c_core_i18n","./c_src_sink_index","./c_core_browser_detection","metaserver/static/js/modules/core/langpack","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_api_v2_noauth_client","./c_browser_cookies","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","./c_csrf","./c_core_xhr","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/login_and_register"],(function(e,t,s,n,i,o,a,r,c,h,l,_,d,u,m,C,p,g,v,A,w,j,k,M,f,P,I,L,b,y,S,B,D,T,x,V,E,F){"use strict";class N{constructor(){this.loadClient=(e,t)=>{if(e){const s=t.chatStoneToProtoModule.chatStoneToProto(e);t.chatClientModule.ChatClientSingleton.setupChatEnvironment(s)}},this.getBestChatCampaignAndLoadChatClient=(e,t,s)=>{const n={url:e};if(s){return(new t.userClientModule.UserApiV2Client).ns("megaphone_chat").rpc("get_best_chat_campaigns",n,{subjectUserId:s}).then((e=>this.loadClient(e.props,t)))}return(new t.noAuthClientModule.NoAuthApiV2Client).ns("megaphone_chat").rpc("get_best_chat_campaigns",n,{}).then((e=>this.loadClient(e.props,t)))},this.getChatCampaignByIdAndLoadClient=(e,t,s,n)=>{const i={url:e,campaign_id:t,locale:window.navigator.language?window.navigator.language:window.navigator.browserLanguage};if(n){return(new s.userClientModule.UserApiV2Client).ns("megaphone_chat").rpc("get_chat_campaign_by_id",i,{subjectUserId:n}).then((e=>this.loadClient(e.props,s)))}return(new s.noAuthClientModule.NoAuthApiV2Client).ns("megaphone_chat").rpc("get_chat_campaign_by_id",i,{}).then((e=>this.loadClient(e.props,s)))},this.resumeOrGetBestChatCampaignAndLoadClient=(e,t,s,n)=>e?Promise.resolve(this.loadClient(e,t)):this.getBestChatCampaignAndLoadChatClient(s,t,n),this.getResumedChatCampaignAndLoadClient=(e,t,s,n,i)=>{const o={url:e,legacy_persistence_cookie:t||"",chat_persistence_cookie:s||""};if(i){return(new n.userClientModule.UserApiV2Client).ns("megaphone_chat").rpc("get_resumed_chat_campaign",o,{subjectUserId:i}).then((t=>this.resumeOrGetBestChatCampaignAndLoadClient(t.props,n,e,i)))}return(new n.noAuthClientModule.NoAuthApiV2Client).ns("megaphone_chat").rpc("get_resumed_chat_campaign",o,{}).then((t=>this.resumeOrGetBestChatCampaignAndLoadClient(t.props,n,e,i)))},this.importDependencies=()=>Promise.all([new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.user_client_esnext})),new Promise((function(t,s){e(["./c_api_v2_noauth_client"],t,s)})).then((function(e){return e.noauth_client_esnext})),new Promise((function(t,s){e(["./c_chat_chat_stone_to_proto"],t,s)})),new Promise((function(t,s){e(["./c_chat_chat_client"],t,s)})).then((function(e){return e.chat_client_esnext})),new Promise((function(t,s){e(["./c_browser_cookies"],t,s)})),new Promise((function(t,s){e(["./c_chat_chat_constants"],t,s)}))]),this.getCookies=(e,t)=>{const{Cookies:s}=e,{SNAPENGAGE_CHAT_VISIBLE_COOKIE:n,CHAT_CAMPAIGN_VISIBLE_COOKIE:i}=t;return{legacy_persistence_cookie:s.read(n),chat_persistence_cookie:s.read(i)}},this.getCampaignFromChatServiceWithDependencies=([e,t,s,n,i,o],a,r)=>{const c={userClientModule:e,noAuthClientModule:t,chatStoneToProtoModule:s,chatClientModule:n,cookiesModule:i,chatConstantsModule:o},h=this.getCookies(i,o);return h.legacy_persistence_cookie||h.chat_persistence_cookie?this.getResumedChatCampaignAndLoadClient(a,h.legacy_persistence_cookie,h.chat_persistence_cookie,c,r):this.getBestChatCampaignAndLoadChatClient(a,c,r)},this.getChatCampaignIDFromChatServiceWithDependencies=([e,t,s,n,i,o],a,r,c)=>{const h={userClientModule:e,noAuthClientModule:t,chatStoneToProtoModule:s,chatClientModule:n,cookiesModule:i,chatConstantsModule:o},l=this.getCookies(i,o);return l.legacy_persistence_cookie||l.chat_persistence_cookie?this.getResumedChatCampaignAndLoadClient(a,l.legacy_persistence_cookie,l.chat_persistence_cookie,h,c):this.getChatCampaignByIdAndLoadClient(a,r,h,c)},this.loadChatClientWithBestCampaign=(e,t,n)=>{if(this.loadPromise)return this.loadPromise;const i=n?Promise.resolve():s.waitForTTI({timeoutMS:5e3});return this.loadPromise=i.then((()=>this.importDependencies())).then((s=>this.getCampaignFromChatServiceWithDependencies(s,e,t))),this.loadPromise},this.loadCampaignByID=(e,t,n)=>(this.loadPromise||(this.loadPromise=s.waitForTTI({timeoutMS:5e3}).then((()=>this.importDependencies())).then((s=>this.getChatCampaignIDFromChatServiceWithDependencies(s,e,t,n)))),this.loadPromise)}}const O=new N;t.ChatClientLoaderSingleton=O,t._ChatClientLoaderDoNotUseDirectly=N,t.initialize_module=e=>{O.loadChatClientWithBestCampaign(e.url,e.userId,e.bypassWaitForTTI)}}));
//# sourceMappingURL=c_chat_chat_client_loader.js-vfl6bt6bZ.map
