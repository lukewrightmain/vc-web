define(["exports","./c_tslib","./e_ui_page_files_router","./c_src_sink_index","./c_core_browser_detection","./c_core_uri","./c_core_notify","./c_core_i18n","./e_edison","./c_lodash-es_lodash","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_api_v2_noauth_client","./c_browser_cookies","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","./c_csrf","./c_core_xhr","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/core/langpack"],(function(e,t,o,s,r,a,n,i,d,c,l,u,_,m,p,f,h,g,w,b,v,y,j,k,M,x,A,S,z,U,I,E,Q,q,R,L,$){"use strict";const C=["dl-web.dropbox.com","dl.dropboxusercontent.com"],Z=".dropboxusercontent.com",D=i.intl.formatMessage({id:"L64bdq",defaultMessage:"There was an error downloading your file."});let N=!1,T={};function W({source:e,type:t}){s.getMetricsReporter$1().createStats({ns:"web_file_actions",name:"download/failed"},{source:e,type:t}).record(1)}const H=({url:e,error:t,source:o="unknown"})=>{const i=a.URI.parse(e),d=i.getAuthority();!function({source:e}){s.getMetricsReporter$1().createStats({ns:"web_file_actions",name:"download/attempt"},{source:e}).record(1)}({source:o});const c=C.includes(d)||d.endsWith(Z)||"www.dropbox.com"===d;c||W({source:o,type:"download_non_block_server"}),a.assert(c,"attempt to download from a non-blockserver domain",{exc_extra:{domain:d,url:e}}),N||(N=!0,T={},window.addEventListener("message",Y));const l=function(){let e="";for(let t=1;t<=4;t++)e+=String(Math.random()).split(".")[1];return e}();i.updateQuery({_download_id:l,_notify_domain:window.location.host});return J({downloadUri:i,downloadId:l,error:t,downloadDomain:d,onLoad:()=>{setTimeout((()=>{const e=T[l];null!=e&&(r.chrome&&(n.Notify.error(D),e.error&&(e.error(),W({source:e.source,type:"download_failed"}))),B(l))}),100)},source:o}),!1},J=({downloadUri:e,downloadId:t,error:o,downloadDomain:s,onLoad:r,source:a})=>{const n=document.createElement("iframe");n.setAttribute("src",String(e)),n.style.display="none",r&&n.addEventListener("load",r),T[t]={origin:s,error:o,iframe:n,source:a},document.body.appendChild(n),window.setTimeout((()=>B(t)),9e4)};const O=e=>{let t;t="too_many_files"===e[".tag"]?i.intl.formatMessage({id:"ZvH26K",defaultMessage:"Attempted to zip too many files."}):"too_much_data"===e[".tag"]?i.intl.formatMessage({id:"Qq4R12",defaultMessage:"Attempted to zip too much data."}):"file_not_found"===e[".tag"]?i.intl.formatMessage({id:"XSR4O8",defaultMessage:"File not found."}):"unauthorized_user"===e[".tag"]?i.intl.formatMessage({id:"tUjhJf",defaultMessage:"Unauthorized user."}):"unauthorized_namespace"===e[".tag"]?i.intl.formatMessage({id:"62VIQy",defaultMessage:"You can't download because you can't access all content.  Please try again, selecting only folders where you have access to all the content."}):i.intl.formatMessage({id:"ItwtZa",defaultMessage:"Zip download failed."}),o.Snackbar.fail(t,"zip-download-status")},V=({block_hash:e,fq_paths:s,parent_path:r,flat_mode:a,subjectUserId:n,root_ns_id:i})=>t.__awaiter(void 0,void 0,void 0,(function*(){try{const t=new o.UserApiV2Client;return{result:yield t.ns("browse_zip_downloads").rpc("get_zip_download_url",{block_hash:e,unnormalized_files:[...s],parent_path:r,flat_mode:a,root_ns_id:i},{subjectUserId:n}),isError:!1}}catch(e){return".tag"in e.error?{isError:!0,error:e.error}:{isError:!0,error:{".tag":"undefined_error"}}}}));function Y(e){const t=a.URI.parse(e.origin);if("https"!==t.getScheme())return;if(!C.includes(t.getAuthority())&&!t.getAuthority().endsWith(Z))return;let o;try{o=JSON.parse(e.data)}catch(e){return}if(!o||!o.download_id)return;const s=T[o.download_id];if(null!=s&&t.getAuthority()===s.origin&&e.source===s.iframe.contentWindow){if("failed"===o.status){const e=(o.message||D)+'<a target="_blank" rel="noreferrer" href="/help/desktop-web/download-entire-folders">'+i.intl.formatMessage({id:"WYQtmB",defaultMessage:"More info"})+"</a>";n.Notify.error(new n.HTML(e)),s.error&&(s.error(),W({source:s.source,type:"download_failed"}))}B(o.download_id)}}function B(e){const t=T[e];null!=t&&(t.iframe.remove(),delete T[e])}e.get=H,e.getZipDownloadUrl=V,e.get_blockserver_link=function({url:e,ns_id:t,ns_path:o,inside_admin_console:s,legal_hold_export_gid:r,revision_id:n,error:i}){const d=a.URI.parse(e);return d.setScheme("https"),s?(d.updateQuery({dl:"1",inside_admin_console:"true"}),r&&d.updateQuery({legal_hold_export_gid:r})):d.updateQuery({dl:"1"}),null!=t&&(a.assert("string"==typeof o,`Namespace ID was passed with invalid path, got: ${o}`),d.updateQuery({nsid:String(t),path:o})),null!=n&&d.updateQuery({revision_id:n}),a.assert("dl-web.dropbox.com"===d.getAuthority(),`download_blockserver_url expects a blockserver resource, got: ${e}`),H({url:d.toString(),error:i,source:"get_blockserver_link"})},e.get_zip=function({fq_paths:e,subject_uid:o,block_hash:s,parent_path:r,flat_zip_mode:a,source:n="unknown",root_ns_id:i}){return t.__awaiter(this,void 0,void 0,(function*(){""===r&&(r="/");const t=yield V({block_hash:s,fq_paths:[...e],parent_path:r,flat_mode:!!a,subjectUserId:o,root_ns_id:i});if(t.isError)O(t.error),W({source:n,type:"zip_download_error"});else{const{url:e}=t.result;H({url:e,source:n})}}))},e.showGetZipUrlErrorSnackbar=O,e.zip_batch_by_ns_id=function({parent_ns_id:e,parent_ns_path:t,files:s,subject_uid:r,block_hash:n}){const i=new a.URI({scheme:"https",authority:"dl-web.dropbox.com",path:"/zip_batch_by_ns_id",query:{_subject_uid:String(r),parent_ns_id:String(e),parent_ns_path:t||"/"}}).toString(),d=document.createElement("form");d.setAttribute("action",i),d.setAttribute("method","post");for(const e of s){const s=`${t}/${o.filename(e.fq_path)}`,r=document.createElement("input");r.setAttribute("name","ns_paths"),r.setAttribute("value",s),d.appendChild(r)}const c=document.createElement("input");c.setAttribute("name","w"),c.setAttribute("value",n),d.appendChild(c),document.body.appendChild(d),d.submit(),d.remove()}}));
//# sourceMappingURL=c_downloads.js-vflY0FA8C.map
