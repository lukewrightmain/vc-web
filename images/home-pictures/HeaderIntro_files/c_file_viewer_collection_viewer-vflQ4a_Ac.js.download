define(["exports","./e_edison","./e_ui_page_files_router","./c_file_store_utils","./c_previews_data_actions","./c_file_viewer_sdk_file_viewer_file_viewer","./c_file_viewer_data_store","./c_core_uri","./c_history","./c_src_sink_index","./c_src_logging_performance","./c_file_viewer_utils","./c_core_logging_constants","./c_lodash-es_lodash","./c_tslib","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","./c_core_notify","./c_core_i18n","metaserver/static/js/modules/core/langpack","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_api_v2_noauth_client","./c_browser_cookies","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","./c_csrf","./c_core_xhr","metaserver/static/js/modules/constants/locales","./c_core_browser_detection","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/login_and_register","./c_extensions_data_selectors","./c_downloads","./c_share_download_ui_api","./c_integrations_data_selectors","./c_portable_delete_snackbars","./c_action_bar_action_bar_strings","./c_portable_delete_strings","./c_files_view_file_actions_snackbars","./c_sdk_file_viewer_action_plugins_utils","./c_file_actions_strings","./c_core_types_preview_type","./c_pap-events_enums_file_type-utils","./c_src_file_viewer_components","./c_api_v2_redux_files","./c_resize-observer-polyfill_dist_ResizeObserver","./c_ui-icon_line_collapse-right","./c_ui-icon_line_expand-left","./c_truncate_index","./c_src_file_extension_extension_constants","./c_core_utils_redesign2023","./c_ui-icon_line_sidebar-show","./c_src_simple-action-bar_action_bar_types","./c_src_toolbar","./c_ui-icon_line_more-horizontal","./c_ui-icon_line_zoom-out","./c_breadcrumb_index","./c_ui-icon_line_move","./c_ui-icon_line_copy","./c_ui-icon_line_cursor","./c_ui-icon_line_delete","./c_auth_login_or_register_types","./c_loggers_device_type","./c_form_row_index","./c_ui_tree_view","./c_sharing_ui_notifications_util","./c_src_utils_logging","./c_account_email","./c_account_email_verify_reasons","./c_ui_modal_dig","./c_ui_input_dig","./c_file_viewer_sdk_file_viewer_experiments","metaserver/static/js/modules/constants/file_viewer_configuration","metaserver/static/js/modules/constants/file_viewer_feature_experiments","metaserver/static/js/modules/constants/file_viewer_flows_experiments","./c_dig-illustrations_spot_file-folders","./c_previews_util","./c_sharing_share_page_action_types","metaserver/static/js/modules/constants/python","./c_flux_base_store","./c_sharing_ui_util","./c_contacts_contact_token_state","./c_icon_icon_helper","./c_sharing_gating_util","./c_sharing_settings_utils_sharing_settings_util","./c_core_logging_video","./c_pap-events_previews_delete_file","./c_pap-events_previews_create_folder","./c_photo-editor_plugin_show-edit-plugin","./c_keymaster","./c_bug_reporting_routing","./c_clipboard_v3","./c_ui-icon_line_dropbox","./c_ui-icon_line_rocket","metaserver/static/js/modules/constants/publish","./c_src_mobile_web","./c_capture_redux_selectors","./c_flows_flows_client","./c_docsend_src_utils","./c_src_common_filepath","./c_flows_approval_approval_io_client","./c_typeahead_index","./c_src_preview-photo-editor_types","./c_ui-icon_line_edit","./c_ui-icon_line_share-arrow","./c_src_common_format_bytes","./c_info_blade_content_metadata_image_metadata","./c_ui-icon_line_closed-captions","./c_src_simple-action-bar_inline_action_bar","./c_assets_pictogram_lightbulb","./c_src_highlighted-truncated-string_em-string","./c_size_class_constants","./c_extensions_split_share_button","./c_ui-icon_line_link","./c_share_modal_evolution_utils_logging","./c_team_discovery_data_utils","./c_growth_ui_teams_web_actions_logger_events","./c_teams_let_members_invite_non_admin_invite_modal","./c_loggers_join_flow_logger","./c_contacts_tokenizer_v2","./c_ui-icon_line_import-contacts","./c_integrations_notify","./c_spectrum_tooltip","./c_src_text","./c_spectrum_colorized_icon","./c_icon_templates_stateless_index","./c_spectrum_svg_icon_bundle","./c_src_instrumentation_common_context","./c_src_instrumentation_constants","./c_src_instrumentation_function_wrapper","./c_spectrum_facepile_facepile_members","./c_spectrum_avatar_avatar_initials","./c_spectrum_avatar_avatar_color_util","./c_src_components_action-bar-strings","./c_ui-icon_line_crop","./c_ui-icon_line_cut","./c_ui-icon_line_shape-rotate-right","./c_ui-icon_line_flip-vertical","./c_ui-icon_line_slider","./c_ui_hoc","./c_capture_api","./c_ux_analytics_dispatch_custom_event"],(function(e,i,t,s,n,r,o,c,a,l,_,p,u,h,d,f,w,v,g,m,S,F,O,T,I,E,C,x,P,R,y,b,V,N,k,D,L,j,A,H,K,U,$,M,B,W,q,z,Q,Y,G,J,X,Z,ee,ie,te,se,ne,re,oe,ce,ae,le,_e,pe,ue,he,de,fe,we,ve,ge,me,Se,Fe,Oe,Te,Ie,Ee,Ce,xe,Pe,Re,ye,be,Ve,Ne,ke,De,Le,je,Ae,He,Ke,Ue,$e,Me,Be,We,qe,ze,Qe,Ye,Ge,Je,Xe,Ze,ei,ii,ti,si,ni,ri,oi,ci,ai,li,_i,pi,ui,hi,di,fi,wi,vi,gi,mi,Si,Fi,Oi,Ti,Ii,Ei,Ci,xi,Pi,Ri,yi,bi,Vi,Ni,ki,Di,Li,ji,Ai,Hi,Ki,Ui,$i,Mi,Bi,Wi,qi,zi){"use strict";const Qi=o.getStoreForFileViewer();function Yi(e,i,t){const n=s.getFileRevisionOrHrefId(e);let r=h.find(i,(e=>s.getFileRevisionOrHrefId(e)===n));if(!r){const t=e.file_id;r=h.find(i,(e=>e.file_id===t))}if(!r&&i.length>0&&void 0!==t){let e=t;return t>=i.length&&(e=i.length>1?i.length-1:0),{newFile:i[e],files:i,newIndex:e}}r||(r=e);const o=i.indexOf(r);return-1===o?{newFile:r,files:[r],newIndex:0}:{newFile:r,files:i,newIndex:o}}function Gi({file:e,files:i,sharedLinkInfos:t,sharePermissions:s,shareTokens:n,oldIndex:r}){const o=i.filter((e=>!e.is_dir)),{newFile:c,newIndex:a}=Yi(e,o,r);return{collection:{file:c,files:o,sharedLinkInfos:t,sharePermissions:s,shareTokens:n},currentIndex:a}}class Ji extends i.React$1.Component{constructor(e){super(e),this.hasFlipped=!1,this.updateFileViewer=()=>{const{file:e}=this.props;this.openFile(e)},this.onFileChanged=(e,i)=>{const t=this.state.collection.files[this.state.currentIndex];if(e.revision_id===t.revision_id&&s.isBrowseFile(t))if(i){const e=Object.assign(Object.assign({},t),{file_id:i.file_id,revision_id:i.revision_id,fq_path:i.fq_path}),s=this.state.collection.files.map(((i,t)=>t===this.state.currentIndex?e:i));this.setState({collection:Object.assign(Object.assign({},this.state.collection),{files:s})})}else{const{newFile:e,newIndex:i}=Yi(t,this.state.collection.files,this.state.currentIndex);i<this.state.collection.files.length-1?this.setState({collection:Object.assign(Object.assign({},this.state.collection),{file:e}),currentIndex:i}):this.closeViewer()}},this.handleFlipNext=h.throttle((()=>{const{collection:e,currentIndex:i}=this.state;this.props.onFlipNext&&this.props.onFlipNext();const t=i+1===e.files.length?0:i+1;this.hasFlipped=!0,this.switchFile(t)}),100),this.handleFlipPrevious=h.throttle((()=>{const{collection:e,currentIndex:i}=this.state;this.props.onFlipPrevious&&this.props.onFlipPrevious();const t=0===i?e.files.length-1:i-1;this.hasFlipped=!0,this.switchFile(t)}),100),this.switchFile=e=>{const{collection:i}=this.state,t=i.files[e];this.updatePreviewUrl(t),this.setState({currentIndex:e},(()=>{this.openFile(t)}))},this.closeViewer=()=>{const{onCloseViewer:e}=this.props;e&&e()},this.state=Gi(e),_.PreviewsEventLogger.mark(_.PreviewsTimingEvents.COLLECTION_VIEWER_CODE_START),this.setupPreviewUrl(this.props.file),this.updateFileViewer()}componentDidMount(){_.PreviewsEventLogger.mark(_.PreviewsTimingEvents.COLLECTION_VIEWER_MOUNT)}componentDidUpdate(e){if(function(e,i){const{file:t,files:s,sharedLinkInfos:n,sharePermissions:r,shareTokens:o}=e;return t!==i.file||s!==i.files||n!==i.sharedLinkInfos||r!==i.sharePermissions||o!==i.shareTokens}(e,this.props)){const e=this.state.currentIndex,i=this.hasFlipped?this.state.collection.files[e]:this.props.file,t=Gi(Object.assign(Object.assign({},this.props),{file:i,oldIndex:e})),s=t.collection.file,n=e!==t.currentIndex,r=i.file_id!==s.file_id,o="fq_path"in i&&"fq_path"in s&&i.fq_path!==s.fq_path;this.setState(t,(()=>{(n||r||o)&&(this.updatePreviewUrl(s),this.openFile(s))}))}}componentWillUnmount(){const{onClose:e}=this.props;e&&e(),this.teardownPreviewUrl()}openFile(e){this.props.openFile(e)}setupPreviewUrl(e){this.props.skipOuterRouting||this.setPreviewUrl(e)}updatePreviewUrl(e){this.setPreviewUrl(e,!1),t.setSpaProductName("preview_file_flip")}teardownPreviewUrl(){this.props.skipOuterRouting||this.setPreviewUrl(null)}setPreviewUrl(e,i=!0){if(this.props.disableRouting)return;const t=c.URI.parse(a.DBHistory.get_url()),n=c.URI.encode_parts(t.getPath());let r=t.removeQuery("select").removeQuery("page");if(null==e)r=r.removeQuery("preview"),r=r.removeQuery("t"),r=r.removeQuery("e");else{const i=s.getFilename(e),t=c.URI.parse(e.href).getQuery();r=r.updateQuery({preview:i,t:null==t?void 0:t.t,e:null==t?void 0:t.e})}const o=r.getQuery();i?a.DBHistory.push_state(n,o,{immediatelyRestoreState:!1}):a.DBHistory.replace_state(n,o)}renderSDKSurface(){const{fileViewOrigin:e,hidePageChrome:n,transparentBackground:o,forceNoToolbar:c,user:a,browseContext:_,browseExceptions:p,canRestoreRevision:d,onRestoreRevision:f,onFullscreenChange:w,brandingInfo:v,initialPreviewSourceContext:g,shouldFocusApproval:m,shouldFocusComment:S,activeCommentThreadId:F,appDownloadInterstitialDismissed:O,containerId:T,isInsideBackup:I,previewApiDataMap:E,ajaxTimerName:C,updateFiles:x,encryptionOptions:P,editActivationParams:R}=this.props,{collection:y,currentIndex:b}=this.state,V=h.get(y.sharedLinkInfos,b),N=h.get(y.sharePermissions,b),k=h.get(y.shareTokens,b),D=h.get(y.files,b),L=y.files.map((e=>{var i;const t=s.getFileRevisionId(e);return null===(i=E[t])||void 0===i?void 0:i.data})),j=x?()=>x(y.files,D,!0):void 0;let A=null!=g?g:u.SourceContext.Unknown;switch(e){case t.FileViewOriginType.BROWSE:case t.FileViewOriginType.VERSION_HISTORY:case t.FileViewOriginType.HOME:case t.FileViewOriginType.HELLOSIGN:case t.FileViewOriginType.PHOTOS:case t.FileViewOriginType.STARRED:case t.FileViewOriginType.RECENTS:case t.FileViewOriginType.SEARCH:case t.FileViewOriginType.COLLECTIONS:case t.FileViewOriginType.VIDEO_SYNTHESIS:case t.FileViewOriginType.VIDEO_HOME:if(!a)throw new Error("User is required to browse files");let s;switch(e){case t.FileViewOriginType.VERSION_HISTORY:s=r.SDKPreviewSurface.VERSION_HISTORY;break;case t.FileViewOriginType.HOME:s=r.SDKPreviewSurface.HOME;break;case t.FileViewOriginType.HELLOSIGN:s=r.SDKPreviewSurface.HELLOSIGN;break;case t.FileViewOriginType.STARRED:s=r.SDKPreviewSurface.STARRED;break;case t.FileViewOriginType.RECENTS:s=r.SDKPreviewSurface.RECENTS;break;case t.FileViewOriginType.SEARCH:s=r.SDKPreviewSurface.SEARCH;break;case t.FileViewOriginType.PHOTOS:s=r.SDKPreviewSurface.PHOTOS;break;case t.FileViewOriginType.COLLECTIONS:s=r.SDKPreviewSurface.COLLECTIONS;break;case t.FileViewOriginType.VIDEO_SYNTHESIS:s=r.SDKPreviewSurface.VIDEO_SYNTHESIS;break;case t.FileViewOriginType.VIDEO_HOME:s=r.SDKPreviewSurface.VIDEO_HOME;break;default:s=r.SDKPreviewSurface.BROWSE}return(I||t.isBackupBrowse())&&(s=r.SDKPreviewSurface.BACKUP,A=u.SourceContext.Backup),i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(r.FileViewerWithCSS,{file:D,fileIndex:b,previewCollection:L,updateFiles:j,fileCount:y.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:V,sharePermission:N,shareToken:k,brandingInfo:v,user:a,onFileChanged:this.onFileChanged,closeFile:this.closeViewer,previewSurface:s,canRestoreRevision:d,onRestoreRevision:f,onFullscreenChange:w,browseContext:_,browseExceptions:p,previewContentOnly:n,canShowFileFlippers:s===r.SDKPreviewSurface.SEARCH||s===r.SDKPreviewSurface.BROWSE||s===r.SDKPreviewSurface.COLLECTIONS||s===r.SDKPreviewSurface.PHOTOS||s===r.SDKPreviewSurface.VIDEO_SYNTHESIS||s===r.SDKPreviewSurface.VIDEO_HOME,shouldFocusApproval:m,shouldFocusComment:S,activeCommentThreadId:F,hideOpenInAppInterstitial:!!O,fileViewOrigin:e,sourceContext:A,ajaxTimerName:C,encryptionOptions:P,editActivationParams:R}));case t.FileViewOriginType.SHARED_LINK_PAGE:if(!V||!N||!k)throw new Error("Missing required data to view");return i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(r.FileViewerWithCSS,{file:D,fileIndex:b,fileCount:y.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:V,sharePermission:N,shareToken:k,brandingInfo:v,closeFile:this.closeViewer,previewSurface:r.SDKPreviewSurface.SHARED_LINK,user:a,canShowFileFlippers:g===u.SourceContext.SharedLinkFolder||g===u.SourceContext.SharedLinkCollection,previewContentOnly:n,hideOpenInAppInterstitial:!!O,initialSourceAction:this.props.initialPreviewSourceAction,onFullscreenChange:w,fileViewOrigin:e,sourceContext:A,ajaxTimerName:C,encryptionOptions:P}));case t.FileViewOriginType.SHARED_CONTENT_LINK_PAGE:if(!V||!N||!k)throw new Error("Missing required data to view");return i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(r.FileViewerWithCSS,{file:D,fileIndex:b,fileCount:y.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:V,sharePermission:N,shareToken:k,brandingInfo:v,closeFile:this.closeViewer,previewSurface:r.SDKPreviewSurface.SHARED_CONTENT_LINK,user:a,canShowFileFlippers:!0,previewContentOnly:n,hideOpenInAppInterstitial:!!O,initialSourceAction:this.props.initialPreviewSourceAction,onFullscreenChange:w,fileViewOrigin:e,sourceContext:A,ajaxTimerName:C,encryptionOptions:P}));case t.FileViewOriginType.COMMERCE:case t.FileViewOriginType.TRANSFER:case t.FileViewOriginType.CLIENT_PORTAL:let h;switch(e){case t.FileViewOriginType.TRANSFER:h=r.SDKPreviewSurface.TRANSFER;break;case t.FileViewOriginType.CLIENT_PORTAL:h=r.SDKPreviewSurface.CLIENT_PORTAL;break;default:h=r.SDKPreviewSurface.COMMERCE}return i.React$1.createElement(r.FileViewerWithCSS,{file:D,fileIndex:b,fileCount:y.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:V,sharePermission:N,shareToken:k,brandingInfo:v,closeFile:this.closeViewer,previewSurface:h,user:a,canShowFileFlippers:!1,previewContentOnly:n,transparentBackground:o,forceNoToolbar:c,hideOpenInAppInterstitial:!!O,containerId:T,initialSourceAction:this.props.initialPreviewSourceAction,onPreviewSessionInitialized:this.props.onPreviewSessionInitialized,onFullscreenChange:w,fileViewOrigin:e,sourceContext:A,ajaxTimerName:C,encryptionOptions:P});case t.FileViewOriginType.SHARED_COLLECTION:return i.React$1.createElement(r.FileViewerWithCSS,{file:D,fileIndex:b,previewCollection:L,fileCount:y.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,user:a,onFileChanged:this.onFileChanged,closeFile:this.closeViewer,previewSurface:r.SDKPreviewSurface.SHARED_COLLECTION,canRestoreRevision:d,onRestoreRevision:f,onFullscreenChange:w,previewContentOnly:n,canShowFileFlippers:!0,hideOpenInAppInterstitial:!!O,fileViewOrigin:e,sourceContext:A,ajaxTimerName:C,encryptionOptions:P});default:return l.getMetricsReporter$1().createStats({ns:"web_previews",name:"unkown_preview_origin"},{origin:`${e}`}),i.React$1.createElement(r.FileViewerWithCSS,{file:D,fileIndex:b,fileCount:y.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:V,sharePermission:N,shareToken:k,brandingInfo:v,user:a,closeFile:this.closeViewer,previewSurface:r.SDKPreviewSurface.UNKNOWN,canRestoreRevision:d,onRestoreRevision:f,onFullscreenChange:w,previewContentOnly:n,canShowFileFlippers:!1,hideOpenInAppInterstitial:!!O,fileViewOrigin:e,sourceContext:A,ajaxTimerName:C,encryptionOptions:P})}}render(){return i.React$1.createElement("div",null,this.renderSDKSurface())}}Ji.displayName="_FileCollectionViewer";const Xi=t.connect(((e,i)=>({previewApiDataMap:n.getApiDataForFiles(e,i.files)})),{openFile:r.openFile})(Ji);class Zi extends i.React$1.Component{render(){return i.React$1.createElement(t.Provider,{store:Qi},i.React$1.createElement(Xi,Object.assign({},this.props)))}}Zi.displayName="FileCollectionViewerWithProvider",e.FileCollectionViewer=Zi,e._FileCollectionViewer=Ji}));
//# sourceMappingURL=c_file_viewer_collection_viewer.js-vflEPBi-l.map
